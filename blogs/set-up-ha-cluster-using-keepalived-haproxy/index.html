<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Use Keepalived and HAproxy to create an HA cluster."><meta name=keywords content="Kubernetes,Keepalived,HAproxy,KubeKey,HA"><meta property="og:type" content="article"><meta property="og:title" content="Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy"><meta property="og:description" content="Use Keepalived and HAproxy to create an HA cluster."><meta property="og:image" content="https://ap3.qingstor.com/kubesphere-website/docs/architecture-ha-k8s-cluster.png"><meta property="og:url" content="https://openksc.github.io/blogs/set-up-ha-cluster-using-keepalived-haproxy/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://ap3.qingstor.com/kubesphere-website/docs/architecture-ha-k8s-cluster.png"><meta name=docsearch:language content="en-US"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/blogs/set-up-ha-cluster-using-keepalived-haproxy/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><script type=text/javascript>_linkedin_partner_id="3131724",window._linkedin_data_partner_ids=window._linkedin_data_partner_ids||[],window._linkedin_data_partner_ids.push(_linkedin_partner_id)</script><script type=text/javascript>(function(){var t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://snap.licdn.com/li.lms-analytics/insight.min.js",t.parentNode.insertBefore(e,t)})()</script><noscript>&lt; img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=3131724&fmt=gif" /></noscript><script>!function(e,t,n,s,o,i){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments)},s.version="1.1",s.queue=[],o=t.createElement(n),o.async=!0,o.src="//static.ads-twitter.com/uwt.js",i=t.getElementsByTagName(n)[0],i.parentNode.insertBefore(o,i))}(window,document,"script"),twq("init","o65xa"),twq("track","PageView")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>ðŸš€ KubeSphere v4.1.3 with Enhancements and Bug Fixes is available now. <a href=/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">Read the release notes â†’</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>Scenarios</span><ul class="dropdown-menu menu-2"><li><a href=/devops/>Embracing One-stop DevOps Workflow</a></li><li><a href=/service-mesh/>Running Microservices on Kubernetes</a></li><li><a href=/observability/>Building Cloud Native Observability</a></li></ul></li><li class=menu-li><span class=menu-span>Resources</span><ul class="dropdown-menu menu-3"><li><a href=/projects/>Open Source Projects</a></li><li><a href=/conferences/>KubeCon & QCon</a></li><li><a href=/blogs/>Technology Blogs</a></li><li><a href=/videos/>Video Resources</a></li></ul></li><li class=menu-li><span class=menu-span>Documentation</span><ul class="dropdown-menu menu-4"><li><a href=/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/docs/v3.4>v3.4</a></li><li><a href=/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/en/%20 target=_blank rel="noopener noreferrer">Extension Development</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>Community</span><ul class="dropdown-menu menu-5"><li><a href=/contribution/>Contribution</a></li><li><a href=/case/>Case Studies</a></li><li><a href=/partner/>Partner</a></li><li><a href=/news/>News</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">RoadMap</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">OSPP 2025</a></li></ul></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>English</span></div><ul class=dropdown-menu><li onclick='handleLangClick("en","/blogs/set-up-ha-cluster-using-keepalived-haproxy/")'>English</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>Scenarios</span><ul class=dropdown-menu><li><a href=/devops/>Embracing One-stop DevOps Workflow</a></li><li><a href=/service-mesh/>Running Microservices on Kubernetes</a></li><li><a href=/observability/>Building Cloud Native Observability</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>Resources</span><ul class=dropdown-menu><li><a href=/projects/>Open Source Projects</a></li><li><a href=/conferences/>KubeCon & QCon</a></li><li><a href=/blogs/>Technology Blogs</a></li><li><a href=/videos/>Video Resources</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>Documentation</span><ul class=dropdown-menu><li><a href=/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/docs/v3.4>v3.4</a></li><li><a href=/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/en/%20>Extension Development</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>Community</span><ul class=dropdown-menu><li><a href=/contribution/>Contribution</a></li><li><a href=/case/>Case Studies</a></li><li><a href=/partner/>Partner</a></li><li><a href=/news/>News</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>RoadMap</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>OSPP 2025</a></li></ul></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="en",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/blogs/>Technology Blogs</a> > </span><span>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy</span></div><div class='main-div middle-div'><div class=author>Pixiake, Sherlock</div><span class=date>Published onï¼š2021-01-27</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>The number of views: <span id=busuanzi_value_page_pv></span></span><h1>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&text=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&title=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&t=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><p>A highly available Kubernetes cluster ensures your applications run without outages which is required for production. In this connection, there are plenty of ways for you to choose from to achieve high availability. For example, if your cluster is deployed on cloud (e.g. Google Cloud and AWS), you can create load balancers on these platforms directly. At the same time, Keepalived, HAproxy and NGINX are also possible alternatives for you to achieve load balancing.</p><p>In this article, I am going to use Keepalived and HAproxy for load balancing and achieve high availability. The steps are listed as below:</p><ol><li>Prepare hosts.</li><li>Configure Keepalived and HAproxy.</li><li>Use KubeKey to set up a Kubernetes cluster.</li></ol><h2 id=cluster-architecture>Cluster Architecture</h2><p>In my cluster, I will set three master nodes, three worker nodes, two nodes for load balancing and one virtual IP address. The virtual IP address in this example may also be called "a floating IP address". That means in the event of node failures, the IP address can be passed between nodes allowing for failover, thus achieving high availability.</p><p><img src=https://ap3.qingstor.com/kubesphere-website/docs/architecture-ha-k8s-cluster.png alt=architecture></p><p>Notice that in my cluster, I am not going to install Keepalived and HAproxy on any of the master nodes. Admittedly, you can do that and high availability can also be achieved. That said, I would like to try a different way by configuring two specific nodes for load balancing (You can add more nodes of this kind as needed). Only Keepalived and HAproxy will be installed on these two nodes, avoiding any potential conflicts with any Kubernetes components and services.</p><h2 id=host-information>Host Information</h2><p>Here is the detailed information of each node in my cluster for your reference:</p><table><thead><tr><th>IP Address</th><th>Host Name</th><th>Role</th><th>System</th></tr></thead><tbody><tr><td>172.16.0.2</td><td>lb1</td><td>Keepalived & HAproxy</td><td>CentOS 7.5, 4 Cores, 4 G Memory, 20 G Disk</td></tr><tr><td>172.16.0.3</td><td>lb2</td><td>Keepalived & HAproxy</td><td>CentOS 7.5, 4 Cores, 4 G Memory, 20 G Disk</td></tr><tr><td>172.16.0.4</td><td>master1</td><td>master, etcd</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.5</td><td>master2</td><td>master, etcd</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.6</td><td>master3</td><td>master, etcd</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.7</td><td>worker1</td><td>worker</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.8</td><td>worker2</td><td>worker</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.9</td><td>worker3</td><td>worker</td><td>CentOS 7.5, 8 Cores, 8 G Memory, 50 G Disk</td></tr><tr><td>172.16.0.10</td><td></td><td>Virtual IP address</td><td></td></tr></tbody></table><p>For more information about requirements for nodes, network, and dependencies, <a href=https://kubesphere.io/blogs/install-kubernetes-using-kubekey/#node-requirements target=_blank rel="noopener noreferrer">see one of my previous posts</a>.</p><h2 id=configure-load-balancing>Configure Load Balancing</h2><p><a href=https://www.keepalived.org/ target=_blank rel="noopener noreferrer">Keepalived</a> provides a VRPP implementation and allows you to configure Linux machines for load balancing, preventing single points of failure. <a href=https://www.haproxy.org/ target=_blank rel="noopener noreferrer">HAProxy</a>, providing reliable, high performance load balancing, works perfectly with Keepalived.</p><p>As I said above, I will install both Keepalived and HAproxy on <code>lb1</code> and <code>lb2</code>. The logic is very simple: if one of the node goes down, the virtual IP address (i.e. the floating IP address) will be automatically associated with another node so that the cluster is still functioning well, thus achieving high availability. If you want, you can add more nodes all with Keepalived and HAproxy installed for that purpose.</p><p>Run the following command to install Keepalived and HAproxy first.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install keepalived haproxy psmisc -y
</span></span></code></pre></div><h3 id=haproxy>HAproxy</h3><ol><li><p>The configuration of HAproxy is exactly the same on the two machines for load balancing. Run the following command to configure HAproxy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /etc/haproxy/haproxy.cfg
</span></span></code></pre></div></li><li><p>Here is my configuration for your reference (Pay attention to the <code>server</code> field. Note that <code>6443</code> is the <code>apiserver</code> port):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>global
</span></span><span style=display:flex><span>    log /dev/log  local0 warning
</span></span><span style=display:flex><span>    chroot      /var/lib/haproxy
</span></span><span style=display:flex><span>    pidfile     /var/run/haproxy.pid
</span></span><span style=display:flex><span>    maxconn     <span style=color:#ae81ff>4000</span>
</span></span><span style=display:flex><span>    user        haproxy
</span></span><span style=display:flex><span>    group       haproxy
</span></span><span style=display:flex><span>    daemon
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   stats socket /var/lib/haproxy/stats
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>defaults
</span></span><span style=display:flex><span>  log global
</span></span><span style=display:flex><span>  option  httplog
</span></span><span style=display:flex><span>  option  dontlognull
</span></span><span style=display:flex><span>        timeout connect <span style=color:#ae81ff>5000</span>
</span></span><span style=display:flex><span>        timeout client <span style=color:#ae81ff>50000</span>
</span></span><span style=display:flex><span>        timeout server <span style=color:#ae81ff>50000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>frontend kube-apiserver
</span></span><span style=display:flex><span>  bind *:6443
</span></span><span style=display:flex><span>  mode tcp
</span></span><span style=display:flex><span>  option tcplog
</span></span><span style=display:flex><span>  default_backend kube-apiserver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>backend kube-apiserver
</span></span><span style=display:flex><span>    mode tcp
</span></span><span style=display:flex><span>    option tcplog
</span></span><span style=display:flex><span>    option tcp-check
</span></span><span style=display:flex><span>    balance roundrobin
</span></span><span style=display:flex><span>    default-server inter 10s downinter 5s rise <span style=color:#ae81ff>2</span> fall <span style=color:#ae81ff>2</span> slowstart 60s maxconn <span style=color:#ae81ff>250</span> maxqueue <span style=color:#ae81ff>256</span> weight <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    server kube-apiserver-1 172.16.0.4:6443 check <span style=color:#75715e># Replace the IP address with your own.</span>
</span></span><span style=display:flex><span>    server kube-apiserver-2 172.16.0.5:6443 check <span style=color:#75715e># Replace the IP address with your own.</span>
</span></span><span style=display:flex><span>    server kube-apiserver-3 172.16.0.6:6443 check <span style=color:#75715e># Replace the IP address with your own.</span>
</span></span></code></pre></div></li><li><p>Save the file and run the following command to restart HAproxy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart haproxy
</span></span></code></pre></div></li><li><p>Make it persist through reboots:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable haproxy
</span></span></code></pre></div></li><li><p>Make sure you configure HAproxy on the other machine (<code>lb2</code>) as well.</p></li></ol><h3 id=keepalived>Keepalived</h3><p>Keepalived must be installed on both machines while the configuration of them is slightly different.</p><ol><li><p>Run the following command to configure Keepalived.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /etc/keepalived/keepalived.conf
</span></span></code></pre></div></li><li><p>Here is my configuration (<code>lb1</code>) for your reference:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>global_defs <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  notification_email <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  router_id LVS_DEVEL
</span></span><span style=display:flex><span>  vrrp_skip_check_adv_addr
</span></span><span style=display:flex><span>  vrrp_garp_interval <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  vrrp_gna_interval <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_script chk_haproxy <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  script <span style=color:#e6db74>&#34;killall -0 haproxy&#34;</span>
</span></span><span style=display:flex><span>  interval <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  weight <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vrrp_instance haproxy-vip <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  state BACKUP
</span></span><span style=display:flex><span>  priority <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>  interface eth0                       <span style=color:#75715e># Network card</span>
</span></span><span style=display:flex><span>  virtual_router_id <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>  advert_int <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  authentication <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    auth_type PASS
</span></span><span style=display:flex><span>    auth_pass <span style=color:#ae81ff>1111</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  unicast_src_ip 172.16.0.2      <span style=color:#75715e># The IP address of this machine</span>
</span></span><span style=display:flex><span>  unicast_peer <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    172.16.0.3                         <span style=color:#75715e># The IP address of peer machines</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  virtual_ipaddress <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    172.16.0.10/24                  <span style=color:#75715e># The VIP address</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  track_script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    chk_haproxy
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class="notices note"><p>Note</p><div><ul><li><p>For the <code>interface</code> field, you must provide your own network card information. You can run <code>ifconfig</code> on your machine to get the value.</p></li><li><p>The IP address provided for <code>unicast_src_ip</code> is the IP address of your current machine. For other machines where HAproxy and Keepalived are also installed for load balancing, their IP address must be input for the field <code>unicast_peer</code>.</p></li></ul></div></div></li><li><p>Save the file and run the following command to restart Keepalived.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart keepalived
</span></span></code></pre></div></li><li><p>Make it persist through reboots:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable haproxy
</span></span></code></pre></div></li><li><p>Make sure you configure Keepalived on the other machine (<code>lb2</code>) as well.</p></li></ol><h2 id=verify-ha>Verify HA</h2><p>Before you start to create your Kubernetes cluster, make sure you have tested the high availability.</p><ol><li><p>On the machine <code>lb1</code>, run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@lb1 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip a s</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc mq state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 52:54:9e:27:38:c8 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.16.0.2/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0
</span></span><span style=display:flex><span>       valid_lft 73334sec preferred_lft 73334sec
</span></span><span style=display:flex><span>    inet 172.16.0.10/24 scope global secondary eth0 <span style=color:#75715e># The VIP address</span>
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::510e:f96:98b2:af40/64 scope link noprefixroute
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div></li><li><p>As you can see above, the virtual IP address is successfully added. Simulate a failure on this node:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop haproxy
</span></span></code></pre></div></li><li><p>Check the floating IP address again and you can see it disappear on <code>lb1</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@lb1 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip a s</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc mq state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 52:54:9e:27:38:c8 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.16.0.2/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0
</span></span><span style=display:flex><span>       valid_lft 72802sec preferred_lft 72802sec
</span></span><span style=display:flex><span>    inet6 fe80::510e:f96:98b2:af40/64 scope link noprefixroute
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div></li><li><p>Theoretically, the virtual IP will be failed over to the other machine (<code>lb2</code>) if the configuration is successful. On <code>lb2</code>, run the following command and here is the expected output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@lb2 ~<span style=color:#f92672>]</span><span style=color:#75715e># ip a s</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc mq state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 52:54:9e:3f:51:ba brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.16.0.3/24 brd 172.16.0.255 scope global noprefixroute dynamic eth0
</span></span><span style=display:flex><span>       valid_lft 72690sec preferred_lft 72690sec
</span></span><span style=display:flex><span>    inet 172.16.0.10/24 scope global secondary eth0   <span style=color:#75715e># The VIP address</span>
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::f67c:bd4f:d6d5:1d9b/64 scope link noprefixroute
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div></li><li><p>As you can see above, high availability is successfully configured.</p></li></ol><h2 id=use-kubekey-to-create-a-kubernetes-cluster>Use KubeKey to Create a Kubernetes Cluster</h2><p><a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">KubeKey</a> is an efficient and convenient tool to create a Kubernetes cluster. If you are not familiar with KubeKey, have a look at my previous articles about using KubeKey to <a href=https://kubesphere.io/blogs/install-kubernetes-using-kubekey/ target=_blank rel="noopener noreferrer">create a three-node cluster</a> and scale your cluster.</p><ol><li><p>Download KubeKey from its <a href=https://github.com/kubesphere/kubekey/releases target=_blank rel="noopener noreferrer">GitHub Release Page</a> or use the following command to download KubeKey version 1.0.1. You only need to download KubeKey to one of your machines (e.g. <code>master1</code>) that serves as the <strong>taskbox</strong> for installation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get-kk.kubesphere.io | VERSION<span style=color:#f92672>=</span>v2.0.0 sh -
</span></span></code></pre></div></li><li><p>The above command downloads KubeKey and unzips the file. Your folder now contains a file called <code>kk</code>. Make it executable:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x kk
</span></span></code></pre></div></li><li><p>Create a configuration file to specify cluster information. The Kubernetes version I am going to install is <code>v1.17.9</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./kk create config --with-kubernetes v1.20.4
</span></span></code></pre></div></li><li><p>A default file <code>config-sample.yaml</code> will be created. Edit the file and here is my configuration for your reference:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kubekey.kubesphere.io/v1alpha1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: master1, address: 172.16.0.4, internalAddress: 172.16.0.4, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: master2, address: 172.16.0.5, internalAddress: 172.16.0.5, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: master3, address: 172.16.0.6, internalAddress: 172.16.0.6, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: worker1, address: 172.16.0.7, internalAddress: 172.16.0.7, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: worker2, address: 172.16.0.8, internalAddress: 172.16.0.8, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: worker3, address: 172.16.0.9, internalAddress: 172.16.0.9, user: root, password</span>: <span style=color:#ae81ff>Testing123}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>roleGroups</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>etcd</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>master</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>worker1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>worker2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>worker3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>controlPlaneEndpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>lb.kubesphere.local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#ae81ff>172.16.0.10</span>   <span style=color:#75715e># The VIP address</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>6443</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubernetes</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.17.9</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>imageRepo</span>: <span style=color:#ae81ff>kubesphere</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clusterName</span>: <span style=color:#ae81ff>cluster.local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>plugin</span>: <span style=color:#ae81ff>calico</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubePodsCIDR</span>: <span style=color:#ae81ff>10.233.64.0</span><span style=color:#ae81ff>/18</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubeServiceCIDR</span>: <span style=color:#ae81ff>10.233.0.0</span><span style=color:#ae81ff>/18</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>registryMirrors</span>: []
</span></span><span style=display:flex><span>    <span style=color:#f92672>insecureRegistries</span>: []
</span></span><span style=display:flex><span>  <span style=color:#f92672>addons</span>: []
</span></span></code></pre></div><div class="notices note"><p>Note</p><div><ul><li>Replace the value of <code>controlPlaneEndpoint.address</code> with your own VIP address.</li><li>For more information about different parameters in this configuration file, see <a href=https://kubesphere.io/blogs/install-kubernetes-using-kubekey/#install-kubernetes target=_blank rel="noopener noreferrer">one of my previous blogs</a>.</li></ul></div></div></li><li><p>Save the file and execute the following command to create your cluster:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./kk create cluster -f config-sample.yaml
</span></span></code></pre></div></li><li><p>You can see the output as below when the installation finishes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Congratulations! Installation is successful.
</span></span></code></pre></div></li><li><p>Execute the following command to check the status of namespaces.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pod --all-namespaces
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>kube-system   calico-kube-controllers-59d85c5c84-l7zp5   1/1     Running   <span style=color:#ae81ff>0</span>          42s
</span></span><span style=display:flex><span>kube-system   calico-node-5d6gb                          1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span><span style=display:flex><span>kube-system   calico-node-77bcj                          1/1     Running   <span style=color:#ae81ff>0</span>          42s
</span></span><span style=display:flex><span>kube-system   calico-node-bdzfp                          1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span><span style=display:flex><span>kube-system   calico-node-ph756                          1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   calico-node-phz7d                          1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   calico-node-v7wnf                          1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   coredns-74d59cc5c6-gdkmz                   1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span><span style=display:flex><span>kube-system   coredns-74d59cc5c6-j2lhc                   1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span><span style=display:flex><span>kube-system   kube-apiserver-master1                     1/1     Running   <span style=color:#ae81ff>0</span>          48s
</span></span><span style=display:flex><span>kube-system   kube-apiserver-master2                     1/1     Running   <span style=color:#ae81ff>0</span>          19s
</span></span><span style=display:flex><span>kube-system   kube-apiserver-master3                     1/1     Running   <span style=color:#ae81ff>0</span>          19s
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-master1            1/1     Running   <span style=color:#ae81ff>0</span>          48s
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-master2            1/1     Running   <span style=color:#ae81ff>0</span>          19s
</span></span><span style=display:flex><span>kube-system   kube-controller-manager-master3            1/1     Running   <span style=color:#ae81ff>0</span>          19s
</span></span><span style=display:flex><span>kube-system   kube-proxy-29sfc                           1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span><span style=display:flex><span>kube-system   kube-proxy-drzsc                           1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   kube-proxy-lgwhd                           1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   kube-proxy-npq6t                           1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span><span style=display:flex><span>kube-system   kube-proxy-srlwx                           1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   kube-proxy-vdtbk                           1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span><span style=display:flex><span>kube-system   kube-scheduler-master1                     1/1     Running   <span style=color:#ae81ff>0</span>          48s
</span></span><span style=display:flex><span>kube-system   kube-scheduler-master2                     1/1     Running   <span style=color:#ae81ff>0</span>          19s
</span></span><span style=display:flex><span>kube-system   kube-scheduler-master3                     1/1     Running   <span style=color:#ae81ff>0</span>          20s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-2chnt                         1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-2wszl                         1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-2xqlc                         1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-92ksq                         1/1     Running   <span style=color:#ae81ff>0</span>          53s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-cktmd                         1/1     Running   <span style=color:#ae81ff>0</span>          22s
</span></span><span style=display:flex><span>kube-system   nodelocaldns-skmlq                         1/1     Running   <span style=color:#ae81ff>0</span>          21s
</span></span></code></pre></div></li></ol><h2 id=summary>Summary</h2><p>Creating a highly available Kubernetes cluster is not just about business applications running without downtime. It is also about selecting the correct tools and using them to set up the cluster with high availability in the most graceful and efficient way. Why not try Keepalived, HAproxy and KubeKey? Perhaps they will give you the answer you have been seeking for so long.</p><h2 id=reference>Reference</h2><p><a href=https://kubesphere.io/blogs/install-kubernetes-using-kubekey/ target=_blank rel="noopener noreferrer">KubeKey: A Lightweight Installer for Kubernetes and Cloud Native Addons</a></p><p><a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">KubeKey GitHub Repository</a></p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&text=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&title=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fblogs%2fset-up-ha-cluster-using-keepalived-haproxy%2f&t=Create%20a%20Highly%20Available%20Kubernetes%20Cluster%20Using%20Keepalived%20and%20HAproxy" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>Table of Contents</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#cluster-architecture>Cluster Architecture</a></li><li><a href=#host-information>Host Information</a></li><li><a href=#configure-load-balancing>Configure Load Balancing</a><ul><li><a href=#haproxy>HAproxy</a></li><li><a href=#keepalived>Keepalived</a></li></ul></li><li><a href=#verify-ha>Verify HA</a></li><li><a href=#use-kubekey-to-create-a-kubernetes-cluster>Use KubeKey to Create a Kubernetes Cluster</a></li><li><a href=#summary>Summary</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>Receive the latest news, articles and updates from KubeSphere</p><div id=blog_formAddress data-usesendcloud=false><form action="https://kubesphere.us10.list-manage.com/subscribe/post?u=c85ea2b944b08b951f607bdd4&amp;id=83f673a2d9" method=post target=_blank novalidate><input name=EMAIL id=email-input-blog type=text placeholder='Please enter your email address'>
<button type=submit id=email-submit-blog>Subscribe</button></form><span id=message_blog data-message1='email is required!' data-message2='Please enter a valid email address!'></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>Receive the latest news, articles and updates from KubeSphere</p><div id=formAddress data-usesendcloud=false><form action="https://kubesphere.us10.list-manage.com/subscribe/post?u=c85ea2b944b08b951f607bdd4&amp;id=83f673a2d9" method=post target=_blank novalidate><input name=EMAIL id=email-input type=text placeholder='Please enter your email address'>
<button type=submit id=email-submit>Subscribe</button></form></div><span id=message data-message1='email is required!' data-message2='Please enter a valid email address!'></span>
<script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1='email is required!' data-message2='Please enter a valid email address!'></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>Scenarios</div><a href=/devops/>Kubernetes DevOps and GitOps</a>
<a href=/service-mesh/>Microservices with Service Mesh</a>
<a href=/observability/>Cloud Native Observability</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">Functions-as-a-Service Platform and Serverless</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">Multi-cloud Apps Mgmt</a></li><li class=nowrap-li><div class=h3>Resources</div><a href=/projects/>Projects</a>
<a href=/blogs/>Blogs</a>
<a href=/conferences/>KubeCon & QCon</a>
<a href=/videos/>Videos</a></li><li class=nowrap-li><div class=h3>KubeSphere Docs</div><a href=/docs/v4.1/01-intro/01-introduction/>Introduction</a>
<a href=/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>Installation</a>
<a href=/docs/v4.1/02-quickstart/>Tutorial</a>
<a href=/docs/v3.4/reference/api-docs/>API Documentation</a></li><li class=nowrap-li><div class=h3>Community</div><a href=/contribution/>Contribution</a>
<a href=/case/>Case Studies</a>
<a href=/partner/>Partners</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">Roadmap</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">Global Site</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">China Site</a></li><li class=nowrap-li><div class=h3>Products and Services</div><a href=https://aws.amazon.com/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.co/kse/ target=_blank rel="noopener noreferrer">KubeSphere Enterprise</a>
<a href=https://kubesphere.co/marketplace/ target=_blank rel="noopener noreferrer">KubeSphere Extensions Marketplace</a>
<a href=https://kubesphere.co/ksv/ target=_blank rel="noopener noreferrer">KubeSphere Virtualization Platform</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">Cloud Native Services and Support</a>
<a href=https://jinshuju.net/f/bDS8me target=_blank rel="noopener noreferrer">Contact Us</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=youtube-a href=https://www.youtube.com/c/KubeSphere target=_blank aria-label=youtube rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p></div></div></div><div class=cookie><div class=common-layout><p>Your privacy is important to us. We use cookies to remember subscription details, optimize site functionality, and deliver content tailored to your interests. To find out more, see our <a href=/privacy>privacy policy</a>.</p><button>
Accept and continue</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>