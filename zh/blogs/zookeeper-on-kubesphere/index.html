<!doctype html><html lang=en-US><head><meta charset=utf-8><title>KubeSphere 部署 Zookeeper 实战教程</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文详细介绍了 Zookeeper 单节点和集群模式在基于 KubeSphere 部署的 K8s 集群上的安装部署、测试验证的过程"><meta name=keywords content="Kubernetes,KubeSphere,Zookeeper"><meta property="og:type" content="article"><meta property="og:title" content="KubeSphere 部署 Zookeeper 实战教程"><meta property="og:description" content="本文详细介绍了 Zookeeper 单节点和集群模式在基于 KubeSphere 部署的 K8s 集群上的安装部署、测试验证的过程"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/zookeeper-on-kubesphere-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/zookeeper-on-kubesphere/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/zookeeper-on-kubesphere-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/zookeeper-on-kubesphere/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/zookeeper-on-kubesphere/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>KubeSphere 部署 Zookeeper 实战教程</span></div><div class='main-div middle-div'><div class=author>运维有术</div><span class=date>发布于：2023-08-11</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>KubeSphere 部署 Zookeeper 实战教程</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&text=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&title=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&t=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><h2 id=前言>前言</h2><h3 id=知识点>知识点</h3><ul><li>定级：<strong>入门级</strong></li><li>如何利用 <strong>AI 助手</strong>辅助运维工作</li><li>单节点 Zookeeper 安装部署</li><li>集群模式 Zookeeper 安装部署</li><li>开源应用选型思想</li></ul><h3 id=实战服务器配置架构-11-复刻小规模生产环境配置略有不同>实战服务器配置(架构 1:1 复刻小规模生产环境，配置略有不同)</h3><table><thead><tr><th style=text-align:center>主机名</th><th style=text-align:center>IP</th><th style=text-align:center>CPU</th><th style=text-align:center>内存</th><th style=text-align:center>系统盘</th><th style=text-align:center>数据盘</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center>ks-master-0</td><td style=text-align:center>192.168.9.91</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ks-master-1</td><td style=text-align:center>192.168.9.92</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ks-master-2</td><td style=text-align:center>192.168.9.93</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ks-worker-0</td><td style=text-align:center>192.168.9.95</td><td style=text-align:center>4</td><td style=text-align:center>16</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker/CI</td></tr><tr><td style=text-align:center>ks-worker-1</td><td style=text-align:center>192.168.9.96</td><td style=text-align:center>4</td><td style=text-align:center>16</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker</td></tr><tr><td style=text-align:center>ks-worker-2</td><td style=text-align:center>192.168.9.97</td><td style=text-align:center>4</td><td style=text-align:center>16</td><td style=text-align:center>50</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker</td></tr><tr><td style=text-align:center>storage-0</td><td style=text-align:center>192.168.9.81</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>50</td><td style=text-align:center>100+</td><td style=text-align:center>ElasticSearch/GlusterFS/Ceph/Longhorn/NFS/</td></tr><tr><td style=text-align:center>storage-1</td><td style=text-align:center>192.168.9.82</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>50</td><td style=text-align:center>100+</td><td style=text-align:center>ElasticSearch/GlusterFS/Ceph/Longhorn</td></tr><tr><td style=text-align:center>storage-2</td><td style=text-align:center>192.168.9.83</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>50</td><td style=text-align:center>100+</td><td style=text-align:center>ElasticSearch/GlusterFS/Ceph/Longhorn</td></tr><tr><td style=text-align:center>registry</td><td style=text-align:center>192.168.9.80</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>50</td><td style=text-align:center>200</td><td style=text-align:center>Sonatype Nexus 3</td></tr><tr><td style=text-align:center>合计</td><td style=text-align:center>10</td><td style=text-align:center>32</td><td style=text-align:center>88</td><td style=text-align:center>500</td><td style=text-align:center>1100+</td><td style=text-align:center></td></tr></tbody></table><h2 id=实战环境涉及软件版本信息>实战环境涉及软件版本信息</h2><ul><li>操作系统：<strong>openEuler 22.03 LTS SP2 x86_64</strong></li><li>KubeSphere：<strong>3.3.2</strong></li><li>Kubernetes：<strong>v1.24.12</strong></li><li>Containerd：<strong>1.6.4</strong></li><li>GlusterFS：<strong>10.0-8</strong></li><li>KubeKey: <strong>v3.0.8</strong></li><li>Zookeeper：<strong>3.8.2</strong></li></ul><h2 id=简介>简介</h2><p>今天我们的实战内容采用<strong>场景模拟</strong>的形式，模拟真实运维工作中，<strong>必然会</strong>遇到的一个场景。</p><p>作为一个初入职场刚接触云原生运维的运维小白，Boss 今天给我安排了一个<strong>高难度</strong>的任务，对，你没看错就是<strong>高难度</strong>的。</p><p><strong>高难度</strong> = <strong>2 M 1 D</strong>= <strong>听过、没见过、没干过、时间短</strong>。</p><p>Boss 提出的任务要求整理如下（都是我根据 Boss 的原话，自己理解、猜测、搜索整理的，实际上 Boos 根本没说几个字）：</p><ul><li>在 K8s 集群上部署一个单节点模式的 Zookeeper</li><li>在 K8s 集群上部署集群模式的 Zookeeper</li><li>使用场景：<strong>研发、测试（后期很有可能直接转生产）</strong></li><li>任务交付期：<strong>明天（领导认为很简单）</strong></li><li><strong>核心要求：能用就行（自己理解的）</strong></li></ul><p>既然不能拒绝，时间紧任务重，那就干吧，冲冲冲！！！</p><h2 id=2-任务实现思路分析>2. 任务实现思路分析</h2><p>工欲善其事，必先利其器。既然是 <strong>2 M 1 D</strong> 级别的任务，先搬出 <strong>AI 时代</strong>运维三板斧中的前两板，看看是否能解决问题。</p><blockquote><p>由于只用了两板斧就搞定了，所以就没用到第三板。</p></blockquote><h3 id=第一板斧ai-助手>第一板斧——AI 助手</h3><p><strong>提示词：</strong> "我要在 K8s 上部署 zookeerper。分别给我一个单节点和集群模式的部署方案，注意需要使用存储类 glusterfs、需要有 SVC、需要有 zoo.cfg 的 ConfigMap"</p><blockquote><p><strong>重点说明：</strong> 本人学艺不精，<strong>AI 助手</strong>玩的还不熟，提示词写的不好，所以最终效果也不是太好。</p></blockquote><p>输入上面的提示词以后，<strong>AI 助手-3.5</strong> 吧啦吧啦返回了一堆文字给我，我只取了精华作为展示。</p><ul><li>单节点部署配置文件（<code>zookeeper-single.yaml</code>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>glusterfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>zoo.cfg</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tickTime=2000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    dataDir=/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    clientPort=2181</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>zookeeper:3.7.0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1Gi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ZOOKEEPER_CONFIG_FILE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/opt/zookeeper-3.7.0/conf/zoo.cfg</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ZOO_SERVERS</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;server.1=zookeeper-0.zookeeper.default.svc.cluster.local:2888:3888;2181&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span></code></pre></div><ul><li>集群模式部署配置文件（<code>zookeeper-cluster.yaml</code>）：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>glusterfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>zoo.cfg</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tickTime=2000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    dataDir=/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    clientPort=2181
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    initLimit=5
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syncLimit=2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server.1=zookeeper-0.zookeeper.default.svc.cluster.local:2888:3888
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server.2=zookeeper-1.zookeeper.default.svc.cluster.local:2888:3888
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    server.3=zookeeper-2.zookeeper.default.svc.cluster.local:2888:3888</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>zookeeper:3.7.0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>1Gi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ZOOKEEPER_CONFIG_FILE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/opt/zookeeper-3.7.0/conf/zoo.cfg</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span></code></pre></div><p>分析完内容，我发现我好像懂了点，但是又没有完全懂，返回的结果中单节点和集群模式的配置文件看着差不太多，分析一下结果，顺便捋一下思路：</p><ul><li>kind 类型不同： 单节点是 <strong>Deployment</strong>， 集群模式是 <strong>StatefulSet</strong>，这个目前看起来没毛病，思路是对的</li><li>Deployment 副本数为 1，StatefulSet 副本数为 3</li><li>集群模式没有使用 <strong>volumeClaimTemplates</strong></li><li>集群模式 zoo.cfg 配置文件中多了几个 server 的配置项，但是好像没有实现 <strong>myid</strong> 的处理</li></ul><blockquote><p>必须有一定的 K8s 和 Zookeeper 相关知识积累才能分析出 <strong>AI 助手</strong> 给出的结果是否符合需求，否则根本看不懂。</p></blockquote><h3 id=第二板斧搜索引擎>第二板斧——搜索引擎</h3><p>搜索引擎，在<strong>AI 助手</strong>出来以前在运维辅助中排名第一，现在暂居第二了，估计也没机会重回巅峰了（谨代表个人排名意见）。</p><p>看完了 <strong>AI 助手</strong> 的输出结果，觉得整体结构内容没问题，但是感觉细节上还是差那么点意思，尤其是集群模式的部署。我们会在本文第三小节验证。</p><p>同时，我还发现了一点 <code>image: zookeeper:3.7.0</code>，既然引用的 Image 是 DockerHub 官方的，那么 DockerHub 上一定有对应的 Image 及容器化部署的使用方法。</p><p>这也就带来一个新的灵感和一种新的学习方法，同时也是<strong>最简单直接的</strong> Docker 部署转化为 Kubernetes 部署的方法，直接去看 Docker 的部署命令、启动命令、相关参数，然后直接搬到 K8s 上就可以。</p><p>直接转到 <strong>DokcerHub 官网</strong>，我们直接用关键词 <strong>zookeeper</strong> 搜索一下。</p><p>搜索结果截图：</p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//DockerHub-Repository-%20zookeeper.png alt></p><p>简单的思考分析一下搜索结果：</p><ul><li><p>排名最高的两个 zookeeper 镜像，下载量都超过 <strong>100M+</strong>, 分别是 Docker 官方和 <strong>Bitnami</strong> 出品的。</p></li><li><p>上周下载量最多的是 Bitnami 出品的 zookeeper，下载量高达 1,140,215，比 DockerHub 出品的 zookeeper 下载量 681,115，多了一倍还多。</p></li></ul><blockquote><p>小提示：<strong>Bitnami</strong>， 十几年前我就开始用，它们出品的一键部署安装包，当时就是很牛的一键部署中间件解决方案服务商，现在应该是更全面、更牛了。</p></blockquote><p><strong>为什么要做上面的分析？</strong></p><ul><li>当我们做开源技术选型的时候，主要的决定因素之一就是<strong>使用者数量</strong>，使用者太少说明产品还不成熟，代表着出了问题你都没地方寻求帮助。</li><li>我的技术选型几个原则：<strong>首选官方</strong>(Apache 官方没有，只能选 DockerHub 官方)、<strong>用户量大</strong>(100M+)、<strong>维护更新频繁</strong>(7 days ago)。</li><li>除了 <strong>DockerHub</strong> 出品的 <strong>zookeeper</strong> 镜像之外，<strong>Bitnami</strong> 出品的镜像也是一个很好的选择，群众的眼睛是雪亮的，如果不好用也不可能这么多人推荐、下载。</li><li><strong>AI 助手</strong> 给出的示例用的是 DockerHub 官方的镜像。</li></ul><p>上面说了那么多，好像没有说到<strong>第二板斧</strong>的重点<strong>搜索引擎</strong>，<strong>AI 助手</strong> 给出的结果中，单节点模式看着没什么问题，但是集群模式总感觉少点啥，重点的 <strong>myid</strong> 的处理方式我就没看到。因此，我又用关键词 <strong>StatefulSet 部署 Zookeeper</strong> 在搜索引擎中搜索了一番。</p><p>搜索结果中有两个方向的思路比较有参考价值：</p><ul><li>基于 K8s 官方文档给出的 Zookeeper 部署方案。</li></ul><p>K8s 官网的一个教程案例 <a href=https://kubernetes.io/docs/tutorials/stateful-application/zookeeper/ title="Running ZooKeeper, A Distributed System Coordinator" target=_blank rel="noopener noreferrer">Running ZooKeeper, A Distributed System Coordinator</a>，这个例子看着比较复杂，而且引入了几个新的技术。</p><ul><li>基于 Bitnami 制作的镜像提供的 Zookeeper 集群部署方案</li></ul><p>梳理清楚已经获取的信息，为了快速完成领导交付的任务，今天的验证测试方案顺序如下：</p><ul><li><strong>AI 助手</strong> 提供的单节点部署配置</li><li><strong>AI 助手</strong> 提供的集群模式部署配置</li><li><strong>Bitnami</strong> 提供的集群模式部署方案</li><li>K8s 官网 Zookeeper 部署案例</li></ul><p>因为，单节点部署比较简单。所以，测试问题重点就在于 <strong>AI 助手</strong>和 <strong>Bitnami</strong> 提供的集群模式部署配置是否可行，如果方案可行就没官网案例什么事了，如果不行再去实验 <strong>K8s 官网 Zookeeper 部署案例</strong>，但是说实话我暂时还很不想碰，因为这个案例里有个技术点我压根儿就没听过，真要搞的话又会引入新的问题。</p><h2 id=zookeeper-单节点部署>Zookeeper 单节点部署</h2><p>我觉得 <strong>AI 助手</strong> 返回的单节点的部署方案和配置文件看着还可以没啥问题。但是，也不要直接复制、粘贴，拿来即用。一定要多参考 DockerHub 官网的 <a href=https://hub.docker.com/_/zookeeper title="Zookeeper 相关示例" target=_blank rel="noopener noreferrer">Zookeeper 相关示例</a>，二者相结合，写出来的才是更靠谱的资源清单。</p><h3 id=思路梳理>思路梳理</h3><p>在 K8s 集群上部一套单节点的 Zookeeper 需要的资源清单如下：</p><ul><li><p>PersistentVolumeClaim</p></li><li><p>ConfigMap：zoo.cfg</p></li><li><p>Deployment</p></li><li><p>Cluster Service</p></li><li><p>External Service（可选）</p></li></ul><p>知道了需要完成的任务目标，接下来结合 <strong>AI 助手</strong>给出的配置和官方配置参数，生成一套资源配置清单。</p><p><strong>注意：</strong> 实践证明，<strong>AI 助手</strong> 给出的也只是一个大概，细节还是有很多不足的地方，下面示例中的所有资源配置清单，都是参考官方配置参数和实际使用需求整理的。</p><p>简单说一下修改了哪些内容。</p><ul><li>Zookeeper 版本选择，使用了落后官方最新的稳定版 3.9.0 一个版本的 <strong>3.8.2</strong> 替换 AI 助手给出的配置方案中的 <strong>3.7.0</strong></li><li>增加了 <strong>dataLog</strong> 的配置</li><li>完善了资源限制的配置</li><li>完善了 <strong>zoo.cfg</strong> 的配置</li></ul><h3 id=资源配置清单>资源配置清单</h3><p><strong>如无特殊说明，所有涉及 K8s 的操作都在 Master-0 节点上执行 , 配置文件根目录为 /srv/opsman/k8s-yaml</strong>。</p><ul><li>创建资源清单文件夹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd /srv/opsman/k8s-yaml
</span></span><span style=display:flex><span>mkdir -p zookeeper/single
</span></span><span style=display:flex><span>cd zookeeper/single
</span></span></code></pre></div><ul><li>vi <strong>zookeeper-pvc.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>glusterfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>1Gi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-datalog</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>glusterfs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>2Gi</span>
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 后端存储类使用的 <strong>GlusterFS</strong>。</p></blockquote><ul><li>vi <strong>zookeeper-cm.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>zoo-cfg</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    tickTime=2000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    dataDir=/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    dataLogDir=/datalog
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    clientPort=2181
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    initLimit=10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    syncLimit=5</span>
</span></span></code></pre></div><ul><li>vi <strong>zookeeper-deploy.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>zookeeper:3.8.2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>50m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>500Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#e6db74>&#39;2&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>4000Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-2181</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/conf</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/data</span>
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>datalog</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/datalog</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>zookeeper-data</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>datalog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>zookeeper-datalog</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>items</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>zoo-cfg</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>zoo.cfg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span></code></pre></div><blockquote><p>Deployment 和 Cluster Service 放在了一个配置文件。</p></blockquote><ul><li>vi <strong>zookeeper-external-svc.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-external-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper-external-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-zookeeper-external</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>32181</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><blockquote><p><strong>注意：可选配置项</strong>，如果不需要被 K8s 集群之外的服务访问，则不需要配置。</p></blockquote><h3 id=部署资源>部署资源</h3><ul><li>部署 PersistentVolumeClaim</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-pvc.yaml
</span></span></code></pre></div><ul><li>部署 ConfigMap</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-cm.yaml
</span></span></code></pre></div><ul><li>部署 Deployment</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-deploy.yaml
</span></span></code></pre></div><ul><li>部署 External Service</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-svc.yaml
</span></span></code></pre></div><h3 id=k8s-部署资源验证>K8s 部署资源验证</h3><ul><li>验证 PersistentVolumeClaim</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 single<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pvc -o wide</span>
</span></span><span style=display:flex><span>NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
</span></span><span style=display:flex><span>zookeeper-data      Bound    pvc-371c9406-1757-451a-9c89-bed47ac71dd4   1Gi        RWO            glusterfs      12s   Filesystem
</span></span><span style=display:flex><span>zookeeper-datalog   Bound    pvc-457a134c-0db2-4efc-902c-555daba2057e   2Gi        RWO            glusterfs      11s   Filesystem
</span></span></code></pre></div><ul><li>验证 Deployment</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 single<span style=color:#f92672>]</span><span style=color:#75715e>#  kubectl get deploy -o wide</span>
</span></span><span style=display:flex><span>NAME        READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES            SELECTOR
</span></span><span style=display:flex><span>zookeeper   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           5m1s   zookeeper    zookeeper:3.8.2   app<span style=color:#f92672>=</span>zookeeper
</span></span></code></pre></div><ul><li>验证 Pod</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 single<span style=color:#f92672>]</span><span style=color:#75715e>#  kubectl get pod -o wide</span>
</span></span><span style=display:flex><span>NAME                         READY   STATUS        RESTARTS        AGE     IP             NODE          NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>zookeeper-bcfc6cc5c-bh56m    1/1     Running       <span style=color:#ae81ff>0</span>               54s     10.233.120.8   ks-worker-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ul><li>验证 Service</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 single<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get svc -o wide</span>
</span></span><span style=display:flex><span>NAME                                                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>          AGE    SELECTOR
</span></span><span style=display:flex><span>zookeeper                                                ClusterIP   10.233.58.30    &lt;none&gt;        2181/TCP         59s    app<span style=color:#f92672>=</span>zookeeper
</span></span><span style=display:flex><span>zookeeper-external-svc                                   NodePort    10.233.40.37    &lt;none&gt;        2181:32181/TCP   59s    app<span style=color:#f92672>=</span>zookeeper
</span></span></code></pre></div><h3 id=zookeeper-服务可用性验证>Zookeeper 服务可用性验证</h3><p><strong>在 K8s 集群内部验证</strong>。</p><ul><li>在 K8s 上创建一个 Zookeeper Client Pod 验证</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run zookeeper-client --image<span style=color:#f92672>=</span>zookeeper:3.8.2
</span></span></code></pre></div><ul><li>验证 Zookeeper Server 连通性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 进入 Zookeeper Client 容器内部</span>
</span></span><span style=display:flex><span>kubectl exec -it zookeeper-client -- bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接 Zookeeper Server</span>
</span></span><span style=display:flex><span>bin/zkCli.sh -server 10.233.58.30:2181
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功结果如下</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 single<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it zookeeper-client -- bash</span>
</span></span><span style=display:flex><span>root@zookeeper-client:/apache-zookeeper-3.8.2-bin# bin/zkCli.sh -server 10.233.58.30:2181
</span></span><span style=display:flex><span>Connecting to 10.233.58.30:2181
</span></span><span style=display:flex><span>2023-08-07 07:44:16,110 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:zookeeper.version<span style=color:#f92672>=</span>3.8.2-139d619b58292d7734b4fc83a0f44be4e7b0c986, built on 2023-07-05 19:24 UTC
</span></span><span style=display:flex><span>2023-08-07 07:44:16,117 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:host.name<span style=color:#f92672>=</span>zookeeper-client
</span></span><span style=display:flex><span>2023-08-07 07:44:16,117 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.version<span style=color:#f92672>=</span>11.0.20
</span></span><span style=display:flex><span>2023-08-07 07:44:16,117 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.vendor<span style=color:#f92672>=</span>Eclipse Adoptium
</span></span><span style=display:flex><span>2023-08-07 07:44:16,117 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.home<span style=color:#f92672>=</span>/opt/java/openjdk
</span></span><span style=display:flex><span>2023-08-07 07:44:16,117 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.class.path<span style=color:#f92672>=</span>/apache-zookeeper-3.8.2-bin/bin/......<span style=color:#f92672>(</span>此处有省略<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.library.path<span style=color:#f92672>=</span>/usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.io.tmpdir<span style=color:#f92672>=</span>/tmp
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:java.compiler<span style=color:#f92672>=</span>&lt;NA&gt;
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.name<span style=color:#f92672>=</span>Linux
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.arch<span style=color:#f92672>=</span>amd64
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.version<span style=color:#f92672>=</span>5.10.0-153.12.0.92.oe2203sp2.x86_64
</span></span><span style=display:flex><span>2023-08-07 07:44:16,118 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:user.name<span style=color:#f92672>=</span>root
</span></span><span style=display:flex><span>2023-08-07 07:44:16,119 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:user.home<span style=color:#f92672>=</span>/root
</span></span><span style=display:flex><span>2023-08-07 07:44:16,119 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:user.dir<span style=color:#f92672>=</span>/apache-zookeeper-3.8.2-bin
</span></span><span style=display:flex><span>2023-08-07 07:44:16,119 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.memory.free<span style=color:#f92672>=</span>42MB
</span></span><span style=display:flex><span>2023-08-07 07:44:16,119 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.memory.max<span style=color:#f92672>=</span>256MB
</span></span><span style=display:flex><span>2023-08-07 07:44:16,120 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:os.memory.total<span style=color:#f92672>=</span>48MB
</span></span><span style=display:flex><span>2023-08-07 07:44:16,123 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ZooKeeper@637<span style=color:#f92672>]</span> - Initiating client connection, connectString<span style=color:#f92672>=</span>10.233.58.30:2181 sessionTimeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30000</span> watcher<span style=color:#f92672>=</span>org.apache.zookeeper.ZooKeeperMain$MyWatcher@18bf3d14
</span></span><span style=display:flex><span>2023-08-07 07:44:16,128 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.c.X509Util@78<span style=color:#f92672>]</span> - Setting -D jdk.tls.rejectClientInitiatedRenegotiation<span style=color:#f92672>=</span>true to disable client-initiated TLS renegotiation
</span></span><span style=display:flex><span>2023-08-07 07:44:16,134 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxnSocket@239<span style=color:#f92672>]</span> - jute.maxbuffer value is <span style=color:#ae81ff>1048575</span> Bytes
</span></span><span style=display:flex><span>2023-08-07 07:44:16,143 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxn@1741<span style=color:#f92672>]</span> - zookeeper.request.timeout value is 0. feature enabled<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>Welcome to ZooKeeper!
</span></span><span style=display:flex><span>2023-08-07 07:44:16,171 <span style=color:#f92672>[</span>myid:10.233.58.30:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.58.30:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1177<span style=color:#f92672>]</span> - Opening socket connection to server zookeeper.default.svc.cluster.local/10.233.58.30:2181.
</span></span><span style=display:flex><span>2023-08-07 07:44:16,173 <span style=color:#f92672>[</span>myid:10.233.58.30:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.58.30:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1179<span style=color:#f92672>]</span> - SASL config status: Will not attempt to authenticate using SASL <span style=color:#f92672>(</span>unknown error<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>2023-08-07 07:44:16,185 <span style=color:#f92672>[</span>myid:10.233.58.30:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.58.30:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1011<span style=color:#f92672>]</span> - Socket connection established, initiating session, client: /10.233.118.8:55022, server: zookeeper.default.svc.cluster.local/10.233.58.30:2181
</span></span><span style=display:flex><span>JLine support is enabled
</span></span><span style=display:flex><span>2023-08-07 07:44:16,251 <span style=color:#f92672>[</span>myid:10.233.58.30:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.58.30:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1452<span style=color:#f92672>]</span> - Session establishment complete on server zookeeper.default.svc.cluster.local/10.233.58.30:2181, session id <span style=color:#f92672>=</span> 0x1000178f5af0000, negotiated timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>30000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WATCHER::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WatchedEvent state:SyncConnected type:None path:null
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.58.30:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>创建测试数据，验证服务可用性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.58.30:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span> create /test test-data1
</span></span><span style=display:flex><span>Created /test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.58.30:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 1<span style=color:#f92672>]</span> get /test
</span></span><span style=display:flex><span>test-data1
</span></span></code></pre></div><p><strong>在 K8s 集群外部验证。</strong></p><p><strong>本文直接使用 K8s Master-0 节点安装 Zookeeper 客户端进行测试验证。</strong></p><ul><li>安装 openjdk，仅限于测试验证。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>yum install java-11-openjdk
</span></span></code></pre></div><ul><li>安装 Zookeeper 客户端，到 <a href=https://zookeeper.apache.org/releases.html title="Zookeeper 官网" target=_blank rel="noopener noreferrer">Zookeeper 官网</a>找相应版本的软件包。本文选择 <strong>3.8.2</strong> 作为测试版本。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 下载并解压 Zookeeper（在国内源下载）</span>
</span></span><span style=display:flex><span>wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.8.2/apache-zookeeper-3.8.2-bin.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tar xvf apache-zookeeper-3.8.2-bin.tar.gz
</span></span></code></pre></div><ul><li>验证 Zookeeper Server 连通性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd apache-zookeeper-3.8.2-bin/bin/
</span></span><span style=display:flex><span>./zkCli.sh -server 192.168.9.91:32181
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功结果如下（结果有省略）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 bin<span style=color:#f92672>]</span><span style=color:#75715e># ./zkCli.sh -server 192.168.9.91:32181</span>
</span></span><span style=display:flex><span>/usr/bin/java
</span></span><span style=display:flex><span>Connecting to 192.168.9.91:32181
</span></span><span style=display:flex><span>2023-08-07 15:46:53,156 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:zookeeper.version<span style=color:#f92672>=</span>3.8.2-139d619b58292d7734b4fc83a0f44be4e7b0c986, built on 2023-07-05 19:24 UTC
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WATCHER::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WatchedEvent state:SyncConnected type:None path:null
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>创建测试数据，验证服务可用性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span> create /test2 test2-data1
</span></span><span style=display:flex><span>Created /test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 1<span style=color:#f92672>]</span> get /test2
</span></span><span style=display:flex><span>test2-data1
</span></span></code></pre></div><p>至此，Boss 交代的任务完成了一半，已经实现了单节点 Zookeeper 的部署，并在 K8s 集群内部和外部分别做了连通性、可用性测试。</p><p>但是，时间已超期，已经来到了第二天，所以说啊，对于一个未知的任务，实现起来，根本没有 Boss 想象的那么简单。</p><p>不过，由于完成了单节点的任务，先上交汇报给 Boss，并说明一下实现思路、过程，部署过程中遇到的问题及解决方案（切记不要直接跟 Boss 说这个很难，你预估的时间有问题，那么说纯属找抽）。</p><p>按上面的套路汇报完，得到了 Boss 的理解和认可（Boss 其实还是很好说话的，只要你能以理说服他），让我先把单节点的 Zookeeper 环境交给测试使用，再去继续研究集群模式的部署方案。</p><p>这波操作不仅没有受到批评，还给自己争取了时间，完美！！！</p><h2 id=集群模式-zookeeper-部署>集群模式 Zookeeper 部署</h2><p>单节点部署 Zookeeper 的任务完成以后，接下来开始研究集群模式的 Zookeeper 部署，<strong>AI 助手</strong>给出的默认示例根本就不靠谱，我也懒得再调教他了。</p><p><strong>为什么这么说？</strong></p><p>因为我利用 AI 助手给的方案，利用 DockerHub 提供的 Zookeeper 去尝试在 K8s 集群上部署 Zookeeper 集群，耗时 <strong>2</strong> 天（主要是犯病了，钻了牛角尖，就想搞定它，无奈能力又不够！）</p><p>接下来简单说一下，我被折磨疯了的两天都做了哪些尝试、遇到了哪些问题、有哪些心得体会（逼得我都差点祭出第三板斧了）。</p><ul><li>集群模式的关键解决 myid 和 servers 的配置</li><li>servers 的配置这个没有问题很好解决，可以在配置文件中直接写入或是用 ENV 的方式注入</li><li>myid 是重点，DockHub 镜像仓库中提供的 Zookeeper 镜像，节点 myid 不能动态配置</li><li>在实验中尝试了 <strong>initContainers</strong> 、<strong>SidecarContainer</strong>、ConfigMap 挂载启动脚本等方式，都没有起到效果</li><li>不是说 DockHub 镜像彻底不能用，只是需要进行启动脚本改造，甚至需要重新打 Image，太麻烦了，已经耗时 <strong>2</strong> 天了，不得不暂时放弃</li><li>上面几种尝试以及最后的成品资源配置清单的编写，都是在 KubeSphere 的图形化管理控制台下测试验证的，比命令行界面方便了太多</li><li><strong>心得：</strong> 通往成功的路有千万条，一条不通时可以尝试换条路，<strong>不要死磕到底</strong>。我们的目的是为了解决问题，<strong>能解决问题的办法就是好办法</strong>，钻牛角尖的精神也要分情况</li></ul><p>最终只能另寻出路，好在之前的调研中，已经找到了另外两种可能的解决方案。</p><ul><li>使用 Bitnami 制作的镜像部署 Zookeeper 集群（<strong>最终选择</strong>）。</li><li>Kubernetes 官方文档示例中介绍的方案，该方案使用镜像 <strong>registry.k8s.io/kubernetes-zookeeper:1.0-3.4.10</strong>，使用 <strong>PodDisruptionBudget</strong> 确保服务可用性。</li></ul><p><strong>说一下最终的选型理由</strong>：</p><ul><li><strong>Pod Disruption Budget</strong>，有点复杂不太适合我目前段位。</li></ul><p>Pod Disruption Budget (Pod 干扰 预算) 简称 PDB，Kubernetes version <strong>>= 1.21</strong> 才可以使用 PodDisruptionBudget。PDB 的作用是将限制在同一时间因自愿干扰导致的多副本应用中发生宕机的 Pod 数量。</p><p>具体的知识点，本文不细说了，反正我目前也不打算用了（唉！主要是说不明白难免误人子弟），有兴趣的可以参考官方文档的 <a href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/disruptions/#pod-disruption-budget title="PDB 介绍" target=_blank rel="noopener noreferrer">PDB 介绍</a>和 <a href=https://kubernetes.io/zh-cn/docs/tasks/run-application/configure-pdb/ title="PDB 配置案例" target=_blank rel="noopener noreferrer">PDB 配置案例</a>。</p><ul><li>Bitnami 制作的镜像部署 Zookeeper 集群，该方案网上的参考案例有很多，而且该方案采用 Zookeeper 原生部署方案，没有额外的 K8S 机制，减少了复杂度。<strong>这个也是选择的重点</strong>。</li></ul><p>接下来，我就开始尝试使用 Bitnami 制作的 <strong>Zookeeper</strong> 镜像完成 <strong>Zookeeper</strong> 集群的部署。</p><h3 id=思路梳理-1>思路梳理</h3><p>在 K8s 集群上部一套 Zookeeper 集群需要的资源清单如下：</p><ul><li><p><strong>StatefulSet</strong></p></li><li><p><strong>Headless Service</strong></p></li><li><p>ConfigMap：zoo.cfg（没有使用，所有的配置都使用 ENV 的形式）</p></li><li><p><strong>ConfigMap：setup.sh（启动脚本，计划使用实际没有使用，最终采取了 ENV 和 Command 方式）</strong></p></li><li><p><strong>External Service（可选）</strong></p></li></ul><p><strong>注意：由于本文配置方案没有考虑安全配置仅适用于开发、测试环境。不要把本文的示例直接拿到生产环境使用，必须参考官方配置文档增加相应的 ENV 配置，方可用于生产</strong>。</p><h3 id=资源配置清单-1>资源配置清单</h3><p><strong>如无特殊说明，所有涉及 K8s 的操作都在 Master-0 节点上执行 , 配置文件根目录为 /srv/opsman/k8s-yaml</strong>。</p><ul><li>创建资源清单文件夹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd /srv/opsman/k8s-yaml
</span></span><span style=display:flex><span>mkdir -p zookeeper/cluster
</span></span><span style=display:flex><span>cd zookeeper/cluster
</span></span></code></pre></div><ul><li><strong>vi zookeeper-svc.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># Headless Service，用于 Zookeeper 集群之间相互通讯</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zk-hs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-client</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-follower</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2888</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2888</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-election</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>3888</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>3888</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterIP</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># Client Service，用于 K8S 集群内的应用访问 Zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zk-cs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-client</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span></code></pre></div><ul><li><strong>vi zookeeper-sts.yaml</strong></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>zk-hs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>affinity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>podAntiAffinity</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>labelSelector</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>matchExpressions</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;app&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>                    - <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>topologyKey</span>: <span style=color:#e6db74>&#34;kubernetes.io/hostname&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>bitnami/zookeeper:3.8.2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>bash</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#39;-ec&#39;</span>
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              HOSTNAME=&#34;$(hostname -s)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              if [[ $HOSTNAME =~ (.*)-([0-9]+)$ ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ORD=${BASH_REMATCH[2]}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                export ZOO_SERVER_ID=&#34;$((ORD + 1 ))&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;Failed to get index from hostname $HOST&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              exec /entrypoint.sh /run.sh</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>2Gi</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>50m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>500Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ZOO_ENABLE_AUTH</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;no&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ALLOW_ANONYMOUS_LOGIN</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;yes&#34;</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ZOO_SERVERS</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: &gt;<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                zookeeper-0.zk-hs.default.svc.cluster.local:2888:3888
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                zookeeper-1.zk-hs.default.svc.cluster.local:2888:3888
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                zookeeper-2.zk-hs.ddefault.svc.cluster.local:2888:3888</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>follower</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2888</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>election</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>3888</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>tcpSocket</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>client</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>successThreshold</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>tcpSocket</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>client</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>successThreshold</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/bitnami/zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeClaimTemplates</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>accessModes</span>: [ <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span> ]
</span></span><span style=display:flex><span>        <span style=color:#f92672>storageClassName</span>: <span style=color:#e6db74>&#34;glusterfs&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>2Gi</span>
</span></span></code></pre></div><blockquote><p><strong>说明：</strong></p><ul><li><strong>ENV</strong> 的配置我只用了最基本的，重点就是 <strong>ZOO_SERVERS</strong>，更多参数的用法请参考 <a href=https://hub.docker.com/r/bitnami/zookeeper title="Bitnami 官方文档" target=_blank rel="noopener noreferrer">Bitnami 官方文档</a></li><li><strong>Command</strong> 里直接写了启动命令，也可以做成 ConfigMap 挂载为脚本</li><li><strong>default.svc.cluster.local</strong>，注意 FQDN 只能这么写，不要写成自定义的，哪怕我的集群域名是 <strong>opsman.top</strong>（这个是遗留问题，来不及细看了，回头再说）</li></ul></blockquote><ul><li>vi zookeeper-external-svc.yaml</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#75715e># External Client Service，用于 K8S 集群外部访问 Zookeeper</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>zookeeper-external-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper-external-svc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tcp-zookeeper-external</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>32181</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>zookeeper</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><blockquote><p><strong>注意：可选配置项</strong>，如果不需要被 K8s 集群之外的服务访问，则不需要配置。</p></blockquote><h3 id=部署资源-1>部署资源</h3><ul><li>部署 Cluster 和 Headless Service</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-svc.yaml
</span></span></code></pre></div><ul><li>部署 StatefulSet</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-sts.yaml
</span></span></code></pre></div><ul><li>部署外部 Services</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f zookeeper-external-svc.yaml
</span></span></code></pre></div><h3 id=k8s-部署资源验证-1>K8s 部署资源验证</h3><ul><li>验证 PersistentVolumeClaim</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pvc -o wide</span>
</span></span><span style=display:flex><span>NAME               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE    VOLUMEMODE
</span></span><span style=display:flex><span>data-zookeeper-0   Bound    pvc-342c3869-17ca-40c7-9db0-755d5af0f85f   2Gi        RWO            glusterfs      2m7s   Filesystem
</span></span><span style=display:flex><span>data-zookeeper-1   Bound    pvc-6744813f-0f5b-4138-8ffc-387f63044af3   2Gi        RWO            glusterfs      47s    Filesystem
</span></span><span style=display:flex><span>data-zookeeper-2   Bound    pvc-731edc8d-189a-4601-aa64-a8d6754d93ec   2Gi        RWO            glusterfs      28s    Filesystem
</span></span></code></pre></div><ul><li>验证 StatefulSet</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get sts -o wide</span>
</span></span><span style=display:flex><span>NAME        READY   AGE    CONTAINERS   IMAGES
</span></span><span style=display:flex><span>zookeeper   3/3     2m3s   zookeeper    bitnami/zookeeper:3.8.2
</span></span></code></pre></div><ul><li>验证 Pod</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -o wide</span>
</span></span><span style=display:flex><span>NAME               READY   STATUS    RESTARTS   AGE     IP              NODE          NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>zookeeper-0        1/1     Running   <span style=color:#ae81ff>0</span>          2m42s   10.233.118.45   ks-worker-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>zookeeper-1        1/1     Running   <span style=color:#ae81ff>0</span>          83s     10.233.120.17   ks-worker-1   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>zookeeper-2        1/1     Running   <span style=color:#ae81ff>0</span>          64s     10.233.115.99   ks-worker-0   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ul><li>验证 Service</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get svc -o wide</span>
</span></span><span style=display:flex><span>NAME                                                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                      AGE     SELECTOR
</span></span><span style=display:flex><span>zk-cs                                                    ClusterIP   10.233.43.229   &lt;none&gt;        2181/TCP                     3m58s   app<span style=color:#f92672>=</span>zookeeper
</span></span><span style=display:flex><span>zk-hs                                                    ClusterIP   None            &lt;none&gt;        2181/TCP,2888/TCP,3888/TCP   3m58s   app<span style=color:#f92672>=</span>zookeeper
</span></span><span style=display:flex><span>zookeeper-external-svc                                   NodePort    10.233.45.5     &lt;none&gt;        2181:32181/TCP               10s     app<span style=color:#f92672>=</span>zookeeper
</span></span></code></pre></div><h3 id=zookeeper-集群状态验证>Zookeeper 集群状态验证</h3><ul><li>验证 StatefulSet 创建的 Pod 配置的主机名</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># for i in 0 1 2; do kubectl exec zookeeper-$i -- hostname; done</span>
</span></span><span style=display:flex><span>zookeeper-0
</span></span><span style=display:flex><span>zookeeper-1
</span></span><span style=display:flex><span>zookeeper-2
</span></span></code></pre></div><ul><li>验证 StatefulSet 创建的 Pod 配置的完全限定域名（Fully Qualified Domain Name，FQDN）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># for i in 0 1 2; do kubectl exec zookeeper-$i -- hostname -f; done</span>
</span></span><span style=display:flex><span>zookeeper-0.zk-hs.default.svc.cluster.local
</span></span><span style=display:flex><span>zookeeper-1.zk-hs.default.svc.cluster.local
</span></span><span style=display:flex><span>zookeeper-2.zk-hs.default.svc.cluster.local
</span></span></code></pre></div><ul><li>验证每个 Zookeeper 服务的 myid 文件内容</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># for i in 0 1 2; do echo &#34;myid zookeeper-$i&#34;;kubectl exec zookeeper-$i -- cat /bitnami/zookeeper/data/myid; done</span>
</span></span><span style=display:flex><span>myid zookeeper-0
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>myid zookeeper-1
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>myid zookeeper-2
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><ul><li>验证 Zookeeper 生成的配置文件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it zookeeper-0 --  cat /opt/bitnami/zookeeper/conf/zoo.cfg | grep -vE &#34;^#|^$&#34;</span>
</span></span><span style=display:flex><span>tickTime<span style=color:#f92672>=</span><span style=color:#ae81ff>2000</span>
</span></span><span style=display:flex><span>initLimit<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>syncLimit<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>dataDir<span style=color:#f92672>=</span>/bitnami/zookeeper/data
</span></span><span style=display:flex><span>clientPort<span style=color:#f92672>=</span><span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>maxClientCnxns<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>autopurge.snapRetainCount<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>autopurge.purgeInterval<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>preAllocSize<span style=color:#f92672>=</span><span style=color:#ae81ff>65536</span>
</span></span><span style=display:flex><span>snapCount<span style=color:#f92672>=</span><span style=color:#ae81ff>100000</span>
</span></span><span style=display:flex><span>maxCnxns<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>reconfigEnabled<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>quorumListenOnAllIPs<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>4lw.commands.whitelist<span style=color:#f92672>=</span>srvr, mntr
</span></span><span style=display:flex><span>maxSessionTimeout<span style=color:#f92672>=</span><span style=color:#ae81ff>40000</span>
</span></span><span style=display:flex><span>admin.serverPort<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>admin.enableServer<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>server.1<span style=color:#f92672>=</span>zookeeper-0.zk-hs.default.svc.cluster.local:2888:3888;<span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>server.2<span style=color:#f92672>=</span>zookeeper-1.zk-hs.default.svc.cluster.local:2888:3888;<span style=color:#ae81ff>2181</span>
</span></span><span style=display:flex><span>server.3<span style=color:#f92672>=</span>zookeeper-2.zk-hs.default.svc.cluster.local:2888:3888;<span style=color:#ae81ff>2181</span>
</span></span></code></pre></div><ul><li>验证集群状态</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># for i in 0 1 2; do echo -e &#34;# myid zookeeper-$i \n&#34;;kubectl exec zookeeper-$i -- /opt/bitnami/zookeeper/bin/zkServer.sh status;echo -e &#34;\n&#34;; done</span>
</span></span><span style=display:flex><span><span style=color:#75715e># myid zookeeper-0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/opt/bitnami/java/bin/java
</span></span><span style=display:flex><span>ZooKeeper JMX enabled by default
</span></span><span style=display:flex><span>Using config: /opt/bitnami/zookeeper/bin/../conf/zoo.cfg
</span></span><span style=display:flex><span>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span style=display:flex><span>Mode: leader
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># myid zookeeper-1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/opt/bitnami/java/bin/java
</span></span><span style=display:flex><span>ZooKeeper JMX enabled by default
</span></span><span style=display:flex><span>Using config: /opt/bitnami/zookeeper/bin/../conf/zoo.cfg
</span></span><span style=display:flex><span>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span style=display:flex><span>Mode: follower
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># myid zookeeper-2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/opt/bitnami/java/bin/java
</span></span><span style=display:flex><span>ZooKeeper JMX enabled by default
</span></span><span style=display:flex><span>Using config: /opt/bitnami/zookeeper/bin/../conf/zoo.cfg
</span></span><span style=display:flex><span>Client port found: 2181. Client address: localhost. Client SSL: false.
</span></span><span style=display:flex><span>Mode: follower
</span></span></code></pre></div><h3 id=zookeeper-服务可用性验证-1>Zookeeper 服务可用性验证</h3><p><strong>在 K8s 集群内部验证</strong>。</p><ul><li>在 K8s 上创建一个 Zookeeper Client Pod 验证（单节点验证时创建过，不需要再创建了）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl run zookeeper-client --image<span style=color:#f92672>=</span>zookeeper:3.8.2
</span></span></code></pre></div><ul><li>验证 Zookeeper Server 连通性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 进入 Zookeeper Client 容器内部</span>
</span></span><span style=display:flex><span>kubectl exec -it zookeeper-client -- bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接 Zookeeper Server（ 10.233.43.229 是 Cluster Service 的 IP）</span>
</span></span><span style=display:flex><span>bin/zkCli.sh -server 10.233.43.229:2181
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功结果如下(内容有省略)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 cluster<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it zookeeper-client -- bash</span>
</span></span><span style=display:flex><span>root@zookeeper-client:/apache-zookeeper-3.8.2-bin# bin/zkCli.sh -server 10.233.43.229:2181
</span></span><span style=display:flex><span>Connecting to 10.233.43.229:2181
</span></span><span style=display:flex><span>2023-08-08 10:08:40,864 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:zookeeper.version<span style=color:#f92672>=</span>3.8.2-139d619b58292d7734b4fc83a0f44be4e7b0c986, built on 2023-07-05 19:24 UTC
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>2023-08-08 10:08:40,872 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ZooKeeper@637<span style=color:#f92672>]</span> - Initiating client connection, connectString<span style=color:#f92672>=</span>10.233.43.229:2181 sessionTimeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30000</span> watcher<span style=color:#f92672>=</span>org.apache.zookeeper.ZooKeeperMain$MyWatcher@18bf3d14
</span></span><span style=display:flex><span>2023-08-08 10:08:40,886 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.c.X509Util@78<span style=color:#f92672>]</span> - Setting -D jdk.tls.rejectClientInitiatedRenegotiation<span style=color:#f92672>=</span>true to disable client-initiated TLS renegotiation
</span></span><span style=display:flex><span>2023-08-08 10:08:40,892 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxnSocket@239<span style=color:#f92672>]</span> - jute.maxbuffer value is <span style=color:#ae81ff>1048575</span> Bytes
</span></span><span style=display:flex><span>2023-08-08 10:08:40,903 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxn@1741<span style=color:#f92672>]</span> - zookeeper.request.timeout value is 0. feature enabled<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>Welcome to ZooKeeper!
</span></span><span style=display:flex><span>2023-08-08 10:08:40,920 <span style=color:#f92672>[</span>myid:10.233.43.229:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.43.229:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1177<span style=color:#f92672>]</span> - Opening socket connection to server zk-cs.default.svc.cluster.local/10.233.43.229:2181.
</span></span><span style=display:flex><span>2023-08-08 10:08:40,923 <span style=color:#f92672>[</span>myid:10.233.43.229:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.43.229:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1179<span style=color:#f92672>]</span> - SASL config status: Will not attempt to authenticate using SASL <span style=color:#f92672>(</span>unknown error<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>JLine support is enabled
</span></span><span style=display:flex><span>2023-08-08 10:08:40,948 <span style=color:#f92672>[</span>myid:10.233.43.229:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.43.229:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1011<span style=color:#f92672>]</span> - Socket connection established, initiating session, client: /10.233.118.8:38050, server: zk-cs.default.svc.cluster.local/10.233.43.229:2181
</span></span><span style=display:flex><span>2023-08-08 10:08:41,064 <span style=color:#f92672>[</span>myid:10.233.43.229:2181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>10.233.43.229:2181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1452<span style=color:#f92672>]</span> - Session establishment complete on server zk-cs.default.svc.cluster.local/10.233.43.229:2181, session id <span style=color:#f92672>=</span> 0x10007253d840000, negotiated timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>30000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WATCHER::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WatchedEvent state:SyncConnected type:None path:null
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.43.229:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>创建测试数据，验证服务可用性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.43.229:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span> create /test test-data1
</span></span><span style=display:flex><span>Created /test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 10.233.43.229:2181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 1<span style=color:#f92672>]</span> get /test
</span></span><span style=display:flex><span>test-data1
</span></span></code></pre></div><p><strong>在 K8s 集群外部验证。</strong></p><ul><li>验证 Zookeeper Server 连通性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 进入 Zookeeper 安装包的 bin 目录</span>
</span></span><span style=display:flex><span>cd apache-zookeeper-3.8.2-bin/bin/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接 Zookeeper Server（ 192.168.9.91 是 K8S Master-0 节点的 IP，32181 是 External Service 定义的 NodePort 端口号）</span>
</span></span><span style=display:flex><span>./zkCli.sh -server 192.168.9.91:32181
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 成功结果如下（结果有省略）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-master-0 bin<span style=color:#f92672>]</span><span style=color:#75715e># ./zkCli.sh -server 192.168.9.91:32181</span>
</span></span><span style=display:flex><span>/usr/bin/java
</span></span><span style=display:flex><span>Connecting to 192.168.9.91:32181
</span></span><span style=display:flex><span>2023-08-08 18:13:52,650 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.Environment@98<span style=color:#f92672>]</span> - Client environment:zookeeper.version<span style=color:#f92672>=</span>3.8.2-139d619b58292d7734b4fc83a0f44be4e7b0c986, built on 2023-07-05 19:24 UTC
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>2023-08-08 18:13:52,660 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ZooKeeper@637<span style=color:#f92672>]</span> - Initiating client connection, connectString<span style=color:#f92672>=</span>192.168.9.91:32181 sessionTimeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30000</span> watcher<span style=color:#f92672>=</span>org.apache.zookeeper.ZooKeeperMain$MyWatcher@5c072e3f
</span></span><span style=display:flex><span>2023-08-08 18:13:52,666 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.c.X509Util@78<span style=color:#f92672>]</span> - Setting -D jdk.tls.rejectClientInitiatedRenegotiation<span style=color:#f92672>=</span>true to disable client-initiated TLS renegotiation
</span></span><span style=display:flex><span>2023-08-08 18:13:52,671 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxnSocket@239<span style=color:#f92672>]</span> - jute.maxbuffer value is <span style=color:#ae81ff>1048575</span> Bytes
</span></span><span style=display:flex><span>2023-08-08 18:13:52,686 <span style=color:#f92672>[</span>myid:<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main:o.a.z.ClientCnxn@1741<span style=color:#f92672>]</span> - zookeeper.request.timeout value is 0. feature enabled<span style=color:#f92672>=</span>false
</span></span><span style=display:flex><span>Welcome to ZooKeeper!
</span></span><span style=display:flex><span>2023-08-08 18:13:52,708 <span style=color:#f92672>[</span>myid:192.168.9.91:32181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>192.168.9.91:32181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1177<span style=color:#f92672>]</span> - Opening socket connection to server ks-master-0/192.168.9.91:32181.
</span></span><span style=display:flex><span>2023-08-08 18:13:52,709 <span style=color:#f92672>[</span>myid:192.168.9.91:32181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>192.168.9.91:32181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1179<span style=color:#f92672>]</span> - SASL config status: Will not attempt to authenticate using SASL <span style=color:#f92672>(</span>unknown error<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>JLine support is enabled
</span></span><span style=display:flex><span>2023-08-08 18:13:52,721 <span style=color:#f92672>[</span>myid:192.168.9.91:32181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>192.168.9.91:32181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1011<span style=color:#f92672>]</span> - Socket connection established, initiating session, client: /192.168.9.91:45004, server: ks-master-0/192.168.9.91:32181
</span></span><span style=display:flex><span>2023-08-08 18:13:52,776 <span style=color:#f92672>[</span>myid:192.168.9.91:32181<span style=color:#f92672>]</span> - INFO  <span style=color:#f92672>[</span>main-SendThread<span style=color:#f92672>(</span>192.168.9.91:32181<span style=color:#f92672>)</span>:o.a.z.ClientCnxn$SendThread@1452<span style=color:#f92672>]</span> - Session establishment complete on server ks-master-0/192.168.9.91:32181, session id <span style=color:#f92672>=</span> 0x10007253d840001, negotiated timeout <span style=color:#f92672>=</span> <span style=color:#ae81ff>30000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WATCHER::
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WatchedEvent state:SyncConnected type:None path:null
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>创建测试数据，验证服务可用性</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建测试数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 0<span style=color:#f92672>]</span> create /test2 test2-data1
</span></span><span style=display:flex><span>Created /test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 读取测试数据（读取了 2次 测试数据）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 1<span style=color:#f92672>]</span> get /test
</span></span><span style=display:flex><span>test-data1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>zk: 192.168.9.91:32181<span style=color:#f92672>(</span>CONNECTED<span style=color:#f92672>)</span> 2<span style=color:#f92672>]</span> get /test2
</span></span><span style=display:flex><span>test2-data1
</span></span></code></pre></div><p>至此，实现了 Zookeeper 集群模式部署，并在 K8S 集群内部和外部分别做了连通性、可用性测试。</p><h3 id=在-kubesphere-管理控制台验证>在 KubeSphere 管理控制台验证</h3><p>看一看 Zookeeper 相关资源在 KubeSphere 管理控制台中展示效果。</p><ul><li>StatefulSet</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-sts-zk-res-status.png alt></p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-sts-zk-monitors.png alt></p><ul><li>Pods</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-pods-zk-0-res-status.png alt></p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-pods-zk-0-monitors.png alt></p><ul><li>Service</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-zk-hs-res-status.png alt></p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-zk-cs-res-status.png alt></p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-zk-exts-res-status.png alt></p><h2 id=总结>总结</h2><p>本文详细介绍了 Zookeeper 单节点和集群模式在基于 KubeSphere 部署的 K8s 集群上的安装部署、测试验证的过程。具体涉及的内容总结如下：</p><ul><li>如何利用 <strong>AI 助手</strong> 和 搜索引擎辅助完成运维工作。</li><li>如何利用 DockerHub 官方提供的 Zookeeper 镜像，在 K8s 集群上部署单节点 Zookeeper 服务并验证测试。</li><li>如何利用 Bitnami 提供的 Zookeeper 镜像，在 K8s 集群上部署 Zookeeper 集群服务并验证测试。</li><li>介绍了一种使用 <strong>PodDisruptionBudget</strong> 部署 Zookeeper 集群的示例，但是并未实际验证。</li></ul><p><strong>本文的配置方案可直接用于开发测试环境，对于生产环境也有一定的借鉴意义。</strong></p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&text=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&title=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fzookeeper-on-kubesphere%2f&t=KubeSphere%20%e9%83%a8%e7%bd%b2%20Zookeeper%20%e5%ae%9e%e6%88%98%e6%95%99%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#前言>前言</a><ul><li><a href=#知识点>知识点</a></li><li><a href=#实战服务器配置架构-11-复刻小规模生产环境配置略有不同>实战服务器配置(架构 1:1 复刻小规模生产环境，配置略有不同)</a></li></ul></li><li><a href=#实战环境涉及软件版本信息>实战环境涉及软件版本信息</a></li><li><a href=#简介>简介</a></li><li><a href=#2-任务实现思路分析>2. 任务实现思路分析</a><ul><li><a href=#第一板斧ai-助手>第一板斧——AI 助手</a></li><li><a href=#第二板斧搜索引擎>第二板斧——搜索引擎</a></li></ul></li><li><a href=#zookeeper-单节点部署>Zookeeper 单节点部署</a><ul><li><a href=#思路梳理>思路梳理</a></li><li><a href=#资源配置清单>资源配置清单</a></li><li><a href=#部署资源>部署资源</a></li><li><a href=#k8s-部署资源验证>K8s 部署资源验证</a></li><li><a href=#zookeeper-服务可用性验证>Zookeeper 服务可用性验证</a></li></ul></li><li><a href=#集群模式-zookeeper-部署>集群模式 Zookeeper 部署</a><ul><li><a href=#思路梳理-1>思路梳理</a></li><li><a href=#资源配置清单-1>资源配置清单</a></li><li><a href=#部署资源-1>部署资源</a></li><li><a href=#k8s-部署资源验证-1>K8s 部署资源验证</a></li><li><a href=#zookeeper-集群状态验证>Zookeeper 集群状态验证</a></li><li><a href=#zookeeper-服务可用性验证-1>Zookeeper 服务可用性验证</a></li><li><a href=#在-kubesphere-管理控制台验证>在 KubeSphere 管理控制台验证</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>