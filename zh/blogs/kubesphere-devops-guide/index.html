<!doctype html><html lang=en-US><head><meta charset=utf-8><title>59 张高清大图，带你实战入门 KubeSphere DevOps</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文档旨在成为您的技术指南，逐步引导您开启 KubeSphere 的 DevOps 之旅。"><meta name=keywords content="KubeSphere,DevOps"><meta property="og:type" content="article"><meta property="og:title" content="59 张高清大图，带你实战入门 KubeSphere DevOps"><meta property="og:description" content="本文档旨在成为您的技术指南，逐步引导您开启 KubeSphere 的 DevOps 之旅。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-devops-java-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-devops-guide/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-devops-java-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-devops-guide/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-devops-guide/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>59 张高清大图，带你实战入门 KubeSphere DevOps</span></div><div class='main-div middle-div'><div class=author>运维有术</div><span class=date>发布于：2024-08-21</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>59 张高清大图，带你实战入门 KubeSphere DevOps</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&text=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&title=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&t=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><p>KubeSphere 基于 <a href=https://jenkins.io/ target=_blank rel="noopener noreferrer">Jenkins</a> 的 DevOps 系统是专为 Kubernetes 中的 CI/CD 工作流设计的，它提供了一站式的解决方案，帮助开发和运维团队用非常简单的方式构建、测试和发布应用到 Kubernetes。它还具有插件管理、<a href=https://kubesphere.com.cn/docs/v3.3/project-user-guide/image-builder/binary-to-image/ target=_blank rel="noopener noreferrer">Binary-to-Image (B2I)</a>、<a href=https://kubesphere.com.cn/docs/v3.3/project-user-guide/image-builder/source-to-image/ target=_blank rel="noopener noreferrer">Source-to-Image (S2I)</a>、代码依赖缓存、代码质量分析、流水线日志等功能。</p><p>DevOps 系统为用户提供了一个自动化的环境，应用可以自动发布到同一个平台。它还兼容第三方私有镜像仓库（如 Harbor）和代码库（如 GitLab/GitHub/SVN/BitBucket）。它为用户提供了全面的、可视化的 CI/CD 流水线，打造了极佳的用户体验，而且这种兼容性强的流水线能力在离线环境中非常有用。</p><p>本文档旨在成为您的技术指南，逐步引导您开启 KubeSphere 的 DevOps 之旅。我们将深入探索如何开启 DevOps 插件，如何规划设计一个完整的 DevOps 流水线并编写 Jenkins 流水线配置文件。通过本文档的实战案例，您将能够掌握从理论到实践的全过程，为您的项目带来持续集成和持续部署的自动化体验。</p><ul><li>您将学习如何在 KubeSphere 上开启 DevOps 插件。</li><li>通过实际案例，规划设计一个高效、自动化的 DevOps 流水线。</li><li>我们将一起编写 Jenkinsfile，定义代码拉取、测试、编译、构建和部署的流程。</li><li>最终，我们将完成一个实战项目，将理论知识转化为实际操作，让您对 KubeSphere DevOps 的应用有更深的理解。</li></ul><p>随着 <strong>59 张高清大图</strong>的辅助，本文档将确保您在每一个步骤中都能获得清晰的指导和深刻的见解。无论您是 DevOps 的新手还是希望在 KubeSphere 上实现 DevOps 流程的老手，本文档都将为您提供宝贵的知识和实践技巧。</p><p><strong>实战服务器配置(架构 1:1 复刻小规模生产环境，配置略有不同)</strong></p><table><thead><tr><th style=text-align:center>主机名</th><th style=text-align:center>IP</th><th style=text-align:center>CPU</th><th style=text-align:center>内存</th><th style=text-align:center>系统盘</th><th style=text-align:center>数据盘</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center>ksp-registry</td><td style=text-align:center>192.168.9.90</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>200</td><td style=text-align:center>Harbor 镜像仓库</td></tr><tr><td style=text-align:center>ksp-control-1</td><td style=text-align:center>192.168.9.91</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-control-plane</td></tr><tr><td style=text-align:center>ksp-control-2</td><td style=text-align:center>192.168.9.92</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-control-plane</td></tr><tr><td style=text-align:center>ksp-control-3</td><td style=text-align:center>192.168.9.93</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>KubeSphere/k8s-control-plane</td></tr><tr><td style=text-align:center>ksp-worker-1</td><td style=text-align:center>192.168.9.94</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker/CI</td></tr><tr><td style=text-align:center>ksp-worker-2</td><td style=text-align:center>192.168.9.95</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker</td></tr><tr><td style=text-align:center>ksp-worker-3</td><td style=text-align:center>192.168.9.96</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker</td></tr><tr><td style=text-align:center>ksp-storage-1</td><td style=text-align:center>192.168.9.97</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>400+</td><td style=text-align:center>ElasticSearch/Longhorn/Ceph/NFS</td></tr><tr><td style=text-align:center>ksp-storage-2</td><td style=text-align:center>192.168.9.98</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>300+</td><td style=text-align:center>ElasticSearch/Longhorn/Ceph</td></tr><tr><td style=text-align:center>ksp-storage-3</td><td style=text-align:center>192.168.9.99</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>300+</td><td style=text-align:center>ElasticSearch/Longhorn/Ceph</td></tr><tr><td style=text-align:center>ksp-gpu-worker-1</td><td style=text-align:center>192.168.9.101</td><td style=text-align:center>4</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker(GPU NVIDIA Tesla M40 24G)</td></tr><tr><td style=text-align:center>ksp-gpu-worker-2</td><td style=text-align:center>192.168.9.102</td><td style=text-align:center>4</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>k8s-worker(GPU NVIDIA Tesla P100 16G)</td></tr><tr><td style=text-align:center>ksp-gateway-1</td><td style=text-align:center>192.168.9.103</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>40</td><td style=text-align:center></td><td style=text-align:center>自建应用服务代理网关/VIP：192.168.9.100</td></tr><tr><td style=text-align:center>ksp-gateway-2</td><td style=text-align:center>192.168.9.104</td><td style=text-align:center>2</td><td style=text-align:center>4</td><td style=text-align:center>40</td><td style=text-align:center></td><td style=text-align:center>自建应用服务代理网关/VIP：192.168.9.100</td></tr><tr><td style=text-align:center>ksp-mid</td><td style=text-align:center>192.168.9.105</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>部署在 k8s 集群之外的服务节点（Gitlab 等）</td></tr><tr><td style=text-align:center>合计</td><td style=text-align:center>15</td><td style=text-align:center>68</td><td style=text-align:center>152</td><td style=text-align:center>600</td><td style=text-align:center>2100+</td><td style=text-align:center></td></tr></tbody></table><p><strong>实战环境涉及软件版本信息</strong></p><ul><li>操作系统：<strong>openEuler 22.03 LTS SP3 x86_64</strong></li><li>KubeSphere：<strong>v3.4.1</strong></li><li>Kubernetes：<strong>v1.28.8</strong></li><li>KubeKey: <strong>v3.1.1</strong></li><li>ks-jenkins： <strong>v3.4.0-2.319.3-1</strong></li></ul><h2 id=1-开启-devops-组件>1. 开启 DevOps 组件</h2><h3 id=11-前提说明>1.1 前提说明</h3><p>现在，新部署的 KubeSphere v3.4.1 开启 DevOps 插件会有问题，具体描述见 <a href=https://ask.kubesphere.io/forum/d/23239-kubesphere-jing-xiang-gou-jian-qi-s2ifu-wu-zheng-shu-guo-qi-x509wen-ti target=_blank rel="noopener noreferrer">KubeSphere 镜像构建器（S2I）服务证书过期(x509)问题</a>。</p><p>在开启之前我们先修复存在的问题。</p><ul><li>清理开启失败的残留 release（适用于开启过 DevOps 且安装失败）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>helm -n kubesphere-devops-system delete devops
</span></span></code></pre></div><ul><li>执行下面命令，获取 ks-installer 镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n kubesphere-system get deployments ks-installer --no-headers -o custom-columns<span style=color:#f92672>=</span>:.spec.template.spec.containers<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.image
</span></span><span style=display:flex><span>kubesphere/ks-installer:v3.4.1
</span></span></code></pre></div><ul><li>在获取的镜像最后加上 ‘-patch.0’ ，执行下面命令更新 ks-installer 镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n kubesphere-system patch deployments ks-installer --type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;json&#39;</span> -p<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/image&#34;, &#34;value&#34;: &#34;kubesphere/ks-installer:v3.4.1-patch.0&#34;}]&#39;</span>
</span></span></code></pre></div><p>更新镜像后 <code>ks-installer</code> 会<strong>自动重启</strong>并根据 <code>ClusterConfiguration</code> 里的配置安装各个开启的未安装的模块。</p><h3 id=12-开启-devops-组件配置>1.2 开启 DevOps 组件配置</h3><ul><li><p>以<code>admin</code>用户登录 KubeSphere 控制台，点击左上角的「平台管理」，选择「集群管理」。</p></li><li><p>点击 「定制资源定义」，在搜索栏中输入 <code>clusterconfiguration</code>，点击搜索结果查看其详细页面。</p><blockquote><p>定制资源定义（CRD）允许用户在不新增 API 服务器的情况下创建一种新的资源类型，用户可以像使用其他 Kubernetes 原生对象一样使用这些定制资源。</p></blockquote></li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-crd-clusterconfiguration.png alt=ksp-v341-crd-clusterconfiguration></p><ul><li>在<strong>自定义资源</strong>中，点击 <code>ks-installer</code>右侧的三个竖点 ，选择<strong>编辑 YAML</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-crd-ks-install.png alt=ksp-v341-crd-ks-install></p><ul><li>在该 YAML 文件中，搜索 <code>devops</code>，将 <code>enabled</code> 的 <code>false</code> 改为 <code>true</code>。完成后，点击右下角的<strong>确定</strong>，保存配置，保存之后 KubeSphere 会自动安装 devops 插件。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>devops</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jenkinsCpuLim</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jenkinsCpuReq</span>: <span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jenkinsMemoryLim</span>: <span style=color:#ae81ff>4Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jenkinsMemoryReq</span>: <span style=color:#ae81ff>4Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jenkinsVolumeSize</span>: <span style=color:#ae81ff>16Gi</span>
</span></span></code></pre></div><blockquote><p><strong>注意</strong>：上面的参数配置是默认值，<strong>仅适用于测试环境</strong>，生产环境建议根据规模调大参数值。</p></blockquote><h3 id=13-验证>1.3 验证</h3><ul><li>在 kubectl 中执行以下命令检查安装过程。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl logs -n kubesphere-system <span style=color:#66d9ef>$(</span>kubectl get pod -n kubesphere-system -l <span style=color:#e6db74>&#39;app in (ks-install, ks-installer)&#39;</span> -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#66d9ef>)</span> -f
</span></span></code></pre></div><p><strong>正确执行后，输出结果如下 :</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>PLAY RECAP *********************************************************************</span>
</span></span><span style=display:flex><span><span style=color:#f92672>localhost                  </span>: <span style=color:#ae81ff>ok=26   changed=14   unreachable=0    failed=0    skipped=21   rescued=0    ignored=0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Start installing monitoring</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Start installing multicluster</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Start installing openpitrix</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Start installing network</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Start installing devops</span>
</span></span><span style=display:flex><span><span style=color:#75715e>**************************************************</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Waiting for all tasks to be completed ...</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>task network status is successful  (1/5)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>task openpitrix status is successful  (2/5)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>task multicluster status is successful  (3/5)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>task monitoring status is successful  (4/5)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>task devops status is successful  (5/5)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>**************************************************</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>Collecting installation results ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###              Welcome to KubeSphere!           ###</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span>...<span style=color:#ae81ff>...</span>
</span></span></code></pre></div><ul><li>检查 Kubernetes 集群 <code>kubesphere-devops-system</code> 命名空间的资源运行状态。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl get all -n kubesphere-devops-system
</span></span><span style=display:flex><span>NAME                                    READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>pod/devops-28717020-l769w               0/1     Completed   <span style=color:#ae81ff>0</span>          14m
</span></span><span style=display:flex><span>pod/devops-apiserver-858fdcc978-hwxbf   1/1     Running     <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>pod/devops-controller-989995d9f-wc6hs   1/1     Running     <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>pod/devops-jenkins-df4d7cd4b-pkmhn      1/1     Running     <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>pod/s2ioperator-0                       1/1     Running     <span style=color:#ae81ff>0</span>          14m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
</span></span><span style=display:flex><span>service/devops-apiserver              ClusterIP   10.233.42.51    &lt;none&gt;        9090/TCP       15m
</span></span><span style=display:flex><span>service/devops-jenkins                NodePort    10.233.48.8     &lt;none&gt;        80:30180/TCP   15m
</span></span><span style=display:flex><span>service/devops-jenkins-agent          ClusterIP   10.233.3.210    &lt;none&gt;        50000/TCP      15m
</span></span><span style=display:flex><span>service/s2ioperator-metrics-service   ClusterIP   10.233.60.160   &lt;none&gt;        8080/TCP       15m
</span></span><span style=display:flex><span>service/s2ioperator-trigger-service   ClusterIP   10.233.13.255   &lt;none&gt;        8081/TCP       15m
</span></span><span style=display:flex><span>service/webhook-server-service        ClusterIP   10.233.1.199    &lt;none&gt;        443/TCP        15m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/devops-apiserver    1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           15m
</span></span><span style=display:flex><span>deployment.apps/devops-controller   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           15m
</span></span><span style=display:flex><span>deployment.apps/devops-jenkins      1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           15m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                          DESIRED   CURRENT   READY   AGE
</span></span><span style=display:flex><span>replicaset.apps/devops-apiserver-858fdcc978   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       15m
</span></span><span style=display:flex><span>replicaset.apps/devops-controller-989995d9f   <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       15m
</span></span><span style=display:flex><span>replicaset.apps/devops-jenkins-df4d7cd4b      <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       15m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                           READY   AGE
</span></span><span style=display:flex><span>statefulset.apps/s2ioperator   1/1     45m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                   SCHEDULE       SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span style=display:flex><span>cronjob.batch/devops   0/30 * * * *   False     <span style=color:#ae81ff>0</span>        14m             15m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                        COMPLETIONS   DURATION   AGE
</span></span><span style=display:flex><span>job.batch/devops-28717020   1/1           15s        14m
</span></span></code></pre></div><blockquote><p><strong>注意</strong>：实际部署中会增加 Minio 、OpenLDAP，还有一组 Argo CD 的服务组件。</p></blockquote><ul><li>KubeSphere 管理控制台验证。</li></ul><p>登录KubeSphere 管理控制台，依次点击「平台管理」->「集群管理」->「系统组件」，检查 <strong>DevOps</strong> 标签页中的所有组件是否都处于<strong>健康</strong>状态。如果是，组件安装成功。</p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-components-devops.png alt=ksp-v341-components-devops></p><h2 id=2-创建和管理-devops-项目>2. 创建和管理 DevOps 项目</h2><p>本文仅演示，如何创建单管理员用户实现企业空间中创建项目和管理 DevOps 项目，更复杂、更贴近生产环境的多用户模式请参考官方文档 <a href=https://kubesphere.io/zh/docs/v3.4/quick-start/create-workspace-and-project/ target=_blank rel="noopener noreferrer">创建企业空间、项目、用户和平台角色</a></p><h3 id=21-创建用户>2.1 创建用户</h3><p>安装 KubeSphere 之后，您需要向平台添加具有不同角色的用户，以便他们可以针对自己授权的资源在不同的层级进行工作。一开始，系统默认只有一个用户 <code>admin</code>，具有 <code>platform-admin</code> 角色。在本步骤中，我将创建一个示例用户 <code>opsxlab</code>。</p><ul><li>以 <code>admin</code> 身份使用默认帐户和密码 (<code>admin/P@88w0rd</code>) 登录 Web 控制台。</li><li>点击左上角的<strong>平台管理</strong>，然后选择<strong>访问控制</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-dashboard-access-workspaces.png alt=ksp-v341-dashboard-access-workspaces></p><ul><li>在<strong>用户</strong>中，点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-accounts.png alt=ksp-v341-access-accounts></p><ul><li>在弹出的对话框中，填写所有必要信息（带有*标记）。在<strong>平台角色</strong>下拉列表，选择<strong>platform-self-provisioner</strong>。点击<strong>确定</strong>。新创建的用户将显示在<strong>用户</strong>页面。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-accounts-devops.png alt=ksp-v341-access-accounts-devops></p><ul><li>在<strong>用户</strong>页面，查看创建的用户。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-accounts-devops-complete.png alt=ksp-v341-access-accounts-devops-complete></p><h3 id=22-创建企业空间>2.2 创建企业空间</h3><p>企业空间是 KubeSphere 多租户系统的基础，是管理项目、DevOps 项目和组织成员的基本逻辑单元。</p><ul><li>在左侧导航栏，选择<strong>企业空间</strong>。企业空间列表中已列出默认企业空间 <strong>system-workspace</strong>，该企业空间包含所有系统项目。其中运行着与系统相关的组件和服务，您无法删除该企业空间。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-workspaces.png alt></p><ul><li>在企业空间列表页面，点击<strong>创建</strong>，输入企业空间的名称（例如 <strong>opsxlab</strong>），并将用户 <code>opsxlab</code> 设置为企业空间管理员。完成后，点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-workspaces-opsxlab.png alt></p><ul><li>点击「创建」返回。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-access-workspaces-opsxlab-complete.png alt></p><ul><li>登出控制台，然后以 <code>opsxlab</code> 身份重新登录，验证是否能成功登录。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-login-opsxlab.png alt></p><ul><li>成功登录后，显示「企业空间」页面。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab.png alt></p><h3 id=23-创建项目>2.3 创建项目</h3><p>在此步骤中，您需要使用在上一步骤中创建的帐户 <code>opsxlab</code> 来创建项目。KubeSphere 中的项目与 Kubernetes 中的命名空间相同，为资源提供了虚拟隔离。</p><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere Web 控制台，点击企业空间 <code>opsxlab</code>，进入企业空间概览。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-overview.png alt></p><ul><li>在<strong>项目</strong>中，点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects.png alt></p><ul><li>输入项目名称（例如 <code>opsxlab</code>），点击<strong>确定</strong>。您还可以为项目添加别名和描述。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-create.png alt></p><ul><li>完成创建</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-complete.png alt></p><ul><li><p>在<strong>项目</strong>中，点击刚创建的项目查看其详情页面。</p></li><li><p>在项目的<strong>概览</strong>页面，默认情况下未设置项目配额。您可以点击<strong>编辑配额</strong>并根据需要指定<strong>资源请求和限制</strong>（例如：CPU 和内存的限制分别设为 1 Core 和 1000 Gi）。</p></li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-projects-opsxlab-overview.png alt></p><h3 id=24-创建-devops-项目>2.4 创建 DevOps 项目</h3><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere 控制台，转到 <strong>DevOps 项目</strong>，然后点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-devops.png alt></p><ul><li>输入 DevOps 项目名称（例如 <code>opsxlab-devops</code>），然后点击<strong>确定</strong>，也可以为该项目添加别名和描述。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-devops-create.png alt></p><ul><li>DevOps 项目创建后，会显示在下图所示的列表中。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-devops-complete.png alt></p><ul><li>点击刚创建的 DevOps 项目查看其详细页面。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops.png alt></p><h2 id=3-devops-流水线规划设计>3. DevOps 流水线规划设计</h2><p>KubeSphere 官方提供的示例项目中的 <code>Jenkinsfile-online</code> 流水线设计更贴近生产环境，流程比较复杂，小白理解起来可能会有困难。为了让小白快速上手 KubeSphere DevOps 的功能，我设计了一个简化版的流程。</p><p>本文我们基于 Jenkins 模拟生产环境应用发布的流程，实现如下的 DevOps 流水线任务：</p><ul><li><strong>阶段 1：Checkout SCM</strong>：从 Git 仓库检出源代码，本文使用 Gitee 作为示例，GitHub 或是自建 GitLab 流程类似。</li><li><strong>阶段 2：单元测试</strong>：待该测试通过后才会进行下一阶段。</li><li><strong>阶段 3：编译 Java 源码</strong>：使用 Maven 构建 Jar 包。</li><li><strong>阶段 4：构建并推送 tag 镜像</strong>：根据运行流水线时输入的分支来构建镜像，并将标签为 <code>TAG_NAME</code> 的镜像推送至 Harbor 镜像仓库。</li><li><strong>阶段 5：推送最新镜像</strong>：将 <code>TAG_NAME</code> 标签的镜像标记为 <code>latest</code>，并推送至 Harbor 镜像仓库。</li><li><strong>阶段 6：部署至生产环境</strong>：将已发布的 <code>TAG_NAME</code> 标签镜像部署到生产环境，此阶段需要审核。</li></ul><h2 id=4-实现流水线的准备工作>4. 实现流水线的准备工作</h2><ul><li>设置 CI 专用节点用于运行流水线</li><li>准备一个 Gitee 帐户（用于存放代码，也可以使用自己搭建的 GitLab 或是 GitHub）</li><li>准备一个 Harbor 镜像仓库，并创建账户（用于存放构建的镜像，也可以使用 DockerHub 或是其他镜像仓库）</li><li>创建 kubeconfig 凭证</li><li>创建一个 DevOps 项目（使用上文创建的 <code>opsxlab-devops</code>）</li></ul><h3 id=41-为依赖项缓存设置-ci-专用节点>4.1 为依赖项缓存设置 CI 专用节点</h3><p>通常情况下，构建应用程序的过程中需要拉取不同的依赖项。这可能会导致某些问题，例如拉取时间长和网络不稳定，这会进一步导致构建失败。</p><p>我们可以配置一个节点或一组节点，专门用于持续集成 (CI)。这些 CI 节点可以通过使用缓存来加快构建过程。为我们流水线提供更可靠和稳定的环境。</p><p>执行下面的命令，标记节点 <code>ksp-worker-1</code> 作为 CI 节点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label nodes ksp-worker-1 node-role.kubernetes.io/worker<span style=color:#f92672>=</span>ci --overwrite
</span></span></code></pre></div><h3 id=42-创建-gitee-仓库访问凭证>4.2 创建 Gitee 仓库访问凭证</h3><p><strong>Step1：在 Gitee 上执行下面的任务。</strong></p><ul><li>登录 Gitee 创建私人令牌，点击「生成新令牌」。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-gitee-personal-access-tokens.png alt></p><ul><li>填写描述信息，并设置最小权限。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-gitee-personal-access-tokens-new.png alt></p><ul><li>点击「提交」,弹出「私人令牌生成提示」，请妥善保存生成的令牌。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-gitee-personal-access-tokens-copy.png alt></p><ul><li>点击「确认并关闭」，返回私人令牌管理页面。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//opsxlab:ksp-v341-devops-gitee-personal-access-tokens-opsxlab-gitee.png alt></p><p><strong>Step2：在 KubeSphere 控制台上执行下面的任务。</strong></p><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere 控制台。</li><li>进入您的 DevOps 项目，在左侧导航栏，选择<strong>DevOps 项目设置 > 凭证</strong>。</li><li>在右侧的<strong>凭证</strong>区域，点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-credentials.png alt></p><ul><li>在弹出的<strong>创建凭证</strong>对话框，设置以下参数：<ul><li>名称：填写凭证名称 <code>opsxlab-gitee</code></li><li>类型：选择<strong>用户名和密码</strong></li><li>用户名：输入您的 Gitee 账户名称 <code>opsxlab</code></li><li>密码/令牌：输入您在 Gitee 中创建的私人令牌</li></ul></li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-credentials-opsxlab-gitee.png alt></p><h3 id=43-创建-harbor-仓库访问凭证>4.3 创建 Harbor 仓库访问凭证</h3><p><strong>Step1：在 Harbor 上执行下面的任务。</strong></p><ul><li>登录 Harbor，选择「系统管理」 -> 「机器人账户」，点击「添加机器人账户」</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-robot-accounts.png alt></p><ul><li>填写基本信息，名称输入 <code>devops</code>，系统会<strong>自动增加 robot-</strong> 的前缀，过期时间选择，永不过期。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-accounts-devops-base.png alt></p><blockquote><p><strong>说明：</strong> 您的机器人名称前缀可能是 <code>robot$</code>，请到「配置管理」-「系统设置」中修改。</p></blockquote><ul><li>设置系统权限，考虑<strong>最小化原则</strong>，<strong>不选择</strong>任何系统权限。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-accounts-devops-permission-null.png alt></p><ul><li>设置项目权限，为了顺利完成后面的演示。这里，我选择了「覆盖全部项目」，并「全选」所有权限（生产环境请考虑<strong>最小化原则</strong>，按需分配权限），点击「完成」按钮。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-accounts-devops-project-permission-all.png alt></p><ul><li>弹出创建成功页面，复制令牌内容，点击「导出到文件中」，页面会自动关闭。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-accounts-devops-%20complete.png alt></p><p><strong>Step2：在 KubeSphere 控制台上执行下面的任务。</strong></p><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere 控制台。</li><li>进入您的 DevOps 项目，在左侧导航栏，选择<strong>DevOps 项目设置 > 凭证</strong>。</li><li>在右侧的<strong>凭证</strong>区域，点击<strong>创建</strong>。</li><li>在弹出的<strong>创建凭证</strong>对话框，设置以下参数：<ul><li>名称：填写凭证名称 <code>opsxlab-harbor</code></li><li>类型：选择<strong>用户名和密码</strong>。</li><li>用户名：输入您的 Harbor 机器人名称 <code>robot-devops</code></li><li>密码/令牌：输入您的 Harbor 机器人令牌</li></ul></li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-credentials-opsxlab-harbor.png alt></p><h3 id=44-创建-kubeconfig-凭证>4.4 创建 kubeconfig 凭证</h3><p>接下来，我们创建 kubeconfig 凭证。</p><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere 控制台。</li><li>进入您的 DevOps 项目，在左侧导航栏，选择<strong>DevOps 项目设置 > 凭证</strong>。</li><li>在右侧的<strong>凭证</strong>区域，点击<strong>创建</strong>。</li><li>在弹出的<strong>创建凭证</strong>对话框，设置以下参数：<ul><li>名称：设置凭证名称，例如 <code>opsxlab-kubeconfig</code></li><li>类型：选择<strong>kubeconfig</strong></li><li>内容：系统自动获取当前 Kubernetes 集群的 kubeconfig 文件内容，并自动填充该字段，您无须做任何更改。但是访问其他集群时，您可能需要更改 kubeconfig</li></ul></li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-credentials-opsxlab-kubeconfig.png alt></p><h3 id=45-凭证列表>4.5 凭证列表</h3><p>创建完成的所有凭证列表如下所示：</p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-credentials-opsxlab-complete.png alt></p><h2 id=5-devops-流水线实战>5. DevOps 流水线实战</h2><h3 id=51-在-gitee-仓库中-fork-测试项目>5.1 在 Gitee 仓库中 Fork 测试项目</h3><ul><li>登录 Gitee， Fork KubeSphere 官方提供的 GitHub 上的测试项目 <strong>devops-maven-sample</strong> 至您的 Gitee 个人帐户。</li></ul><p>项目 URL 为 <code>https://github.com/kubesphere/devops-maven-sample</code> ，操作过程参考如下：</p><p>在 Gitee 个人主页，点击「右上角的加号」，选择「从 GitHub/GitLab 导入仓库」。</p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-gitee-import.png alt></p><p>仓库类型选择<strong>私有</strong>，并填写其它信息，点击「导入」。</p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-import-devops-maven-sample.png alt></p><p>成功导入后的内容如下：</p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-maven-sample.png alt></p><h3 id=52-新增-jenkinsfile>5.2 新增 Jenkinsfile</h3><p>根据流水线规划设计，直接在 <code>Master</code> 分支新建一个 <code>Jenkinsfile-sample</code> 实现简化版流水线。</p><p><strong>说明：</strong> 实际使用中，本文示例的流水线不会直接到代码仓库拉取 <code>Jenkinsfile-sample</code> 文件。将该文件存入代码仓库的 <code>master</code> 分支，是为了实现版本管理和后续的实验。</p><ul><li>在您自己的 Gitee 仓库 <strong>devops-maven-sample</strong> 中的 <code>master</code> 分支，点击右上角的<strong>加号按钮</strong>，点击「新建文件」。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-devops-maven-sample-create-file.png alt></p><ul><li>需要填写的信息如下图：</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-devops-maven-sample-Jenkinsfile-sample.png alt></p><ul><li>文本框内流水线核心内容如下：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>pipeline {</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>agent {</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>node {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>label &#39;maven&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>parameters {</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>string(name:&#39;BRANCH_NAME&#39;,defaultValue</span>: <span style=color:#e6db74>&#39;master&#39;</span>,<span style=color:#ae81ff>description:&#39;&#39;)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>string(name:&#39;TAG_NAME&#39;,defaultValue</span>: <span style=color:#e6db74>&#39;&#39;</span>,<span style=color:#ae81ff>description:&#39;&#39;)</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>environment {</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>DOCKER_CREDENTIAL_ID = &#39;opsxlab-harbor&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>GITHUB_CREDENTIAL_ID = &#39;opsxlab-gitee&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>KUBECONFIG_CREDENTIAL_ID = &#39;opsxlab-kubeconfig&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>REGISTRY = &#39;registry.opsxlab.cn:8443&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>DOCKERHUB_NAMESPACE = &#39;opsxlab&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>GITHUB_ACCOUNT = &#39;opsxlab&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>APP_NAME = &#39;devops-maven-sample&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>GIT_REPOSITORY_URL = &#39;https://gitee.com&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>stages {</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage(&#39;拉取代码&#39;) {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps {</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>git(url</span>: <span style=color:#e6db74>&#34;${GIT_REPOSITORY_URL}/${GITHUB_ACCOUNT}/${APP_NAME}.git&#34;</span><span style=color:#f92672>, credentialsId</span>: <span style=color:#e6db74>&#34;${GITHUB_CREDENTIAL_ID}&#34;</span><span style=color:#f92672>, branch</span>: <span style=color:#e6db74>&#34;$BRANCH_NAME&#34;</span><span style=color:#f92672>, changelog: true, poll</span>: <span style=color:#66d9ef>false</span><span style=color:#ae81ff>)</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage (&#39;编译测试&#39;) {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps {</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>container (&#39;maven&#39;) {</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>sh &#39;mvn clean test&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage (&#39;编译构建&#39;) {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps {</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>container (&#39;maven&#39;) {</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>sh &#39;mvn clean package -DskipTests&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage (&#39;制作并推送镜像&#39;) {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps {</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>container (&#39;maven&#39;) {</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>withCredentials([usernamePassword(passwordVariable : &#39;DOCKER_PASSWORD&#39;, usernameVariable : &#39;DOCKER_USERNAME&#39;, credentialsId </span>: <span style=color:#e6db74>&#34;$DOCKER_CREDENTIAL_ID&#34;</span> ,<span style=color:#ae81ff>)]) {</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>sh &#39;echo &#34;$DOCKER_PASSWORD&#34; | podman login $REGISTRY -u &#34;$DOCKER_USERNAME&#34; --password-stdin&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>sh &#39;podman build -f Dockerfile-online -t $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:$TAG_NAME .&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>sh &#39;podman push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:$TAG_NAME&#39;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage(&#39;推送 latest 标签&#39;){</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>when{</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>branch &#39;master&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps{</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>container (&#39;maven&#39;) {</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>sh &#39;podman tag  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:$TAG_NAME $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>sh &#39;podman push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>stage(&#39;部署到 k8s Prod 集群&#39;) {</span>
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>when{</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>branch &#39;master&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>steps {</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>input(id: &#39;deploy-to-dev&#39;, message</span>: <span style=color:#e6db74>&#39;deploy to K8s Prod?&#39;</span><span style=color:#ae81ff>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>container (&#39;maven&#39;) {</span>
</span></span><span style=display:flex><span>          <span style=color:#ae81ff>withCredentials([</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>kubeconfigFile(credentialsId: env.KUBECONFIG_CREDENTIAL_ID, variable</span>: <span style=color:#e6db74>&#39;KUBECONFIG&#39;</span><span style=color:#ae81ff>)]) {</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>sh &#39;envsubst &lt; deploy/prod-all-in-one/devops-sample.yaml | kubectl apply -f -&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>重要变量说明：</strong></p><table><thead><tr><th style=text-align:left>条目</th><th style=text-align:center>值</th><th style=text-align:left>描述信息</th></tr></thead><tbody><tr><td style=text-align:left>DOCKER_CREDENTIAL_ID</td><td style=text-align:center>opsxlab-harbor</td><td style=text-align:left>您在 KubeSphere 中为 Harbor（DockerHub） 帐户设置的<strong>名称</strong>，用于访问 Harbor （DockerHub） 仓库。</td></tr><tr><td style=text-align:left>GITHUB_CREDENTIAL_ID</td><td style=text-align:center>opsxlab-gitee</td><td style=text-align:left>您在 KubeSphere 中为 Gitee （GitHub）帐户设置的<strong>名称</strong>，用于访问 Gitee （GitHub）仓库。</td></tr><tr><td style=text-align:left>KUBECONFIG_CREDENTIAL_ID</td><td style=text-align:center>opsxlab-kubeconfig</td><td style=text-align:left>您在 KubeSphere 中为 kubeconfig 设置的<strong>名称</strong>，用于访问运行中的 Kubernetes 集群。</td></tr><tr><td style=text-align:left>REGISTRY</td><td style=text-align:center>docker.io</td><td style=text-align:left>默认为 <code>docker.io</code>，用作推送镜像的地址。</td></tr><tr><td style=text-align:left>DOCKERHUB_NAMESPACE</td><td style=text-align:center>opsxlab</td><td style=text-align:left>请替换为您的 Harbor（DockerHub） 的命名空间，一般为帐户名，也可以替换为该帐户下的项目名称。</td></tr><tr><td style=text-align:left>GITHUB_ACCOUNT</td><td style=text-align:center>opsxlab</td><td style=text-align:left>请替换为您的 Gitee （GitHub）帐户名。例如，如果您的 GitHub 地址是 <code>https://github.com/kubesphere/</code>，则您的 GitHub 帐户名为 <code>kubesphere</code>，也可以替换为该帐户下的 Organization 名称。</td></tr><tr><td style=text-align:left>APP_NAME</td><td style=text-align:center>devops-maven-sample</td><td style=text-align:left>应用名称，对应 Gitee （GitHub）上的项目仓库名称。</td></tr><tr><td style=text-align:left>GIT_REPOSITORY_URL</td><td style=text-align:center><a href=https://gitee.com target=_blank rel="noopener noreferrer">https://gitee.com</a></td><td style=text-align:left>Git 仓库服务器地址，本文使用 <a href=https://gitee.com target=_blank rel="noopener noreferrer">https://gitee.com</a></td></tr></tbody></table><ul><li>编辑内容后，点击页面底部的 <strong>提交</strong>，更新 <code>master</code> 分支中的文件。</li></ul><h3 id=53-修改-dockerfile-online>5.3 修改 Dockerfile-online</h3><p>Dockerfile 中使用的基础镜像为 DockerHub 上的 <code>java:8u92-jre-alpine</code>，网络受限的用户可以提前拉取该镜像到本地镜像仓库，并修改 Dockerfile 文件。</p><ul><li>在您自己的 Gitee 仓库 <strong>devops-maven-sample</strong> 中的 <code>master</code> 分支，点击根目录中的文件 <code>Dockerfile-online</code>。</li><li>点击右侧的编辑按钮，编辑自定义配置。</li><li>修改后的最终内容如下</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>FROM registry.opsxlab.cn:8443/library/java:8u92-jre-alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>WORKDIR /home</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>COPY target/*.jar /home</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>ENTRYPOINT java -jar *.jar</span>
</span></span></code></pre></div><ul><li>编辑内容后，点击页面底部的 <strong>提交</strong>，更新 <code>Master</code> 分支中的文件。</li></ul><h3 id=54-创建项目>5.4 创建项目</h3><p>接下来我们在 KubeSphere 上创建一个项目 <code>kubesphere-sample-prod</code>，代表生产环境。待流水线成功运行，将在这个项目中自动创建应用程序的相关部署 (Deployment) 和服务 (Service)。</p><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere。在您创建 DevOps 项目的企业空间中创建项目 <code>kubesphere-sample-prod</code>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-projects-kubesphere-sample-prod.png alt></p><ul><li>项目创建后，会显示在项目列表中。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-workspaces-opsxlab-procects-list.png alt></p><h3 id=55-创建流水线>5.5 创建流水线</h3><ul><li>以 <code>opsxlab</code> 身份登录 KubeSphere。转到 DevOps 项目 <code>opsxlab-devops</code>，点击<strong>创建</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-create.png alt></p><ul><li>在弹出的对话框中，填入基本信息，将其命名为 <code>jenkinsfile-sample</code> 并在<strong>流水线类别</strong>下拉列表中选择<strong>流水线</strong>。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-pipelines-jenkinsfile-sample.png alt></p><ul><li>点击「下一步」，在<strong>高级设置</strong>中，所有配置项使用默认值。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-pipelines-jenkinsfile-sample-advanced.png alt></p><ul><li>点击「创建」，完成创建并返回流水线列表。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-list.png alt></p><h3 id=56-运行流水线>5.6 运行流水线</h3><ul><li>流水线创建后，点击该流水线名称进入其详情页面。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline.png alt></p><blockquote><p><strong>备注:</strong> 流水线详情页显示<strong>同步状态</strong>，即 KubeSphere 和 Jenkins 的同步结果。若同步成功，您会看到<strong>成功</strong>图标中打上绿色的对号。</p></blockquote><ul><li>点击「编辑 Jenkinsfile」，输入 Gitee 仓库 <strong>devops-maven-sample</strong> 中<code>Jenkinsfile-sample</code> 文件的内容，点击「确定」。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-Jenkinsfile.png alt></p><ul><li>点击「运行记录」，再点击「流水线配置」，刷新流水线内容。图形化显示流水线配置。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-graph.png alt></p><ul><li>点击「运行」，在弹出的「设置参数」窗口，输入<strong>TAG_NAME</strong> 的值 <strong>v0.0.1</strong>，<strong>BRANCH_NAME</strong> 参数使用默认值 <code>master</code>，点击「确定」。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-run.png alt=ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-run></p><blockquote><p><strong>说明：</strong> 第一次运行时，可能不会弹出<strong>设置参数</strong>窗口，请立即点击「运行记录」，停止对应的任务后。再次点击「运行」。</p></blockquote><ul><li>稍等片刻，没有异常时，会以图形化展示完整的流水线流程及任务执行进度。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-run-activity.png alt></p><ul><li>流水线在 <code>部署到 K8s Prod 集群</code> 阶段暂停，您需要手动点击绿色的 <strong>Proceed</strong> 按钮，<strong>继续</strong>流水线任务。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-run-complete.png alt></p><p><strong>特殊说明：</strong></p><ul><li>在开发或生产环境中，可能需要具有更高权限的人员（例如版本管理员）来审核流水线、镜像以及代码分析结果。他们有权决定流水线是否能进入下一阶段。</li><li>在 Jenkinsfile 中，您可以使用 <code>input</code> 来指定由谁审核流水线。如果您想指定一个用户（例如 <code>project-admin</code>）来审核，您可以在 Jenkinsfile 中添加一个字段。</li><li>在 KubeSphere 3.4 中，如果不指定审核员，那么能够运行流水线的帐户也能够继续或终止该流水线。如果指定审核员，流水线创建者或者您指定的审核员账户均有权限继续或终止流水线。</li><li>本文示例没有增加额外的审核员，直接使用创建流水线的账户继续执行流水线任务。</li></ul><h3 id=57-检查流水线状态>5.7 检查流水线状态</h3><ul><li>在<strong>运行日志</strong>中，您可以查看流水线的运行状态。请注意，流水线在刚创建后将继续初始化几分钟。示例流水线有六个阶段，它们已在 <code>Jenkinsfile-sample</code>中单独定义。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-task-status.png alt></p><ul><li>点击每一个阶段名称，比如<strong>编译构建</strong>。可以查看该阶段的详细运行日志。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-task-status-stage.png alt></p><ul><li>点击右上角的<strong>查看完整日志</strong>来查看流水线完整的运行日志。您可以看到流水线的动态日志输出，包括可能导致流水线无法运行的错误。对于每个阶段，您都可以点击该阶段来查看其日志，而且可以将日志下载到本地计算机进行进一步分析（图略）。</li><li>流水线的每一次运行，在「运行记录」中都会有完整的记录，如下所示。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-devops-pipelines-jenkinsfile-sample-pipeline-run-logs.png alt></p><h3 id=58-验证结果>5.8 验证结果</h3><ul><li>流水线成功运行后，会自动推送 Docker 镜像并在 K8s 集群中部署服务。</li><li>按照 Jenkinsfile 中的定义，通过流水线构建的 Docker 镜像已成功推送到 Harbor 镜像仓库。在 Harbor 镜像仓库中，您会看到带有标签 <code>v0.0.1和 latest</code> 的镜像。</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-harbor-devops-maven-sample-artifacts-v001.png alt></p><ul><li>示例应用程序将部署到 <code>kubesphere-sample-prod</code>项目，并创建相应的部署和服务。转到这个项目，预期结果如下所示：</li></ul><table><thead><tr><th style=text-align:left>环境</th><th style=text-align:left>URL</th><th style=text-align:left>命名空间</th><th style=text-align:left>部署</th><th style=text-align:left>服务</th></tr></thead><tbody><tr><td style=text-align:left>Production</td><td style=text-align:left><code>http://{$NodeIP}:{$30961}</code></td><td style=text-align:left>kubesphere-sample-prod</td><td style=text-align:left>ks-sample</td><td style=text-align:left>ks-sample</td></tr></tbody></table><ul><li>查看部署（Deployment）</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-kubesphere-sample-prod-deployments-ks-sample.png alt></p><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-kubesphere-sample-prod-deployments-ks-sample-resource-status.png alt></p><ul><li>查看服务（ Service）</li></ul><p><img src=https://opsxlab-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-devops-opsxlab-kubesphere-sample-prod-services-ks-sample-resource-status.png alt></p><h3 id=59-访问示例服务>5.9 访问示例服务</h3><ul><li>在 K8s 控制节点，使用 <strong>kubectl</strong> 执行以下命令，获取 ks-sample 服务的 NodePort</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get svc -n kubesphere-sample-prod
</span></span><span style=display:flex><span>NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>          AGE
</span></span><span style=display:flex><span>ks-sample   NodePort   10.233.10.213   &lt;none&gt;        8080:30961/TCP   1h
</span></span></code></pre></div><ul><li>使用 <code>curl</code> 访问 {$NodeIP}:{$NodePort}。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl 192.168.9.91:30961
</span></span><span style=display:flex><span>Really appreciate your star, that<span style=color:#960050;background-color:#1e0010>&#39;</span>s the power of our life.
</span></span></code></pre></div><p><strong>免责声明：</strong></p><ul><li>笔者水平有限，尽管经过多次验证和检查，尽力确保内容的准确性，<strong>但仍可能存在疏漏之处</strong>。敬请业界专家大佬不吝指教。</li><li>本文所述内容仅通过实战环境验证测试，读者可学习、借鉴，但<strong>严禁直接用于生产环境</strong>。<strong>由此引发的任何问题，作者概不负责</strong>！</li></ul></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&text=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&title=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-guide%2f&t=59%20%e5%bc%a0%e9%ab%98%e6%b8%85%e5%a4%a7%e5%9b%be%ef%bc%8c%e5%b8%a6%e4%bd%a0%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8%20KubeSphere%20DevOps" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#1-开启-devops-组件>1. 开启 DevOps 组件</a><ul><li><a href=#11-前提说明>1.1 前提说明</a></li><li><a href=#12-开启-devops-组件配置>1.2 开启 DevOps 组件配置</a></li><li><a href=#13-验证>1.3 验证</a></li></ul></li><li><a href=#2-创建和管理-devops-项目>2. 创建和管理 DevOps 项目</a><ul><li><a href=#21-创建用户>2.1 创建用户</a></li><li><a href=#22-创建企业空间>2.2 创建企业空间</a></li><li><a href=#23-创建项目>2.3 创建项目</a></li><li><a href=#24-创建-devops-项目>2.4 创建 DevOps 项目</a></li></ul></li><li><a href=#3-devops-流水线规划设计>3. DevOps 流水线规划设计</a></li><li><a href=#4-实现流水线的准备工作>4. 实现流水线的准备工作</a><ul><li><a href=#41-为依赖项缓存设置-ci-专用节点>4.1 为依赖项缓存设置 CI 专用节点</a></li><li><a href=#42-创建-gitee-仓库访问凭证>4.2 创建 Gitee 仓库访问凭证</a></li><li><a href=#43-创建-harbor-仓库访问凭证>4.3 创建 Harbor 仓库访问凭证</a></li><li><a href=#44-创建-kubeconfig-凭证>4.4 创建 kubeconfig 凭证</a></li><li><a href=#45-凭证列表>4.5 凭证列表</a></li></ul></li><li><a href=#5-devops-流水线实战>5. DevOps 流水线实战</a><ul><li><a href=#51-在-gitee-仓库中-fork-测试项目>5.1 在 Gitee 仓库中 Fork 测试项目</a></li><li><a href=#52-新增-jenkinsfile>5.2 新增 Jenkinsfile</a></li><li><a href=#53-修改-dockerfile-online>5.3 修改 Dockerfile-online</a></li><li><a href=#54-创建项目>5.4 创建项目</a></li><li><a href=#55-创建流水线>5.5 创建流水线</a></li><li><a href=#56-运行流水线>5.6 运行流水线</a></li><li><a href=#57-检查流水线状态>5.7 检查流水线状态</a></li><li><a href=#58-验证结果>5.8 验证结果</a></li><li><a href=#59-访问示例服务>5.9 访问示例服务</a></li></ul></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>