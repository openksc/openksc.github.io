<!doctype html><html lang=en-US><head><meta charset=utf-8><title>基于 KubeSphere 的开源微服务开发平台 Pig 最佳实践</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文主要描写了使用 KubeSphere 这款容器云平台和 Pig 这款开源微服务开发平台来解决微服务系统部署、监控的复杂问题。"><meta name=keywords content="Kubernetes,KubeSphere,Pig,微服务"><meta property="og:type" content="article"><meta property="og:title" content="基于 KubeSphere 的开源微服务开发平台 Pig 最佳实践"><meta property="og:description" content="本文主要描写了使用 KubeSphere 这款容器云平台和 Pig 这款开源微服务开发平台来解决微服务系统部署、监控的复杂问题。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-pig-practice-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-pig-practice/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-pig-practice-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-pig-practice/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-pig-practice/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>基于 KubeSphere 的开源微服务开发平台 Pig 最佳实践</span></div><div class='main-div middle-div'><div class=author>何昌涛</div><span class=date>发布于：2022-10-25</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>基于 KubeSphere 的开源微服务开发平台 Pig 最佳实践</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&text=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&title=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&t=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><blockquote><p>作者：何昌涛，北京北大英华科技有限公司高级 Java 工程师，云原生爱好者。</p></blockquote><h2 id=前言>前言</h2><p>近年来，为了满足越来越复杂的业务需求，我们从传统单体架构系统升级为微服务架构，就是把一个大型应用程序分割成可以独立部署的小型服务，每个服务之间都是松耦合的，通过 RPC 或者是 Rest 协议来进行通信，可以按照业务领域来划分成独立的单元。但是微服务系统相对于以往的单体系统更为复杂，当业务增加时，服务也将越来越多，服务的频繁部署、监控将变得复杂起来，尤其在上了 K8s 以后会更加复杂。那么有没有一款全栈的容器云平台来帮我们解决这些问题哩？那当然是有的，下面我们一起来揭秘一下吧。</p><h2 id=介绍>介绍</h2><h3 id=kubesphere>KubeSphere</h3><p>KubeSphere 是在 Kubernetes 之上构建的开源容器平台，提供全栈的 IT 自动化运维的能力，简化企业的 DevOps 工作流。</p><h3 id=pig>Pig</h3><p><a href=https://gitee.com/log4j/pig target=_blank rel="noopener noreferrer">Pig</a> 是一个基于 Spring Boot 2.7、 Spring Cloud 2021 & Alibaba、 SAS OAuth2 的开源微服务开发平台，也是微服务最佳实践。在国内拥有大量拥护者，同时也有商业版本提供技术支持。</p><h2 id=环境搭建>环境搭建</h2><ul><li>K8s 容器化环境一套，并部署完 KubeSphere v3.3.0 版本，启用 DevOps 插件。</li><li>GitLab 代码仓库管理开源系统一套。</li><li>Harbor 容器镜像开源系统一套。</li><li>SonarQube 开源自动代码审查工具一套。</li><li>一个更易于构建云原生应用的动态服务发现、配置管理和服务管理的 Nacos 开源平台一套（可选，Pig 已提供 Naocs 服务，即 Register 服务）。</li><li>高性能的 key-value 数据库 Redis（3.2 +）一套（Pig 需要）。</li><li>关系型开源数据库管理系统 MySQL 一套（Pig 需要）。</li><li>高性能对象存储 Minio 一套（Pig 中文件上传需要，可选）。或者阿里云、华为云、腾讯对象存储也可。</li></ul><h2 id=架构设计>架构设计</h2><h3 id=kubesphere-架构>KubeSphere 架构</h3><p>KubeSphere 将前端与后端分开，实现了面向云原生的设计，后端的各个功能组件可通过 REST API 对接外部系统。KubeSphere 无底层的基础设施依赖，可以运行在任何 Kubernetes、私有云、公有云、VM 或物理环境（BM）之上。 此外，它可以部署在任何 Kubernetes 发行版上。如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f23add71-0796-4c31-9a87-7de57dc08851.png alt></p><blockquote><p>该图来自 KubeSphere 官网架构说明。</p></blockquote><h3 id=pig-架构>Pig 架构</h3><p>Pig 平台设计灵活可扩展、可移植、可应对高并发需求。同时兼顾本地化、私有云、公有云部署，支持 SaaS 模式应用。如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/faba1b41-e6b1-459b-8e79-dd0fe8917cbf.png alt></p><blockquote><p>该图来自 Pig 白皮书中的基础架构图。</p></blockquote><h3 id=整体架构图>整体架构图</h3><p>其实就是将原架构加上一层 Ingress, 在 KubeSphere 中对应的是应用路由（Ingress 路由规则）和项目网关（Ingress Controller）。如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a9416be1-90cc-4bf1-aa63-139a3cb0c929.png alt></p><h3 id=整体容器化部署流程图>整体容器化部署流程图</h3><p>运维人员可通过 KubeSphere 来管理服务，也可以利用 KubeSphere 中的 Jenkins 来发布制品。如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/20d39dca-bc13-423c-9ef2-05687c510c33.png alt></p><h2 id=部署过程>部署过程</h2><p>分别创建两条流水线，一条用于构建 Pig 后端 Java 代码，另外一条用于构建基于 Vue 的 Pig-ui 前端代码。</p><h3 id=创建企业空间>创建企业空间</h3><p>为项目创建一个名称为 pig-workspace 的企业空间 , 企业空间是一个组织您的项目和 DevOps 项目、管理资源访问权限以及在团队内部共享资源等的逻辑单元，可以作为团队工作的独立工作空间。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/e0aa9fa6-efb8-497a-b6c9-dd39bafb7522.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/abf5e6fb-61a2-4f85-897b-57d0f8ad5ca7.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/2e078216-6117-4e90-b97d-43c9e7773485.png alt></p><h3 id=创建-devops-项目>创建 DevOps 项目</h3><p>DevOps 项目是一个独立的命名空间，其中定义了一组流水线。用户可以按照自己的方式对流水线进行分组（例如：项目类型、组织类型）。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/56f5580a-e6d7-4e4f-b7b6-f66c343fced8.png alt></p><h3 id=创建项目>创建项目</h3><p>项目用于对资源进行分组管理和控制不同用户的资源管理权限。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/0bf17611-db4f-4a3a-a5de-453836c74116.png alt></p><h3 id=部署-mysql>部署 MySQL</h3><ol><li>进入应用商店，在应用分类中选择数据库和缓存，找到 MySQL。如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8eea9d55-9f67-4fbe-a48b-80853c16ada2.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/c1751e21-80be-4c9f-83be-53999d59a7a4.png alt></p><ol start=2><li>在基本信息中，填写应用名称 pig-MySQL, 并选择位置，进行下一步。如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8f677cee-3502-4cc5-90ac-d6dc7c31505e.png alt></p><ol start=3><li>在应用配置中，编辑 yaml 文件 , 将镜像改为 MySQL/MySQL-server:8.0.30，将密码设置为 root。如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/de473208-c31f-4311-8aec-7b40375c1268.png alt></p><blockquote><p>MySQL 镜像采用 pig 项目 db 下 Dockerfile 中的版本，也可自己指定。</p></blockquote><ol start=4><li>点击安装：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a6885b2f-e7d3-478e-837f-429d9bdbfa9e.png alt></p><ol start=5><li>进入 pig-mysql 服务，编辑外部访问 , 从而访问 MySQL 导入 pig 的数据：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/0bff01a8-ab1c-4c52-8734-c04b808184a5.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/29ea5a30-322c-47fa-9774-68e1051a3964.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/6e3eeadd-0ebe-4cad-a94d-d7c0853d19ce.png alt></p><ol start=6><li>进入 MySQL 容器，调整帐号允许从远程登陆：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/69fcb1b4-8400-4ce6-8182-34ce8b3e075c.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/9cbc4ac0-d041-477b-881c-4323b6acf0a1.png alt></p><p>登录 MySQL 进行授权操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ MySQL -uroot -proot
</span></span><span style=display:flex><span>$ use MySQL;
</span></span><span style=display:flex><span>$ update user set host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;%&#39;</span> where user<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;root&#39;</span>;
</span></span><span style=display:flex><span>$ flush privileges;
</span></span><span style=display:flex><span>$ ALTER USER <span style=color:#e6db74>&#39;root&#39;</span>@<span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED WITH MySQL_native_password BY <span style=color:#e6db74>&#39;root&#39;</span>;
</span></span><span style=display:flex><span>$ flush privileges;
</span></span></code></pre></div><ol start=7><li>利用 Navicat 客户端连接 pig-mysql 服务，导入数据：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8f4915d9-95bc-4b7c-8f9f-0ba003e39fc7.png alt></p><h2 id=部署-redis>部署 Redis</h2><ol><li>进入应用商店，在应用分类中选择数据库和缓存，找到 Redis。如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/587567d1-4a45-4b52-8f0c-f883302d8095.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ba56795b-4a30-42cd-a709-9fa6cf2cd112.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/cea14892-5f08-4e75-93f8-91d4d2774ad8.png alt></p><blockquote><p>注：Pig 中默认使用无密码模式，因此可以暂时留空。生产环境不推荐将密码设置为空。</p></blockquote><ol start=2><li>安装成功后，如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/3f11873d-f435-44c9-98b7-205d697c81a1.png alt></p><h2 id=创建凭证>创建凭证</h2><p>Pig 所依赖的后端微服务为无状态服务。利用 KubeSphere 服务创建 DevOps 流水线项目来部署这些微服务。</p><ol><li>创建 kubeconfig 凭证 , 如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/c12fe912-8b1e-404a-9618-c1490ae34e37.png alt></p><blockquote><p>名称自定义，需要和 Jenkinsfile 中的一致即可，内容默认或者去 /root/.kube 下复制。</p></blockquote><ol start=2><li>创建 Harbor 凭证 , 如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f9ef91cd-054d-4576-8f45-8f416659c29a.png alt></p><blockquote><p>名称自定义，需要和 Jenkinsfile 中的一致即可。</p></blockquote><ol start=3><li>创建 gitlab 凭证 , 如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ac939576-7201-4fd2-bb12-8f051ed8a930.png alt></p><blockquote><p>名称自定义，需要和 Jenkinsfile 中的一致即可。</p></blockquote><p>全部凭证如下：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/c2731a18-018e-4fbb-8b58-9141254885d8.png alt></p><h2 id=设置-harbor-镜像仓库>设置 harbor 镜像仓库</h2><p>新建一个 pig-dev 项目 , 如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/48bd9cce-d8c1-4be9-9d85-936930ee14d3.png alt></p><h2 id=部署-pig-后端无状态服务>部署 Pig 后端无状态服务</h2><ol><li>新建 pig 后端流水线 , 如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/634e9271-bf37-459b-8c7a-efe52850c421.png alt></p><p>选择代码仓库：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/0f0f00c3-96b0-48aa-a513-04ccf40a4d90.png alt></p><p>编辑设置：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/620044ab-92bd-459c-8725-b4aa26893b58.png alt></p><ol start=2><li>代码中创建 Jenkinsfile 文件：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/5634357b-c0bb-4738-b99d-78e25b2a469a.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        label <span style=color:#e6db74>&#39;maven&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parameters <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        choice<span style=color:#f92672>(</span>choices: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;dev&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;test&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pre&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pre2&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;prod&#39;</span><span style=color:#f92672>],</span> name: <span style=color:#e6db74>&#39;Environments&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;请选择要发布的环境：dev开发环境、test测试环境、pre预发布环境、pre2灰度环境、prod 生产环境&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        choice<span style=color:#f92672>(</span>choices: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;pig-gateway&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-auth&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-register&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-upms-biz&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;pig-codegen&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-monitor&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-sentinel-dashboard&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pig-xxl-job-admin&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;all&#39;</span><span style=color:#f92672>],</span> name: <span style=color:#e6db74>&#39;ServicesDeploy&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;请选择要构建的服务,支持单个服务发布或全部服务发布&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        choice<span style=color:#f92672>(</span>choices: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>],</span> name: <span style=color:#e6db74>&#39;sonarQube&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;是否进行sonarQube代码质量检查,默认为no&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        string<span style=color:#f92672>(</span>name: <span style=color:#e6db74>&#39;MultiServicesBuild&#39;</span><span style=color:#f92672>,</span> defaultValue: <span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;自由组合发布服务,如填写pig-gateway,pig-auth等,默认此项不生效,和ServicesDeploy只能选其一&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HARBOR_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;harbor-id&#39;</span>
</span></span><span style=display:flex><span>        GITLAB_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;gitlab&#39;</span>
</span></span><span style=display:flex><span>        KUBECONFIG_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-kubeconfig&#39;</span>
</span></span><span style=display:flex><span>        REGISTRY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ip:端口&#39;</span><span style=color:#75715e>//harbor镜像仓库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HARBOR_NAMESPACE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-dev&#39;</span>
</span></span><span style=display:flex><span>        K8s_NAMESPACE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-dev&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;拉取代码&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                checkout<span style=color:#f92672>(</span>scm<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;初始化变量&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		  agent none
</span></span><span style=display:flex><span>		  steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			  script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>//自由组合发布
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.MultiServicesBuild}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;no&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				  ServicesBuild <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${params.MultiServicesBuild}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					println <span style=color:#e6db74>&#34;now got ${service}&#34;</span>
</span></span><span style=display:flex><span>				  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.ServicesDeploy}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>					ServicesBuildStr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-gateway,pig-auth,pig-register,pig-upms-biz,pig-codegen,pig-monitor,pig-sentinel-dashboard,pig-xxl-job-admin&#39;</span>
</span></span><span style=display:flex><span>					ServicesBuild <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${ServicesBuildStr}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span><span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.ServicesDeploy}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>					ServicesBuild <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${params.ServicesDeploy}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;,&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarQube代码质量检查&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.sonarQube}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;yes&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>def</span> workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-&#34;</span>
</span></span><span style=display:flex><span>                          println <span style=color:#e6db74>&#34;当前进行代码质量检查是：${service}&#34;</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-gateway&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-auth&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-register&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${workspace}&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>().</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>)[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-codegen&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-monitor&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-sentinel-dashboard&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-xxl-job-admin&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-visual/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-upms-biz&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                               workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-upms/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                           <span style=color:#75715e>//定义当前Jenkins的SonarQubeScanner工具
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                           scannerHome <span style=color:#f92672>=</span> tool <span style=color:#e6db74>&#39;sonar-scanner&#39;</span>
</span></span><span style=display:flex><span>                           <span style=color:#75715e>//引用当前JenkinsSonarQube环境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                           withSonarQubeEnv<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarqube9.4&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                               sh <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                               cd ${workspace}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                               ${scannerHome}/bin/sonar-scanner
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        println <span style=color:#e6db74>&#34;是no，跳过sonarQube代码质量检查&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;打包&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			agent none
</span></span><span style=display:flex><span>			steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				  script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#34;mvn -Dmaven.test.skip=true clean package -P${params.Environments}&#34;</span>
</span></span><span style=display:flex><span>				  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;构建镜像&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			agent none
</span></span><span style=display:flex><span>			steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				  script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>def</span> workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-&#34;</span>
</span></span><span style=display:flex><span>                      println <span style=color:#e6db74>&#34;当前构建的镜像是：${service}&#34;</span>
</span></span><span style=display:flex><span>                      stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;build ${service}&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-gateway&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-auth&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-register&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${workspace}&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>().</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>)[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-codegen&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-monitor&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-sentinel-dashboard&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-xxl-job-admin&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-visual/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-upms-biz&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                               workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-upms/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#34;cd ${workspace} &amp;&amp; docker build -f Dockerfile -t $REGISTRY/$HARBOR_NAMESPACE/${service}:$BUILD_NUMBER .&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;镜像推送&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			agent none
</span></span><span style=display:flex><span>			steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				  script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					  println <span style=color:#e6db74>&#34;当前推送的镜像是：${service}&#34;</span>
</span></span><span style=display:flex><span>					  stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;push ${service}&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						withCredentials<span style=color:#f92672>([</span>usernamePassword<span style=color:#f92672>(</span>passwordVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HARBOR_PASSWORD&#39;</span> <span style=color:#f92672>,</span>usernameVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HARBOR_USERNAME&#39;</span> <span style=color:#f92672>,</span>credentialsId <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;$HARBOR_CREDENTIAL_ID&#34;</span> <span style=color:#f92672>,)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>							sh <span style=color:#e6db74>&#39;echo &#34;$HARBOR_PASSWORD&#34; | docker login $REGISTRY -u &#34;$HARBOR_USERNAME&#34; --password-stdin&#39;</span>
</span></span><span style=display:flex><span>							sh <span style=color:#e6db74>&#34;docker push  $REGISTRY/$HARBOR_NAMESPACE/${service}:$BUILD_NUMBER&#34;</span>
</span></span><span style=display:flex><span>						<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;推送镜像之latest&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			agent none
</span></span><span style=display:flex><span>			steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				  script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					  println <span style=color:#e6db74>&#34;当前推送的latest镜像是：${service}&#34;</span>
</span></span><span style=display:flex><span>					  stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;pushLatest ${service}&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						sh <span style=color:#e6db74>&#34;docker tag  $REGISTRY/$HARBOR_NAMESPACE/${service}:$BUILD_NUMBER $REGISTRY/$HARBOR_NAMESPACE/${service}:latest&#34;</span>
</span></span><span style=display:flex><span>						sh <span style=color:#e6db74>&#34;docker push  $REGISTRY/$HARBOR_NAMESPACE/${service}:latest&#34;</span>
</span></span><span style=display:flex><span>					  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;部署到dev环境&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			 steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				 container <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				   script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					 <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       <span style=color:#75715e>//自定义的全局变量,也就是整个流水线可以去使用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       env<span style=color:#f92672>.</span><span style=color:#a6e22e>APP_NAME</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${service}&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-gateway&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31201</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>9999</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-auth&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31202</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-register&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31203</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>8848</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-upms-biz&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31204</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4000</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-codegen&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31205</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5002</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-monitor&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31206</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5001</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-sentinel-dashboard&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31207</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5003</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-xxl-job-admin&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>NODEPORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>31208</span>
</span></span><span style=display:flex><span>                          env<span style=color:#f92672>.</span><span style=color:#a6e22e>PORT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5004</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					   stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;deploy ${service}&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>						println <span style=color:#e6db74>&#34;即将部署的服务是 $APP_NAME&#34;</span>
</span></span><span style=display:flex><span>						   withCredentials<span style=color:#f92672>([</span>
</span></span><span style=display:flex><span>							   kubeconfigFile<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>							   credentialsId: env<span style=color:#f92672>.</span><span style=color:#a6e22e>KUBECONFIG_CREDENTIAL_ID</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>							   variable: <span style=color:#e6db74>&#39;KUBECONFIG&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>							   <span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                   <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-register&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                       sh <span style=color:#e6db74>&#34;envsubst &lt; deploy/${params.Environments}/nacos-devops.yaml | kubectl apply -f -&#34;</span>
</span></span><span style=display:flex><span>                                   <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                       sh <span style=color:#e6db74>&#34;envsubst &lt; deploy/${params.Environments}/devops.yaml | kubectl apply -f -&#34;</span>
</span></span><span style=display:flex><span>                                   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>						   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>					 <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				 <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			 <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>通过 ${service} 来判断最终选择哪个 deploy 来部署。</p></blockquote><ol start=3><li>代码中创建 devops.yaml 部署文件：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/bbbda9e8-06f4-40e8-960e-c0cf5544d77b.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>progressDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>$REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$BUILD_NUMBER</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePath</span>: <span style=color:#ae81ff>/dev/termination-log</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePolicy</span>: <span style=color:#ae81ff>File</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnsPolicy</span>: <span style=color:#ae81ff>ClusterFirst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>$NODEPORT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><ol start=4><li>代码中创建 nacos-devops.yaml 部署文件：</li></ol><p>由于 pig-register 服务是 nacos 服务，其 K8s 的 yaml 部署应该和其他服务不同，采用 StatefulSet 来部署且副本数为 3，, 并添加相对应的端口。</p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>pod.alpha.kubernetes.io/initialized</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>affinity</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>podAntiAffinity</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requiredDuringSchedulingIgnoredDuringExecution</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>labelSelector</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>matchExpressions</span>:
</span></span><span style=display:flex><span>                  - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;app&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>values</span>:
</span></span><span style=display:flex><span>                      - <span style=color:#ae81ff>nacos</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>topologyKey</span>: <span style=color:#e6db74>&#34;kubernetes.io/hostname&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>$REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$BUILD_NUMBER</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8848</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client-port</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9848</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client-rpc</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9849</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>raft-rpc</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>7848</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>old-raft-rpc</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePath</span>: <span style=color:#ae81ff>/dev/termination-log</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePolicy</span>: <span style=color:#ae81ff>File</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnsPolicy</span>: <span style=color:#ae81ff>ClusterFirst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service.alpha.kubernetes.io/tolerate-unready-endpoints</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8848</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>server</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8848</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>$NODEPORT</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9848</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>client-rpc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>9848</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9849</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>raft-rpc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>9849</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>### 兼容1.4.x版本的选举端口</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>7848</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>old-raft-rpc</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>7848</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><blockquote><p>后续这些文件都可可采用共享仓库来统一管理。</p></blockquote><ol start=5><li>发布</li></ol><p>由于 pig-gateway、pig-auth 和 pig-upms-biz 等其它服务都是依赖 nacos(pig-register) 服务的，所以我们先发布 pig-register 服务。</p><p>进入 DevOps 项目 -> pig-dev -> pig-backend-dev -> 运行。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f39d7356-3a60-47c5-9fa8-a80a18832c71.png alt></p><blockquote><p>这里 KubeSphere3.3.0 版本中有个 bug，choice 类型的还是识别为 string，所以暂时只能手动输入。此 bug 将会在 3.3.1 版本修复。</p></blockquote><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/04898bd6-11d6-4275-b309-239a178d9a0f.png alt></p><p>查看任务状态：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/5343ffc0-697f-477a-b72b-33ba709ddd19.png alt></p><p>查看日志：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/92bba4cb-d49b-4c5b-94c8-4e1e59a24693.png alt></p><p>在项目 -> 应用负载 -> 服务下查看刚发布的 pig-register 服务：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ad6a86ae-14c6-43e5-8c48-a62ae0f884e7.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/7f9892f1-545a-4c11-a10a-c389b0547854.png alt></p><p>进入 DevOps 项目 -> pig-dev -> pig-backend-dev -> 运行 -> 选择自由组合发布：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f3cd8d56-db90-4819-9cd0-b67974a0a0f4.png alt></p><p>发布完成查看服务：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/253edbb2-212c-48be-aa18-46b9eef45908.png alt></p><blockquote><p>至此已经完成 Pig 后端无状态服务的部署。</p></blockquote><h2 id=部署-pig-前端无状态服务>部署 Pig 前端无状态服务</h2><ol><li>新建 pig 前端流水线 , 如下所示：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/83ee947b-a951-4fbc-8cd1-95481ba50303.png alt></p><p>选择代码仓库：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/3e0305e6-610e-464d-baf2-f83afa86c507.png alt></p><p>编辑设置：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/55c1d451-a031-454a-aff0-abf4c62bf9de.png alt></p><ol start=2><li>代码中创建 Jenkinsfile 文件：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/eb803dba-adba-4037-8894-e0d30752f9bc.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    node <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      label <span style=color:#e6db74>&#39;nodejs&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parameters <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        choice<span style=color:#f92672>(</span>choices: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;dev&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;test&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pre&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;pre2&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;prod&#39;</span><span style=color:#f92672>],</span> name: <span style=color:#e6db74>&#39;Environments&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;请选择要发布的环境：dev开发环境、test测试环境、pre预发布环境、pre2灰度环境、prod 生产环境&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        choice<span style=color:#f92672>(</span>choices: <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;no&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;yes&#39;</span><span style=color:#f92672>],</span> name: <span style=color:#e6db74>&#39;sonarQube&#39;</span><span style=color:#f92672>,</span> description: <span style=color:#e6db74>&#39;是否进行sonarQube代码质量检查,默认为no&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        HARBOR_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;harbor-id&#39;</span>
</span></span><span style=display:flex><span>        GITLAB_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;gitlab&#39;</span>
</span></span><span style=display:flex><span>        KUBECONFIG_CREDENTIAL_ID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-kubeconfig&#39;</span>
</span></span><span style=display:flex><span>        REGISTRY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ip:端口&#39;</span><span style=color:#75715e>//harbor镜像仓里
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HARBOR_NAMESPACE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-dev&#39;</span>
</span></span><span style=display:flex><span>        APP_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-front&#39;</span>
</span></span><span style=display:flex><span>        K8s_NAMESPACE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pig-dev&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stage <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;拉取代码&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                   checkout<span style=color:#f92672>(</span>scm<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarQube代码质量检查&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.sonarQube}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;yes&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       println <span style=color:#e6db74>&#34;当前进行代码质量检查是：${APP_NAME}&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#75715e>//定义当前Jenkins的SonarQubeScanner工具
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       scannerHome <span style=color:#f92672>=</span> tool <span style=color:#e6db74>&#39;sonar-scanner&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#75715e>//引用当前JenkinsSonarQube环境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       withSonarQubeEnv<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarqube9.4&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                           sh <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           cd .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           ${scannerHome}/bin/sonar-scanner
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                       &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        println <span style=color:#e6db74>&#34;是no，跳过sonarQube代码质量检查&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;项目编译&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;node -v&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;npm -v&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;npm install&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;npm run build:docker&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;ls&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;构建镜像&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;ls&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;cd ./docker &amp;&amp; docker  build  -t $REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$APP_NAME-$BUILD_NUMBER .&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;镜像推送&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    withCredentials<span style=color:#f92672>([</span>usernamePassword<span style=color:#f92672>(</span>passwordVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HARBOR_PASSWORD&#39;</span> <span style=color:#f92672>,</span>usernameVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;HARBOR_USERNAME&#39;</span> <span style=color:#f92672>,</span>credentialsId <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;$HARBOR_CREDENTIAL_ID&#34;</span> <span style=color:#f92672>,)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#39;echo &#34;$HARBOR_PASSWORD&#34; | docker login $REGISTRY -u &#34;$HARBOR_USERNAME&#34; --password-stdin&#39;</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#39;docker push  $REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$APP_NAME-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;推送镜像之latest&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                  sh <span style=color:#e6db74>&#39;docker tag  $REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$APP_NAME-$BUILD_NUMBER $REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:latest &#39;</span>
</span></span><span style=display:flex><span>                  sh <span style=color:#e6db74>&#39;docker push  $REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:latest &#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;部署到dev环境&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                  container <span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       withCredentials<span style=color:#f92672>([</span>
</span></span><span style=display:flex><span>                           kubeconfigFile<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                           credentialsId: env<span style=color:#f92672>.</span><span style=color:#a6e22e>KUBECONFIG_CREDENTIAL_ID</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                           variable: <span style=color:#e6db74>&#39;KUBECONFIG&#39;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                           sh <span style=color:#e6db74>&#34;envsubst &lt; deploy/${params.Environments}/devops.yaml | kubectl apply -f -&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>         <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=3><li>代码中创建 devops.yaml 部署文件：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/bc576a7b-4ef8-4e10-ab69-dbd3bd4ff4fb.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>progressDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pig-front</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rollingUpdate</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxSurge</span>: <span style=color:#ae81ff>50</span><span style=color:#ae81ff>%</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxUnavailable</span>: <span style=color:#ae81ff>50</span><span style=color:#ae81ff>%</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>RollingUpdate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pig-front</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>$REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$APP_NAME-$BUILD_NUMBER</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pig-front-end</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePath</span>: <span style=color:#ae81ff>/dev/termination-log</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePolicy</span>: <span style=color:#ae81ff>File</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnsPolicy</span>: <span style=color:#ae81ff>ClusterFirst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>31200</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><blockquote><p>后续这些文件都可可采用共享仓库来统一管理。</p></blockquote><ol start=4><li>发布：</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/78390f9f-be17-4205-8d75-a9f63745585c.png alt></p><blockquote><p>这里 KubeSphere3.3.0 版本中有个 bug，choice 类型的还是识别为 string，此 bug 将会在 3.3.1 版本修复。</p></blockquote><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/4d5a28e1-4176-430d-9101-a8d723a95333.png alt></p><p>查看任务状态：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/25565d31-311d-4432-aa25-51692599a687.png alt></p><p>查看日志：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/1f9e7421-127d-403f-8bb2-175327e85513.png alt></p><p>在项目 -> 应用负载 -> 服务下查看刚发布的 pig-front 服务。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/73125a61-53fa-477a-b0ec-cea99cc396f3.png alt></p><p>至此所有的服务均已发布完成。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/b17e2d0b-707c-4316-bff8-73471915102e.png alt></p><h3 id=利用-kubesphere-中的-jenkins-发布>利用 KubeSphere 中的 Jenkins 发布</h3><p>访问 <code>ip:30180</code>（账号：admin，密码：P@88w0rd）：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/826b327e-afba-4213-b25b-25988c02fe8c.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/4b51e14f-4e77-41c3-a260-b04e70adb29d.png alt></p><p>可以打开 Blue Ocean 查看状态：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/47a07a33-9831-4ac3-b6bf-4ec161ce0130.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a5324900-d31a-42b8-b772-61c4a9e34751.png alt></p><h2 id=通过-nodeport-方式暴露集群内部容器服务>通过 NodePort 方式暴露集群内部容器服务</h2><p>NodePort 设计之初就不建议用于生产环境暴露服务，所以默认端口都是一些大端口，如下：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8747dd92-3fca-449e-8e0f-5ed8adcc0deb.png alt></p><p>输入 node ip + 31200 访问：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/d4499704-061d-4a91-8a38-66b207e5c44c.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f7ef0f6a-b4b1-4537-8856-9d232eaa81d8.png alt></p><h2 id=优化和改进>优化和改进</h2><h3 id=通过探针优雅的解决部署过程中服务平滑过渡问题>通过探针优雅的解决部署过程中服务平滑过渡问题</h3><p>若是只有一个副本的情况下，新的 Pod 启动成功时，开始停掉旧的 Pod, 但是我们看到的 running 状态，并不以为着我们的服务是正常的。若是这个时候杀死旧的 Pod, 那么将有新的 Pod 接受请求，这个时候会出现服务短暂不可用状态，所以需要增加探来确保我们的服务已经正常了，可以接收并处理用户请求。我们常用的探针如下：</p><h4 id=livenessprobe存活性探测>livenessProbe：存活性探测</h4><p>许多应用程序经过长时间运行，最终过渡到无法运行的状态，除了重启，无法恢复。通常情况下，K8s 会发现应用程序已经终止，然后重启应用程序 pod。有时应用程序可能因为某些原因（后端服务故障等）导致暂时无法对外提供服务，但应用软件没有终止，导致 K8s 无法隔离有故障的 pod，调用者可能会访问到有故障的 pod，导致业务不稳定。K8s 提供 livenessProbe 来检测容器是否正常运行，并且对相应状况进行相应的补救措施。</p><h4 id=readinessprobe就绪性探测>readinessProbe：就绪性探测</h4><p>在没有配置 readinessProbe 的资源对象中，pod 中的容器启动完成后，就认为 pod 中的应用程序可以对外提供服务，该 pod 就会加入相对应的 service，对外提供服务。但有时一些应用程序启动后，需要较长时间的加载才能对外服务，如果这时对外提供服务，执行结果必然无法达到预期效果，影响用户体验。比如使用 tomcat 的应用程序来说，并不是简单地说 tomcat 启动成功就可以对外提供服务的，还需要等待 spring 容器初始化，数据库连接上等等。</p><p><strong>1) SpringBoot 的 actuator</strong></p><p>其实 actuator 是用来帮助用户监控和操作 SprinBoot 应用的，这些监控和操作都可以通过 http 请求实现，如下图，http://localhost:7777/actuator/health 地址返回的是应用的健康状态。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/20091db7-a6c4-4d0a-a77c-6372b894554e.png alt></p><p>需引以下 maven:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- 引入Actuator监控依赖 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><blockquote><p>在 SpringBoot-2.3 版本中，actuator 新增了两个地址：/actuator/health/liveness 和 /actuator/health/readiness，前者用作 Kubernetes 的存活探针，后者用作 Kubernetes 的就绪探针 , 需要先在配置文件中开启，如下：</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>management</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>health</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>probes</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>health</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>livenessstate</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>readinessstate</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><blockquote><p>/actuator/health/ 和 /actuator/health/ 是默认开启的。</p></blockquote><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/babcd72f-6e6d-46c3-a93d-d87b9a847d1f.png alt></p><p>利用 SpringBoot 的接口来作为容器探针的健康检测 , 按照如下就可以：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9999</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health/readiness</span>
</span></span><span style=display:flex><span><span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span><span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9999</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health/liveness</span>
</span></span></code></pre></div><p><strong>2) pig 后端项目增加探针</strong></p><p>pig 项目全局所有的模块都会引入 Actuator 监控依赖，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--监控--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>调整 pig 项目后端 devops.yaml, 增加以下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>完整 devops.yaml 内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>progressDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>$REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$BUILD_NUMBER</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePath</span>: <span style=color:#ae81ff>/dev/termination-log</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePolicy</span>: <span style=color:#ae81ff>File</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>failureThreshold</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/actuator/health</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnsPolicy</span>: <span style=color:#ae81ff>ClusterFirst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>$PORT</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>$NODEPORT</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><blockquote><p>注： /actuator/health/readiness 和 /actuator/health/liveness 也可以用，需在配置文件中开启。若是内存、CPU 限制过低，需要调整 initialDelaySeconds 时间，否则会出现还未启动成功，就开始探测，会进入循环，直到探测失败（就是 failureThreshold 定义的次数），要掌握好这个时间的度。</p></blockquote><p>重新发布 pig-geteway 测试：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ebea2b43-16a0-4d60-b1c3-b1b8a06e504c.png alt></p><p>正在进行探测：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ee68567a-983e-4b29-b8ea-2661d8d72b29.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a8bb2922-77d2-4e93-9bc6-92a2f7d3096c.png alt></p><p>探测成功，新的 Pod 可用，旧的 Pod 删除：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/17f70f57-b232-41cc-b68d-f8b205c333f1.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/aa6a123b-6d53-42c6-a1c9-70bff246ab19.png alt></p><p><strong>3) pig 前端项目增加探针</strong></p><p>前端项目我们直接探测 Nginx 的端口即可。调整 devops.yaml, 增加如下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span></code></pre></div><p>完整 devops.yaml 如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>progressDeadlineSeconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pig-front</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>rollingUpdate</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxSurge</span>: <span style=color:#ae81ff>50</span><span style=color:#ae81ff>%</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>maxUnavailable</span>: <span style=color:#ae81ff>50</span><span style=color:#ae81ff>%</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>RollingUpdate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>pig-front</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>$REGISTRY/$HARBOR_NAMESPACE/$APP_NAME:$APP_NAME-$BUILD_NUMBER</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pig-front-end</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePath</span>: <span style=color:#ae81ff>/dev/termination-log</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>terminationMessagePolicy</span>: <span style=color:#ae81ff>File</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnsPolicy</span>: <span style=color:#ae81ff>ClusterFirst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>$K8s_NAMESPACE</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodePort</span>: <span style=color:#ae81ff>31200</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>$APP_NAME</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sessionAffinity</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span></code></pre></div><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/aa026e83-71fb-4866-ba02-29664cc91c78.png alt></p><h3 id=通过探针优雅的解决服务部署过程中注册中心服务平滑过渡问题>通过探针优雅的解决服务部署过程中注册中心服务平滑过渡问题</h3><p>我们后端采用 Spring Cloud（Spring Cloud Alibaba）微服务结构技术路线进行开发，采用 Nacos 作为注册中心。而服务注册到 Nacos 是需要时间的。而一般的容器探测只是探测服务是否达到了可用的状态，没有考虑到注册到注册中心的服务是否可用，其实在多副本的情况下只要控制好滚动更新策略，应该不会出现这种情况的。在 Nacos 中也是有负载均衡的，Nacos 实现负载均衡是通过内置的 Ribbon 实现的。像 Gateway 网关服务尤其重要，因为它还要负责服务转发。所以保证这种服务的可用性也变得尤为重要。</p><p>例如单副本 Gateway 网关服务，若是在开始探测时，网关服务并没有及时注册到注册中心里，这个时候开始测探，服务本身是可用的，那么探测成功后，新的 Pod 变成了 running 状态，便停掉了第一个 Pod，而注册中心中的服务其实并不可用，会出现短暂服务不可用。</p><p>其实健康探测我们还可以往前走一步，把服务成功注册到注册中心中作为服务可用的状态。</p><p><strong>自己编写容器探针接口：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author 小盒子
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @version 1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @description: 容器探针接口，用来进行探测服务是否注册进入注册中心
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @date 2022/10/22 10:58
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;nacos&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HealthController</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> DiscoveryClient discoveryClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/health/{services}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getService</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;services&#34;</span>)String services) <span style=color:#66d9ef>throws</span> NacosException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//从nacos中根据serverId获取实例 方法一（采用此方法，DiscoveryClient 代表的就是：服务发现操作对象）</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (StringUtils.<span style=color:#a6e22e>isBlank</span>(services)){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>(HttpStatus.<span style=color:#a6e22e>BAD_REQUEST</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> discoveryClient.<span style=color:#a6e22e>getInstances</span>(services);
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Integer<span style=color:#f92672>&gt;</span> ipMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (instances.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>&gt;</span> 0){
</span></span><span style=display:flex><span>            instances.<span style=color:#a6e22e>forEach</span>(key <span style=color:#f92672>-&gt;</span>{
</span></span><span style=display:flex><span>                ipMap.<span style=color:#a6e22e>put</span>(key.<span style=color:#a6e22e>getHost</span>(), key.<span style=color:#a6e22e>getPort</span>());
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//从nacos中根据serverId获取实例 方法二 采用nacos的java的SDK</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        Properties properties = new Properties();</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        properties.put(&#34;serverAddr&#34;, &#34;192.168.4.25:8849&#34;);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        properties.put(&#34;namespace&#34;, &#34;caseretrieval-dev&#34;);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        NamingService naming = NamingFactory.createNamingService(properties);</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//        List&lt;Instance&gt; instancesList = naming.selectInstances(&#34;case-gateway&#34;, true);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//从nacos中根据serverId获取实例 方法三，采用nacos的OPEN-api</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//http://192.168.4.25:8849/nacos/v1/ns/instance/list?serviceName=case-gateway&amp;namespaceId=caseretrieval-dev</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取本机IP地址</span>
</span></span><span style=display:flex><span>        String hostAddress <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            InetAddress localHost <span style=color:#f92672>=</span> InetAddress.<span style=color:#a6e22e>getLocalHost</span>();
</span></span><span style=display:flex><span>            hostAddress <span style=color:#f92672>=</span> localHost.<span style=color:#a6e22e>getHostAddress</span>();
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;当前服务本机ip是：&#34;</span><span style=color:#f92672>+</span>hostAddress);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (UnknownHostException e) {
</span></span><span style=display:flex><span>            log.<span style=color:#a6e22e>error</span>(e.<span style=color:#a6e22e>getMessage</span>(), e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>//查看本机服务是否已经注册到nacos中</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ipMap.<span style=color:#a6e22e>containsKey</span>(hostAddress)){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>(HttpStatus.<span style=color:#a6e22e>OK</span>);
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseEntity<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>(HttpStatus.<span style=color:#a6e22e>SERVICE_UNAVAILABLE</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>其实正常情况下，合理的滚动更新策略，加上就绪性探测、存活性探测或者启动探测就能达到目标了，也不必这么麻烦。</p></blockquote><h3 id=通过-ingress-方式暴露集群内部容器服务>通过 Ingress 方式暴露集群内部容器服务</h3><p>如果需要从集群外部访问服务，即将服务暴露给用户使用，KubernetesService 本身提供了两种方式，一种是 NodePort ，另外一种是 LoadBalancer 。另外 Ingress 也是一种常用的暴露服务的方式。</p><p>KubeSphere 的项目网关就是 IngressController ，是一个七层负载均衡调度器，客户端的请求先到达这个七层负载均衡调度器，KubeSphere 中的应用路由就是 Ingress ，是定义规则的。数据包走向如下图流程所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a189e6ef-74b8-4da4-b5a0-88c763eefd54.png alt></p><h4 id=开启项目网关>开启项目网关</h4><p>对项目中的外网访问网关以及服务治理等配置进行设置和管理。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/d831cda1-e47f-45e8-808c-814350f20e57.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/1ac36a74-00d1-4386-bb99-ad37433c4706.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/d95bd4ff-96bc-4b1b-b264-bcea278628e1.png alt></p><blockquote><p>KubeSphere 中的项目网关，开启后会自动安装 IngressController。</p></blockquote><p>对应在 K8s 集群中 svc 如下图所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/dbea48f5-edee-4ca7-817b-bcf80bd457bd.png alt></p><p>KubeSphere 中应用路由是需要手动创建的，如下图所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8c87a631-6886-476f-83a8-6c7efdadd973.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/347ddd41-fbac-41c8-9f8b-93d3fee6554b.png alt></p><h4 id=设置路由规则>设置路由规则</h4><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f4d7f58a-20a6-4259-aefe-e036974cd99a.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/6ab8c2dc-d103-4996-85d5-34a71a53332d.png alt></p><blockquote><p>指定自定义域名并通过本地 hosts 文件或 DNS 服务器将域名解析为网关 IP 地址。</p></blockquote><h4 id=访问>访问 <a href=http://pig.com:32576/ target=_blank rel="noopener noreferrer">http://pig.com:32576/</a></h4><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f0146856-95b8-4b8e-b11d-0eb14942889f.png alt></p><h3 id=将-sonarqube-集成到流水线>将 SonarQube 集成到流水线</h3><p>SonarQube 是一种主流的代码质量持续检测工具。您可以将其用于代码库的静态和动态分析。SonarQube 集成到 KubeSphere(Jenkins) 流水线后，如果在运行的流水线中检测到问题，您可以直接在仪表板上查看常见代码问题，例如 Bug 和漏洞。</p><p>在日常开发中 SonarQube 往往是基于现有的 Gitlab、Jenkins 集成配合使用的，以便在项目拉取代码后进行代码审查。若是存在多套环境的情况下，例如有开发环境、测试环境、生产环境等，我是不建议在生产环境中去进行代码审查的，一来进行重复的代码审查没有意义，二来比较浪费时间，所以建议只在开发环境开启代码审查即可。</p><h4 id=在-jenkins-中集成-sonarqube>在 Jenkins 中集成 SonarQube</h4><p>微服务项目中需要在每个项目下都建立 sonar-project.properties 文件，在 Jenkins 的脚本中需要循环去 checking 每个微服务。</p><ol><li>在 sonarQube 中生成 token</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ab423df8-5450-445f-9edb-ef3ea2e53217.png alt></p><ol start=2><li>在 Jenkins 中安装 SonarQube Scanner 插件</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/3fe3869f-e90c-490a-8b6f-73d7c0e03314.png alt></p><ol start=3><li>在 Jenkins 中添加 SonarQube 凭证</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/e102fcef-fc0a-4542-83c8-99a8c7349924.png alt></p><blockquote><p>选择 Secret text 作为凭证类型。</p></blockquote><p>完成后如下所示：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/eff5d0da-fd37-4e5c-8ab7-c9c23c97fab4.png alt></p><ol start=4><li>在 Jenkins 系统配置中配置 SonarQube</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/e4dbeda3-0139-4d6b-b95a-1af85dec03a7.png alt></p><ol start=5><li>在 Jenkins 全工具中安装 SonarQube Scanner</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/eb9c41a4-37bf-4e49-aba1-fee590083e4b.png alt></p><blockquote><p>sonar-scanner 名称自定义，在 jenkinsfile 中要保持一直。</p></blockquote><ol start=6><li>关闭审查结果上传 SCM 功能</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/45cc3cba-7f94-41b7-aaee-e73226bf2bc4.png alt></p><h4 id=后端代码审查>后端代码审查</h4><ol><li>调整 Jenkins 脚本</li></ol><p>微服务项目中需要在每个项目下都建立 sonar-project.properties 文件，在 Jenkins 的脚本中需要循环去 checking 每个微服务。</p><p>如以下示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarQube代码质量检查&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.sonarQube}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;yes&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>service <span style=color:#66d9ef>in</span> ServicesBuild<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>def</span> workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-&#34;</span>
</span></span><span style=display:flex><span>                          println <span style=color:#e6db74>&#34;当前进行代码质量检查是：${service}&#34;</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-gateway&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-auth&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-register&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${workspace}&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>().</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>)[</span><span style=color:#ae81ff>1</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                          <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-codegen&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-monitor&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-sentinel-dashboard&#34;</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-xxl-job-admin&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                              workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-visual/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                           <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;pig-upms-biz&#34;</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                               workspace <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pig-upms/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;${service}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                           <span style=color:#75715e>//定义当前Jenkins的SonarQubeScanner工具
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                           scannerHome <span style=color:#f92672>=</span> tool <span style=color:#e6db74>&#39;sonar-scanner&#39;</span>
</span></span><span style=display:flex><span>                           <span style=color:#75715e>//引用当前JenkinsSonarQube环境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                           withSonarQubeEnv<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarqube9.4&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                               sh <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                               cd ${workspace}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                               ${scannerHome}/bin/sonar-scanner
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                           <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        println <span style=color:#e6db74>&#34;是no，跳过sonarQube代码质量检查&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><blockquote><p>注：sonar-scanner 和 sonarqube9.4 名称需和 Jenkins 中配置的一致。</p></blockquote><ol start=2><li>新建 sonar-project.properties 文件</li></ol><p>以 pig-gateway 为例，在 pig 项目中新增 sonar-project.properties 文件。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/855b6cf6-fd5d-433e-8aac-79083d89df0d.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#75715e>#项目的key(自定义)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectKey</span>=<span style=color:#a6e22e>pig-gateway</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#项目名称</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectName</span>=<span style=color:#a6e22e>pig-gateway</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#项目版本号</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectVersion</span>=<span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#需要分析的源码的目录，多个目录用英文逗号隔开</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>sources</span>=.
</span></span><span style=display:flex><span><span style=color:#75715e>#需要忽略的目录</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>exclusions</span>=<span style=color:#960050;background-color:#1e0010>**/</span><span style=color:#a6e22e>test</span><span style=color:#960050;background-color:#1e0010>/**</span>,<span style=color:#960050;background-color:#1e0010>**/</span><span style=color:#a6e22e>target</span><span style=color:#960050;background-color:#1e0010>/**</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 字节码文件所在位置</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>java</span>.<span style=color:#a6e22e>binaries</span>=.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>java</span>.<span style=color:#a6e22e>source</span>=<span style=color:#ae81ff>1.8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>java</span>.<span style=color:#a6e22e>target</span>=<span style=color:#ae81ff>1.8</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#sonar.java.libraries=**/target/classes/**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Encoding of the source code. Default is default system encoding</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>sourceEncoding</span>=<span style=color:#a6e22e>UTF-8</span>
</span></span></code></pre></div><p>发布测试：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ed6b41c7-2cb7-4fa3-9c14-ccc77ec20bd9.png alt></p><p>在 Jenkins 中查看：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f207282b-3fea-47c5-951f-06e7e177cf20.png alt></p><p>在 SonarQube 中查看代码检测情况：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/a7c9824c-446e-4fda-8e99-a9de4f895101.png alt></p><blockquote><p>pig-gateway 的代码质量还是很错的，不过有一个漏洞哦。</p></blockquote><h4 id=前端代码审查>前端代码审查</h4><ol><li>调整 Jenkins 脚本</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarQube代码质量检查&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                script <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;${params.sonarQube}&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trim</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;yes&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                       println <span style=color:#e6db74>&#34;当前进行代码质量检查是：${APP_NAME}&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#75715e>//定义当前Jenkins的SonarQubeScanner工具
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       scannerHome <span style=color:#f92672>=</span> tool <span style=color:#e6db74>&#39;sonar-scanner&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#75715e>//引用当前JenkinsSonarQube环境
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       withSonarQubeEnv<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;sonarqube9.4&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                           sh <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           cd .
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                           ${scannerHome}/bin/sonar-scanner
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                       &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>                       <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        println <span style=color:#e6db74>&#34;是no，跳过sonarQube代码质量检查&#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><ol start=2><li>新建 sonar-project.properties 文件</li></ol><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/bb601e1f-492e-4598-853b-085edfee25b0.png alt></p><p>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectKey</span>=<span style=color:#a6e22e>pig_ui</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectName</span>=<span style=color:#a6e22e>pig_ui</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>projectVersion</span>=<span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sonar</span>.<span style=color:#a6e22e>sources</span>=.
</span></span></code></pre></div><p>发布测试：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/4733f5bc-e0b6-40a6-965c-ad5494c20f9e.png alt></p><p>在 Jenkins 中查看：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/723a6c74-66ce-41d2-9929-38f0e452f9de.png alt></p><p>在 SonarQube 中查看代码检测情况：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8cf60ee9-5aca-45cb-b1f0-5a0ab1902655.png alt></p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&text=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&title=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-pig-practice%2f&t=%e5%9f%ba%e4%ba%8e%20KubeSphere%20%e7%9a%84%e5%bc%80%e6%ba%90%e5%be%ae%e6%9c%8d%e5%8a%a1%e5%bc%80%e5%8f%91%e5%b9%b3%e5%8f%b0%20Pig%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#介绍>介绍</a><ul><li><a href=#kubesphere>KubeSphere</a></li><li><a href=#pig>Pig</a></li></ul></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#架构设计>架构设计</a><ul><li><a href=#kubesphere-架构>KubeSphere 架构</a></li><li><a href=#pig-架构>Pig 架构</a></li><li><a href=#整体架构图>整体架构图</a></li><li><a href=#整体容器化部署流程图>整体容器化部署流程图</a></li></ul></li><li><a href=#部署过程>部署过程</a><ul><li><a href=#创建企业空间>创建企业空间</a></li><li><a href=#创建-devops-项目>创建 DevOps 项目</a></li><li><a href=#创建项目>创建项目</a></li><li><a href=#部署-mysql>部署 MySQL</a></li></ul></li><li><a href=#部署-redis>部署 Redis</a></li><li><a href=#创建凭证>创建凭证</a></li><li><a href=#设置-harbor-镜像仓库>设置 harbor 镜像仓库</a></li><li><a href=#部署-pig-后端无状态服务>部署 Pig 后端无状态服务</a></li><li><a href=#部署-pig-前端无状态服务>部署 Pig 前端无状态服务</a><ul><li><a href=#利用-kubesphere-中的-jenkins-发布>利用 KubeSphere 中的 Jenkins 发布</a></li></ul></li><li><a href=#通过-nodeport-方式暴露集群内部容器服务>通过 NodePort 方式暴露集群内部容器服务</a></li><li><a href=#优化和改进>优化和改进</a><ul><li><a href=#通过探针优雅的解决部署过程中服务平滑过渡问题>通过探针优雅的解决部署过程中服务平滑过渡问题</a></li><li><a href=#通过探针优雅的解决服务部署过程中注册中心服务平滑过渡问题>通过探针优雅的解决服务部署过程中注册中心服务平滑过渡问题</a></li><li><a href=#通过-ingress-方式暴露集群内部容器服务>通过 Ingress 方式暴露集群内部容器服务</a></li><li><a href=#将-sonarqube-集成到流水线>将 SonarQube 集成到流水线</a></li></ul></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>