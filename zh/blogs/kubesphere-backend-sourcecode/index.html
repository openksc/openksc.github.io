<!doctype html><html lang=en-US><head><meta charset=utf-8><title>KubeSphere 后端源码深度解析</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="这篇文章我们将学习在 vscode 上的 ssh remote 插件基础上，尝试 debug 和学习 KubeSphere 后端模块架构。"><meta name=keywords content="KubeSphere,后端源码,Kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="KubeSphere 后端源码深度解析"><meta property="og:description" content="这篇文章我们将学习在 vscode 上的 ssh remote 插件基础上，尝试 debug 和学习 KubeSphere 后端模块架构。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/KubeSphere-backend-sourcecode.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-backend-sourcecode/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/KubeSphere-backend-sourcecode.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-backend-sourcecode/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-backend-sourcecode/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>KubeSphere 后端源码深度解析</span></div><div class='main-div middle-div'><div class=author>朱含</div><span class=date>发布于：2022-01-19</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>KubeSphere 后端源码深度解析</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&text=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&title=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&t=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><p>这篇文章我们将学习在 vscode 上的 ssh remote 插件基础上，尝试 debug 和学习 KubeSphere 后端模块架构。</p><h2 id=前提>前提</h2><ul><li>安装好 vscode 以及 ssh remote container 插件；</li><li>在远程主机上安装好 kubenertes 容器 " 操作系统 " 和 KubeSphere >= v3.1.0 云“控制面板”；</li><li>安装 go >=1.16;</li><li>在 KubeSphere 上安装了需要 debug 的 KubeSphere 组件，如 devops、kubeedge 或者 whatever, 如果是默认激活的组件，像 monitoring，不需要去激活。</li></ul><h2 id=配置-launch-文件>配置 launch 文件</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#960050;background-color:#1e0010>cat</span> <span style=color:#960050;background-color:#1e0010>.vscode/launch.json</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用 IntelliSense 了解相关属性。 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 悬停以查看现有属性的描述。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;0.2.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;configurations&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;ks-apiserver&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;go&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;request&#34;</span>: <span style=color:#e6db74>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;auto&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;program&#34;</span>: <span style=color:#e6db74>&#34;${workspaceFolder}/cmd/ks-apiserver/apiserver.go&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ks-apiserver-调试依赖文件>ks-apiserver 调试依赖文件</h2><p>在相对路径 cmd/ks-apiserver/ 下配置 kubesphere.yaml。</p><p>首先，查看集群之中的 cm 配置文件 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n kubesphere-system get cm kubesphere-config -oyaml
</span></span></code></pre></div><p>因为上述 configmap 中差少 kubeconfig 相关配置，所以需要将上述 yaml 文件拷贝出来整合以下。</p><p>为啥要用添加 kubeconfig 文件？</p><p>主要是因为 K8s 在创建 client 时需要这么一个文件 , 而容器中会用到 inclusterconfig 就不需要添加了。</p><p>感兴趣可以看下 client-go 的例子：</p><blockquote><p><a href=https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration/main.go#L41 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration/main.go#L41</a></p><p><a href=https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration/main.go#L53 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration/main.go#L53</a></p></blockquote><p>所以完整的配置启动文件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>$ cat ./cmd/ks-apiserver/kubesphere.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kubernetes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubeconfig</span>: <span style=color:#e6db74>&#34;/root/.kube/config&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>master</span>: <span style=color:#ae81ff>https://192.168.88.6:6443</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>$qps</span>: <span style=color:#ae81ff>1e+06</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>burst</span>: <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>authentication</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticateRateLimiterMaxTries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticateRateLimiterDuration</span>: <span style=color:#ae81ff>10m0s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loginHistoryRetentionPeriod</span>: <span style=color:#ae81ff>168h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>maximumClockSkew</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>multipleLogin</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubectlImage</span>: <span style=color:#ae81ff>kubesphere/kubectl:v1.20.0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jwtSecret</span>: <span style=color:#e6db74>&#34;Xtc8ZWUf9f3cJN89bglrTJhfUPMZR87d&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>oauthOptions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>clients</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kubesphere</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>kubesphere</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>redirectURIs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ippoolType</span>: <span style=color:#ae81ff>none</span>
</span></span><span style=display:flex><span><span style=color:#f92672>monitoring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enableGPUMonitoring</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>gpu</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kinds</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>resourceName</span>: <span style=color:#ae81ff>nvidia.com/gpu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resourceType</span>: <span style=color:#ae81ff>GPU</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>default</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>notification</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://notification-manager-svc.kubesphere-monitoring-system.svc:19093</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>kubeedge</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://edge-watcher.kubeedge.svc/api/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>watchesPath</span>: <span style=color:#ae81ff>/var/helm-charts/watches.yaml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kubesphere-controls-system</span>
</span></span></code></pre></div><p>除了 kubernetes, 第一层的 key 表示我们集群中已经按照或者默认激活的 KubeSphere 组件，现在就可以通过 F5 来启动 debug 了。</p><p>在 debug 之前，你可能会问，这个配置文件为啥要放在 /cmd/ks-apiserver/kubesphere.yaml?</p><p>我们先来探索一波 ks-apiserver 的运行逻辑。</p><h2 id=启动-ks-apiserver>启动 ks-apiserver</h2><p>查看 cmd/ks-apiserver/app/server.go 的逻辑 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Load configuration from file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apiserverconfig</span>.<span style=color:#a6e22e>TryLoadFromDisk</span>()
</span></span></code></pre></div><p>TryLoadFromDisk 的逻辑如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetConfigName</span>(<span style=color:#a6e22e>defaultConfigurationName</span>) <span style=color:#75715e>// kubesphere</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AddConfigPath</span>(<span style=color:#a6e22e>defaultConfigurationPath</span>) <span style=color:#75715e>// /etc/kubesphere</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load from current working directory, only used for debugging</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AddConfigPath</span>(<span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load from Environment variables</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetEnvPrefix</span>(<span style=color:#e6db74>&#34;kubesphere&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AutomaticEnv</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetEnvKeyReplacer</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReplacer</span>(<span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 上面一顿配置之后，单步调试，ReadInConfig这一步读取的文件路径是	</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// v.configPaths：[&#34;/etc/kubesphere&#34;,&#34;/root/go/src/kubesphere.io/kubesphere/cmd/ks-apiserver&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>ReadInConfig</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>ConfigFileNotFoundError</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error parsing configuration file %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>() <span style=color:#75715e>// 初始化各组件配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 从读取的实际路径配置文件来反序列化到conf这个struct</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>conf</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>conf</span>, <span style=color:#a6e22e>n</span>
</span></span></code></pre></div><p>上面的注释，解释了需要在指定路径下添加 kubesphere.yaml 启动 ks-apiserver 命令行。</p><p>我们接着往下撸，这里使用 cobra.Command 这个 package 来做命令行的集成：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>ServerRunOptions</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// NewAPIServer 通过给定的配置启动apiserver实例，绑定实例化的各组件的client</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这一步还通过AddToScheme来注册一些自定义的GVK到k8s，最终暴露为apis API</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 借助rest.Config和scheme 初始化runtimecache和runtimeClient </span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>apiserver</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>NewAPIServer</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PrepareRun 主要是使用resful-go集成kapis API</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 上一步绑定了各组件的client，这一步就可以调用各组件的client来访问对应组件的server端了</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 猜猜4.0后端可插拔架构会是什么样子的？</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>apiserver</span>.<span style=color:#a6e22e>PrepareRun</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 运行各种informers同步资源，并开始ks-apiserver监听请求</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>apiserver</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>s.NewAPIServer(ctx.Done()) 主要是创建一个 apiserver 实例。创建 apiserver 实例这一步，还通过 scheme 注册 ks 自定义的 GVK 到 K8s, 暴露为 apis 请求路径的 API。</p><p>PrepareRun 主要是使用 resful-go 框架集成了各子模块代理请求或集成服务， 暴露为 kapis 请求路径的 API 功能 。</p><p>apiserver.Run(ctx) 则是做了资源同步，并启动 server 监听。</p><p>下面分开阐述说明。</p><h3 id=newapiserver>NewAPIServer</h3><p>首先是绑定各种 client 和 informers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 调用各组件的NewForConfig方法整合clientset</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kubernetesClient</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>k8s</span>.<span style=color:#a6e22e>NewKubernetesClient</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesOptions</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>apiServer</span>.<span style=color:#a6e22e>KubernetesClient</span> = <span style=color:#a6e22e>kubernetesClient</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>informerFactory</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>informers</span>.<span style=color:#a6e22e>NewInformerFactories</span>(<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Kubernetes</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>KubeSphere</span>(),<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Istio</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Snapshot</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>ApiExtensions</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Prometheus</span>())
</span></span><span style=display:flex><span><span style=color:#a6e22e>apiServer</span>.<span style=color:#a6e22e>InformerFactory</span> = <span style=color:#a6e22e>informerFactory</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 根据kubesphere.yaml或者kubesphere-config configmap的配置来绑定ks组件的client</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>初始化绑定完毕后 , 会启动一个 server 来响应请求 , 所以这里会做一个 addr 绑定 :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Addr</span>: <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>InsecurePort</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>SecurePort</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>certificate</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>LoadX509KeyPair</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>TlsCertFile</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>TlsPrivateKey</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>TLSConfig</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Certificates</span>: []<span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Certificate</span>{<span style=color:#a6e22e>certificate</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>Addr</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>SecurePort</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scheme</span>.<span style=color:#a6e22e>Scheme</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apis</span>.<span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>sch</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;unable add APIs to scheme: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>注意这一步 apis.AddToScheme(sch), 将我们定义的 GVK 注册到 k8s 中。</p><p>顺带一提，GVK 指的是 Group,Version, Kind, 举个栗子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;namespaces&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;nodes&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;resourcequotas&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;tenant.kubesphere.io&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1alpha1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;workspaces&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;cluster.kubesphere.io&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1alpha1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;clusters&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Scheme 管理 GVK 和 Type 的关系 , 一个 GVK 只能对应一个 reflect.Type, 一个 reflect.Type 可能对应多个 GVK；此外，Scheme 还聚合了 converter 及 cloner, 用来转换不同版本的结构体和获取结构体值的拷贝；限于篇幅有限，感兴趣的童鞋可以深入探索下。</p><p>回归正文，下面我们看下怎么注入 scheme 的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// AddToSchemes may be used to add all resources defined in the project to a Schemevar AddToSchemes runtime.SchemeBuilder</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// AddToScheme adds all Resources to the Schemefunc </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Scheme</span>) <span style=color:#66d9ef>error</span> {	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>AddToSchemes</span>.<span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>s</span>)}
</span></span></code></pre></div><p>而 AddToSchemes 这个类型的是<code>[]func(*Scheme) error</code> 的别名，只需要在 package apis 下的接口文件中实现相应的 init() 方法来导入实现的版本 API，就可以注入 Scheme 中。</p><p>举个例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat pkg/apis/addtoscheme_dashboard_v1alpha2.go
</span></span><span style=display:flex><span>package apis
</span></span><span style=display:flex><span>import monitoringdashboardv1alpha2 <span style=color:#e6db74>&#34;kubesphere.io/monitoring-dashboard/api/v1alpha2&#34;</span>
</span></span><span style=display:flex><span>func init<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>	
</span></span><span style=display:flex><span>  AddToSchemes <span style=color:#f92672>=</span> append<span style=color:#f92672>(</span>AddToSchemes, monitoringdashboardv1alpha2.SchemeBuilder.AddToScheme<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>也就是，我们开发的插件集成的版本化资源，必须实现 xxx.SchemeBuilder.AddToScheme 功能，才能注册到 scheme 中，最终暴露为 apis 访问 API 服务。</p><p>至此，所有子模块对应的 client 已经与这个 apiserver 绑定。</p><h3 id=preparerun>PrepareRun</h3><p>下面，我们探讨下 PrepareRun 是怎么注册 kapis 以及绑定 handler 的。</p><p>主要是通过 restful-go 框架来实现的。</p><p>restful-go 框架使用 container 来 hold 住拥有特定 GVR 的 webservice, 一个 webserver 可以绑定多个 router，允许 container 或者 webserver 添加自定义拦截器，也就是调用 filter 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>APIServer</span>) <span style=color:#a6e22e>PrepareRun</span>(<span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// container来hold住拥有特定GVR的webservice</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span> = <span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>NewContainer</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加请求Request日志拦截器</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Filter</span>(<span style=color:#a6e22e>logRequestAndResponse</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Router</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>CurlyRouter</span>{})
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 发生Recover时，绑定一个日志handler</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>RecoverHandler</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>panicReason</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>httpWriter</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logStackOnRecover</span>(<span style=color:#a6e22e>panicReason</span>, <span style=color:#a6e22e>httpWriter</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 每个API组都构建一个webservice，然后根据路由规则来并绑定回调函数</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 通过AddToContainer来完成绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>installKubeSphereAPIs</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 注册metrics指标: ks_server_request_total、ks_server_request_duration_seconds</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 绑定metrics handler</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>installMetricsAPI</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 为有效请求增加监控计数</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Filter</span>(<span style=color:#a6e22e>monitorRequest</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>RegisteredWebServices</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;%s&#34;</span>, <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>RootPath</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Handler</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加各个调用链的拦截器, 用于验证和路由分发</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>buildHandlerChain</span>(<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面主要使用 restful-go 框架给 s.Server.handler 绑定了一个 container, 添加了各种拦截器。</p><p>在 s.installKubeSphereAPIS() 这一步安装 GVR 绑定了 kapis 代理，具体是这样实现的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 调用各api组的AddToContainer方法来向container注册kapi:</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>urlruntime</span>.<span style=color:#a6e22e>Must</span>(<span style=color:#a6e22e>monitoringv1alpha3</span>.<span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>Kubernetes</span>(), <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>MonitoringClient</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>MetricsClient</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>KubeSphere</span>(), <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>OpenPitrixOptions</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 详细来说，各个组件实现的AddToContainer方法</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 为带有GroupVersion信息的webserver添加route，不同路由路径绑定不同的handler</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NewWebService</span>(<span style=color:#a6e22e>GroupVersion</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// 给子路由绑定回调函数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Route</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/kubesphere&#34;</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>handleKubeSphereMetricsQuery</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Doc</span>(<span style=color:#e6db74>&#34;Get platform-level metric data.&#34;</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>(<span style=color:#a6e22e>restfulspec</span>.<span style=color:#a6e22e>KeyOpenAPITags</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>constants</span>.<span style=color:#a6e22e>KubeSphereMetricsTag</span>}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Writes</span>(<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>{}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Returns</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>respOK</span>, <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>{})).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Produces</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>MIME_JSON</span>)
</span></span></code></pre></div><p>我们知道 apis 对应 K8s 的请求，而在 ks 中 kapis 对应子组件的代理请求，由 ks-apiserver 自身或者转发目标组件 server 来提供响应，那么 ks-apiserver 是怎么区分这些请求的？</p><p>答案是通过 buildHandlerChain 来进行分发的。</p><h3 id=buildhandlerchain>buildHandlerChain</h3><p>上面说到 buildHandlerChain 构建了各种服务的拦截器，按序排列如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithKubeAPIServer</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>Config</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>errorResponder</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>AuditingOptions</span>.<span style=color:#a6e22e>Enable</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuditing</span>(<span style=color:#a6e22e>handler</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>audit</span>.<span style=color:#a6e22e>NewAuditing</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>AuditingOptions</span>, <span style=color:#a6e22e>stopCh</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuthorization</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>authorizers</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>MultiClusterOptions</span>.<span style=color:#a6e22e>Enable</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clusterDispatcher</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dispatch</span>.<span style=color:#a6e22e>NewClusterDispatch</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>.<span style=color:#a6e22e>KubeSphereSharedInformerFactory</span>().<span style=color:#a6e22e>Cluster</span>().<span style=color:#a6e22e>V1alpha1</span>().<span style=color:#a6e22e>Clusters</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithMultipleClusterDispatcher</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>clusterDispatcher</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuthentication</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>authn</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithRequestInfo</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>requestInfoResolver</span>)
</span></span></code></pre></div><p>WithRequestInfo 这个 filter 定义了如下逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>info</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>NewRequestInfo</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestInfoFactory</span>) <span style=color:#a6e22e>NewRequestInfo</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RequestInfo</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>APIPrefix</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>currentParts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>splitPath</span>(<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>Path</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>//Proxy discovery API</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>currentParts</span>) &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>prefix</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过api路由路径中的携带apis还是kapis就可以区分</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kubernetesAPIPrefixes</span>.<span style=color:#a6e22e>Has</span>(<span style=color:#a6e22e>prefix</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>IsKubernetesRequest</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// URL forms: /clusters/{cluster}/*</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;clusters&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>Cluster</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>currentParts</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码很多，我就不一一截图了，大概意思可以从注释看到：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// NewRequestInfo returns the information from the http request.  If error is not nil, RequestInfo holds the information as best it is known before the failure</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// It handles both resource and non-resource requests and fills in all the pertinent information for each.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Valid Inputs:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /apis/{api-group}/{version}/namespaces</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Special verbs without subresources:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/proxy/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/proxy/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Special verbs with subresources:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/watch/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/watch/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/workspaces/{workspace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// With workspaces:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/clusters/{cluster}/{api-group}/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/clusters/{cluster}/{api-group}/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span></code></pre></div><p>通过路由定义的信息，就可以区分这个请求是什么级别的，以及这个请求要分发到哪个 server 了。</p><p>我们给各个 filter 的回调函数加上断点， 然后做个小实验看下拦截器的拦截顺序是怎样的。</p><p>假设远程云主机的服务已经启动，服务端口在 9090，以及你为 anonymous 这个 globalrole 设定了 monitoring.kubesphere.io 这个组下资源类型为 ClusterDashboard 的访问权限。当然了，你也可以用有访问权限的账号来直接测试。</p><p>接下来，我们来发送一个 kapis 请求，看这个链路怎么跳跃的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#e6db74>&#39;{&#34;grafanaDashboardUrl&#34;:&#34;https://grafana.com/api/dashboards/7362/revisions/5/download&#34;, &#34;description&#34;:&#34;this is a test dashboard.&#34;}&#39;</span> -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> localhost:9090/kapis/monitoring.kubesphere.io/v1alpha3/clusterdashboards/test1/template
</span></span></code></pre></div><p>测试结果如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WithRequestInfo -&gt; WithAuthentication -&gt; WithAuthorization -&gt; WithKubeAPIServer
</span></span></code></pre></div><h3 id=run>Run</h3><p>这个方法主要干了两件事，一是启动 informers 同步资源 , 二是启动 ks apiserver。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>APIServer</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 启动informer工厂，包括k8s和ks的informers</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 同步资源，包括k8s和ks的GVR</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查GVR是否存在，不存在报错警告，存在就同步</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waitForResourceSync</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>shutdownCtx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>shutdownCtx</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 启动server</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>0</span>).<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Start listening on %s&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>TLSConfig</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>ListenAndServeTLS</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>ListenAndServe</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>至此，调用完 Run 方法后，ks-apiserver 就启动了。</p><p>现在我们做一下简单总结：</p><ul><li>根据配置文件创建 ks-apiserver 实例 , 该实例调用了三个关键方法，分别是 NewAPIServer、PrepareRun 以及 Run 方法；</li><li>NewAPIServer 通过给定的配置，绑定各个模块的 client，将自定义的 GVK 注册到 Scheme，暴露 apis 路由服务；</li><li>PrepareRun 通过 restful-go 框架来注册、绑定 kapi 路由和回调函数，用来自身响应或者下发组件 server 查询合并数据返回给客户端 ;</li><li>最后 , 调用 Run 方法，同步资源并启动 ks-apiserver 服务；</li></ul><h2 id=gvk-探索实战>GVK 探索实战</h2><p>显然，我们只需要关注各模块的 AddToContainer 方法就行了。</p><h3 id=iamkubesphereio>iam.kubesphere.io</h3><blockquote><p>pkg/kapis/iam/v1alpha2/register.go</p></blockquote><p>从代码注释来看，这个模块管理着 users、clustermembers、globalroles、clusterroles、workspaceroles、roles、workspaces groups 、workspace members、devops members 等账号角色的 CRUD。</p><p>现在我们可以在 handler 中打上断点，去请求这些 api。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/users&#34;</span>
</span></span><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/clustermembers&#34;</span>
</span></span><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/users/admin/globalroles&#34;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=kubeedgekubesphereio>kubeedge.kubesphere.io</h3><blockquote><p>pkg/kapis/kubeedge/v1alpha1/register.go</p></blockquote><p>代码里面使用的代理转发请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>container</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#a6e22e>endpoint</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>generic</span>.<span style=color:#a6e22e>NewGenericProxy</span>(<span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>GroupVersion</span>.<span style=color:#a6e22e>Group</span>, <span style=color:#a6e22e>GroupVersion</span>.<span style=color:#a6e22e>Version</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>container</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也就是 kapis/kubeedge.kubesphere.io 的请求会转发到 <a href=http://edge-watcher.kubeedge.svc/api/ target=_blank rel="noopener noreferrer">http://edge-watcher.kubeedge.svc/api/</a>，也就是 kubeedge 这个 namespace 下的 service，相关的接口集成在那里。</p><p>关于整合边缘计算平台的集成，除了需要做一个主流边缘框架的快速安装和集成外，还可以集成一个类似 edge-shim 的适配器，大概需要从一下几个方面考虑：</p><ul><li>代理 endpoint: 现在的 kubeedge 就是使用代理模式转发；</li><li>健康检查接口：至少要确保云端的组件已经成功部署；</li><li>事件、长期日志、审计等可观测组件的支持；</li><li>其他边缘辅助功能，如文件或者配置下发等；</li></ul><h3 id=notificationkubesphereio>notification.kubesphere.io</h3><blockquote><p>pkg/kapis/notification/v2beta1/register.go</p></blockquote><p>这个组下的 api 主要实现了 notification 的全局或租户级别的 config 和 receivers 资源的 CRUD。</p><p>config 资源</p><blockquote><p>用于配置对接通知渠道相关参数的一些配置，分为全局的和租户级别的 config 资源；</p></blockquote><p>reciever 资源</p><blockquote><p>用于配置接收者的一些配置信息，区分全局的和租户级别的接收者；</p></blockquote><p>我们挑选一个回调函数进行剖析：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Route</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/{resources}&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>ListResource</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Doc</span>(<span style=color:#e6db74>&#34;list the notification configs or receivers&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Metadata</span>(<span style=color:#a6e22e>KeyOpenAPITags</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>constants</span>.<span style=color:#a6e22e>NotificationTag</span>}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;resources&#34;</span>, <span style=color:#e6db74>&#34;known values include configs, receivers, secrets&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterName</span>, <span style=color:#e6db74>&#34;name used for filtering&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterLabelSelector</span>, <span style=color:#e6db74>&#34;label selector used for filtering&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#e6db74>&#34;type&#34;</span>, <span style=color:#e6db74>&#34;config or receiver type, known values include dingtalk, email, slack, webhook, wechat&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterPage</span>, <span style=color:#e6db74>&#34;page&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>DataFormat</span>(<span style=color:#e6db74>&#34;page=%d&#34;</span>).<span style=color:#a6e22e>DefaultValue</span>(<span style=color:#e6db74>&#34;page=1&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterLimit</span>, <span style=color:#e6db74>&#34;limit&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterAscending</span>, <span style=color:#e6db74>&#34;sort parameters, e.g. ascending=false&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>DefaultValue</span>(<span style=color:#e6db74>&#34;ascending=false&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterOrderBy</span>, <span style=color:#e6db74>&#34;sort parameters, e.g. orderBy=createTime&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Returns</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>{<span style=color:#a6e22e>Items</span>: []<span style=color:#66d9ef>interface</span>{}{}}))
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>handler</span>) <span style=color:#a6e22e>ListResource</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 租户或用户的名称</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 资源类型，configs/recievers/secrets</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resource</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;resources&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 通知渠道 dingtalk/slack/email/webhook/wechat</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subresource</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#e6db74>&#34;type&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParseQueryParameter</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>operator</span>.<span style=color:#a6e22e>IsKnownResource</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleBadRequest</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>servererr</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;unknown resource type %s/%s&#34;</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>operator</span>.<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>, <span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handleResponse</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>objs</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们看下 list object 的逻辑：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// List objects.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>operator</span>) <span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> = <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果没有给定租户的名称，则获取全局的对象</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isConfig</span>(<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>GetObject</span>(<span style=color:#a6e22e>resource</span>)) {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// type=default对config资源来说是全局的</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=default&#34;</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// type=global对receiever资源来说是全局的</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=global&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 否则就给过滤器绑定租户名称</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=tenant,user=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 组装过滤标签</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> = <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>filter</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 通过过滤标签获取cluster或者namespace下的指定资源</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>resourceGetter</span>.<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>ns</span>, <span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>subresource</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Secret</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>{}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样一来，就实现了租户级别的通知告警 CR 配置的 CRUD，这些 CR 是这么分类的：</p><ul><li>config 分为全局 type = default, 租户 type = tenant 两种级别；</li><li>reciever 分为全局 type = global, 租户 type = tenant 两种级别；</li></ul><p>那么 config 和 reciever 怎么相互绑定、告警是如何通过渠道给租户发消息的？</p><blockquote><p><a href=https://github.com/kubesphere/notification-manager/blob/master/pkg/webhook/v1/handler.go#L45 target=_blank rel="noopener noreferrer">https://github.com/kubesphere/notification-manager/blob/master/pkg/webhook/v1/handler.go#L45</a></p><p><a href=https://github.com/kubesphere/notification-manager/blob/master/pkg/notify/notify.go#L66 target=_blank rel="noopener noreferrer">https://github.com/kubesphere/notification-manager/blob/master/pkg/notify/notify.go#L66</a></p></blockquote><p>notification-manager 简称 nm，我这里断章取义地简要回答一下。</p><p>功能方面：</p><ul><li>全局配置 reciever 通过配置的渠道将所有的 alerts 发送给其定义好的接收者名单， 配置了租户信息的 reciever 只能通过渠道发送当前 ns 下的 alerts；</li><li>reciever 中可以通过配置 alertSelector 参数来进一步过滤告警消息；</li><li>通过修改名为 notification-manager-template 的 confimap 来定制发送消息模板；</li></ul><p>告警到通知的流程：</p><ul><li>nm 使用端口 19093 和 API 路径 /api/v2/alerts 接收从 Alertmanager 发送的告警 ;</li><li>回调函数接受 alerts 转换为 notification 模板数据，按照 namespace 区分告警数据；</li><li>遍历所有 Recievers，每个 ns 下启动一个协程来发送消息， 而这里每个 ns 对应着多个通知渠道，因此也使用 waitgroup 来并发编排完成任务；</li></ul><h3 id=monitoringkubesphereio>monitoring.kubesphere.io</h3><blockquote><p>pkg/kapis/monitoring/v1alpha3/register.go</p></blockquote><p>将监控指标分为平台级、节点级、workspaces、namespaces、pods 等级别，不仅可以获取总的统计，还能获取 nodes/namespaces/workspaces 下的所有 pods/containers 等监控指标。</p><p>我们查看回调函数，以 handleNamedMetricsQuery 为例分析：</p><ul><li>遍历给定指标级别下的合法 metric 指标，根据请求参数中 metricFilter 的来过滤指标名；</li><li>判断为范围查询还是实时查询，来调取 monitoring 包中相关方法，通过对应的 client 请求后端获取结果返回；</li></ul><p>代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>handler</span>) <span style=color:#a6e22e>handleNamedMetricsQuery</span>(<span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>q</span> <span style=color:#a6e22e>queryOptions</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>res</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>metrics</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// q.namedMetrics 是一组按照监控指标级别分类好的拥有promsql expr定义的完整指标名数组</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 监控指标级别分类是根据 monitoring.Levelxxx在上一个栈里细分的，i.e: monitoring.LevelPod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>metric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>namedMetrics</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>metric</span>, <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>MetricMeterPrefix</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// skip meter metric</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 根据请求参数中的指标名来过滤</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MatchString</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>metricFilter</span>, <span style=color:#a6e22e>metric</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>metrics</span> = append(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>metric</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>metrics</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断是否是范围查询还是实时查询，继续调用相关函数</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 主要还是用prometheus client去查询promsql, 边缘节点的指标目前通过metrics server来查询</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>isRangeQuery</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>option</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>GetNamedMetrics</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>time</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>option</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>shouldSort</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>res</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>order</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>identifier</span>).<span style=color:#a6e22e>Page</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>limit</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在，我们将视角移植到 :</p><blockquote><p>pkg/models/monitoring/monitoring.go:156</p></blockquote><p>以 GetNamedMetricsOverTime 为例，这里阐述了会合并 prometheus 和 metrics-server 的查询结果进行返回：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mo</span> <span style=color:#a6e22e>monitoringOperator</span>) <span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>step</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>opt</span> <span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>QueryOption</span>) <span style=color:#a6e22e>Metrics</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取prometheus client查询结果，主要使用sync.WaitGroup并发查询，每个指标启动一个goroutine，最后将结果和并返回</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果metrics-server激活了</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>metricsserver</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//合并边缘节点数据</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>edgeMetrics</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>MetricData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>ressMetric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ress</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>metricName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ressMetric</span>.<span style=color:#a6e22e>MetricName</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ressMetricValues</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ressMetric</span>.<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>ressMetricValues</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// this metric has no prometheus metrics data</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>edgeMetrics</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// start to request monintoring metricsApi data</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>mr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>metricsserver</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>mrMetric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>mr</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>edgeMetrics</span>[<span style=color:#a6e22e>mrMetric</span>.<span style=color:#a6e22e>MetricName</span>] = <span style=color:#a6e22e>mrMetric</span>.<span style=color:#a6e22e>MetricData</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>edgeMetrics</span>[<span style=color:#a6e22e>metricName</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ress</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span> = append(<span style=color:#a6e22e>ress</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span>, <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>MetricValues</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Metrics</span>{<span style=color:#a6e22e>Results</span>: <span style=color:#a6e22e>ress</span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，monitoring 包还定义了各监控查询 client 的接口方法，可以按需探索：</p><ul><li><p>GetMetric(expr string, time time.Time) Metric</p></li><li><p>GetMetricOverTime(expr string, start, end time.Time, step time.Duration) Metric</p></li><li><p><code>GetNamedMetrics(metrics []string, time time.Time, opt QueryOption) []Metric</code></p></li><li><p><code>GetNamedMetricsOverTime(metrics []string, start, end time.Time, step time.Duration, opt QueryOption) []Metric</code></p></li><li><p><code>GetMetadata(namespace string) []Metadata</code></p></li><li><p><code>GetMetricLabelSet(expr string, start, end time.Time) []map[string]string</code></p></li></ul><h3 id=tenantkubesphereio>tenant.kubesphere.io</h3><p>再聊 api 之前，顺带一提多租户在隔离的安全程度上，我们可以将其分为软隔离 (Soft Multi-tenancy) 和硬隔离 (Hard Multi-tenancy) 两种。</p><ul><li>软隔离更多的是面向企业内部的多租需求；</li><li>硬隔离面向的更多是对外提供服务的服务供应商，需要更严格的隔离作为安全保障。</li></ul><p>这个 group 下比较重要的部分是实现租户查询 logs/audits/events：</p><p>以查询日志为例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tenantHandler</span>) <span style=color:#a6e22e>QueryLogs</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询上下文中携带的租户信息</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>UserFrom</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot obtain user info&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleForbidden</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解析查询的参数，比如确定属于哪个ns/workload/pod/container的查询、时间段，是否为柱状查询等</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>queryParam</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>loggingv1alpha2</span>.<span style=color:#a6e22e>ParseQueryParameter</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 导出数据</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>queryParam</span>.<span style=color:#a6e22e>Operation</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>loggingv1alpha2</span>.<span style=color:#a6e22e>OperationExport</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>HEADER_ContentType</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Disposition&#34;</span>, <span style=color:#e6db74>&#34;attachment&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 验证账号是否有权限</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// admin账号可以导出所有ns的日志，租户只能导出本ns的日志</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 组装loggingclient进行日志导出</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>tenant</span>.<span style=color:#a6e22e>ExportLogs</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>queryParam</span>, <span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 验证账号是否有权限</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// admin账号可以查看所有ns的日志，租户只能查看本ns的日志</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 组装loggingclient进行日志返回</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>tenant</span>.<span style=color:#a6e22e>QueryLogs</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>queryParam</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>由于篇幅有限，只对以上 GVR 进行了调试，感兴趣可以深入了解~</p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&text=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&title=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&t=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#前提>前提</a></li><li><a href=#配置-launch-文件>配置 launch 文件</a></li><li><a href=#ks-apiserver-调试依赖文件>ks-apiserver 调试依赖文件</a></li><li><a href=#启动-ks-apiserver>启动 ks-apiserver</a><ul><li><a href=#newapiserver>NewAPIServer</a></li><li><a href=#preparerun>PrepareRun</a></li><li><a href=#buildhandlerchain>buildHandlerChain</a></li><li><a href=#run>Run</a></li></ul></li><li><a href=#gvk-探索实战>GVK 探索实战</a><ul><li><a href=#iamkubesphereio>iam.kubesphere.io</a></li><li><a href=#kubeedgekubesphereio>kubeedge.kubesphere.io</a></li><li><a href=#notificationkubesphereio>notification.kubesphere.io</a></li><li><a href=#monitoringkubesphereio>monitoring.kubesphere.io</a></li><li><a href=#tenantkubesphereio>tenant.kubesphere.io</a></li></ul></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>