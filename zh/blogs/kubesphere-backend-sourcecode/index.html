<!doctype html><html lang=en-US><head><meta charset=utf-8><title>KubeSphere åç«¯æºç æ·±åº¦è§£æ</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†å­¦ä¹ åœ¨ vscode ä¸Šçš„ ssh remote æ’ä»¶åŸºç¡€ä¸Šï¼Œå°è¯• debug å’Œå­¦ä¹  KubeSphere åç«¯æ¨¡å—æ¶æ„ã€‚"><meta name=keywords content="KubeSphere,åç«¯æºç ,Kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="KubeSphere åç«¯æºç æ·±åº¦è§£æ"><meta property="og:description" content="è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†å­¦ä¹ åœ¨ vscode ä¸Šçš„ ssh remote æ’ä»¶åŸºç¡€ä¸Šï¼Œå°è¯• debug å’Œå­¦ä¹  KubeSphere åç«¯æ¨¡å—æ¶æ„ã€‚"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/KubeSphere-backend-sourcecode.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-backend-sourcecode/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/KubeSphere-backend-sourcecode.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-backend-sourcecode/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>ğŸš€ KubeSphere v4.1.3 å‘å¸ƒï¼Œå¤šé¡¹ä¼˜åŒ–ä¸æ”¹è¿›ï¼Œæ¬¢è¿ä½“éªŒï¼<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">è¯·æŸ¥çœ‹ Release notes â†’</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>åº”ç”¨åœºæ™¯</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>æ‹¥æŠ±ä¸€ç«™å¼ DevOps å·¥ä½œæµ</a></li><li><a href=/zh/service-mesh/>åœ¨ Kubernetes è¿è¡Œå¾®æœåŠ¡</a></li><li><a href=/zh/observability/>æ„å»ºä¸°å¯Œçš„äº‘åŸç”Ÿå¯è§‚æµ‹æ€§</a></li></ul></li><li class=menu-li><span class=menu-span>èµ„æº</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>å¼€æºé¡¹ç›®</a></li><li><a href=/zh/conferences/>å¼€æºå³°ä¼š</a></li><li><a href=/zh/blogs/>æŠ€æœ¯åšå®¢</a></li><li><a href=/zh/videos/>è§†é¢‘èµ„æº</a></li><li><a href=/zh/learn/>äº‘åŸç”Ÿå®æˆ˜</a></li></ul></li><li class=menu-li><span class=menu-span>æ–‡æ¡£ä¸­å¿ƒ</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">æ‰©å±•ç»„ä»¶å¼€å‘</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>å¼€æºç¤¾åŒº</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>å‚ä¸è´¡çŒ®</a></li><li><a href=/zh/live/>ç¤¾åŒºæ´»åŠ¨</a></li><li><a href=/zh/case/>æ¡ˆä¾‹å­¦ä¹ </a></li><li><a href=/zh/partner/>åˆä½œä¼™ä¼´</a></li><li><a href=/zh/user-group/>ç”¨æˆ·å§”å‘˜ä¼š</a></li><li><a href=/zh/news/>åŠ¨æ€</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">ç‰ˆæœ¬è®¡åˆ’</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">ä¸­å›½ç«™</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">å¼€æºä¹‹å¤ 2025</a></li></ul></li><li><a data-docs=ç”¨æˆ·è®ºå› href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">ç”¨æˆ·è®ºå›</a></li><li><a data-docs=è®¤è¯ href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">è®¤è¯</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>ç®€ä½“ä¸­æ–‡</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-backend-sourcecode/")'>ç®€ä½“ä¸­æ–‡</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>åº”ç”¨åœºæ™¯</span><ul class=dropdown-menu><li><a href=/zh/devops/>æ‹¥æŠ±ä¸€ç«™å¼ DevOps å·¥ä½œæµ</a></li><li><a href=/zh/service-mesh/>åœ¨ Kubernetes è¿è¡Œå¾®æœåŠ¡</a></li><li><a href=/zh/observability/>æ„å»ºä¸°å¯Œçš„äº‘åŸç”Ÿå¯è§‚æµ‹æ€§</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>èµ„æº</span><ul class=dropdown-menu><li><a href=/zh/projects/>å¼€æºé¡¹ç›®</a></li><li><a href=/zh/conferences/>å¼€æºå³°ä¼š</a></li><li><a href=/zh/blogs/>æŠ€æœ¯åšå®¢</a></li><li><a href=/zh/videos/>è§†é¢‘èµ„æº</a></li><li><a href=/zh/learn/>äº‘åŸç”Ÿå®æˆ˜</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>æ–‡æ¡£ä¸­å¿ƒ</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>æ‰©å±•ç»„ä»¶å¼€å‘</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>å¼€æºç¤¾åŒº</span><ul class=dropdown-menu><li><a href=/zh/contribution/>å‚ä¸è´¡çŒ®</a></li><li><a href=/zh/live/>ç¤¾åŒºæ´»åŠ¨</a></li><li><a href=/zh/case/>æ¡ˆä¾‹å­¦ä¹ </a></li><li><a href=/zh/partner/>åˆä½œä¼™ä¼´</a></li><li><a href=/zh/user-group/>ç”¨æˆ·å§”å‘˜ä¼š</a></li><li><a href=/zh/news/>åŠ¨æ€</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>ç‰ˆæœ¬è®¡åˆ’</a></li><li><a href=https://www.kubesphere.io/zh/>ä¸­å›½ç«™</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>å¼€æºä¹‹å¤ 2025</a></li></ul></li><li><a data-docs=ç”¨æˆ·è®ºå› href=https://ask.kubesphere.io/forum>ç”¨æˆ·è®ºå›</a></li><li><a data-docs=è®¤è¯ href=https://kubesphere.cloud/certification/>è®¤è¯</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>æŠ€æœ¯åšå®¢</a> > </span><span>KubeSphere åç«¯æºç æ·±åº¦è§£æ</span></div><div class='main-div middle-div'><div class=author>æœ±å«</div><span class=date>å‘å¸ƒäºï¼š2022-01-19</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>æœ¬æ–‡æ€»é˜…è¯»é‡ï¼š<span id=busuanzi_value_page_pv></span></span><h1>KubeSphere åç«¯æºç æ·±åº¦è§£æ</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&text=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&title=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&t=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†å­¦ä¹ åœ¨ vscode ä¸Šçš„ ssh remote æ’ä»¶åŸºç¡€ä¸Šï¼Œå°è¯• debug å’Œå­¦ä¹  KubeSphere åç«¯æ¨¡å—æ¶æ„ã€‚</p><h2 id=å‰æ>å‰æ</h2><ul><li>å®‰è£…å¥½ vscode ä»¥åŠ ssh remote container æ’ä»¶ï¼›</li><li>åœ¨è¿œç¨‹ä¸»æœºä¸Šå®‰è£…å¥½ kubenertes å®¹å™¨ " æ“ä½œç³»ç»Ÿ " å’Œ KubeSphere >= v3.1.0 äº‘â€œæ§åˆ¶é¢æ¿â€ï¼›</li><li>å®‰è£… go >=1.16;</li><li>åœ¨ KubeSphere ä¸Šå®‰è£…äº†éœ€è¦ debug çš„ KubeSphere ç»„ä»¶ï¼Œå¦‚ devopsã€kubeedge æˆ–è€… whatever, å¦‚æœæ˜¯é»˜è®¤æ¿€æ´»çš„ç»„ä»¶ï¼Œåƒ monitoringï¼Œä¸éœ€è¦å»æ¿€æ´»ã€‚</li></ul><h2 id=é…ç½®-launch-æ–‡ä»¶>é…ç½® launch æ–‡ä»¶</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#960050;background-color:#1e0010>cat</span> <span style=color:#960050;background-color:#1e0010>.vscode/launch.json</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;0.2.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;configurations&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;ks-apiserver&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;go&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;request&#34;</span>: <span style=color:#e6db74>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;mode&#34;</span>: <span style=color:#e6db74>&#34;auto&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;program&#34;</span>: <span style=color:#e6db74>&#34;${workspaceFolder}/cmd/ks-apiserver/apiserver.go&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ks-apiserver-è°ƒè¯•ä¾èµ–æ–‡ä»¶>ks-apiserver è°ƒè¯•ä¾èµ–æ–‡ä»¶</h2><p>åœ¨ç›¸å¯¹è·¯å¾„ cmd/ks-apiserver/ ä¸‹é…ç½® kubesphere.yamlã€‚</p><p>é¦–å…ˆï¼ŒæŸ¥çœ‹é›†ç¾¤ä¹‹ä¸­çš„ cm é…ç½®æ–‡ä»¶ :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n kubesphere-system get cm kubesphere-config -oyaml
</span></span></code></pre></div><p>å› ä¸ºä¸Šè¿° configmap ä¸­å·®å°‘ kubeconfig ç›¸å…³é…ç½®ï¼Œæ‰€ä»¥éœ€è¦å°†ä¸Šè¿° yaml æ–‡ä»¶æ‹·è´å‡ºæ¥æ•´åˆä»¥ä¸‹ã€‚</p><p>ä¸ºå•¥è¦ç”¨æ·»åŠ  kubeconfig æ–‡ä»¶ï¼Ÿ</p><p>ä¸»è¦æ˜¯å› ä¸º K8s åœ¨åˆ›å»º client æ—¶éœ€è¦è¿™ä¹ˆä¸€ä¸ªæ–‡ä»¶ , è€Œå®¹å™¨ä¸­ä¼šç”¨åˆ° inclusterconfig å°±ä¸éœ€è¦æ·»åŠ äº†ã€‚</p><p>æ„Ÿå…´è¶£å¯ä»¥çœ‹ä¸‹ client-go çš„ä¾‹å­ï¼š</p><blockquote><p><a href=https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration/main.go#L41 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/client-go/blob/master/examples/in-cluster-client-configuration/main.go#L41</a></p><p><a href=https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration/main.go#L53 target=_blank rel="noopener noreferrer">https://github.com/kubernetes/client-go/blob/master/examples/out-of-cluster-client-configuration/main.go#L53</a></p></blockquote><p>æ‰€ä»¥å®Œæ•´çš„é…ç½®å¯åŠ¨æ–‡ä»¶å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>$ cat ./cmd/ks-apiserver/kubesphere.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kubernetes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubeconfig</span>: <span style=color:#e6db74>&#34;/root/.kube/config&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>master</span>: <span style=color:#ae81ff>https://192.168.88.6:6443</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>$qps</span>: <span style=color:#ae81ff>1e+06</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>burst</span>: <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>authentication</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticateRateLimiterMaxTries</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>authenticateRateLimiterDuration</span>: <span style=color:#ae81ff>10m0s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>loginHistoryRetentionPeriod</span>: <span style=color:#ae81ff>168h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>maximumClockSkew</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>multipleLogin</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubectlImage</span>: <span style=color:#ae81ff>kubesphere/kubectl:v1.20.0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jwtSecret</span>: <span style=color:#e6db74>&#34;Xtc8ZWUf9f3cJN89bglrTJhfUPMZR87d&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>oauthOptions</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>clients</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kubesphere</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>secret</span>: <span style=color:#ae81ff>kubesphere</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>redirectURIs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;*&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ippoolType</span>: <span style=color:#ae81ff>none</span>
</span></span><span style=display:flex><span><span style=color:#f92672>monitoring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>enableGPUMonitoring</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>gpu</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kinds</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>resourceName</span>: <span style=color:#ae81ff>nvidia.com/gpu</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>resourceType</span>: <span style=color:#ae81ff>GPU</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>default</span>: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>notification</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://notification-manager-svc.kubesphere-monitoring-system.svc:19093</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>kubeedge</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://edge-watcher.kubeedge.svc/api/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>gateway</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>watchesPath</span>: <span style=color:#ae81ff>/var/helm-charts/watches.yaml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>kubesphere-controls-system</span>
</span></span></code></pre></div><p>é™¤äº† kubernetes, ç¬¬ä¸€å±‚çš„ key è¡¨ç¤ºæˆ‘ä»¬é›†ç¾¤ä¸­å·²ç»æŒ‰ç…§æˆ–è€…é»˜è®¤æ¿€æ´»çš„ KubeSphere ç»„ä»¶ï¼Œç°åœ¨å°±å¯ä»¥é€šè¿‡ F5 æ¥å¯åŠ¨ debug äº†ã€‚</p><p>åœ¨ debug ä¹‹å‰ï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶ä¸ºå•¥è¦æ”¾åœ¨ /cmd/ks-apiserver/kubesphere.yaml?</p><p>æˆ‘ä»¬å…ˆæ¥æ¢ç´¢ä¸€æ³¢ ks-apiserver çš„è¿è¡Œé€»è¾‘ã€‚</p><h2 id=å¯åŠ¨-ks-apiserver>å¯åŠ¨ ks-apiserver</h2><p>æŸ¥çœ‹ cmd/ks-apiserver/app/server.go çš„é€»è¾‘ :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Load configuration from file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conf</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apiserverconfig</span>.<span style=color:#a6e22e>TryLoadFromDisk</span>()
</span></span></code></pre></div><p>TryLoadFromDisk çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetConfigName</span>(<span style=color:#a6e22e>defaultConfigurationName</span>) <span style=color:#75715e>// kubesphere</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AddConfigPath</span>(<span style=color:#a6e22e>defaultConfigurationPath</span>) <span style=color:#75715e>// /etc/kubesphere</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load from current working directory, only used for debugging</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AddConfigPath</span>(<span style=color:#e6db74>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load from Environment variables</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetEnvPrefix</span>(<span style=color:#e6db74>&#34;kubesphere&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>AutomaticEnv</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>SetEnvKeyReplacer</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReplacer</span>(<span style=color:#e6db74>&#34;.&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸Šé¢ä¸€é¡¿é…ç½®ä¹‹åï¼Œå•æ­¥è°ƒè¯•ï¼ŒReadInConfigè¿™ä¸€æ­¥è¯»å–çš„æ–‡ä»¶è·¯å¾„æ˜¯	</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// v.configPathsï¼š[&#34;/etc/kubesphere&#34;,&#34;/root/go/src/kubesphere.io/kubesphere/cmd/ks-apiserver&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>ReadInConfig</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>ConfigFileNotFoundError</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error parsing configuration file %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>conf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>New</span>() <span style=color:#75715e>// åˆå§‹åŒ–å„ç»„ä»¶é…ç½®</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä»è¯»å–çš„å®é™…è·¯å¾„é…ç½®æ–‡ä»¶æ¥ååºåˆ—åŒ–åˆ°confè¿™ä¸ªstruct</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>viper</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>conf</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>conf</span>, <span style=color:#a6e22e>n</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„æ³¨é‡Šï¼Œè§£é‡Šäº†éœ€è¦åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ·»åŠ  kubesphere.yaml å¯åŠ¨ ks-apiserver å‘½ä»¤è¡Œã€‚</p><p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹æ’¸ï¼Œè¿™é‡Œä½¿ç”¨ cobra.Command è¿™ä¸ª package æ¥åšå‘½ä»¤è¡Œçš„é›†æˆï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>ServerRunOptions</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// NewAPIServer é€šè¿‡ç»™å®šçš„é…ç½®å¯åŠ¨apiserverå®ä¾‹ï¼Œç»‘å®šå®ä¾‹åŒ–çš„å„ç»„ä»¶çš„client</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¿™ä¸€æ­¥è¿˜é€šè¿‡AddToSchemeæ¥æ³¨å†Œä¸€äº›è‡ªå®šä¹‰çš„GVKåˆ°k8sï¼Œæœ€ç»ˆæš´éœ²ä¸ºapis API</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å€ŸåŠ©rest.Configå’Œscheme åˆå§‹åŒ–runtimecacheå’ŒruntimeClient </span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>apiserver</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>NewAPIServer</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// PrepareRun ä¸»è¦æ˜¯ä½¿ç”¨resful-goé›†æˆkapis API</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¸Šä¸€æ­¥ç»‘å®šäº†å„ç»„ä»¶çš„clientï¼Œè¿™ä¸€æ­¥å°±å¯ä»¥è°ƒç”¨å„ç»„ä»¶çš„clientæ¥è®¿é—®å¯¹åº”ç»„ä»¶çš„serverç«¯äº†</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// çŒœçŒœ4.0åç«¯å¯æ’æ‹”æ¶æ„ä¼šæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>apiserver</span>.<span style=color:#a6e22e>PrepareRun</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è¿è¡Œå„ç§informersåŒæ­¥èµ„æºï¼Œå¹¶å¼€å§‹ks-apiserverç›‘å¬è¯·æ±‚</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>apiserver</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>s.NewAPIServer(ctx.Done()) ä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ª apiserver å®ä¾‹ã€‚åˆ›å»º apiserver å®ä¾‹è¿™ä¸€æ­¥ï¼Œè¿˜é€šè¿‡ scheme æ³¨å†Œ ks è‡ªå®šä¹‰çš„ GVK åˆ° K8s, æš´éœ²ä¸º apis è¯·æ±‚è·¯å¾„çš„ APIã€‚</p><p>PrepareRun ä¸»è¦æ˜¯ä½¿ç”¨ resful-go æ¡†æ¶é›†æˆäº†å„å­æ¨¡å—ä»£ç†è¯·æ±‚æˆ–é›†æˆæœåŠ¡ï¼Œ æš´éœ²ä¸º kapis è¯·æ±‚è·¯å¾„çš„ API åŠŸèƒ½ ã€‚</p><p>apiserver.Run(ctx) åˆ™æ˜¯åšäº†èµ„æºåŒæ­¥ï¼Œå¹¶å¯åŠ¨ server ç›‘å¬ã€‚</p><p>ä¸‹é¢åˆ†å¼€é˜è¿°è¯´æ˜ã€‚</p><h3 id=newapiserver>NewAPIServer</h3><p>é¦–å…ˆæ˜¯ç»‘å®šå„ç§ client å’Œ informers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// è°ƒç”¨å„ç»„ä»¶çš„NewForConfigæ–¹æ³•æ•´åˆclientset</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>kubernetesClient</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>k8s</span>.<span style=color:#a6e22e>NewKubernetesClient</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesOptions</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>apiServer</span>.<span style=color:#a6e22e>KubernetesClient</span> = <span style=color:#a6e22e>kubernetesClient</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>informerFactory</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>informers</span>.<span style=color:#a6e22e>NewInformerFactories</span>(<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Kubernetes</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>KubeSphere</span>(),<span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Istio</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Snapshot</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>ApiExtensions</span>(), <span style=color:#a6e22e>kubernetesClient</span>.<span style=color:#a6e22e>Prometheus</span>())
</span></span><span style=display:flex><span><span style=color:#a6e22e>apiServer</span>.<span style=color:#a6e22e>InformerFactory</span> = <span style=color:#a6e22e>informerFactory</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ ¹æ®kubesphere.yamlæˆ–è€…kubesphere-config configmapçš„é…ç½®æ¥ç»‘å®šksç»„ä»¶çš„client</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>åˆå§‹åŒ–ç»‘å®šå®Œæ¯•å , ä¼šå¯åŠ¨ä¸€ä¸ª server æ¥å“åº”è¯·æ±‚ , æ‰€ä»¥è¿™é‡Œä¼šåšä¸€ä¸ª addr ç»‘å®š :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Addr</span>: <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>InsecurePort</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>SecurePort</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>certificate</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>LoadX509KeyPair</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>TlsCertFile</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>TlsPrivateKey</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>TLSConfig</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Certificates</span>: []<span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Certificate</span>{<span style=color:#a6e22e>certificate</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>Addr</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;:%d&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>GenericServerRunOptions</span>.<span style=color:#a6e22e>SecurePort</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scheme</span>.<span style=color:#a6e22e>Scheme</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>apis</span>.<span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>sch</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;unable add APIs to scheme: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>æ³¨æ„è¿™ä¸€æ­¥ apis.AddToScheme(sch), å°†æˆ‘ä»¬å®šä¹‰çš„ GVK æ³¨å†Œåˆ° k8s ä¸­ã€‚</p><p>é¡ºå¸¦ä¸€æï¼ŒGVK æŒ‡çš„æ˜¯ Group,Version, Kind, ä¸¾ä¸ªæ —å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;namespaces&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;nodes&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;resourcequotas&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;tenant.kubesphere.io&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1alpha1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;workspaces&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#a6e22e>Group</span>: <span style=color:#e6db74>&#34;cluster.kubesphere.io&#34;</span>, <span style=color:#a6e22e>Version</span>: <span style=color:#e6db74>&#34;v1alpha1&#34;</span>, <span style=color:#a6e22e>Resource</span>: <span style=color:#e6db74>&#34;clusters&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>Scheme ç®¡ç† GVK å’Œ Type çš„å…³ç³» , ä¸€ä¸ª GVK åªèƒ½å¯¹åº”ä¸€ä¸ª reflect.Type, ä¸€ä¸ª reflect.Type å¯èƒ½å¯¹åº”å¤šä¸ª GVKï¼›æ­¤å¤–ï¼ŒScheme è¿˜èšåˆäº† converter åŠ cloner, ç”¨æ¥è½¬æ¢ä¸åŒç‰ˆæœ¬çš„ç»“æ„ä½“å’Œè·å–ç»“æ„ä½“å€¼çš„æ‹·è´ï¼›é™äºç¯‡å¹…æœ‰é™ï¼Œæ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥æ·±å…¥æ¢ç´¢ä¸‹ã€‚</p><p>å›å½’æ­£æ–‡ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹æ€ä¹ˆæ³¨å…¥ scheme çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// AddToSchemes may be used to add all resources defined in the project to a Schemevar AddToSchemes runtime.SchemeBuilder</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// AddToScheme adds all Resources to the Schemefunc </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Scheme</span>) <span style=color:#66d9ef>error</span> {	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>AddToSchemes</span>.<span style=color:#a6e22e>AddToScheme</span>(<span style=color:#a6e22e>s</span>)}
</span></span></code></pre></div><p>è€Œ AddToSchemes è¿™ä¸ªç±»å‹çš„æ˜¯<code>[]func(*Scheme) error</code> çš„åˆ«åï¼Œåªéœ€è¦åœ¨ package apis ä¸‹çš„æ¥å£æ–‡ä»¶ä¸­å®ç°ç›¸åº”çš„ init() æ–¹æ³•æ¥å¯¼å…¥å®ç°çš„ç‰ˆæœ¬ APIï¼Œå°±å¯ä»¥æ³¨å…¥ Scheme ä¸­ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat pkg/apis/addtoscheme_dashboard_v1alpha2.go
</span></span><span style=display:flex><span>package apis
</span></span><span style=display:flex><span>import monitoringdashboardv1alpha2 <span style=color:#e6db74>&#34;kubesphere.io/monitoring-dashboard/api/v1alpha2&#34;</span>
</span></span><span style=display:flex><span>func init<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>	
</span></span><span style=display:flex><span>  AddToSchemes <span style=color:#f92672>=</span> append<span style=color:#f92672>(</span>AddToSchemes, monitoringdashboardv1alpha2.SchemeBuilder.AddToScheme<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯ï¼Œæˆ‘ä»¬å¼€å‘çš„æ’ä»¶é›†æˆçš„ç‰ˆæœ¬åŒ–èµ„æºï¼Œå¿…é¡»å®ç° xxx.SchemeBuilder.AddToScheme åŠŸèƒ½ï¼Œæ‰èƒ½æ³¨å†Œåˆ° scheme ä¸­ï¼Œæœ€ç»ˆæš´éœ²ä¸º apis è®¿é—® API æœåŠ¡ã€‚</p><p>è‡³æ­¤ï¼Œæ‰€æœ‰å­æ¨¡å—å¯¹åº”çš„ client å·²ç»ä¸è¿™ä¸ª apiserver ç»‘å®šã€‚</p><h3 id=preparerun>PrepareRun</h3><p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¢è®¨ä¸‹ PrepareRun æ˜¯æ€ä¹ˆæ³¨å†Œ kapis ä»¥åŠç»‘å®š handler çš„ã€‚</p><p>ä¸»è¦æ˜¯é€šè¿‡ restful-go æ¡†æ¶æ¥å®ç°çš„ã€‚</p><p>restful-go æ¡†æ¶ä½¿ç”¨ container æ¥ hold ä½æ‹¥æœ‰ç‰¹å®š GVR çš„ webservice, ä¸€ä¸ª webserver å¯ä»¥ç»‘å®šå¤šä¸ª routerï¼Œå…è®¸ container æˆ–è€… webserver æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ filter æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>APIServer</span>) <span style=color:#a6e22e>PrepareRun</span>(<span style=color:#a6e22e>stopCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// containeræ¥holdä½æ‹¥æœ‰ç‰¹å®šGVRçš„webservice</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span> = <span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>NewContainer</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ·»åŠ è¯·æ±‚Requestæ—¥å¿—æ‹¦æˆªå™¨</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Filter</span>(<span style=color:#a6e22e>logRequestAndResponse</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Router</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>CurlyRouter</span>{})
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å‘ç”ŸRecoveræ—¶ï¼Œç»‘å®šä¸€ä¸ªæ—¥å¿—handler</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>RecoverHandler</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>panicReason</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>httpWriter</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logStackOnRecover</span>(<span style=color:#a6e22e>panicReason</span>, <span style=color:#a6e22e>httpWriter</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ¯ä¸ªAPIç»„éƒ½æ„å»ºä¸€ä¸ªwebserviceï¼Œç„¶åæ ¹æ®è·¯ç”±è§„åˆ™æ¥å¹¶ç»‘å®šå›è°ƒå‡½æ•°</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// é€šè¿‡AddToContaineræ¥å®Œæˆç»‘å®š</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>installKubeSphereAPIs</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ³¨å†ŒmetricsæŒ‡æ ‡: ks_server_request_totalã€ks_server_request_duration_seconds</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç»‘å®šmetrics handler</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>installMetricsAPI</span>()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¸ºæœ‰æ•ˆè¯·æ±‚å¢åŠ ç›‘æ§è®¡æ•°</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Filter</span>(<span style=color:#a6e22e>monitorRequest</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>RegisteredWebServices</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;%s&#34;</span>, <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>RootPath</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Handler</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ·»åŠ å„ä¸ªè°ƒç”¨é“¾çš„æ‹¦æˆªå™¨, ç”¨äºéªŒè¯å’Œè·¯ç”±åˆ†å‘</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>buildHandlerChain</span>(<span style=color:#a6e22e>stopCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸Šé¢ä¸»è¦ä½¿ç”¨ restful-go æ¡†æ¶ç»™ s.Server.handler ç»‘å®šäº†ä¸€ä¸ª container, æ·»åŠ äº†å„ç§æ‹¦æˆªå™¨ã€‚</p><p>åœ¨ s.installKubeSphereAPIS() è¿™ä¸€æ­¥å®‰è£… GVR ç»‘å®šäº† kapis ä»£ç†ï¼Œå…·ä½“æ˜¯è¿™æ ·å®ç°çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// è°ƒç”¨å„apiç»„çš„AddToContaineræ–¹æ³•æ¥å‘containeræ³¨å†Œkapi:</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>urlruntime</span>.<span style=color:#a6e22e>Must</span>(<span style=color:#a6e22e>monitoringv1alpha3</span>.<span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>container</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>Kubernetes</span>(), <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>MonitoringClient</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>MetricsClient</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>KubeSphere</span>(), <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>OpenPitrixOptions</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¯¦ç»†æ¥è¯´ï¼Œå„ä¸ªç»„ä»¶å®ç°çš„AddToContaineræ–¹æ³•</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸ºå¸¦æœ‰GroupVersionä¿¡æ¯çš„webserveræ·»åŠ routeï¼Œä¸åŒè·¯ç”±è·¯å¾„ç»‘å®šä¸åŒçš„handler</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>NewWebService</span>(<span style=color:#a6e22e>GroupVersion</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>// ç»™å­è·¯ç”±ç»‘å®šå›è°ƒå‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Route</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/kubesphere&#34;</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>handleKubeSphereMetricsQuery</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Doc</span>(<span style=color:#e6db74>&#34;Get platform-level metric data.&#34;</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>(<span style=color:#a6e22e>restfulspec</span>.<span style=color:#a6e22e>KeyOpenAPITags</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>constants</span>.<span style=color:#a6e22e>KubeSphereMetricsTag</span>}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Writes</span>(<span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>{}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Returns</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>respOK</span>, <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>{})).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Produces</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>MIME_JSON</span>)
</span></span></code></pre></div><p>æˆ‘ä»¬çŸ¥é“ apis å¯¹åº” K8s çš„è¯·æ±‚ï¼Œè€Œåœ¨ ks ä¸­ kapis å¯¹åº”å­ç»„ä»¶çš„ä»£ç†è¯·æ±‚ï¼Œç”± ks-apiserver è‡ªèº«æˆ–è€…è½¬å‘ç›®æ ‡ç»„ä»¶ server æ¥æä¾›å“åº”ï¼Œé‚£ä¹ˆ ks-apiserver æ˜¯æ€ä¹ˆåŒºåˆ†è¿™äº›è¯·æ±‚çš„ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯é€šè¿‡ buildHandlerChain æ¥è¿›è¡Œåˆ†å‘çš„ã€‚</p><h3 id=buildhandlerchain>buildHandlerChain</h3><p>ä¸Šé¢è¯´åˆ° buildHandlerChain æ„å»ºäº†å„ç§æœåŠ¡çš„æ‹¦æˆªå™¨ï¼ŒæŒ‰åºæ’åˆ—å¦‚ä¸‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithKubeAPIServer</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>KubernetesClient</span>.<span style=color:#a6e22e>Config</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>errorResponder</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>AuditingOptions</span>.<span style=color:#a6e22e>Enable</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuditing</span>(<span style=color:#a6e22e>handler</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>audit</span>.<span style=color:#a6e22e>NewAuditing</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>AuditingOptions</span>, <span style=color:#a6e22e>stopCh</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuthorization</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>authorizers</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Config</span>.<span style=color:#a6e22e>MultiClusterOptions</span>.<span style=color:#a6e22e>Enable</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>clusterDispatcher</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dispatch</span>.<span style=color:#a6e22e>NewClusterDispatch</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>InformerFactory</span>.<span style=color:#a6e22e>KubeSphereSharedInformerFactory</span>().<span style=color:#a6e22e>Cluster</span>().<span style=color:#a6e22e>V1alpha1</span>().<span style=color:#a6e22e>Clusters</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithMultipleClusterDispatcher</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>clusterDispatcher</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithAuthentication</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>authn</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>handler</span> = <span style=color:#a6e22e>filters</span>.<span style=color:#a6e22e>WithRequestInfo</span>(<span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>requestInfoResolver</span>)
</span></span></code></pre></div><p>WithRequestInfo è¿™ä¸ª filter å®šä¹‰äº†å¦‚ä¸‹é€»è¾‘ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>info</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resolver</span>.<span style=color:#a6e22e>NewRequestInfo</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestInfoFactory</span>) <span style=color:#a6e22e>NewRequestInfo</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>RequestInfo</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>APIPrefix</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>currentParts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>splitPath</span>(<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>Path</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>//Proxy discovery API</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>currentParts</span>) &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>prefix</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é€šè¿‡apiè·¯ç”±è·¯å¾„ä¸­çš„æºå¸¦apisè¿˜æ˜¯kapiså°±å¯ä»¥åŒºåˆ†</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kubernetesAPIPrefixes</span>.<span style=color:#a6e22e>Has</span>(<span style=color:#a6e22e>prefix</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>IsKubernetesRequest</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// URL forms: /clusters/{cluster}/*</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;clusters&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>requestInfo</span>.<span style=color:#a6e22e>Cluster</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>currentParts</span>) &gt; <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>currentParts</span> = <span style=color:#a6e22e>currentParts</span>[<span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»£ç å¾ˆå¤šï¼Œæˆ‘å°±ä¸ä¸€ä¸€æˆªå›¾äº†ï¼Œå¤§æ¦‚æ„æ€å¯ä»¥ä»æ³¨é‡Šçœ‹åˆ°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// NewRequestInfo returns the information from the http request.  If error is not nil, RequestInfo holds the information as best it is known before the failure</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// It handles both resource and non-resource requests and fills in all the pertinent information for each.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Valid Inputs:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /apis/{api-group}/{version}/namespaces</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Special verbs without subresources:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/proxy/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/proxy/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Special verbs with subresources:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/watch/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /api/{version}/watch/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/workspaces/{workspace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/{api-group}/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// With workspaces:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/clusters/{cluster}/{api-group}/{version}/namespaces/{namespace}/{resource}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /kapis/clusters/{cluster}/{api-group}/{version}/namespaces/{namespace}/{resource}/{resourceName}</span>
</span></span></code></pre></div><p>é€šè¿‡è·¯ç”±å®šä¹‰çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åŒºåˆ†è¿™ä¸ªè¯·æ±‚æ˜¯ä»€ä¹ˆçº§åˆ«çš„ï¼Œä»¥åŠè¿™ä¸ªè¯·æ±‚è¦åˆ†å‘åˆ°å“ªä¸ª server äº†ã€‚</p><p>æˆ‘ä»¬ç»™å„ä¸ª filter çš„å›è°ƒå‡½æ•°åŠ ä¸Šæ–­ç‚¹ï¼Œ ç„¶ååšä¸ªå°å®éªŒçœ‹ä¸‹æ‹¦æˆªå™¨çš„æ‹¦æˆªé¡ºåºæ˜¯æ€æ ·çš„ã€‚</p><p>å‡è®¾è¿œç¨‹äº‘ä¸»æœºçš„æœåŠ¡å·²ç»å¯åŠ¨ï¼ŒæœåŠ¡ç«¯å£åœ¨ 9090ï¼Œä»¥åŠä½ ä¸º anonymous è¿™ä¸ª globalrole è®¾å®šäº† monitoring.kubesphere.io è¿™ä¸ªç»„ä¸‹èµ„æºç±»å‹ä¸º ClusterDashboard çš„è®¿é—®æƒé™ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨æœ‰è®¿é—®æƒé™çš„è´¦å·æ¥ç›´æ¥æµ‹è¯•ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å‘é€ä¸€ä¸ª kapis è¯·æ±‚ï¼Œçœ‹è¿™ä¸ªé“¾è·¯æ€ä¹ˆè·³è·ƒçš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -d <span style=color:#e6db74>&#39;{&#34;grafanaDashboardUrl&#34;:&#34;https://grafana.com/api/dashboards/7362/revisions/5/download&#34;, &#34;description&#34;:&#34;this is a test dashboard.&#34;}&#39;</span> -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> localhost:9090/kapis/monitoring.kubesphere.io/v1alpha3/clusterdashboards/test1/template
</span></span></code></pre></div><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>WithRequestInfo -&gt; WithAuthentication -&gt; WithAuthorization -&gt; WithKubeAPIServer
</span></span></code></pre></div><h3 id=run>Run</h3><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦å¹²äº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯å¯åŠ¨ informers åŒæ­¥èµ„æº , äºŒæ˜¯å¯åŠ¨ ks apiserverã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>APIServer</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// å¯åŠ¨informerå·¥å‚ï¼ŒåŒ…æ‹¬k8så’Œksçš„informers</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åŒæ­¥èµ„æºï¼ŒåŒ…æ‹¬k8så’Œksçš„GVR</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// æ£€æŸ¥GVRæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨æŠ¥é”™è­¦å‘Šï¼Œå­˜åœ¨å°±åŒæ­¥</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>waitForResourceSync</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>shutdownCtx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>shutdownCtx</span>)
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¯åŠ¨server</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>0</span>).<span style=color:#a6e22e>Infof</span>(<span style=color:#e6db74>&#34;Start listening on %s&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>Addr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>TLSConfig</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>ListenAndServeTLS</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>ListenAndServe</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œè°ƒç”¨å®Œ Run æ–¹æ³•åï¼Œks-apiserver å°±å¯åŠ¨äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åšä¸€ä¸‹ç®€å•æ€»ç»“ï¼š</p><ul><li>æ ¹æ®é…ç½®æ–‡ä»¶åˆ›å»º ks-apiserver å®ä¾‹ , è¯¥å®ä¾‹è°ƒç”¨äº†ä¸‰ä¸ªå…³é”®æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ NewAPIServerã€PrepareRun ä»¥åŠ Run æ–¹æ³•ï¼›</li><li>NewAPIServer é€šè¿‡ç»™å®šçš„é…ç½®ï¼Œç»‘å®šå„ä¸ªæ¨¡å—çš„ clientï¼Œå°†è‡ªå®šä¹‰çš„ GVK æ³¨å†Œåˆ° Schemeï¼Œæš´éœ² apis è·¯ç”±æœåŠ¡ï¼›</li><li>PrepareRun é€šè¿‡ restful-go æ¡†æ¶æ¥æ³¨å†Œã€ç»‘å®š kapi è·¯ç”±å’Œå›è°ƒå‡½æ•°ï¼Œç”¨æ¥è‡ªèº«å“åº”æˆ–è€…ä¸‹å‘ç»„ä»¶ server æŸ¥è¯¢åˆå¹¶æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ ;</li><li>æœ€å , è°ƒç”¨ Run æ–¹æ³•ï¼ŒåŒæ­¥èµ„æºå¹¶å¯åŠ¨ ks-apiserver æœåŠ¡ï¼›</li></ul><h2 id=gvk-æ¢ç´¢å®æˆ˜>GVK æ¢ç´¢å®æˆ˜</h2><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å„æ¨¡å—çš„ AddToContainer æ–¹æ³•å°±è¡Œäº†ã€‚</p><h3 id=iamkubesphereio>iam.kubesphere.io</h3><blockquote><p>pkg/kapis/iam/v1alpha2/register.go</p></blockquote><p>ä»ä»£ç æ³¨é‡Šæ¥çœ‹ï¼Œè¿™ä¸ªæ¨¡å—ç®¡ç†ç€ usersã€clustermembersã€globalrolesã€clusterrolesã€workspacerolesã€rolesã€workspaces groups ã€workspace membersã€devops members ç­‰è´¦å·è§’è‰²çš„ CRUDã€‚</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ handler ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œå»è¯·æ±‚è¿™äº› apiã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/users&#34;</span>
</span></span><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/clustermembers&#34;</span>
</span></span><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;localhost:9090/kapis/iam.kubesphere.io/v1alpha2/users/admin/globalroles&#34;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=kubeedgekubesphereio>kubeedge.kubesphere.io</h3><blockquote><p>pkg/kapis/kubeedge/v1alpha1/register.go</p></blockquote><p>ä»£ç é‡Œé¢ä½¿ç”¨çš„ä»£ç†è½¬å‘è¯·æ±‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>container</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#a6e22e>endpoint</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>generic</span>.<span style=color:#a6e22e>NewGenericProxy</span>(<span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>GroupVersion</span>.<span style=color:#a6e22e>Group</span>, <span style=color:#a6e22e>GroupVersion</span>.<span style=color:#a6e22e>Version</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>proxy</span>.<span style=color:#a6e22e>AddToContainer</span>(<span style=color:#a6e22e>container</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯ kapis/kubeedge.kubesphere.io çš„è¯·æ±‚ä¼šè½¬å‘åˆ° <a href=http://edge-watcher.kubeedge.svc/api/ target=_blank rel="noopener noreferrer">http://edge-watcher.kubeedge.svc/api/</a>ï¼Œä¹Ÿå°±æ˜¯ kubeedge è¿™ä¸ª namespace ä¸‹çš„ serviceï¼Œç›¸å…³çš„æ¥å£é›†æˆåœ¨é‚£é‡Œã€‚</p><p>å…³äºæ•´åˆè¾¹ç¼˜è®¡ç®—å¹³å°çš„é›†æˆï¼Œé™¤äº†éœ€è¦åšä¸€ä¸ªä¸»æµè¾¹ç¼˜æ¡†æ¶çš„å¿«é€Ÿå®‰è£…å’Œé›†æˆå¤–ï¼Œè¿˜å¯ä»¥é›†æˆä¸€ä¸ªç±»ä¼¼ edge-shim çš„é€‚é…å™¨ï¼Œå¤§æ¦‚éœ€è¦ä»ä¸€ä¸‹å‡ ä¸ªæ–¹é¢è€ƒè™‘ï¼š</p><ul><li>ä»£ç† endpoint: ç°åœ¨çš„ kubeedge å°±æ˜¯ä½¿ç”¨ä»£ç†æ¨¡å¼è½¬å‘ï¼›</li><li>å¥åº·æ£€æŸ¥æ¥å£ï¼šè‡³å°‘è¦ç¡®ä¿äº‘ç«¯çš„ç»„ä»¶å·²ç»æˆåŠŸéƒ¨ç½²ï¼›</li><li>äº‹ä»¶ã€é•¿æœŸæ—¥å¿—ã€å®¡è®¡ç­‰å¯è§‚æµ‹ç»„ä»¶çš„æ”¯æŒï¼›</li><li>å…¶ä»–è¾¹ç¼˜è¾…åŠ©åŠŸèƒ½ï¼Œå¦‚æ–‡ä»¶æˆ–è€…é…ç½®ä¸‹å‘ç­‰ï¼›</li></ul><h3 id=notificationkubesphereio>notification.kubesphere.io</h3><blockquote><p>pkg/kapis/notification/v2beta1/register.go</p></blockquote><p>è¿™ä¸ªç»„ä¸‹çš„ api ä¸»è¦å®ç°äº† notification çš„å…¨å±€æˆ–ç§Ÿæˆ·çº§åˆ«çš„ config å’Œ receivers èµ„æºçš„ CRUDã€‚</p><p>config èµ„æº</p><blockquote><p>ç”¨äºé…ç½®å¯¹æ¥é€šçŸ¥æ¸ é“ç›¸å…³å‚æ•°çš„ä¸€äº›é…ç½®ï¼Œåˆ†ä¸ºå…¨å±€çš„å’Œç§Ÿæˆ·çº§åˆ«çš„ config èµ„æºï¼›</p></blockquote><p>reciever èµ„æº</p><blockquote><p>ç”¨äºé…ç½®æ¥æ”¶è€…çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼ŒåŒºåˆ†å…¨å±€çš„å’Œç§Ÿæˆ·çº§åˆ«çš„æ¥æ”¶è€…ï¼›</p></blockquote><p>æˆ‘ä»¬æŒ‘é€‰ä¸€ä¸ªå›è°ƒå‡½æ•°è¿›è¡Œå‰–æï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>Route</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/{resources}&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>To</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>ListResource</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Doc</span>(<span style=color:#e6db74>&#34;list the notification configs or receivers&#34;</span>).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Metadata</span>(<span style=color:#a6e22e>KeyOpenAPITags</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>constants</span>.<span style=color:#a6e22e>NotificationTag</span>}).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;resources&#34;</span>, <span style=color:#e6db74>&#34;known values include configs, receivers, secrets&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterName</span>, <span style=color:#e6db74>&#34;name used for filtering&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterLabelSelector</span>, <span style=color:#e6db74>&#34;label selector used for filtering&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#e6db74>&#34;type&#34;</span>, <span style=color:#e6db74>&#34;config or receiver type, known values include dingtalk, email, slack, webhook, wechat&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterPage</span>, <span style=color:#e6db74>&#34;page&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>DataFormat</span>(<span style=color:#e6db74>&#34;page=%d&#34;</span>).<span style=color:#a6e22e>DefaultValue</span>(<span style=color:#e6db74>&#34;page=1&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterLimit</span>, <span style=color:#e6db74>&#34;limit&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterAscending</span>, <span style=color:#e6db74>&#34;sort parameters, e.g. ascending=false&#34;</span>).<span style=color:#a6e22e>Required</span>(<span style=color:#66d9ef>false</span>).<span style=color:#a6e22e>DefaultValue</span>(<span style=color:#e6db74>&#34;ascending=false&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Param</span>(<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParameterOrderBy</span>, <span style=color:#e6db74>&#34;sort parameters, e.g. orderBy=createTime&#34;</span>)).
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Returns</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>{<span style=color:#a6e22e>Items</span>: []<span style=color:#66d9ef>interface</span>{}{}}))
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>handler</span>) <span style=color:#a6e22e>ListResource</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç§Ÿæˆ·æˆ–ç”¨æˆ·çš„åç§°</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// èµ„æºç±»å‹ï¼Œconfigs/recievers/secrets</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resource</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>PathParameter</span>(<span style=color:#e6db74>&#34;resources&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é€šçŸ¥æ¸ é“ dingtalk/slack/email/webhook/wechat</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subresource</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>QueryParameter</span>(<span style=color:#e6db74>&#34;type&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>ParseQueryParameter</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>operator</span>.<span style=color:#a6e22e>IsKnownResource</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleBadRequest</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>servererr</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;unknown resource type %s/%s&#34;</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>objs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>operator</span>.<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span>, <span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>handleResponse</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>objs</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬çœ‹ä¸‹ list object çš„é€»è¾‘ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// List objects.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>operator</span>) <span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>subresource</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>query</span>.<span style=color:#a6e22e>Query</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> = <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;,&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>filter</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœæ²¡æœ‰ç»™å®šç§Ÿæˆ·çš„åç§°ï¼Œåˆ™è·å–å…¨å±€çš„å¯¹è±¡</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isConfig</span>(<span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>GetObject</span>(<span style=color:#a6e22e>resource</span>)) {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// type=defaultå¯¹configèµ„æºæ¥è¯´æ˜¯å…¨å±€çš„</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=default&#34;</span>
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		    <span style=color:#75715e>// type=globalå¯¹receieverèµ„æºæ¥è¯´æ˜¯å…¨å±€çš„</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=global&#34;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦åˆ™å°±ç»™è¿‡æ»¤å™¨ç»‘å®šç§Ÿæˆ·åç§°</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>filter</span> = <span style=color:#e6db74>&#34;type=tenant,user=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç»„è£…è¿‡æ»¤æ ‡ç­¾</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> = <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>LabelSelector</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>filter</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// é€šè¿‡è¿‡æ»¤æ ‡ç­¾è·å–clusteræˆ–è€…namespaceä¸‹çš„æŒ‡å®šèµ„æº</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>resourceGetter</span>.<span style=color:#a6e22e>List</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>ns</span>, <span style=color:#a6e22e>q</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>subresource</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>resource</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Secret</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>ListResult</span>{}
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ ·ä¸€æ¥ï¼Œå°±å®ç°äº†ç§Ÿæˆ·çº§åˆ«çš„é€šçŸ¥å‘Šè­¦ CR é…ç½®çš„ CRUDï¼Œè¿™äº› CR æ˜¯è¿™ä¹ˆåˆ†ç±»çš„ï¼š</p><ul><li>config åˆ†ä¸ºå…¨å±€ type = default, ç§Ÿæˆ· type = tenant ä¸¤ç§çº§åˆ«ï¼›</li><li>reciever åˆ†ä¸ºå…¨å±€ type = global, ç§Ÿæˆ· type = tenant ä¸¤ç§çº§åˆ«ï¼›</li></ul><p>é‚£ä¹ˆ config å’Œ reciever æ€ä¹ˆç›¸äº’ç»‘å®šã€å‘Šè­¦æ˜¯å¦‚ä½•é€šè¿‡æ¸ é“ç»™ç§Ÿæˆ·å‘æ¶ˆæ¯çš„ï¼Ÿ</p><blockquote><p><a href=https://github.com/kubesphere/notification-manager/blob/master/pkg/webhook/v1/handler.go#L45 target=_blank rel="noopener noreferrer">https://github.com/kubesphere/notification-manager/blob/master/pkg/webhook/v1/handler.go#L45</a></p><p><a href=https://github.com/kubesphere/notification-manager/blob/master/pkg/notify/notify.go#L66 target=_blank rel="noopener noreferrer">https://github.com/kubesphere/notification-manager/blob/master/pkg/notify/notify.go#L66</a></p></blockquote><p>notification-manager ç®€ç§° nmï¼Œæˆ‘è¿™é‡Œæ–­ç« å–ä¹‰åœ°ç®€è¦å›ç­”ä¸€ä¸‹ã€‚</p><p>åŠŸèƒ½æ–¹é¢ï¼š</p><ul><li>å…¨å±€é…ç½® reciever é€šè¿‡é…ç½®çš„æ¸ é“å°†æ‰€æœ‰çš„ alerts å‘é€ç»™å…¶å®šä¹‰å¥½çš„æ¥æ”¶è€…åå•ï¼Œ é…ç½®äº†ç§Ÿæˆ·ä¿¡æ¯çš„ reciever åªèƒ½é€šè¿‡æ¸ é“å‘é€å½“å‰ ns ä¸‹çš„ alertsï¼›</li><li>reciever ä¸­å¯ä»¥é€šè¿‡é…ç½® alertSelector å‚æ•°æ¥è¿›ä¸€æ­¥è¿‡æ»¤å‘Šè­¦æ¶ˆæ¯ï¼›</li><li>é€šè¿‡ä¿®æ”¹åä¸º notification-manager-template çš„ confimap æ¥å®šåˆ¶å‘é€æ¶ˆæ¯æ¨¡æ¿ï¼›</li></ul><p>å‘Šè­¦åˆ°é€šçŸ¥çš„æµç¨‹ï¼š</p><ul><li>nm ä½¿ç”¨ç«¯å£ 19093 å’Œ API è·¯å¾„ /api/v2/alerts æ¥æ”¶ä» Alertmanager å‘é€çš„å‘Šè­¦ ;</li><li>å›è°ƒå‡½æ•°æ¥å— alerts è½¬æ¢ä¸º notification æ¨¡æ¿æ•°æ®ï¼ŒæŒ‰ç…§ namespace åŒºåˆ†å‘Šè­¦æ•°æ®ï¼›</li><li>éå†æ‰€æœ‰ Recieversï¼Œæ¯ä¸ª ns ä¸‹å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥å‘é€æ¶ˆæ¯ï¼Œ è€Œè¿™é‡Œæ¯ä¸ª ns å¯¹åº”ç€å¤šä¸ªé€šçŸ¥æ¸ é“ï¼Œå› æ­¤ä¹Ÿä½¿ç”¨ waitgroup æ¥å¹¶å‘ç¼–æ’å®Œæˆä»»åŠ¡ï¼›</li></ul><h3 id=monitoringkubesphereio>monitoring.kubesphere.io</h3><blockquote><p>pkg/kapis/monitoring/v1alpha3/register.go</p></blockquote><p>å°†ç›‘æ§æŒ‡æ ‡åˆ†ä¸ºå¹³å°çº§ã€èŠ‚ç‚¹çº§ã€workspacesã€namespacesã€pods ç­‰çº§åˆ«ï¼Œä¸ä»…å¯ä»¥è·å–æ€»çš„ç»Ÿè®¡ï¼Œè¿˜èƒ½è·å– nodes/namespaces/workspaces ä¸‹çš„æ‰€æœ‰ pods/containers ç­‰ç›‘æ§æŒ‡æ ‡ã€‚</p><p>æˆ‘ä»¬æŸ¥çœ‹å›è°ƒå‡½æ•°ï¼Œä»¥ handleNamedMetricsQuery ä¸ºä¾‹åˆ†æï¼š</p><ul><li>éå†ç»™å®šæŒ‡æ ‡çº§åˆ«ä¸‹çš„åˆæ³• metric æŒ‡æ ‡ï¼Œæ ¹æ®è¯·æ±‚å‚æ•°ä¸­ metricFilter çš„æ¥è¿‡æ»¤æŒ‡æ ‡åï¼›</li><li>åˆ¤æ–­ä¸ºèŒƒå›´æŸ¥è¯¢è¿˜æ˜¯å®æ—¶æŸ¥è¯¢ï¼Œæ¥è°ƒå– monitoring åŒ…ä¸­ç›¸å…³æ–¹æ³•ï¼Œé€šè¿‡å¯¹åº”çš„ client è¯·æ±‚åç«¯è·å–ç»“æœè¿”å›ï¼›</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>handler</span>) <span style=color:#a6e22e>handleNamedMetricsQuery</span>(<span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#a6e22e>q</span> <span style=color:#a6e22e>queryOptions</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>res</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Metrics</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>metrics</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// q.namedMetrics æ˜¯ä¸€ç»„æŒ‰ç…§ç›‘æ§æŒ‡æ ‡çº§åˆ«åˆ†ç±»å¥½çš„æ‹¥æœ‰promsql exprå®šä¹‰çš„å®Œæ•´æŒ‡æ ‡åæ•°ç»„</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ç›‘æ§æŒ‡æ ‡çº§åˆ«åˆ†ç±»æ˜¯æ ¹æ® monitoring.Levelxxxåœ¨ä¸Šä¸€ä¸ªæ ˆé‡Œç»†åˆ†çš„ï¼Œi.e: monitoring.LevelPod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>metric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>namedMetrics</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>metric</span>, <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>MetricMeterPrefix</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// skip meter metric</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// æ ¹æ®è¯·æ±‚å‚æ•°ä¸­çš„æŒ‡æ ‡åæ¥è¿‡æ»¤</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MatchString</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>metricFilter</span>, <span style=color:#a6e22e>metric</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>metrics</span> = append(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>metric</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>metrics</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// åˆ¤æ–­æ˜¯å¦æ˜¯èŒƒå›´æŸ¥è¯¢è¿˜æ˜¯å®æ—¶æŸ¥è¯¢ï¼Œç»§ç»­è°ƒç”¨ç›¸å…³å‡½æ•°</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ä¸»è¦è¿˜æ˜¯ç”¨prometheus clientå»æŸ¥è¯¢promsql, è¾¹ç¼˜èŠ‚ç‚¹çš„æŒ‡æ ‡ç›®å‰é€šè¿‡metrics serveræ¥æŸ¥è¯¢</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>isRangeQuery</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>option</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>GetNamedMetrics</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>time</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>option</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>shouldSort</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>res</span> = <span style=color:#f92672>*</span><span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Sort</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>order</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>identifier</span>).<span style=color:#a6e22e>Page</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>page</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>limit</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†è§†è§’ç§»æ¤åˆ° :</p><blockquote><p>pkg/models/monitoring/monitoring.go:156</p></blockquote><p>ä»¥ GetNamedMetricsOverTime ä¸ºä¾‹ï¼Œè¿™é‡Œé˜è¿°äº†ä¼šåˆå¹¶ prometheus å’Œ metrics-server çš„æŸ¥è¯¢ç»“æœè¿›è¡Œè¿”å›ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mo</span> <span style=color:#a6e22e>monitoringOperator</span>) <span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>step</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>opt</span> <span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>QueryOption</span>) <span style=color:#a6e22e>Metrics</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–prometheus clientæŸ¥è¯¢ç»“æœï¼Œä¸»è¦ä½¿ç”¨sync.WaitGroupå¹¶å‘æŸ¥è¯¢ï¼Œæ¯ä¸ªæŒ‡æ ‡å¯åŠ¨ä¸€ä¸ªgoroutineï¼Œæœ€åå°†ç»“æœå’Œå¹¶è¿”å›</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ress</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¦‚æœmetrics-serveræ¿€æ´»äº†</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>metricsserver</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//åˆå¹¶è¾¹ç¼˜èŠ‚ç‚¹æ•°æ®</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>edgeMetrics</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>monitoring</span>.<span style=color:#a6e22e>MetricData</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>ressMetric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ress</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>metricName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ressMetric</span>.<span style=color:#a6e22e>MetricName</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ressMetricValues</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ressMetric</span>.<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>ressMetricValues</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// this metric has no prometheus metrics data</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>edgeMetrics</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>					<span style=color:#75715e>// start to request monintoring metricsApi data</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>mr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mo</span>.<span style=color:#a6e22e>metricsserver</span>.<span style=color:#a6e22e>GetNamedMetricsOverTime</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>start</span>, <span style=color:#a6e22e>end</span>, <span style=color:#a6e22e>step</span>, <span style=color:#a6e22e>opt</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>mrMetric</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>mr</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>edgeMetrics</span>[<span style=color:#a6e22e>mrMetric</span>.<span style=color:#a6e22e>MetricName</span>] = <span style=color:#a6e22e>mrMetric</span>.<span style=color:#a6e22e>MetricData</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>edgeMetrics</span>[<span style=color:#a6e22e>metricName</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ress</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span> = append(<span style=color:#a6e22e>ress</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>MetricData</span>.<span style=color:#a6e22e>MetricValues</span>, <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>MetricValues</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Metrics</span>{<span style=color:#a6e22e>Results</span>: <span style=color:#a6e22e>ress</span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œmonitoring åŒ…è¿˜å®šä¹‰äº†å„ç›‘æ§æŸ¥è¯¢ client çš„æ¥å£æ–¹æ³•ï¼Œå¯ä»¥æŒ‰éœ€æ¢ç´¢ï¼š</p><ul><li><p>GetMetric(expr string, time time.Time) Metric</p></li><li><p>GetMetricOverTime(expr string, start, end time.Time, step time.Duration) Metric</p></li><li><p><code>GetNamedMetrics(metrics []string, time time.Time, opt QueryOption) []Metric</code></p></li><li><p><code>GetNamedMetricsOverTime(metrics []string, start, end time.Time, step time.Duration, opt QueryOption) []Metric</code></p></li><li><p><code>GetMetadata(namespace string) []Metadata</code></p></li><li><p><code>GetMetricLabelSet(expr string, start, end time.Time) []map[string]string</code></p></li></ul><h3 id=tenantkubesphereio>tenant.kubesphere.io</h3><p>å†èŠ api ä¹‹å‰ï¼Œé¡ºå¸¦ä¸€æå¤šç§Ÿæˆ·åœ¨éš”ç¦»çš„å®‰å…¨ç¨‹åº¦ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸ºè½¯éš”ç¦» (Soft Multi-tenancy) å’Œç¡¬éš”ç¦» (Hard Multi-tenancy) ä¸¤ç§ã€‚</p><ul><li>è½¯éš”ç¦»æ›´å¤šçš„æ˜¯é¢å‘ä¼ä¸šå†…éƒ¨çš„å¤šç§Ÿéœ€æ±‚ï¼›</li><li>ç¡¬éš”ç¦»é¢å‘çš„æ›´å¤šæ˜¯å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡ä¾›åº”å•†ï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„éš”ç¦»ä½œä¸ºå®‰å…¨ä¿éšœã€‚</li></ul><p>è¿™ä¸ª group ä¸‹æ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†æ˜¯å®ç°ç§Ÿæˆ·æŸ¥è¯¢ logs/audits/eventsï¼š</p><p>ä»¥æŸ¥è¯¢æ—¥å¿—ä¸ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>tenantHandler</span>) <span style=color:#a6e22e>QueryLogs</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>resp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>Response</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŸ¥è¯¢ä¸Šä¸‹æ–‡ä¸­æºå¸¦çš„ç§Ÿæˆ·ä¿¡æ¯</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>UserFrom</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;cannot obtain user info&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleForbidden</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// è§£ææŸ¥è¯¢çš„å‚æ•°ï¼Œæ¯”å¦‚ç¡®å®šå±äºå“ªä¸ªns/workload/pod/containerçš„æŸ¥è¯¢ã€æ—¶é—´æ®µï¼Œæ˜¯å¦ä¸ºæŸ±çŠ¶æŸ¥è¯¢ç­‰</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>queryParam</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>loggingv1alpha2</span>.<span style=color:#a6e22e>ParseQueryParameter</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// å¯¼å‡ºæ•°æ®</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>queryParam</span>.<span style=color:#a6e22e>Operation</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>loggingv1alpha2</span>.<span style=color:#a6e22e>OperationExport</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>restful</span>.<span style=color:#a6e22e>HEADER_ContentType</span>, <span style=color:#e6db74>&#34;text/plain&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Disposition&#34;</span>, <span style=color:#e6db74>&#34;attachment&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// éªŒè¯è´¦å·æ˜¯å¦æœ‰æƒé™</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// adminè´¦å·å¯ä»¥å¯¼å‡ºæ‰€æœ‰nsçš„æ—¥å¿—ï¼Œç§Ÿæˆ·åªèƒ½å¯¼å‡ºæœ¬nsçš„æ—¥å¿—</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç»„è£…loggingclientè¿›è¡Œæ—¥å¿—å¯¼å‡º</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>tenant</span>.<span style=color:#a6e22e>ExportLogs</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>queryParam</span>, <span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// éªŒè¯è´¦å·æ˜¯å¦æœ‰æƒé™</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// adminè´¦å·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰nsçš„æ—¥å¿—ï¼Œç§Ÿæˆ·åªèƒ½æŸ¥çœ‹æœ¬nsçš„æ—¥å¿—</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ç»„è£…loggingclientè¿›è¡Œæ—¥å¿—è¿”å›</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>tenant</span>.<span style=color:#a6e22e>QueryLogs</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>queryParam</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>Errorln</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>api</span>.<span style=color:#a6e22e>HandleInternalError</span>(<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>WriteAsJson</span>(<span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”±äºç¯‡å¹…æœ‰é™ï¼Œåªå¯¹ä»¥ä¸Š GVR è¿›è¡Œäº†è°ƒè¯•ï¼Œæ„Ÿå…´è¶£å¯ä»¥æ·±å…¥äº†è§£~</p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&text=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&title=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-backend-sourcecode%2f&t=KubeSphere%20%e5%90%8e%e7%ab%af%e6%ba%90%e7%a0%81%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>ç›®å½•</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#å‰æ>å‰æ</a></li><li><a href=#é…ç½®-launch-æ–‡ä»¶>é…ç½® launch æ–‡ä»¶</a></li><li><a href=#ks-apiserver-è°ƒè¯•ä¾èµ–æ–‡ä»¶>ks-apiserver è°ƒè¯•ä¾èµ–æ–‡ä»¶</a></li><li><a href=#å¯åŠ¨-ks-apiserver>å¯åŠ¨ ks-apiserver</a><ul><li><a href=#newapiserver>NewAPIServer</a></li><li><a href=#preparerun>PrepareRun</a></li><li><a href=#buildhandlerchain>buildHandlerChain</a></li><li><a href=#run>Run</a></li></ul></li><li><a href=#gvk-æ¢ç´¢å®æˆ˜>GVK æ¢ç´¢å®æˆ˜</a><ul><li><a href=#iamkubesphereio>iam.kubesphere.io</a></li><li><a href=#kubeedgekubesphereio>kubeedge.kubesphere.io</a></li><li><a href=#notificationkubesphereio>notification.kubesphere.io</a></li><li><a href=#monitoringkubesphereio>monitoring.kubesphere.io</a></li><li><a href=#tenantkubesphereio>tenant.kubesphere.io</a></li></ul></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>é€šè¿‡é‚®ä»¶æ¥æ”¶ KubeSphere æœ€æ–°çš„æŠ€æœ¯åšå®¢ä¸äº§å“æ›´æ–°çš„é€šçŸ¥</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>è®¢é˜…</button>
<span id=message_blog data-message1=è¯·æä¾›æ‚¨çš„é‚®ç®± data-message2=è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€! data-message3=é‚®ç®±åœ°å€å·²ç»å­˜åœ¨ style=color:red></span><span id=message1_blog style=color:#00a971 data-success=è®¢é˜…æˆåŠŸå•¦ï¼Œæˆ‘ä»¬ä¿è¯ä¸ä¼šç»™ä½ å‘åƒåœ¾é‚®ä»¶çš„å•¦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>é€šè¿‡é‚®ä»¶æ¥æ”¶ KubeSphere æœ€æ–°çš„æŠ€æœ¯åšå®¢ä¸äº§å“æ›´æ–°çš„é€šçŸ¥</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€>
<button id=email-submit>è®¢é˜…</button></div><span id=message data-message1=è¯·æä¾›æ‚¨çš„é‚®ç®± data-message2=è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€! data-message3=é‚®ç®±åœ°å€å·²ç»å­˜åœ¨></span><span id=message1 style=color:#00a971 data-success=è®¢é˜…æˆåŠŸå•¦ï¼Œæˆ‘ä»¬ä¿è¯ä¸ä¼šç»™ä½ å‘åƒåœ¾é‚®ä»¶çš„å•¦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=è¯·æä¾›æ‚¨çš„é‚®ç®± data-message2=è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>åº”ç”¨åœºæ™¯</div><a href=/zh/devops/>æ‹¥æŠ±ä¸€ç«™å¼ DevOps</a>
<a href=/zh/service-mesh/>åœ¨ K8s è¿è¡Œå¾®æœåŠ¡</a>
<a href=/zh/observability/>æ„å»ºäº‘åŸç”Ÿå¯è§‚æµ‹æ€§</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s ä¸€é”®éƒ¨ç½²ä¸è¿ç»´</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">æ„å»º FaaS å¹³å°ä¸ Serverless æ¶æ„</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">å¤šäº‘åº”ç”¨ç®¡ç†å¹³å°</a></li><li class=nowrap-li><div class=h3>èµ„æº</div><a href=/zh/projects/>å¼€æºé¡¹ç›®</a>
<a href=/zh/blogs/>æŠ€æœ¯åšå®¢</a>
<a href=/zh/conferences/>å¼€æºå³°ä¼š</a>
<a href=/zh/videos/>è§†é¢‘èµ„æº</a>
<a href=/zh/learn/>äº‘åŸç”Ÿå®æˆ˜</a></li><li class=nowrap-li><div class=h3>æ–‡æ¡£ä¸­å¿ƒ</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>äº§å“ä»‹ç»</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>å¦‚ä½•å®‰è£…</a>
<a href=/zh/docs/v4.1/02-quickstart/>å¿«é€Ÿå…¥é—¨</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API æ–‡æ¡£</a></li><li class=nowrap-li><div class=h3>å¼€æºç¤¾åŒº</div><a href=/zh/contribution/>å‚ä¸è´¡çŒ®</a>
<a href=/zh/live/>ç¤¾åŒºæ´»åŠ¨</a>
<a href=/zh/case/>æ¡ˆä¾‹å­¦ä¹ </a>
<a href=/zh/partner/>åˆä½œä¼™ä¼´</a>
<a href=/zh/user-group/>ç”¨æˆ·å§”å‘˜ä¼š</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">ç‰ˆæœ¬è®¡åˆ’</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">ä¸­å›½ç«™</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">ä¸­æ–‡è®ºå›</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">å…¨çƒç«™</a></li><li class=nowrap-li><div class=h3>äº§å“ä¸æœåŠ¡</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere ä¼ä¸šç‰ˆ</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere è™šæ‹ŸåŒ–å¹³å°</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">äº‘åŸç”Ÿæ‰©å±•ç»„ä»¶å¸‚åœº</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">äº‘åŸç”Ÿåº”ç”¨æœåŠ¡å¹³å°</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">äº†è§£å•†ä¸šäº§å“ä¸å’¨è¯¢åˆä½œ</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>äº¬ICPå¤‡13019086å·</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=å¤‡æ¡ˆå›¾æ ‡>
<span>äº¬å…¬ç½‘å®‰å¤‡ 11010502041003å·</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>æ‚¨çš„éšç§å¯¹æˆ‘ä»¬å¾ˆé‡è¦ã€‚æˆ‘ä»¬ä½¿ç”¨Cookieæ¥è®°ä½è®¢é˜…è¯¦ç»†ä¿¡æ¯ï¼Œä¼˜åŒ–ç½‘ç«™åŠŸèƒ½å¹¶äº¤ä»˜æ ¹æ®æ‚¨çš„å…´è¶£é‡èº«å®šåˆ¶çš„å†…å®¹ã€‚è¦äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„<a href=/zh/privacy>éšç§æ”¿ç­–</a>.</p><button>
æ¥å—å¹¶ç»§ç»­</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>