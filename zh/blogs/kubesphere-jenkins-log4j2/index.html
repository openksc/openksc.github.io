<!doctype html><html lang=en-US><head><meta charset=utf-8><title>修复 KubeSphere 内置 Jenkins 的 Apache Log4j2 漏洞</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文以修复 Jenkins 存在的 Apache Log4j2 漏洞为背景，介绍了修复该漏洞的两种解决方案。并且，初步探究了在 KubeSphere 中集成的 Jenkins 如何自定义构建镜像以及如何升级更新。"><meta name=keywords content="KubeSphere,Kubernetes,Log4j2,Jenkins"><meta property="og:type" content="article"><meta property="og:title" content="修复 KubeSphere 内置 Jenkins 的 Apache Log4j2 漏洞"><meta property="og:description" content="本文以修复 Jenkins 存在的 Apache Log4j2 漏洞为背景，介绍了修复该漏洞的两种解决方案。并且，初步探究了在 KubeSphere 中集成的 Jenkins 如何自定义构建镜像以及如何升级更新。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-jenkins-log4j2-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-jenkins-log4j2/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-jenkins-log4j2-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-jenkins-log4j2/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-jenkins-log4j2/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>修复 KubeSphere 内置 Jenkins 的 Apache Log4j2 漏洞</span></div><div class='main-div middle-div'><div class=author>老 Z</div><span class=date>发布于：2023-02-10</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>修复 KubeSphere 内置 Jenkins 的 Apache Log4j2 漏洞</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&text=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&title=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&t=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><blockquote><p>作者：老 Z，运维架构师，云原生爱好者，目前专注于云原生运维，云原生领域技术栈涉及 Kubernetes、KubeSphere、DevOps、OpenStack、Ansible 等。</p></blockquote><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/image-20230210141327867.png alt></p><h2 id=简介>简介</h2><p>生产环境 KubeSphere 3.3.0 部署的 Kubernetes 集群在安全评估的时候发现安全漏洞，其中一项漏洞提示<strong>目标可能存在 Apache Log4j2 远程代码执行漏洞 (CVE-2021-44228)</strong>。</p><p>本文记录了该漏洞修复的全部过程，文中介绍了修复该漏洞的两种解决方案，其中涉及自定义构建 KubeSphere 适用的 Jenkins Image 的详细操作。</p><h2 id=漏洞修复方案>漏洞修复方案</h2><h3 id=漏洞详细信息>漏洞详细信息</h3><p>漏洞报告中涉及漏洞 <strong>目标可能存在 Apache Log4j2 远程代码执行漏洞 (CVE-2021-44228)</strong> 的具体信息如下：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/image-20230208151708221.png alt></p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/image-20230208110325840.png alt></p><h3 id=漏洞分析>漏洞分析</h3><ol><li>分析漏洞报告信息，发现对应的服务端口为 <strong>30180</strong>，对应的服务为 <strong>Jenkins</strong>。使用 Curl 访问服务端口，查看返回头信息。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -I http://192.168.9.91:30180</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>403</span> Forbidden
</span></span><span style=display:flex><span>Date: Thu, <span style=color:#ae81ff>09</span> Feb <span style=color:#ae81ff>2023</span> 00:36:45 GMT
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Set-Cookie: JSESSIONID.b1c3bc24<span style=color:#f92672>=</span>node084x6l5z2ss0ghsb2t9tde2gl16558.node0; Path<span style=color:#f92672>=</span>/; HttpOnly
</span></span><span style=display:flex><span>Expires: Thu, <span style=color:#ae81ff>01</span> Jan <span style=color:#ae81ff>1970</span> 00:00:00 GMT
</span></span><span style=display:flex><span>Content-Type: text/html;charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>X-Hudson: 1.395
</span></span><span style=display:flex><span>X-Jenkins: 2.319.1
</span></span><span style=display:flex><span>X-Jenkins-Session: 1fde6067
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>541</span>
</span></span><span style=display:flex><span>Server: Jetty<span style=color:#f92672>(</span>9.4.43.v20210629<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 从结果中可以看到 KubeSphere 3.3.0 采用的 Jenkins 使用的 Jetty 版本为 <strong>9.4.43.v20210629</strong>，跟漏扫报告中的结果一致。</p></blockquote><ol start=2><li>在 K8s 中查看 Jenkins 服务使用的 Image 版本。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get deploy  devops-jenkins -n kubesphere-devops-system -o wide</span>
</span></span><span style=display:flex><span>NAME             READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS       IMAGES                                                                    SELECTOR
</span></span><span style=display:flex><span>devops-jenkins   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           101d   devops-jenkins   registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.319.1   component<span style=color:#f92672>=</span>devops-jenkins-master
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 从结果中可以看到 KubeSphere 3.3.0 采用的 Jenkins 版本为 <strong>2.319.1</strong>，跟漏扫报告中的结果一致。</p></blockquote><ol start=3><li>在 K8s 中确认 Jenkins 哪些组件用到了跟 Log4j 有关的 JAR 包。</li></ol><ul><li>查找 Jenkins 服务对应的 Pod。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get pod -n kubesphere-devops-system -o wide</span>
</span></span><span style=display:flex><span>NAME                                 READY   STATUS      RESTARTS        AGE    IP               NODE              NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>devops-27930510-52tck                0/1     Completed   <span style=color:#ae81ff>0</span>               87m    10.233.116.224   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-27930540-6b7cz                0/1     Completed   <span style=color:#ae81ff>0</span>               57m    10.233.116.225   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-27930570-t5k6b                0/1     Completed   <span style=color:#ae81ff>0</span>               27m    10.233.116.226   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-apiserver-6b468c95cb-grx4j    1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>4h30m ago<span style=color:#f92672>)</span>   101d   10.233.116.211   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-controller-667f8449d7-w8mvf   1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>4h37m ago<span style=color:#f92672>)</span>   101d   10.233.117.173   ks-k8s-master-0   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-jenkins-67fbd685bf-4jmn4      1/1     Running     <span style=color:#ae81ff>7</span> <span style=color:#f92672>(</span>4h23m ago<span style=color:#f92672>)</span>   101d   10.233.117.162   ks-k8s-master-0   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>s2ioperator-0                        1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>4h36m ago<span style=color:#f92672>)</span>   101d   10.233.87.33     ks-k8s-master-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ul><li>进入 Jenkins Pod 的命令行控制台</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl exec -it devops-jenkins-67fbd685bf-4jmn4 -n kubesphere-devops-system -- bash</span>
</span></span><span style=display:flex><span>Defaulted container <span style=color:#e6db74>&#34;devops-jenkins&#34;</span> out of: devops-jenkins, copy-default-config <span style=color:#f92672>(</span>init<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>root@devops-jenkins-67fbd685bf-4jmn4:/# 
</span></span></code></pre></div><ul><li>在 Jenkins 挂载的主目录中查找跟 Log4j 有关的 JAR 包 (所有操作都是在容器内部)。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 进入 Jenkins 数据主目录</span>
</span></span><span style=display:flex><span>root@devops-jenkins-67fbd685bf-4jmn4:~# cd  /var/jenkins_home
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查找带 log4j 关键字带所有 jar 包</span>
</span></span><span style=display:flex><span>root@devops-jenkins-67fbd685bf-4jmn4:/var/jenkins_home# find ./ -name <span style=color:#e6db74>&#34;*log4j*&#34;</span>
</span></span><span style=display:flex><span>./war/WEB-INF/lib/log4j-over-slf4j-1.7.32.jar
</span></span><span style=display:flex><span>./plugins/ssh-slaves/WEB-INF/lib/log4j-over-slf4j-1.7.26.jar
</span></span><span style=display:flex><span>./plugins/prometheus/WEB-INF/lib/log4j-over-slf4j-1.7.30.jar
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 并没有搜到到 log4j 的核心包，但是搜索到了 <strong>log4j-over-slf4j</strong>，该软件包并不属于 log4j <a href=https://repo.maven.apache.org/maven2/org/apache/logging/log4j/ target=_blank rel="noopener noreferrer">官方 MAVEN 仓库</a>（也可能是我没有找到），而且居然有 3 个不同版本，Jenkins 自己用了一个版本，还有两个插件也用了两个不同的版本。</p><p>百度了一下 <strong>log4j-over-slf4j</strong> 是用来把日志框架的 Log4j API 桥接到 SLF4J API，实际上底层使用的 SLF4J，细节我并没有深究，也没有去研究漏洞扫描工具是如何判断的。</p><p>但是由于搜索不到其他的 log4j 相关的 JAR 包，初步判定是由于 <strong>log4j-over-slf4j</strong> 包引起的漏洞。</p></blockquote><ol start=4><li>漏洞原因</li></ol><ul><li><strong>log4j-over-slf4j</strong> 包引起的漏洞</li><li>Jenkins 服务运行环境使用的 <strong>Jetty</strong> 版本过低。</li><li>以上二者均有。</li></ul><h3 id=漏洞修复方案-1>漏洞修复方案</h3><ol><li><strong>方案一：</strong> 替换查找到的所有 log4j-over-slf4j 相关的 jar 包</li></ol><ul><li>只考虑 Log4j 是造成该漏洞信息的主要原因，应该是 Jenkins 程序调用的 log4j-over-slf4j 引起的，可以只换这一个，但是为了安全起见，我把 3 个都替换了。</li><li>硬替 jar 包的方式可能引起某些特殊场景的异常，一定要备份好之前的 jar 包，便于回滚。</li><li>解决方案可能并不彻底，只是根据 <strong>Log4j</strong> 的相关修复建议，替换了有关的 JAR 包，但是并不符合 Jetty 版本要求，目前版本为 <strong>9.4.43.v20210629</strong> 需要升级到不低于 <strong>11.0.7</strong> 的版本。</li><li><strong>如果没有特殊需求，建议首选这种修复方案，虽然没有解决根本，但是胜在简单，回滚方便，整体出问题的可能性更小。</strong></li></ul><blockquote><p><strong>说明：</strong> 该方案已经验证， 替换 jar 包后重启 devops-jenkins，重新执行漏洞扫描，该漏洞没再次发现。</p><p>重启后也执行过相应的流水线任务，目前看来功能也都正常。毕竟没有完全充分测试，所以不排除某些特殊场景可能存在问题。</p></blockquote><ol start=2><li><strong>方案二：</strong> 升级 Jenkins 和相应的插件到比较新的版本</li></ol><ul><li>升级比较彻底， Jetty 和 Log4j 都升级到新的版本。</li><li>需要考虑版本兼容性问题，是否与 KubeSphere 适配，没在官网找到相关介绍，只能升级尝试。</li><li>自己打包比较麻烦，需要有一定的动手能力，需要自己重新构建 <strong>ks-jenkins</strong> 使用的 Image。</li><li>官方的打包项目文档比较简单，需要有一定的基础。</li><li>利用重新构建的 Image 重启已有的 Jenkins 服务后，<strong>原有数据配置是否丝毫不受影响</strong>？还需要进一步深层次验证。</li><li>升级 Jenkins 和插件还有一个简单方法，直接在 Jenkins 的管理界面把提示升级的组件都升级了，这些更简单便捷的解决了版本兼容性的问题，有兴趣的可以自己尝试。</li><li>如果选全升级的解决方案，一定要自己做充分的验证测试，才可以在生产环境升级。毕竟，未知的永远是可怕的。</li><li>本文在实验过程中遇到了很多插件版本兼容性问题，后面文档中的内容都是不断摸索、试错整理的，而且最终也没有完美解决。</li><li><strong>再次强调，除非明确的知道你在做什么，能搞定所有变动带来对风险，否则不要轻易的在生产环境用该方案！！！</strong></li></ul><blockquote><p><strong>说明：</strong> 为了 get 一个新的技巧，本文后面的内容重点介绍手动自定义构建 <strong>ks-jenkins Image</strong> 的实战操作。</p></blockquote><h2 id=自定义构建-jenkins-镜像>自定义构建 Jenkins 镜像</h2><p>KubeSphere 使用的 Jenkins Image 是采用 GitHub 中 <a href=https://github.com/kubesphere/ks-jenkins target=_blank rel="noopener noreferrer">ks-jenkins</a> 项目下的相关工具和配置进行打包的，该项目底层工具使用的是 jcli，具体说明可以查看项目介绍。</p><p>项目文档比较简单，没有一定的代码开发基础，实战起来还是比较困难的，我也是根据自己的理解和搜索引擎整理了操作过程，有些细节知识点并没有深入了解，目前也仅仅是解决了能打包的需求。</p><p>重新构建的镜像思路和方法是对的，但是整体的功能性与兼容性，并没有进行过充分测试，而且实战过程中也遇到了很多没有解决的问题，后续操作的价值仅限于参考。<strong>生产环境使用请慎重。</strong></p><h3 id=配置开发环境>配置开发环境</h3><ol><li>安装 Java</li></ol><p>从 Oracle <a href=https://www.oracle.com/java/technologies/downloads/#java8 target=_blank rel="noopener noreferrer">官网下载</a>软件包 <strong>jdk-8u361-linux-x64.tar.gz</strong>，这个需要自己注册账户才能下载。大家也可以使用自己习惯的方式配置 安装配置 JAVA 环境。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建工具存放目录，并解压 jdk 软件包</span>
</span></span><span style=display:flex><span>mkdir /data/tools
</span></span><span style=display:flex><span>tar xvf jdk-8u361-linux-x64.tar.gz -C /data/tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 java profile</span>
</span></span><span style=display:flex><span>cat &gt;&gt; /etc/profile &lt;&lt; <span style=color:#e6db74>&#34;EOF&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># java environment</span>
</span></span><span style=display:flex><span>export JAVA_HOME<span style=color:#f92672>=</span>/data/tools/jdk1.8.0_361
</span></span><span style=display:flex><span>export CLASSPATH<span style=color:#f92672>=</span>.:<span style=color:#e6db74>${</span>JAVA_HOME<span style=color:#e6db74>}</span>/jre/lib/rt.jar:<span style=color:#e6db74>${</span>JAVA_HOME<span style=color:#e6db74>}</span>/lib/dt.jar:<span style=color:#e6db74>${</span>JAVA_HOME<span style=color:#e6db74>}</span>/lib/tools.jar
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$PATH:<span style=color:#e6db74>${</span>JAVA_HOME<span style=color:#e6db74>}</span>/bin
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 Java</span>
</span></span><span style=display:flex><span>source /etc/profile
</span></span><span style=display:flex><span>java -version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出信息如下，表示 Java 安装成功</span>
</span></span><span style=display:flex><span>java version <span style=color:#e6db74>&#34;1.8.0_361&#34;</span>
</span></span><span style=display:flex><span>Java<span style=color:#f92672>(</span>TM<span style=color:#f92672>)</span> SE Runtime Environment <span style=color:#f92672>(</span>build 1.8.0_361-b09<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Java HotSpot<span style=color:#f92672>(</span>TM<span style=color:#f92672>)</span> 64-Bit Server VM <span style=color:#f92672>(</span>build 25.361-b09, mixed mode<span style=color:#f92672>)</span>
</span></span></code></pre></div><ol start=2><li>安装 Maven</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 下载 并解压 Maven</span>
</span></span><span style=display:flex><span>wget https://archive.apache.org/dist/maven/maven-3/3.8.7/binaries/apache-maven-3.8.7-bin.tar.gz
</span></span><span style=display:flex><span>tar xvf apache-maven-3.8.7-bin.tar.gz -C /data/tools/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 maven profile</span>
</span></span><span style=display:flex><span>cat &gt;&gt; /etc/profile &lt;&lt; <span style=color:#e6db74>&#34;EOF&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># maven environment</span>
</span></span><span style=display:flex><span>export M2_HOME<span style=color:#f92672>=</span>/data/tools/apache-maven-3.8.7
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$PATH:$M2_HOME/bin
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 Maven</span>
</span></span><span style=display:flex><span>source /etc/profile
</span></span><span style=display:flex><span>mvn -version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出信息如下，表示 Maven 安装成功</span>
</span></span><span style=display:flex><span>Apache Maven 3.8.6 <span style=color:#f92672>(</span>84538c9988a25aec085021c365c560670ad80f63<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Maven home: /data/tools/apache-maven
</span></span><span style=display:flex><span>Java version: 1.8.0_361, vendor: Oracle Corporation, runtime: /data/tools/jdk1.8.0_361/jre
</span></span><span style=display:flex><span>Default locale: en_US, platform encoding: UTF-8
</span></span><span style=display:flex><span>OS name: <span style=color:#e6db74>&#34;linux&#34;</span>, version: <span style=color:#e6db74>&#34;3.10.0-1160.83.1.el7.x86_64&#34;</span>, arch: <span style=color:#e6db74>&#34;amd64&#34;</span>, family: <span style=color:#e6db74>&#34;unix&#34;</span>
</span></span></code></pre></div><ol start=3><li>安装 jcli</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /tmp
</span></span><span style=display:flex><span>curl -L https://github.com/jenkins-zh/jenkins-cli/releases/latest/download/jcli-linux-amd64.tar.gz | tar xzv
</span></span><span style=display:flex><span>mv jcli /usr/local/bin/
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 受限于网络原因，可能需要多次操作，最好是使用其他方式提前下载并传送到服务器。</p></blockquote><ol start=4><li>安装 Git（可选项）</li></ol><p>安装 Git 的目的是从 GitHub 上拉取代码，也可以不使用 Git，直接在 GitHub 上下载打包好的代码文件。考虑 GitOps 配置管理及以后的扩展需求，本文重点介绍 Git 的方式。</p><p>CentOS 系统自带的 Git 版本比较老，在某些场景使用时会有版本兼容性问题。因此，选择了第三方的软件源安装新版的 Git。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># CentOS 7 安装 ius 软件源</span>
</span></span><span style=display:flex><span>curl https://setup.ius.io | sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装新版本 Git</span>
</span></span><span style=display:flex><span>yum install git236
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 Git</span>
</span></span><span style=display:flex><span>git version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出信息如下，表示 Git 安装成功</span>
</span></span><span style=display:flex><span>git version 2.36.4
</span></span></code></pre></div><ol start=5><li>安装 Docker</li></ol><p>构建镜像的过程中会直接生成 Jenkins Docker 镜像。因此，需要打包服务器安装 Docker 运行环境。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 配置 Docker 安装源</span>
</span></span><span style=display:flex><span>cat &gt;&gt; /etc/yum.repos.d/docker.repo &lt;&lt; <span style=color:#e6db74>&#34;EOF&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>docker-ce-stable<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>name<span style=color:#f92672>=</span>Docker CE Stable - $basearch
</span></span><span style=display:flex><span>baseurl<span style=color:#f92672>=</span>https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/$releasever/$basearch/stable
</span></span><span style=display:flex><span>enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>gpgkey<span style=color:#f92672>=</span>https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/gpg
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装 Docker</span>
</span></span><span style=display:flex><span>yum install docker-ce
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置 Docker</span>
</span></span><span style=display:flex><span>mkdir /etc/docker
</span></span><span style=display:flex><span>cat &gt;&gt; /etc/docker/daemon.json &lt;&lt; <span style=color:#e6db74>&#34;EOF&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;data-root&#34;</span>: <span style=color:#e6db74>&#34;/data/docker&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;registry-mirrors&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://mirror.ccs.tencentyun.com&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;https://registry.docker-cn.com&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动 Docker</span>
</span></span><span style=display:flex><span>systemctl start docker --now
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 Docker</span>
</span></span><span style=display:flex><span>docker version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出信息如下，表示安装成功</span>
</span></span><span style=display:flex><span>Client: Docker Engine - Community
</span></span><span style=display:flex><span> Version:           23.0.0
</span></span><span style=display:flex><span> API version:       1.42
</span></span><span style=display:flex><span> Go version:        go1.19.5
</span></span><span style=display:flex><span> Git commit:        e92dd87
</span></span><span style=display:flex><span> Built:             Wed Feb  <span style=color:#ae81ff>1</span> 17:49:02 <span style=color:#ae81ff>2023</span>
</span></span><span style=display:flex><span> OS/Arch:           linux/amd64
</span></span><span style=display:flex><span> Context:           default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Server: Docker Engine - Community
</span></span><span style=display:flex><span> Engine:
</span></span><span style=display:flex><span>  Version:          23.0.0
</span></span><span style=display:flex><span>  API version:      1.42 <span style=color:#f92672>(</span>minimum version 1.12<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Go version:       go1.19.5
</span></span><span style=display:flex><span>  Git commit:       d7573ab
</span></span><span style=display:flex><span>  Built:            Wed Feb  <span style=color:#ae81ff>1</span> 17:46:49 <span style=color:#ae81ff>2023</span>
</span></span><span style=display:flex><span>  OS/Arch:          linux/amd64
</span></span><span style=display:flex><span>  Experimental:     false
</span></span><span style=display:flex><span> containerd:
</span></span><span style=display:flex><span>  Version:          1.6.16
</span></span><span style=display:flex><span>  GitCommit:        31aa4358a36870b21a992d3ad2bef29e1d693bec
</span></span><span style=display:flex><span> runc:
</span></span><span style=display:flex><span>  Version:          1.1.4
</span></span><span style=display:flex><span>  GitCommit:        v1.1.4-0-g5fd4c4d
</span></span><span style=display:flex><span> docker-init:
</span></span><span style=display:flex><span>  Version:          0.19.0
</span></span><span style=display:flex><span>  GitCommit:        de40ad0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装 docker-compose，使用国内的镜像，官方 GitHub 上下载实在是太慢了。</span>
</span></span><span style=display:flex><span>curl -L https://get.daocloud.io/docker/compose/releases/download/v2.15.1/docker-compose-<span style=color:#e6db74>`</span>uname -s<span style=color:#e6db74>`</span>-<span style=color:#e6db74>`</span>uname -m<span style=color:#e6db74>`</span> &gt; /usr/local/bin/docker-compose
</span></span><span style=display:flex><span>chmod u+x /usr/local/bin/docker-compose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 docker-compose</span>
</span></span><span style=display:flex><span>docker-compose version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出信息如下，表示安装成功</span>
</span></span><span style=display:flex><span>Docker Compose version v2.15.1
</span></span></code></pre></div><h3 id=自定义构建镜像>自定义构建镜像</h3><ol><li>升级版本规划</li></ol><ul><li>Jenkins：<strong>2.375.3</strong>，使用 LTS 最新版，具体版本信息查询 <a href=https://www.jenkins.io/download/ target=_blank rel="noopener noreferrer">入口</a>。</li><li>Jenkins 2.375.3 镜像地址：<strong>jenkins/jenkins:2.375.3</strong>，具体 Image tag 信息查询 <a href="https://hub.docker.com/r/jenkins/jenkins/tags?page=1&amp;name=375.3" target=_blank rel="noopener noreferrer">入口</a>。</li><li>Plugins ssh-slaves：<strong>1.834.v622da_57f702c</strong>，插件版本及需要的 Jenkins 最低版本等详细信息查询 <a href=https://plugins.jenkins.io/ssh-slaves/ target=_blank rel="noopener noreferrer">入口</a>。</li><li>Plugins prometheus：<strong>2.1.1</strong>，插件版本及需要的 Jenkins 最低版本等详细信息查询 <a href=https://plugins.jenkins.io/prometheus/ target=_blank rel="noopener noreferrer">入口</a>。</li></ul><blockquote><p><strong>说明：</strong> 初步只更新 Jenkins 版本和有关联的两个 Plugins 的版本，其他 Plugins 由于不清楚依赖关系及影响，暂时不动。</p><p>这也是一个试错的过程，在后续的测试中发现，仅仅修改两个插件的版本号是远远不够的。</p></blockquote><ol start=2><li>下载 ks-jenkins 代码</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /data/build
</span></span><span style=display:flex><span>cd /data/build
</span></span><span style=display:flex><span>git clone https://github.com/kubesphere/ks-jenkins.git
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> 受限于网络原因，可能需要多次操作。</p></blockquote><ol start=3><li>创建一个新的代码分支</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 根据 Master 分支创建新分支，命名方式参考的已有分支</span>
</span></span><span style=display:flex><span>cd ks-jenkins
</span></span><span style=display:flex><span>git checkout -b v3.3.0-2.375.3
</span></span></code></pre></div><ol start=4><li>根据规划修改配置文件 <strong>formula.yaml</strong></li></ol><p>主要修改 jenkins 基础镜像的版本，插件 ssh-slaves 和 prometheus 的版本，同时因为依赖关系更新了这两个插件依赖的其他插件的版本。</p><blockquote><p><strong>说明：</strong> 这个梳理插件之间的版本依赖关系的过程比较麻烦，我目前也没有找到更好的办法，都是在管理界面根据提示的需求修改的。</p></blockquote><p>同时，还修改了 build 的一些参数，具体原因请查看常见问题。</p><p>修改后的主要内容大致如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>buildSettings</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>base</span>: <span style=color:#ae81ff>jenkins/jenkins:2.375.3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: {{<span style=color:#ae81ff>.tag}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>outputDir</span>: {{<span style=color:#ae81ff>.output}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>war</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>jenkins-war</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>2.375.3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>plugins</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>......</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>ssh-slaves</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.834</span><span style=color:#ae81ff>.v622da_57f702c</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>prometheus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;2.1.1&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>4.1.6.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins.pipeline-stage-view</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>pipeline-rest-api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;2.21&#34;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>trilead-api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.57</span><span style=color:#ae81ff>.v6e90e07157e1</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>credentials</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>1139.</span><span style=color:#ae81ff>veb_9579fca_33b_</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>org.jenkins-ci.plugins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>ssh-credentials</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>291.</span><span style=color:#ae81ff>v8211e4f8efb_c</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>groupId</span>: <span style=color:#ae81ff>io.jenkins</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>artifactId</span>: <span style=color:#ae81ff>configuration-as-code</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>source</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;1569.vb_72405b_80249&#34;</span>
</span></span></code></pre></div><blockquote><p><strong>注意：</strong> 上面的配置文件只列出了部分插件的变更信息，并不是完整的，并没有实现完整的效果，仅供参考。</p></blockquote><ol start=5><li>修改构建配置文件 <strong>Makefile</strong></li></ol><p>主要修改 build 相关的内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#a6e22e>build</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	jcli cwp --install-artifacts --config-path formula.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set output<span style=color:#f92672>=</span>tmp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set tag<span style=color:#f92672>=</span>kubesphere/ks-jenkins:v3.3.0-2.375.3
</span></span></code></pre></div><ol start=6><li>制作 Image</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 执行构建命令</span>
</span></span><span style=display:flex><span>make build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 正确的构建会有类似下面的输出</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main ks-jenkins<span style=color:#f92672>]</span><span style=color:#75715e># make build</span>
</span></span><span style=display:flex><span>jcli cwp --install-artifacts --config-path formula.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set output<span style=color:#f92672>=</span>tmp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set tag<span style=color:#f92672>=</span>kubesphere/ks-jenkins:v3.3.0-2.375.3
</span></span><span style=display:flex><span>Feb 09, <span style=color:#ae81ff>2023</span> 2:31:00 PM io.jenkins.tools.warpackager.lib.impl.Builder buildIfNeeded
</span></span><span style=display:flex><span>INFO: Component org.jenkins-ci.main:jenkins-war:2.375.3: no build required
</span></span><span style=display:flex><span>Feb 09, <span style=color:#ae81ff>2023</span> 2:31:00 PM io.jenkins.tools.warpackager.lib.impl.Builder buildIfNeeded
</span></span><span style=display:flex><span>INFO: Component io.jenkins:configuration-as-code:1.53: no build required
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Feb 09, <span style=color:#ae81ff>2023</span> 2:31:00 PM io.jenkins.tools.warpackager.lib.impl.Builder checkoutIfNeeded
</span></span><span style=display:flex><span>INFO: Will checkout bundle-plugins from local directory: remove-bundle-plugins.groovy
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Scanning <span style=color:#66d9ef>for</span> projects...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> ------------------&lt; io.github.ks-jenkins:ks-jenkins &gt;-------------------
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> Building ks-jenkins 1.0-SNAPSHOT
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>INFO<span style=color:#f92672>]</span> --------------------------------<span style=color:#f92672>[</span> jar <span style=color:#f92672>]</span>---------------------------------
</span></span><span style=display:flex><span>Downloading from repo.jenkins-ci.org: https://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/2.375.3/jenkins-war-2.375.3.pom
</span></span><span style=display:flex><span>Downloaded from repo.jenkins-ci.org: https://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/2.375.3/jenkins-war-2.375.3.pom <span style=color:#f92672>(</span>6.4 kB at <span style=color:#ae81ff>625</span> B/s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Downloading from incrementals: https://repo.jenkins-ci.org/incrementals/com/microsoft/azure/azure-client-runtime/maven-metadata.xml
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INFO: Discovered hooks: init.groovy.d
</span></span><span style=display:flex><span>Feb 09, <span style=color:#ae81ff>2023</span> 4:14:50 PM io.jenkins.tools.warpackager.lib.util.DockerfileBuilder build
</span></span><span style=display:flex><span>INFO: Generating Dockerfile
</span></span><span style=display:flex><span>Feb 09, <span style=color:#ae81ff>2023</span> 4:14:50 PM io.jenkins.tools.warpackager.lib.util.DockerfileBuilder build
</span></span><span style=display:flex><span>INFO: Building Docker image kubesphere/ks-jenkins:v3.3.0-2.375.3
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Building 329.0s <span style=color:#f92672>(</span>7/7<span style=color:#f92672>)</span> FINISHED                                                               
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>internal<span style=color:#f92672>]</span> load .dockerignore                                                           0.6s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; transferring context: 2B                                                             0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>internal<span style=color:#f92672>]</span> load build definition from Dockerfile                                        0.8s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; transferring dockerfile: 295B                                                        0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>internal<span style=color:#f92672>]</span> load metadata <span style=color:#66d9ef>for</span> docker.io/jenkins/jenkins:2.375.3                        126.8s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>internal<span style=color:#f92672>]</span> load build context                                                           2.3s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; transferring context: 334.65MB                                                       2.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>1/2<span style=color:#f92672>]</span> FROM docker.io/jenkins/jenkins:2.375.3@sha256:8656eb80548f7d9c7be5d1f4c367ef43  177.5s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; resolve docker.io/jenkins/jenkins:2.375.3@sha256:8656eb80548f7d9c7be5d1f4c367ef432f  0.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:f16216f97fcb99c68e03372f08859d8efd86e075e8bc22a0707d991b05 13.12kB / 13.12kB  0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:8656eb80548f7d9c7be5d1f4c367ef432f2dd62f81efa86795c915525801 2.36kB / 2.36kB  0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:ed0d0b4f22e27ee95718f7e701f5e189b58f8a4ffbc60b9769124ccabfb1 2.77kB / 2.77kB  0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:699c8a97647f5789e5850bcf1a3d5afe9730edb654e1ae0714d5bd198 55.03MB / 55.03MB  47.3s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:656837bc63c37068f9786473270235ab4830753280df7f0350ad09fb0 51.63MB / 51.63MB  47.7s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:81ba850015575dd93d4b7b63eb5cb6a1aea458b325242ab10531b482cba 8.93MB / 8.93MB  34.5s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:f565cdb160feddd496a91f8857376382ff4e1b48333c1c0f994a1765bf3 1.24kB / 1.24kB  66.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:699c8a97647f5789e5850bcf1a3d5afe9730edb654e1ae0714d5bd198a67a3ed   2.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:656837bc63c37068f9786473270235ab4830753280df7f0350ad09fb0374f1ee   1.9s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:81ba850015575dd93d4b7b63eb5cb6a1aea458b325242ab10531b482cba6d2f1   0.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:f565cdb160feddd496a91f8857376382ff4e1b48333c1c0f994a1765bf3dd519   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:7f0db80857b0730f0a39ac7c71449bb1166d945c66bb6a1ea0fd6d75190e250 189B / 189B  79.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:7f0db80857b0730f0a39ac7c71449bb1166d945c66bb6a1ea0fd6d75190e2505   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:b113c3f8acf6fadd7bf46f1085836b609f006c6582857c849361969394 5.68MB / 5.68MB  112.4s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:a02b1ab95401fafdd2c8a936bba450cdebe3182ffddb7d6ca8a319e52a8f3f5 199B / 199B  96.8s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:b51e09c8a0bdd4feb08358353f7214e20375f292d3e18ce11dabb77e 94.02MB / 94.02MB  112.3s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:90c616f07a2df86bef2ad9cc09ca44f34c9d0bc5e7bf6463c53037c7 76.93MB / 76.93MB  150.1s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:b51e09c8a0bdd4feb08358353f7214e20375f292d3e18ce11dabb77e3b21a2a2   0.6s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:a02b1ab95401fafdd2c8a936bba450cdebe3182ffddb7d6ca8a319e52a8f3f53   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:b113c3f8acf6fadd7bf46f1085836b609f006c6582857c849361969394671a06   0.2s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:32fdd8eaf030672618b17bb89dfd41e06b48b4e5698b5d749b7df02ceb 1.17kB / 1.17kB  143.6s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:22b92623028315e2f81b64231e48c1e8cc5656c2d95b4d43dbea67f1ff 1.93kB / 1.93kB  143.6s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:e04af8aa1a0565689acfc84c92700ee9726771b3e9f2fb14139c382dce6f39 374B / 374B  174.7s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; sha256:3938fe646b557890e41807ff23870f648fd4eed439d13bc617f3d1f267e56a 269B / 269B  174.9s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:90c616f07a2df86bef2ad9cc09ca44f34c9d0bc5e7bf6463c53037c786653ee2   2.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:22b92623028315e2f81b64231e48c1e8cc5656c2d95b4d43dbea67f1ff8b7fb4   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:32fdd8eaf030672618b17bb89dfd41e06b48b4e5698b5d749b7df02ceba2d8db   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:e04af8aa1a0565689acfc84c92700ee9726771b3e9f2fb14139c382dce6f3979   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; extracting sha256:3938fe646b557890e41807ff23870f648fd4eed439d13bc617f3d1f267e56ae4   0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>[</span>2/2<span style=color:#f92672>]</span> ADD target/ks-jenkins-1.0-SNAPSHOT.war /usr/share/jenkins/jenkins.war            21.8s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; exporting to image                                                                      2.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; exporting layers                                                                     1.9s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; writing image sha256:23c59911c9309bb8436716797ab488e80b3d7dbeea0135c9b8c9faa230d24f  0.0s
</span></span><span style=display:flex><span> <span style=color:#f92672>=</span>&gt; <span style=color:#f92672>=</span>&gt; naming to docker.io/kubesphere/ks-jenkins:v3.3.0-2.375.3
</span></span></code></pre></div><blockquote><p><strong>注意：</strong> 构建过程会通过 Maven 下载很多依赖包，具体时长视网络和机器配置而定。</p></blockquote><h3 id=镜像验证>镜像验证</h3><p>镜像构建完成后，我们需要验证镜像是否可用，新的镜像是否符合安全需求。</p><ol><li>查看构建的 Image</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main ks-jenkins<span style=color:#f92672>]</span><span style=color:#75715e># docker images</span>
</span></span><span style=display:flex><span>REPOSITORY              TAG              IMAGE ID       CREATED              SIZE
</span></span><span style=display:flex><span>kubesphere/ks-jenkins   v3.3.0-2.375.3   23c59911c930   About a minute ago   801MB
</span></span></code></pre></div><ol start=2><li>验证 Image 是否可用</li></ol><p>一定要验证构建的 Image 是否能创建 Jenkins，并正常使用。</p><p>在开发服务器上使用 Docker 启动一个 Jenkins。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建容器运行目录（个人习惯）</span>
</span></span><span style=display:flex><span>mkdir -p /data/containers/jenkins/volumes/jenkins_home
</span></span><span style=display:flex><span>cd /data/containers/jenkins/
</span></span><span style=display:flex><span>chown 1000:1000 volumes/jenkins_home/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建 docker-compose.yml</span>
</span></span><span style=display:flex><span>cat &gt;&gt; docker-compose.yml &lt;&lt; <span style=color:#e6db74>&#34;EOF&#34;</span>
</span></span><span style=display:flex><span>version: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  jenkins:
</span></span><span style=display:flex><span>    image: <span style=color:#e6db74>&#39;kubesphere/ks-jenkins:v3.3.0-2.375.3&#39;</span>
</span></span><span style=display:flex><span>    container_name: jenkins
</span></span><span style=display:flex><span>    privileged: true
</span></span><span style=display:flex><span>    restart: always
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;8080:8080&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;50000:50000&#39;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#39;./volumes/jenkins_home:/var/jenkins_home&#39;</span>
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行 Jenkins</span>
</span></span><span style=display:flex><span>docker-compose up -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行结果正常如下</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Running 2/2
</span></span><span style=display:flex><span> ⠿ Network jenkins_default  Created                                                                    0.1s
</span></span><span style=display:flex><span> ⠿ Container jenkins        Started                                                                    0.7s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看容器是否成功启动</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main jenkins<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose ps</span>
</span></span><span style=display:flex><span>NAME                IMAGE                                  COMMAND                  SERVICE             CREATED              STATUS              PORTS
</span></span><span style=display:flex><span>jenkins             kubesphere/ks-jenkins:v3.3.0-2.375.3   <span style=color:#e6db74>&#34;tini -- /usr/local/…&#34;</span>   jenkins             About a minute ago   Up About a minute   0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp, 0.0.0.0:50000-&gt;50000/tcp, :::50000-&gt;50000/tcp
</span></span></code></pre></div><ol start=3><li>验证 Jenkins 是否正常</li></ol><p>登录 Jenkins 管理控制台，需要输入系统初始化密码 <code>docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword</code>。</p><p>登录后，跳过系统初始化，直接进「系统管理」即可（截图略）。</p><blockquote><p><strong>注意：</strong> 实际操作中，插件管理里有很多<strong>红色</strong>的警告，我也是根据警告不断的调整不同插件的版本，再次打包再次验证。</p><p>简单的方案是在界面把所有存在问题的插件告警都处理完，然后根据最终结果，整理配置文件中插件版本号，然后再次打包。</p></blockquote><ol start=4><li>验证漏洞是否修复</li></ol><blockquote><p>检查请求响应头，发现 <strong>Jetty</strong> 版本依旧<strong>不符合</strong>要求的 <strong>11.0.7</strong>。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main ~<span style=color:#f92672>]</span><span style=color:#75715e># curl -I 192.168.9.10:8080</span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#ae81ff>403</span> Forbidden
</span></span><span style=display:flex><span>Date: Fri, <span style=color:#ae81ff>10</span> Feb <span style=color:#ae81ff>2023</span> 02:43:37 GMT
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Set-Cookie: JSESSIONID.cb5c1002<span style=color:#f92672>=</span>node0qid22cxyj1f81jjc8verbvj5e2.node0; Path<span style=color:#f92672>=</span>/; HttpOnly
</span></span><span style=display:flex><span>Expires: Thu, <span style=color:#ae81ff>01</span> Jan <span style=color:#ae81ff>1970</span> 00:00:00 GMT
</span></span><span style=display:flex><span>Content-Type: text/html;charset<span style=color:#f92672>=</span>utf-8
</span></span><span style=display:flex><span>X-Hudson: 1.395
</span></span><span style=display:flex><span>X-Jenkins: 2.375.3
</span></span><span style=display:flex><span>X-Jenkins-Session: d2fd27f1
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>541</span>
</span></span><span style=display:flex><span>Server: Jetty<span style=color:#f92672>(</span>10.0.12<span style=color:#f92672>)</span>
</span></span></code></pre></div><blockquote><p>检查 log4j 相关的 jar 包，只存在一个 log4j-over-slf4j 的包且已经是比较新的版本</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main jenkins_home<span style=color:#f92672>]</span><span style=color:#75715e># find ./ -name &#34;log4j*&#34;</span>
</span></span><span style=display:flex><span>./war/WEB-INF/lib/log4j-over-slf4j-2.0.3.jar
</span></span></code></pre></div><ol start=5><li>验证结论</li></ol><p>新构建的镜像 Jetty 版本并不符合安全要求，log4j 相关的包符合要求。</p><p>根据配置文件构建的镜像测试效果并不完美，很多插件无法使用，主要问题在于插件的兼容性问题。这个也确实是我们测试之前担心的，暂时我也没有更好的解决办法。</p><p>如果有强烈的更新需求，建议使用新版的 Jenkins 构建镜像，部署完成后从插件管理里解决插件依赖问题。</p><h2 id=替换-kubesphere-使用的-jenkins-image>替换 KubeSphere 使用的 Jenkins Image</h2><p>鉴于自定义构建 Jenkins Image 的结果并不完美。因此，本节后面的操作，<strong>切记不要轻易在生产环境直接使用</strong>！仅把思路和操作方法提供给各位，作为参考。如果要在生产环境使用，一定要经过充分的测试验证。</p><h3 id=将自定义的-jenkins-镜像传送到服务>将自定义的 Jenkins 镜像传送到服务</h3><p>如果使用离线镜像自定义域名部署的集群，推送镜像到内网 Harbor 仓库 (此过程略)。</p><p>如果用的在线互联网的镜像，比如我的环境就是使用的 <strong>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.319.1</strong>。 手工推送镜像到服务器并修改 tag 名字。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 在打包服务器导出自定义构建的 Image</span>
</span></span><span style=display:flex><span>docker tag kubesphere/ks-jenkins:v3.3.0-2.375.3 registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.375.3
</span></span><span style=display:flex><span>docker save registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.375.3 -o ks-jenkins-v3.3.0-2.375.3.tar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 上传到 devops-jenkins 所在的服务器（过程略）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 在 devops-jenkins 服务器导入, 没有 docker 命令，只能用 ctr 命令</span>
</span></span><span style=display:flex><span>ctr -n k8s.io image import ks-jenkins-v3.3.0-2.375.3.tar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证镜像是否导入</span>
</span></span><span style=display:flex><span>ctr -n k8s.io image ls |grep jenkins
</span></span></code></pre></div><h3 id=修改-deployment-devops-jenkins-的配置>修改 Deployment devops-jenkins 的配置</h3><p>如果采用的在线互联网镜像的模式，需要更改两个配置项，<strong>image</strong> 和 <strong>imagePullPolicy</strong>，默认的 imagePullPolicy 为 Always，需要修改为 <strong>IfNotPresent</strong>。</p><p>有条件的尽量使用自建的镜像仓库，只需要修改 Image 配置即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 执行修改命令</span>
</span></span><span style=display:flex><span>kubectl edit deploy devops-jenkins -n kubesphere-devops-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改的主要内容如下（一共有两处相同的内容需要修改）</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 原始内容</span>
</span></span><span style=display:flex><span>image: registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.319.1
</span></span><span style=display:flex><span>imagePullPolicy: Always
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改后</span>
</span></span><span style=display:flex><span>image: registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.375.3
</span></span><span style=display:flex><span>imagePullPolicy: IfNotPresent
</span></span></code></pre></div><blockquote><p><strong>注意：</strong> 修改完成后保存退出，Deploy 会发现配置变更自动重建 Pod。</p></blockquote><h3 id=验证状态>验证状态</h3><ol><li>查看 deployment</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get  deploy -n kubesphere-devops-system -o wide</span>
</span></span><span style=display:flex><span>NAME                READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS       IMAGES                                                                    SELECTOR
</span></span><span style=display:flex><span>devops-apiserver    1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           102d   ks-devops        registry.cn-beijing.aliyuncs.com/kubesphereio/devops-apiserver:v3.3.0     app.kubernetes.io/instance<span style=color:#f92672>=</span>devops,app.kubernetes.io/name<span style=color:#f92672>=</span>ks-devops,devops.kubesphere.io/component<span style=color:#f92672>=</span>apiserver
</span></span><span style=display:flex><span>devops-controller   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           102d   ks-devops        registry.cn-beijing.aliyuncs.com/kubesphereio/devops-controller:v3.3.0    app.kubernetes.io/instance<span style=color:#f92672>=</span>devops,app.kubernetes.io/name<span style=color:#f92672>=</span>ks-devops,devops.kubesphere.io/component<span style=color:#f92672>=</span>controller
</span></span><span style=display:flex><span>devops-jenkins      1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           102d   devops-jenkins   registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.3.0-2.375.3   component<span style=color:#f92672>=</span>devops-jenkins-master
</span></span></code></pre></div><ol start=2><li>验证 Pod</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看 pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ks-k8s-master-0 ~<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get  pod -n kubesphere-devops-system -o wide</span>
</span></span><span style=display:flex><span>NAME                                 READY   STATUS      RESTARTS      AGE     IP               NODE              NOMINATED NODE   READINESS GATES
</span></span><span style=display:flex><span>devops-27932190-njblk                0/1     Completed   <span style=color:#ae81ff>0</span>             88m     10.233.116.37    ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-27932220-xrgnj                0/1     Completed   <span style=color:#ae81ff>0</span>             58m     10.233.116.38    ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-27932250-rvl2r                0/1     Completed   <span style=color:#ae81ff>0</span>             28m     10.233.116.39    ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-apiserver-6b468c95cb-grx4j    1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>32h ago<span style=color:#f92672>)</span>   102d    10.233.116.211   ks-k8s-master-2   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-controller-667f8449d7-w8mvf   1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>32h ago<span style=color:#f92672>)</span>   102d    10.233.117.173   ks-k8s-master-0   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>devops-jenkins-56d7d75d9-zj7lh       1/1     Running     <span style=color:#ae81ff>0</span>             4m34s   10.233.117.177   ks-k8s-master-0   &lt;none&gt;           &lt;none&gt;
</span></span><span style=display:flex><span>s2ioperator-0                        1/1     Running     <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>32h ago<span style=color:#f92672>)</span>   102d    10.233.87.33     ks-k8s-master-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><blockquote><p><strong>注意：</strong> 启动过程较慢，需要多刷新几次，确保状态 READY 值为 1/1</p></blockquote><ol start=3><li><p>登录 Jenkins 管理界面</p><p>确保能正常登录系统。</p><p>系统管理里没有明显报错。</p><p>原有的 Jenkins 项目都能查看。</p></li><li><p>验证原有的流水线任务</p><p>执行原有的流水线任务，检查任务是否能正常执行，并且结果符合预期。</p></li></ol><h2 id=常见问题>常见问题</h2><h3 id=采用默认配置文件时-build-失败>采用默认配置文件时 build 失败</h3><ul><li>报错信息</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@zdevops-main ks-jenkins<span style=color:#f92672>]</span><span style=color:#75715e># make build</span>
</span></span><span style=display:flex><span>jcli cwp --install-artifacts --config-path formula.yaml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set output<span style=color:#f92672>=</span>load <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set tag<span style=color:#f92672>=</span>kubespheredev/ks-jenkins:test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --value-set platform<span style=color:#f92672>=</span>linux/amd64
</span></span><span style=display:flex><span>Exception in thread <span style=color:#e6db74>&#34;main&#34;</span> com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException: Unrecognized field <span style=color:#e6db74>&#34;output&#34;</span> <span style=color:#f92672>(</span>class io.jenkins.tools.warpackager.lib.config.DockerBuildSettings<span style=color:#f92672>)</span>, not marked as ignorable <span style=color:#f92672>(</span><span style=color:#ae81ff>5</span> known properties: <span style=color:#e6db74>&#34;base&#34;</span>, <span style=color:#e6db74>&#34;tag&#34;</span>, <span style=color:#e6db74>&#34;outputDir&#34;</span>, <span style=color:#e6db74>&#34;build&#34;</span>, <span style=color:#e6db74>&#34;customSettings&#34;</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span> at <span style=color:#f92672>[</span>Source: <span style=color:#f92672>(</span>FileInputStream<span style=color:#f92672>)</span>; line: 10, column: 17<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>through reference chain: io.jenkins.tools.warpackager.lib.config.Config<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;buildSettings&#34;</span><span style=color:#f92672>]</span>-&gt;io.jenkins.tools.warpackager.lib.config.BuildSettings<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;docker&#34;</span><span style=color:#f92672>]</span>-&gt;io.jenkins.tools.warpackager.lib.config.DockerBuildSettings<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;output&#34;</span><span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException.from<span style=color:#f92672>(</span>UnrecognizedPropertyException.java:61<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.DeserializationContext.handleUnknownProperty<span style=color:#f92672>(</span>DeserializationContext.java:855<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.std.StdDeserializer.handleUnknownProperty<span style=color:#f92672>(</span>StdDeserializer.java:1212<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializerBase.handleUnknownProperty<span style=color:#f92672>(</span>BeanDeserializerBase.java:1604<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializerBase.handleUnknownVanilla<span style=color:#f92672>(</span>BeanDeserializerBase.java:1582<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize<span style=color:#f92672>(</span>BeanDeserializer.java:299<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize<span style=color:#f92672>(</span>BeanDeserializer.java:156<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.impl.FieldProperty.deserializeAndSet<span style=color:#f92672>(</span>FieldProperty.java:138<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize<span style=color:#f92672>(</span>BeanDeserializer.java:293<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize<span style=color:#f92672>(</span>BeanDeserializer.java:156<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.impl.FieldProperty.deserializeAndSet<span style=color:#f92672>(</span>FieldProperty.java:138<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.vanillaDeserialize<span style=color:#f92672>(</span>BeanDeserializer.java:293<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.deser.BeanDeserializer.deserialize<span style=color:#f92672>(</span>BeanDeserializer.java:156<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose<span style=color:#f92672>(</span>ObjectMapper.java:4526<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at com.fasterxml.jackson.databind.ObjectMapper.readValue<span style=color:#f92672>(</span>ObjectMapper.java:3505<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at io.jenkins.tools.warpackager.lib.config.Config.load<span style=color:#f92672>(</span>Config.java:77<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at io.jenkins.tools.warpackager.lib.config.Config.loadConfig<span style=color:#f92672>(</span>Config.java:106<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        at io.jenkins.tools.warpackager.cli.Main.main<span style=color:#f92672>(</span>Main.java:38<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>make: *** <span style=color:#f92672>[</span>build<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>经过简单分析，判断应该是现有的 ks-jenkins 代码库已经好几个月没有更新，使用的底层 jcli 不断在更新，导致现有版本的 <strong>cwp-cli.jar</strong> 的输入参数与默认配置文件中使用的配置不匹配。解决方案有两种：</p><ul><li>下载老版本的 cwp-cli 的 jar 包，具体方法只能靠各位自己研究了，我不熟悉也没深入探究。</li><li>根据当前版本的参数要求，修改配置文件 <strong>formula.yaml</strong>(比较简单，因此本文采用了该方案)。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 原配置文件内容</span>
</span></span><span style=display:flex><span><span style=color:#f92672>buildSettings</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>base</span>: <span style=color:#ae81ff>jenkins/jenkins:2.319.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: {{<span style=color:#ae81ff>.tag}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>output</span>: {{<span style=color:#ae81ff>.output}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>platform</span>: {{<span style=color:#ae81ff>.platform}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>buildx</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># 修改后的配置文件</span>
</span></span><span style=display:flex><span><span style=color:#f92672>buildSettings</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>base</span>: <span style=color:#ae81ff>jenkins/jenkins:2.375.3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag</span>: {{<span style=color:#ae81ff>.tag}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>outputDir</span>: {{<span style=color:#ae81ff>.output}}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h3 id=jenkins-系统管理界面中插件管理显示很多红色警告信息>Jenkins 系统管理界面中插件管理显示很多红色警告信息</h3><ul><li>报错信息</li></ul><p>不截图了，主要是在 Jenkins 的系统管理界面中插件管理的页面，会显示很多红色警告信息。有插件版本依赖关系、插件降级等红色或是黄色的提示。</p><ul><li>解决方案</li></ul><p>目前看来最简单的解决方案是在插件管理的页面根据提示解决。</p><p>如果想自动打包镜像的时候就处理好插件的依赖，我感觉还是需要在 <strong>jcli</strong> 这个工具入手。官方文档不够详细，资料也少，暂时没时间和精力去深入探究。所以先放弃了，后续有新的研究成果再分享。</p><p>但是 Jenkins 本身的问题解决后，与现有的 KubeSphere 是否兼容还需要充分验证。</p><h2 id=结束语>结束语</h2><p>本文以修复 Jenkins 存在的 Apache Log4j2 漏洞为背景，介绍了修复该漏洞的两种解决方案。并且，初步探究了在 KubeSphere 中集成的 Jenkins 如何自定义构建镜像以及如何升级更新。</p><p>探究过程并不是很完美，效果并没有达到预期。主要是由于插件依赖性的问题，导致自定义构建的镜像部署的 Jenkins 插件管理里存在很多告警。</p><p>由于能力和时间很有限，只能以一个不完美的结果结束本文了，非常抱歉！</p><p>因此，本文仅作为抛砖引玉之作，实战过程不适合在生产环境直接使用。动手能力超强的读者可将文中的思路和操作方法作为参考，继续改造。如果有更加完美的解决办法，请联系我分享给我，我将不胜感激！</p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&text=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&title=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-jenkins-log4j2%2f&t=%e4%bf%ae%e5%a4%8d%20KubeSphere%20%e5%86%85%e7%bd%ae%20Jenkins%20%e7%9a%84%20Apache%20Log4j2%20%e6%bc%8f%e6%b4%9e" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#漏洞修复方案>漏洞修复方案</a><ul><li><a href=#漏洞详细信息>漏洞详细信息</a></li><li><a href=#漏洞分析>漏洞分析</a></li><li><a href=#漏洞修复方案-1>漏洞修复方案</a></li></ul></li><li><a href=#自定义构建-jenkins-镜像>自定义构建 Jenkins 镜像</a><ul><li><a href=#配置开发环境>配置开发环境</a></li><li><a href=#自定义构建镜像>自定义构建镜像</a></li><li><a href=#镜像验证>镜像验证</a></li></ul></li><li><a href=#替换-kubesphere-使用的-jenkins-image>替换 KubeSphere 使用的 Jenkins Image</a><ul><li><a href=#将自定义的-jenkins-镜像传送到服务>将自定义的 Jenkins 镜像传送到服务</a></li><li><a href=#修改-deployment-devops-jenkins-的配置>修改 Deployment devops-jenkins 的配置</a></li><li><a href=#验证状态>验证状态</a></li></ul></li><li><a href=#常见问题>常见问题</a><ul><li><a href=#采用默认配置文件时-build-失败>采用默认配置文件时 build 失败</a></li><li><a href=#jenkins-系统管理界面中插件管理显示很多红色警告信息>Jenkins 系统管理界面中插件管理显示很多红色警告信息</a></li></ul></li><li><a href=#结束语>结束语</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>