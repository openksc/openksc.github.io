<!doctype html><html lang=en-US><head><meta charset=utf-8><title>你真的理解 K8s 中的 requests 和 limits 吗？</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="KubeSphere 是在 Kubernetes 之上构建的以应用为中心的多租户容器平台，提供全栈的 IT 自动化运维的能力，简化企业的 DevOps 工作流。KubeSphere 提供了运维友好的向导式操作界面，帮助企业快速构建一个强大和功能丰富的容器云平台。"><meta name=keywords content="KubeSphere,Kubernetes,容器平台,DevOps,混合云"><meta property="og:type" content="article"><meta property="og:title" content="你真的理解 K8s 中的 requests 和 limits 吗？"><meta property="og:description" content="KubeSphere 是在 Kubernetes 之上构建的以应用为中心的多租户容器平台，提供全栈的 IT 自动化运维的能力，简化企业的 DevOps 工作流。KubeSphere 提供了运维友好的向导式操作界面，帮助企业快速构建一个强大和功能丰富的容器云平台。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/deep-dive-into-the-k8s-request-and-limit/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/deep-dive-into-the-k8s-request-and-limit/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/deep-dive-into-the-k8s-request-and-limit/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>你真的理解 K8s 中的 requests 和 limits 吗？</span></div><div class='main-div middle-div'><div class=author>饶云坤</div><span class=date>发布于：2021-01-01</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>你真的理解 K8s 中的 requests 和 limits 吗？</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&text=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&title=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&t=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><p>在 K8s 集群中部署资源的时候，你是否经常遇到以下情形：</p><ol><li>经常在 K8s 集群种部署负载的时候不设置 CPU <code>requests</code> 或将 CPU <code>requests</code> 设置得过低（这样“看上去”就可以在每个节点上容纳更多 Pod ）。在业务比较繁忙的时候，节点的 CPU 全负荷运行。业务延迟明显增加，有时甚至机器会莫名其妙地进入 CPU 软死锁等“假死”状态。</li><li>类似地，部署负载的时候，不设置内存 <code>requests</code> 或者内存 <code>requests</code> 设置得过低，这时会发现有些 Pod 会不断地失败重启。而不断重启的这些 Pod 通常跑的是 Java 业务应用。但是这些 Java 应用本地调试运行地时候明明都是正常的。</li><li>在 K8s 集群中，集群负载并不是完全均匀地在节点间分配的，通常内存不均匀分配的情况较为突出，集群中某些节点的内存使用率明显高于其他节点。 K8s 作为一个众所周知的云原生分布式容器编排系统，一个所谓的事实上标准，其调度器不是应该保证资源的均匀分配吗？</li></ol><p>如果在业务高峰时间遇到上述问题，并且机器已经 hang 住甚至无法远程 ssh 登陆，那么通常留给集群管理员的只剩下重启集群这一个选项。如果你遇到过上面类似的情形，想了解如何规避相关问题或者你是 K8s 运维开发人员，想对这类问题的本质一探究竟，那么请耐心阅读下面的章节。我们会先对这类问题做一个定性分析，并给出避免此类问题的最佳实践，最后如果你对 K8s <code>requests</code> 和 <code>limits</code> 的底层机制感兴趣，我们可以从源码角度做进一步地分析，做到“知其然也知其所以然”。</p><h2 id=问题分析>问题分析</h2><p>首先我们需要知道对于 CPU 和内存这 2 类资源，他们是有一定区别的。 CPU 属于可压缩资源，其中 CPU 资源的分配和管理是 Linux 内核借助于完全公平调度算法（ CFS ）和 Cgroup 机制共同完成的。简单地讲，如果 pod 中服务使用 CPU 超过设置的 CPU <code>limits</code>， pod 的 CPU 资源会被限流（ throttled ）。对于没有设置<code>limit</code>的 pod ，一旦节点的空闲 CPU 资源耗尽，之前分配的 CPU 资源会逐渐减少。不管是上面的哪种情况，最终的结果都是 Pod 已经越来越无法承载外部更多的请求，表现为应用延时增加，响应变慢。这种情形对于上面的情形 1 。内存属于不可压缩资源， Pod 之间是无法共享的，完全独占的，这也就意味着资源一旦耗尽或者不足，分配新的资源一定是会失败的。有的 Pod 内部进程在初始化启动时会提前开辟出一段内存空间。比如 JVM 虚拟机在启动的时候会申请一段内存空间。如果内存 <code>requests</code> 指定的数值小于 JVM 虚拟机向系统申请的内存，导致内存申请失败（ oom-kill ），从而 Pod 出现不断地失败重启。这种情形对应于上面的情形 2 。对于情形 3 ，实际上在创建 pod 的过程中，一方面， K8s 需要拨备包含 CPU 和内存在内的多种资源，这里的资源均衡是包含 CPU 和内存在内的所有资源的综合考量。另一方面， K8s 内置的调度算法不仅仅涉及到“最小资源分配节点”，还会把其他诸如 Pod 亲和性等因素考虑在内。并且 k8s 调度基于的是资源的 <code>requests</code> 数值，而之所以往往观察到的是内存分布不够均衡，是因为对于应用来说，相比于其他资源，内存一般是更紧缺的一类资源。另一方面， K8s 的调度机制是基于当前的状态。比如当出现新的 Pod 进行调度时，调度程序会根据其当时对 Kubernetes 集群的资源描述做出最佳调度决定。但是 Kubernetes 集群是非常动态的，由于整个集群范围内的变化，比如一个节点为了维护，我们先执行了驱逐操作，这个节点上的所有 Pod 会被驱逐到其他节点去，但是当我们维护完成后，之前的 Pod 并不会自动回到该节点上来，因为 Pod 一旦被绑定了节点是不会触发重新调度的。</p><h2 id=最佳实践>最佳实践</h2><p>由上面的分析我们可以看到，集群的稳定性直接决定了其上运行的业务应用的稳定性。而临时性的资源短缺往往是导致集群不稳定的主要因素。集群一旦不稳定，轻则业务应用的性能下降，重则出现相关结点不可用。那么如何提高集群的稳定性呢？一方面，可以通过<a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/ target=_blank rel="noopener noreferrer">编辑 Kubelet 配置文件</a>来预留一部分系统资源，从而保证当可用计算资源较少时 kubelet 所在节点的稳定性。 这在处理如内存和硬盘之类的不可压缩资源时尤为重要。另一方面，通过合理地设置 pod 的 QoS 可以进一步提高集群稳定性：不同 QoS 的 Pod 具有不同的 OOM 分数，当出现资源不足时，集群会优先 Kill 掉 <code>Best-Effort</code> 类型的 Pod ，其次是 <code>Burstable</code> 类型的 Pod ，最后是<code>Guaranteed</code> 类型的 Pod 。因此，如果资源充足，可将 QoS pods 类型均设置为 <code>Guaranteed</code> 。用计算资源换业务性能和稳定性，减少排查问题时间和成本。同时如果想更好的提高资源利用率，业务服务也可以设置为 <code>Guaranteed</code> ，而其他服务根据重要程度可分别设置为 <code>Burstable</code> 或 <code>Best-Effort</code> 。下面我们会以 Kubesphere 平台为例，演示如何方便优雅地配置 Pod 相关的资源。</p><h2 id=kubesphere-资源配置实践>KubeSphere 资源配置实践</h2><p>前面我们已经了解到 K8s 中<code>requests</code>、<code>limits</code>这 2 个参数的合理设置对整个集群的稳定性至关重要。而作为 K8s 的发行版 Kubephere ，极大地降低了 K8s 的学习门槛，配合简介美观的 UI 界面，你会发现有效运维原来是一件如此轻松的事情。下面我们将演示如何在 KubeSphere 平台中配置容器的相关资源配额与限制。</p><h3 id=相关概念>相关概念</h3><p>在进行演示之前，让我们再回顾一下K8s相关概念。</p><h4 id=requests-与-limits-简介>requests 与 limits 简介</h4><p>为了实现 K8s 集群中资源的有效调度和充分利用， K8s 采用<code>requests</code>和<code>limits</code>两种限制类型来对资源进行容器粒度的分配。每一个容器都可以独立地设定相应的<code>requests</code>和<code>limits</code>。这 2 个参数是通过每个容器 containerSpec 的 resources 字段进行设置的。一般来说，在调度的时候<code>requests</code>比较重要，在运行时<code>limits</code>比较重要。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>resources</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:    
</span></span><span style=display:flex><span>        <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>50m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>50Mi</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>limits</span>:    
</span></span><span style=display:flex><span>        <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>100Mi</span>
</span></span></code></pre></div><p><code>requests</code>定义了对应容器需要的最小资源量。这句话的含义是，举例来讲，比如对于一个 Spring Boot 业务容器，这里的<code>requests</code>必须是容器镜像中 JVM 虚拟机需要占用的最少资源。如果这里把 pod 的内存<code>requests</code>指定为 10Mi ，显然是不合理的，JVM 实际占用的内存 Xms 超出了 K8s 分配给 pod 的内存，导致 pod 内存溢出，从而 K8s 不断重启 pod 。</p><p><code>limits</code>定义了这个容器最大可以消耗的资源上限，防止过量消耗资源导致资源短缺甚至宕机。特别的，设置为 0 表示对使用的资源不做限制。值得一提的是，当设置<code>limits</code>而没有设置<code>requests</code>时，Kubernetes 默认令<code>requests</code>等于<code>limits</code>。</p><p>进一步可以把<code>requests</code>和<code>limits</code>描述的资源分为 2 类：可压缩资源（例如 CPU ）和不可压缩资源（例如内存）。合理地设置<code>limits</code>参数对于不可压缩资源来讲尤为重要。</p><p>前面我们已经知道<code>requests</code>参数会最终的 K8s 调度结果起到直接的显而易见的影响。借助于 Linux 内核 Cgroup 机制，<code>limits</code>参数实际上是被 K8s 用来约束分配给进程的资源。对于内存参数而言，实际上就是告诉 Linux 内核什么时候相关容器进程可以为了清理空间而被杀死（ oom-kill ）。</p><p>总结一下：</p><ul><li>对于 CPU，如果 pod 中服务使用 CPU 超过设置的<code>limits</code>，pod 不会被 kill 掉但会被限制。如果没有设置 limits ，pod 可以使用全部空闲的 CPU 资源。</li><li>对于内存，当一个 pod 使用内存超过了设置的<code>limits</code>，pod 中 container 的进程会被 kernel 因 OOM kill 掉。当 container 因为 OOM 被 kill 掉时，系统倾向于在其原所在的机器上重启该 container 或本机或其他重新创建一个 pod。</li><li>0 &lt;= requests &lt;=Node Allocatable, requests &lt;= limits &lt;= Infinity</li></ul><h4 id=pod-的服务质量-qos->Pod 的服务质量（ QoS ）</h4><p>Kubernetes 创建 Pod 时就给它指定了下列一种 QoS 类：Guaranteed，Burstable，BestEffort。</p><ul><li>Guaranteed：Pod 中的每个容器，包含初始化容器，必须指定内存和CPU的<code>requests</code>和<code>limits</code>，并且两者要相等。</li><li>Burstable：Pod 不符合 Guaranteed QoS 类的标准；Pod 中至少一个容器具有内存或 CPU <code>requests</code>。</li><li>BestEffort：Pod 中的容器必须没有设置内存和 CPU <code>requests</code>或<code>limits</code>。</li></ul><p>结合结点上 Kubelet 的CPU管理策略，可以对指定 pod 进行绑核操作，参见<a href=https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/ target=_blank rel="noopener noreferrer">官方文档</a>。</p><h3 id=准备工作>准备工作</h3><p>您需要创建一个企业空间、一个项目和一个用户 ( ws-admin )，务必邀请该用户到项目中并赋予 admin 角色。有关更多信息，请参见<a href=https://kubesphere.io/zh/docs/quick-start/create-workspace-and-project/ target=_blank rel="noopener noreferrer">创建企业空间、项目、用户和角色</a>。</p><h3 id=设置项目配额-resource-quotas->设置项目配额（ Resource Quotas ）</h3><ol><li>进入项目基本信息界面，依次直接点击“项目管理 -> 编辑配额”进入项目的配额设置页面。</li></ol><p><img src=../../../images/blogs/deep-dive-into-the-K8s-request-and-limit/ksnip_20210122-194612.png alt></p><ol start=2><li>进入项目配额页面，为该项目分别指定<code>requests</code>和<code>limits</code>配额。</li></ol><p><img src=../../../images/blogs/deep-dive-into-the-K8s-request-and-limit/ksnip_20210122-193909.png alt></p><p>设置项目配额的有 2 方面的作用:</p><ul><li>限定了该项目下所有 pod 指定的<code>requests</code>和<code>limits</code>之和分别要小于等与这里指定的项目的总<code>requests</code>和<code>limits</code>。</li><li>如果在项目中创建任何一个容器没有指定<code>requests</code>或者<code>limits</code>，那么相应的资源会创建报错，并会以事件的形式给出报错提示。</li></ul><p>可以看到，设定项目配额以后，在该项目中创建任何容器都需要指定<code>requests</code>和<code>limits</code>，隐含实现了所谓的“code is law”，即人人都需要遵守的规则。</p><blockquote><p>Kubesphere中的项目配额等价于 K8s 中的 resource quotas ，项目配额除了能够以项目为单位管理 CPU 和内存的使用使用分配情况，还能够管理其他类型的资源数目等，详细信息参见<a href=https://kubernetes.io/docs/concepts/policy/resource-quotas/ target=_blank rel="noopener noreferrer">资源配额</a>。</p></blockquote><h3 id=设置容器资源的默认请求>设置容器资源的默认请求</h3><p>上面我们已经讨论过项目中开启了配额以后，那么之后创建的 pod 必须明确指定相应的 <code>requests</code> 和 <code>limits</code> 。事实上，在实际的测试或者生产环境当中，大部分 pod 的 <code>requests</code> 和 <code>limits</code> 是高度相近甚至完全相同的。有没有办法在项目中，事先设定好默认的缺省 <code>requests</code> 和 <code>limits</code> ，当用户没有指定容器的 <code>requests</code> 和 <code>limits</code> 时，直接应用默认值，若 pod 已经指定 <code>requests</code> 和 <code>limits</code> 是否直接跳过呢？答案是肯定的。</p><ol><li>进入项目基本信息界面，依次直接点击“项目管理 -> 编辑资源默认请求”进入项目的默认请求设置页面。</li></ol><p><img src=../../../images/blogs/deep-dive-into-the-K8s-request-and-limit/ksnip_20210122-194745.png alt></p><ol start=2><li>进入项目配额页面，为该项目分别指定 CPU 和内存的默认值。</li></ol><p><img src=../../../images/blogs/deep-dive-into-the-K8s-request-and-limit/ksnip_20210122-194358.png alt></p><blockquote><p>KubeSphere 中的项目种的容器资源默认请求是借助于 K8s 中的 Limit Ranges ，目前 KubeSphere 支持 CPU 和内存的<code>requests</code>和<code>limits</code>的默认值设定。</p></blockquote><p>前面我们已经了解到，对于一些关键的业务容器，通常其流量和负载相比于其他 pod 都是比较高的，对于这类容器的<code>requests</code>和<code>limits</code>需要具体问题具体分析。分析的维度是多个方面的，例如该业务容器是 CPU 密集型的，还是 IO 密集型的。是单点的还是高可用的，这个服务的上游和下游是谁等等。另一方面，在生产环境中这类业务容器的负载从一个比较长的时间维度看的话，往往是具有周期性的。因此，业务容器的历史监控数据可以在参数设置方面提供重要的参考价值。而 KubeSphere 在最初的设计中，就已经在架构层面考虑到了这点，将 Prometheus 组件无缝集成到 KubeSphere 平台中，并提供纵向上至集群层级，下至 pod 层级的完整的监控体系。横向涵盖 CPU ，内存，网络，存储等。一般，<code>requests</code>值可以设定为历史数据的均指，而<code>limits</code>要大于历史数据的均指，最终数值还需要结合具体情况做一些小的调整。</p><h2 id=源码分析>源码分析</h2><p>前面我们从日常 K8s 运维出发，描述了由于 <code>requests</code> 和 <code>limits</code>参数配置不当而引起的一系列问题，阐述了问题产生的原因并给出的最佳实践。下面我们将深入到 K8s 内部，从代码里表征的逻辑关系来进一步分析和验证上面给出的结论。</p><h3 id=requests-是如何影响-k8s-调度决策的>requests 是如何影响 K8s 调度决策的？</h3><p>我们知道在 K8s 中 pod 是最小的调度单位，pod 的<code>requests</code>与 pod 内容器的<code>requests</code>关系如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>computePodResourceRequest</span>(<span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>preFilterState</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>preFilterState</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Containers</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// take max_resource(sum_pod, any_init_container)</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>InitContainers</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>SetMaxResource</span>(<span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If Overhead is being utilized, add to the total requests for the pod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Overhead</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>utilfeature</span>.<span style=color:#a6e22e>DefaultFeatureGate</span>.<span style=color:#a6e22e>Enabled</span>(<span style=color:#a6e22e>features</span>.<span style=color:#a6e22e>PodOverhead</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Spec</span>.<span style=color:#a6e22e>Overhead</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Fit</span>) <span style=color:#a6e22e>PreFilter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cycleState</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>CycleState</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>Status</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cycleState</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>preFilterStateKey</span>, <span style=color:#a6e22e>computePodResourceRequest</span>(<span style=color:#a6e22e>pod</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getPreFilterState</span>(<span style=color:#a6e22e>cycleState</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>CycleState</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>preFilterState</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cycleState</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>preFilterStateKey</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// preFilterState doesn&#39;t exist, likely PreFilter wasn&#39;t invoked.</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error reading %q from cycleState: %v&#34;</span>, <span style=color:#a6e22e>preFilterStateKey</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>preFilterState</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;%+v  convert to NodeResourcesFit.preFilterState error&#34;</span>, <span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Fit</span>) <span style=color:#a6e22e>Filter</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cycleState</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>CycleState</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>nodeInfo</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>NodeInfo</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>Status</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getPreFilterState</span>(<span style=color:#a6e22e>cycleState</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>NewStatus</span>(<span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>Error</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>insufficientResources</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fitsRequest</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>nodeInfo</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ignoredResources</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>ignoredResourceGroups</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>insufficientResources</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We will keep all failure reasons.</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>failureReasons</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>insufficientResources</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>insufficientResources</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>failureReasons</span> = append(<span style=color:#a6e22e>failureReasons</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Reason</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>NewStatus</span>(<span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>Unschedulable</span>, <span style=color:#a6e22e>failureReasons</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从上面的源码中不难看出，调度器（实际上是 Schedule thread ）首先会在 Pre filter 阶段计算出待调度 pod 所需要的资源，具体讲就是从 Pod Spec 中分别计算初始容器和工作容器<code>requests</code>之和，并取其较大者，特别地，对于像 Kata-container 这样微虚机，其自身的虚拟化开销相比于容器来说是不能忽略不计的，所以还需要加上虚拟化本身的资源开销，计算出的结果存入到缓存中，在紧接着的 Filter 阶段，会遍历所有节点过滤出符合符合条件的节点。</p><p>实际上在过滤出所有符合条件的节点以后，如果当前满足的条件的节点只有一个，那么该 pod 随后将被调度到该结点。但是更多的情况下，此时过滤之后符合条件的结点往往有多个，这时候就需要进入 Score 阶段，依次对这些结点进行打分（ Score ）。而打分本身也是包括多个维度通过内置 plugin 的形式综合评判的。值得注意的是，前面我们定义的 pod 的<code>requests</code>和<code>limits</code>参数也会直接影响到<code>NodeResourcesLeastAllocated</code>算法最终的计算结果。源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>leastResourceScorer</span>(<span style=color:#a6e22e>resToWeightMap</span> <span style=color:#a6e22e>resourceToWeightMap</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>resourceToValueMap</span>, <span style=color:#a6e22e>resourceToValueMap</span>, <span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>requested</span>, <span style=color:#a6e22e>allocable</span> <span style=color:#a6e22e>resourceToValueMap</span>, <span style=color:#a6e22e>includeVolumes</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>requestedVolumes</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>allocatableVolumes</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodeScore</span>, <span style=color:#a6e22e>weightSum</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>weight</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>resToWeightMap</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>resourceScore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>leastRequestedScore</span>(<span style=color:#a6e22e>requested</span>[<span style=color:#a6e22e>resource</span>], <span style=color:#a6e22e>allocable</span>[<span style=color:#a6e22e>resource</span>])
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>nodeScore</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>resourceScore</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weightSum</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodeScore</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>weightSum</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>leastRequestedScore</span>(<span style=color:#a6e22e>requested</span>, <span style=color:#a6e22e>capacity</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>capacity</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>requested</span> &gt; <span style=color:#a6e22e>capacity</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> ((<span style=color:#a6e22e>capacity</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>requested</span>) <span style=color:#f92672>*</span> int64(<span style=color:#a6e22e>framework</span>.<span style=color:#a6e22e>MaxNodeScore</span>)) <span style=color:#f92672>/</span> <span style=color:#a6e22e>capacity</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到在<code>NodeResourcesLeastAllocated</code>算法中，对于同一个 pod ，目标结点的资源越充裕，那么该结点的得分也就越高。换句话说，同一个 pod 更倾向于调度到资源充足的结点。需要注意的是，实际上在创建 pod 的过程中，一方面， K8s 需要拨备包含 CPU 和内存在内的多种资源。每种资源都会对应一个权重（对应源码中的 resToWeightMap 数据结构），所以这里的资源均衡是包含 CPU 和内存在内的所有资源的综合考量。另一方面，在 Score 阶段，除了<code>NodeResourcesLeastAllocated</code>算法以外，调用器还会使用到其他算法（例如<code>InterPodAffinity</code>）进行分数的评定。</p><blockquote><p>注：在 K8s 调度器中，会把调度过程分为若干个阶段，即 Pre filter, Filter, Post filter, Score 等。在 Pre filter 阶段，用于选择符合 Pod Spec 描述的 Nodes 。</p></blockquote><h3 id=qos-是如何影响-k8s-调度决策的>QoS 是如何影响 K8s 调度决策的？</h3><p>QOS 作为 K8s 中一种资源保护机制，其主要是针对不可压缩资源比如的内存的一种控制技术，比如在内存中其通过为不同的 pod 和容器构造 OOM 评分，并且通过内核的策略的辅助，从而实现当节点内存资源不足的时候，内核可以按照策略的优先级，优先 kill 掉哪些优先级比较低（分值越高优先级越低）的pod。相关源码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GetContainerOOMScoreAdjust</span>(<span style=color:#a6e22e>pod</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Container</span>, <span style=color:#a6e22e>memoryCapacity</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>IsCriticalPod</span>(<span style=color:#a6e22e>pod</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Critical pods should be the last to get killed.</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>guaranteedOOMScoreAdj</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v1qos</span>.<span style=color:#a6e22e>GetPodQOS</span>(<span style=color:#a6e22e>pod</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PodQOSGuaranteed</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Guaranteed containers should be the last to get killed.</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>guaranteedOOMScoreAdj</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>PodQOSBestEffort</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>besteffortOOMScoreAdj</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Burstable containers are a middle tier, between Guaranteed and Best-Effort. Ideally,</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// we want to protect Burstable containers that consume less memory than requested.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The formula below is a heuristic. A container requesting for 10% of a system&#39;s</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// memory will have an OOM score adjust of 900. If a process in container Y</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// uses over 10% of memory, its OOM score will be 1000. The idea is that containers</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// which use more than their request will have an OOM score of 1000 and will be prime</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// targets for OOM kills.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Note that this is a heuristic, it won&#39;t work if a container has many small processes.</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memoryRequest</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>Resources</span>.<span style=color:#a6e22e>Requests</span>.<span style=color:#a6e22e>Memory</span>().<span style=color:#a6e22e>Value</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>oomScoreAdjust</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>-</span> (<span style=color:#ae81ff>1000</span><span style=color:#f92672>*</span><span style=color:#a6e22e>memoryRequest</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>memoryCapacity</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// A guaranteed pod using 100% of memory can have an OOM score of 10. Ensure</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// that burstable pods have a higher OOM score adjustment.</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> int(<span style=color:#a6e22e>oomScoreAdjust</span>) &lt; (<span style=color:#ae81ff>1000</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>guaranteedOOMScoreAdj</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> (<span style=color:#ae81ff>1000</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>guaranteedOOMScoreAdj</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Give burstable pods a higher chance of survival over besteffort pods.</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> int(<span style=color:#a6e22e>oomScoreAdjust</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>besteffortOOMScoreAdj</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>oomScoreAdjust</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>oomScoreAdjust</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=总结>总结</h2><p>Kubernetes 作为一个具有良好移植和扩展性的开源平台，用于管理容器化的工作负载和服务。 Kubernetes 拥有一个庞大且快速增长的生态系统，已成为容器编排领域的事实标准。但是也不可避免地引入许多复杂性。而 KubeSphere 作为国内唯一一个开源的 Kubernetes（K8s）发行版，极大地降低了使用 Kubernetes
的门槛。借助于 KubeSphere 平台，原先需要通过后台命令行和 yaml 文件管理的系统配置，现在只需要在简介美观的 UI 界面上轻松完成。本文从云原生应用部署阶段<code>requests</code>和<code>limits</code>的设置问题其入，分析了相关 K8s 底层的工作原理以及如何通过 KubeSphere 平台简化相关的运维工作。</p><h2 id=参考文献>参考文献</h2><ul><li><a href=https://learnk8s.io/setting-cpu-memory-limits-requests target=_blank rel="noopener noreferrer">https://learnk8s.io/setting-cpu-memory-limits-requests</a></li><li><a href=https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/ target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/</a></li><li><a href=https://docs.oracle.com/cd/E13150_01/jrockit_jvm/jrockit/jrdocs/refman/optionX.html target=_blank rel="noopener noreferrer">https://docs.oracle.com/cd/E13150_01/jrockit_jvm/jrockit/jrdocs/refman/optionX.html</a></li><li><a href=https://ask.kubesphere.io/forum/d/1155-k8s target=_blank rel="noopener noreferrer">https://ask.kubesphere.io/forum/d/1155-k8s</a></li><li><a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/ target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/</a></li><li><a href=https://kubernetes.io/docs/concepts/policy/limit-range/ target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/concepts/policy/limit-range/</a></li><li><a href=https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt target=_blank rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/scheduler/sched-bwc.txt</a></li><li><a href=https://www.kernel.org/doc/Documentation/scheduler/sched-design-CFS.txt target=_blank rel="noopener noreferrer">https://www.kernel.org/doc/Documentation/scheduler/sched-design-CFS.txt</a></li><li><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu target=_blank rel="noopener noreferrer">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-cpu</a></li><li><a href=https://medium.com/omio-engineering/cpu-limits-and-aggressive-throttling-in-kubernetes-c5b20bd8a718 target=_blank rel="noopener noreferrer">https://medium.com/omio-engineering/cpu-limits-and-aggressive-throttling-in-kubernetes-c5b20bd8a718</a></li></ul></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&text=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&title=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeep-dive-into-the-k8s-request-and-limit%2f&t=%e4%bd%a0%e7%9c%9f%e7%9a%84%e7%90%86%e8%a7%a3%20K8s%20%e4%b8%ad%e7%9a%84%20requests%20%e5%92%8c%20limits%20%e5%90%97%ef%bc%9f" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#问题分析>问题分析</a></li><li><a href=#最佳实践>最佳实践</a></li><li><a href=#kubesphere-资源配置实践>KubeSphere 资源配置实践</a><ul><li><a href=#相关概念>相关概念</a></li><li><a href=#准备工作>准备工作</a></li><li><a href=#设置项目配额-resource-quotas->设置项目配额（ Resource Quotas ）</a></li><li><a href=#设置容器资源的默认请求>设置容器资源的默认请求</a></li></ul></li><li><a href=#源码分析>源码分析</a><ul><li><a href=#requests-是如何影响-k8s-调度决策的>requests 是如何影响 K8s 调度决策的？</a></li><li><a href=#qos-是如何影响-k8s-调度决策的>QoS 是如何影响 K8s 调度决策的？</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>