<!doctype html><html lang=en-US><head><meta charset=utf-8><title>KubeSphere DevOps 流水线入门指南</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文首先将介绍 DevOps 是什么，随后尝试利用 KubeSphere 集成的功能来实现 DevOps。"><meta name=keywords content="KubeSphere,Kubernetes,DevOps,Jenkins,Groovy"><meta property="og:type" content="article"><meta property="og:title" content="KubeSphere DevOps 流水线入门指南"><meta property="og:description" content="本文首先将介绍 DevOps 是什么，随后尝试利用 KubeSphere 集成的功能来实现 DevOps。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-devops-pipeline-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/kubesphere-devops-pipeline-guide/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/kubesphere-devops-pipeline-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/kubesphere-devops-pipeline-guide/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/kubesphere-devops-pipeline-guide/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>KubeSphere DevOps 流水线入门指南</span></div><div class='main-div middle-div'><div class=author>赵海亮</div><span class=date>发布于：2022-10-27</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>KubeSphere DevOps 流水线入门指南</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&text=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&title=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&t=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><blockquote><p>作者：赵海亮，浙江大学计算机专业四年级在读博士生，研究方向为云计算、边缘计算、分布式系统等。</p></blockquote><p>虽然 KubeSphere 能够将我们从 yaml 文件的编写中解放出来，但是项目上云仍然十分繁琐。 此外，一旦项目源代码发生更替（如发布新功能或去除 bug 等），所有组件都需要重新经历 “源码打包 --> 制作镜像 --> 启动容器” 这个流程。 这意味着，项目运维人员不得不从事大量重复性劳动。为了提高项目发布的效率，工业界引入了 DevOps 的概念。</p><p>本文首先将介绍 DevOps 是什么，随后尝试利用 KubeSphere 集成的功能来实现 DevOps。</p><h2 id=什么是-devops>什么是 DevOps</h2><p>目前绝大多数互联网公司将开发和系统管理划分成不同的部门。 开发部门的驱动力通常是 “频繁交付新特性”，而运维部门则更关注 IT 服务的可靠性和 IT 成本投入的效率。 两者目标的不匹配，因而存在鸿沟，从而减慢了 IT 交付业务价值的速度。 为了解决这个问题，DevOps（Development 和 Operations 的组合词）被提出。 DevOps 的目的是在企业内部搭建一个自动化 “软件交付” 和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。</p><p>实现 DevOps 通常需要多个软件和工具的密切配合。 如图 1 所示，DevOps 将软件的交付流程依次划分为 Plan、Code、Build、Test、Release、Deploy、Operate 以及 Monitor 这些阶段。 当需求变更时，将会从 Monitor 重新平滑过渡至 Plan 阶段。每个阶段都有一系列的软件和工具可供选择。 对于任意项目，我们只需要基于这些软件和工具 <strong>搭建一条自动化流水线</strong> ，再设置类似于 “一旦代码变更就自动执行” 这样的钩子函数，整个项目即可自动实现“持续集成 / 持续交付（CI/CD）”，这将大大减少重复劳动。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/ecb1db00-df40-47b8-a071-82e2af035892.png alt></p><p>KubeSphere DevOps 基于 Kubernetes Jenkins Agent 实现。 和传统的 Jenkins Controller-Agent 架构不同的是，在 KubeSphere 中，Jenkins Agent 可以动态扩缩容，从而降低 CI/CD 对集群资源的盲目占用。 KubeSphere 的 DevOps 用户指南参见 <a href=https://kubesphere.io/zh/docs/devops-user-guide/ target=_blank rel="noopener noreferrer">https://kubesphere.io/zh/docs/devops-user-guide/</a>。 本文将依照该指南将一个开源项目上云。</p><h2 id=基于-devops-的项目部署>基于 DevOps 的项目部署</h2><h3 id=项目介绍>项目介绍</h3><p>本次实验要部署的项目叫做尚医通，这是一个基于 Spring-Boot 实现的预约挂号统一平台。 该项目一共包含三个子部分，分别为 <code>yygh-parent</code>、<code>yygh-site</code> 和 <code>yygh-admin</code>。 在架构上，该项目依赖的数据层中间件有 mysql、redis、mongodb 以及 rabbitmq，依赖的流量治理中间件有 sentinel 和 nacos。</p><p>接下来，我们约定项目根目录为 <code>his</code>，然后分别从开源地址 <a href=https://gitee.com/leifengyang/yygh-parent target=_blank rel="noopener noreferrer">https://gitee.com/leifengyang/yygh-parent</a>、https://gitee.com/leifengyang/yygh-site 和 <a href=https://gitee.com/leifengyang/yygh-admin target=_blank rel="noopener noreferrer">https://gitee.com/leifengyang/yygh-admin</a> 拉取源代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  his lsa
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>drwxr-xr-x   <span style=color:#ae81ff>5</span> hliangzhao  staff   160B Nov <span style=color:#ae81ff>15</span> 10:33 .
</span></span><span style=display:flex><span>drwxr-xr-x@ <span style=color:#ae81ff>42</span> hliangzhao  staff   1.3K Nov <span style=color:#ae81ff>15</span> 10:33 ..
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>24</span> hliangzhao  staff   768B Nov <span style=color:#ae81ff>15</span> 10:33 yygh-admin
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>15</span> hliangzhao  staff   480B Nov <span style=color:#ae81ff>15</span> 10:33 yygh-parent
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>24</span> hliangzhao  staff   768B Nov <span style=color:#ae81ff>15</span> 10:34 yygh-site
</span></span></code></pre></div><p>依次查看三个项目的文件布局：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  his cd yygh-parent
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  yygh-parent git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> tree -L <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── common                      <span style=color:#75715e># 通用模块</span>
</span></span><span style=display:flex><span>│   ├── common-util
</span></span><span style=display:flex><span>│   ├── pom.xml
</span></span><span style=display:flex><span>│   ├── rabbit-util
</span></span><span style=display:flex><span>│   └── service-util
</span></span><span style=display:flex><span>├── data                        <span style=color:#75715e># 项目演示数据</span>
</span></span><span style=display:flex><span>│   ├── json
</span></span><span style=display:flex><span>│   └── sql
</span></span><span style=display:flex><span>├── hospital-manage             <span style=color:#75715e># 医院后台</span>
</span></span><span style=display:flex><span>│   ├── Dockerfile
</span></span><span style=display:flex><span>│   ├── deploy
</span></span><span style=display:flex><span>│   ├── pom.xml
</span></span><span style=display:flex><span>│   ├── src
</span></span><span style=display:flex><span>├── model                       <span style=color:#75715e># 数据模型</span>
</span></span><span style=display:flex><span>│   ├── pom.xml
</span></span><span style=display:flex><span>│   └── src
</span></span><span style=display:flex><span>├── pom.xml
</span></span><span style=display:flex><span>├── server-gateway              <span style=color:#75715e># 网关</span>
</span></span><span style=display:flex><span>│   ├── Dockerfile
</span></span><span style=display:flex><span>│   ├── deploy
</span></span><span style=display:flex><span>│   ├── pom.xml
</span></span><span style=display:flex><span>│   └── src
</span></span><span style=display:flex><span>├── service                     <span style=color:#75715e># 微服务层</span>
</span></span><span style=display:flex><span>│   ├── pom.xml
</span></span><span style=display:flex><span>│   ├── service-cmn             <span style=color:#75715e># 公共服务</span>
</span></span><span style=display:flex><span>│   ├── service-hosp            <span style=color:#75715e># 医院数据服务</span>
</span></span><span style=display:flex><span>│   ├── service-order           <span style=color:#75715e># 预约下单服务</span>
</span></span><span style=display:flex><span>│   ├── service-oss             <span style=color:#75715e># 对象存储服务</span>
</span></span><span style=display:flex><span>│   ├── service-sms             <span style=color:#75715e># 短信服务</span>
</span></span><span style=display:flex><span>│   ├── service-statistics      <span style=color:#75715e># 统计服务</span>
</span></span><span style=display:flex><span>│   ├── service-task            <span style=color:#75715e># 定时服务</span>
</span></span><span style=display:flex><span>│   └── service-user            <span style=color:#75715e># 会员服务</span>
</span></span><span style=display:flex><span>└── service-client
</span></span><span style=display:flex><span>    ├── pom.xml
</span></span><span style=display:flex><span>    ├── service-cmn-client
</span></span><span style=display:flex><span>    ├── service-hosp-client
</span></span><span style=display:flex><span>    ├── service-order-client
</span></span><span style=display:flex><span>    └── service-user-client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>30</span> directories, <span style=color:#ae81ff>12</span> files
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  yygh-parent git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> cd ../yygh-admin
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  yygh-admin git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> tree -L <span style=color:#ae81ff>1</span>        <span style=color:#75715e># 医院挂号后台（前端 UI）</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── Dockerfile
</span></span><span style=display:flex><span>├── LICENSE
</span></span><span style=display:flex><span>├── build
</span></span><span style=display:flex><span>├── config
</span></span><span style=display:flex><span>├── deploy
</span></span><span style=display:flex><span>├── favicon.ico
</span></span><span style=display:flex><span>├── index.html
</span></span><span style=display:flex><span>├── package.json
</span></span><span style=display:flex><span>├── src
</span></span><span style=display:flex><span>└── static
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span> directories, <span style=color:#ae81ff>9</span> files
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  yygh-site git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> tree -L <span style=color:#ae81ff>1</span>        <span style=color:#75715e># 用户挂号前台（前端 UI）</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── Dockerfile
</span></span><span style=display:flex><span>├── api
</span></span><span style=display:flex><span>├── assets
</span></span><span style=display:flex><span>├── components
</span></span><span style=display:flex><span>├── deploy
</span></span><span style=display:flex><span>├── layouts
</span></span><span style=display:flex><span>├── middleware
</span></span><span style=display:flex><span>├── nuxt.config.js
</span></span><span style=display:flex><span>├── package-lock.json
</span></span><span style=display:flex><span>├── package.json
</span></span><span style=display:flex><span>├── pages
</span></span><span style=display:flex><span>├── plugins
</span></span><span style=display:flex><span>├── static
</span></span><span style=display:flex><span>├── store
</span></span><span style=display:flex><span>└── utils
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span> directories, <span style=color:#ae81ff>7</span> files
</span></span></code></pre></div><p>对于本项目，我们需要部署如下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yygh-parent/hospital-manage         <span style=color:#75715e># 医院管理</span>
</span></span><span style=display:flex><span>yygh-parent/server-gateway          <span style=color:#75715e># 网关</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 8 个微服务</span>
</span></span><span style=display:flex><span>yygh-parent/service/service-cmn
</span></span><span style=display:flex><span>yygh-parent/service/service-hosp
</span></span><span style=display:flex><span>yygh-parent/service/service-order
</span></span><span style=display:flex><span>yygh-parent/service/service-oss
</span></span><span style=display:flex><span>yygh-parent/service/service-sms
</span></span><span style=display:flex><span>yygh-parent/service/service-statistics
</span></span><span style=display:flex><span>yygh-parent/service/service-task
</span></span><span style=display:flex><span>yygh-parent/service/service-user
</span></span><span style=display:flex><span><span style=color:#75715e># 2 个前端</span>
</span></span><span style=display:flex><span>yygh-admin
</span></span><span style=display:flex><span>yygh-site
</span></span></code></pre></div><p>以上 12 个待部署的子项目将以独立 Pod 的形式在集群中部署。 每一个子项目根目录需要具有一个 Dockerfile 文件以及一个名为 <code>deploy</code> 的文件夹。 前者是本子项目的镜像制作文件，后者是本子项目的资源清单文件 <code>*.yaml</code>（用于在集群中部署）。 以 <code>service-cmn</code> 为例，其文件布局如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>base<span style=color:#f92672>)</span> ➜  service-cmn git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> tree -L <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── Dockerfile        <span style=color:#75715e># 将本子项目构建为镜像的 Dockerfile</span>
</span></span><span style=display:flex><span>├── deploy            <span style=color:#75715e># 存放用于部署本子项目的资源清单文件</span>
</span></span><span style=display:flex><span>│   └── deploy.yml
</span></span><span style=display:flex><span>├── pom.xml           <span style=color:#75715e># 项目依赖</span>
</span></span><span style=display:flex><span>├── src               <span style=color:#75715e># 源代码</span>
</span></span><span style=display:flex><span>│   └── main
</span></span><span style=display:flex><span>└── target            <span style=color:#75715e># maven 打包后自动创建</span>
</span></span></code></pre></div><p>遵循上的一篇文章 <a href=https://hliangzhao.cn/articles/000001636890936aa648c32c5484364aae34e9f41e6225e000 title="使用 KubeSphere 部署 Ruoyi-Cloud · KS 实践 02" target=_blank rel="noopener noreferrer">使用 KubeSphere 部署 Ruoyi-Cloud · KS 实践 02</a> 中所述的部署流程，我们首先需要将中间件上云。然后，我们将三个项目以流水线的方式上云。</p><h3 id=部署中间件>部署中间件</h3><p>本项目所使用的中间件除了 Sentinel 和 MongoDB，其他均已在前文中部署。 接下里依次部署这两个中间件。</p><p>对于 Sentinel，我们直接使用雷丰阳已经制作好的镜像 <code>leifengyang/sentinel:1.8.2</code>，然后暴露一个 NodePort 类型的 Service，端口号为 <code>32636</code>。 访问 <code>http://192.168.23.160:32636</code>，以默认用户 <code>sentinel</code> 和默认密码 <code>sentinel</code> 登录，可以进入 Sentinel 控制台。 如果一切顺利，应该可以看到类似的页面：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/1776090-20221101110638437-1889863892.png alt></p><p>对于 MongoDB，我们直接通过应用模版部署它（不勾选登录认证）：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/87e3debf-5831-4c94-913d-76900c767287.png alt></p><p>为 MongoDB 应用暴露一个 NodePort 类型的 Service，端口号为 <code>31801</code>，然后在本机通过 MongoDB Compass 连接它（<code>192.168.23.160:31801</code>）：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/219fd8bd-0424-4ab9-9bb5-d6d6fd3a497e.png alt></p><p>如果可以连上，则一切正常。</p><h3 id=导入初始数据>导入初始数据</h3><p>使用 DataGrip 将位于 <code>his/yygh-parent/data/sql</code> 目录下的全部演示数据（一共有 5 个 sql 文件需要执行，会创建 5 个 <code>yygh</code> 打头的数据库）导入集群中的 MySQL 实例：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/651ecb64-8826-4a19-82ba-a36b6a640cbb.png alt></p><p>MongoDB 的演示数据将在项目启动后导入。</p><h3 id=在-nacos-中创建微服务的启动配置>在 Nacos 中创建微服务的启动配置</h3><p>观察每一个子项目的 Dockerfile，以 <code>service-cmn</code> 为例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># service-cmn 的 Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:8-jdk</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span>leifengyang
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动 prod 环境，以 service-cmn-prod.yml 作为启动配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PARAMS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--server.port=8080 --spring.profiles.active=prod --spring.cloud.nacos.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.file-extension=yml&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> target/*.jar /app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/bin/sh&#34;</span>,<span style=color:#e6db74>&#34;-c&#34;</span>,<span style=color:#e6db74>&#34;java -Dfile.encoding=utf8  -Djava.security.egd=file:/dev/./urandom -jar /app.jar ${PARAMS}&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>这意味着该子项目在启动时，会激活 <code>prod</code> 环境，并从 Nacos 中读取 <code>service-cmn-prod.yml</code> 文件作为启动配置。 因此，我们首先需要在 Nacos 中创建其生产环境配置文件 <code>service-cmn-prod.yml</code>，然后将 <code>子项目路径 / src/main/resources/application-dev.yml</code> 的内容复制进去，在其基础上修改。 需要修改的内容主要是中间件的访问地址。 以 <code>service-cmn</code> 为例，它的配置文件被命名为 <code>service-cmn-prod.yml</code>，其最终内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># service-cmn-prod.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span><span style=color:#f92672>mybatis-plus</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>configuration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>log-impl</span>: <span style=color:#ae81ff>org.apache.ibatis.logging.stdout.StdOutImpl</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mapper-locations</span>: <span style=color:#ae81ff>classpath:mapper/*.xml</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>global-config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>db-config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>logic-delete-value</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>logic-not-delete-value</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>sentinel</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>transport</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># 修改 sentinel 访问地址</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dashboard</span>: <span style=color:#ae81ff>http://his-sentinel-nodeport.his:8080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>redis</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修改 redis 访问地址</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>his-redis-nodeport.his</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>database</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>1800000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>lettuce</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>pool</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>max-active</span>: <span style=color:#ae81ff>20</span>      <span style=color:#75715e># 最大连接数</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>max-wait</span>: -<span style=color:#ae81ff>1</span>        <span style=color:#75715e># 最大阻塞等待时间 (负数表示没限制)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>max-idle</span>: <span style=color:#ae81ff>5</span>         <span style=color:#75715e># 最大空闲</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>min-idle</span>: <span style=color:#ae81ff>0</span>         <span style=color:#75715e># 最小空闲</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>com.zaxxer.hikari.HikariDataSource</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.jdbc.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 修改 mysql 访问地址和连接凭证</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://his-mysql-nodeport.his:3306/yygh_cmn?characterEncoding=utf-8&amp;useSSL=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>123456</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hikari</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>connection-test-query</span>: <span style=color:#ae81ff>SELECT 1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>connection-timeout</span>: <span style=color:#ae81ff>60000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>idle-timeout</span>: <span style=color:#ae81ff>500000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max-lifetime</span>: <span style=color:#ae81ff>540000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>maximum-pool-size</span>: <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>minimum-idle</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>pool-name</span>: <span style=color:#ae81ff>GuliHikariPool</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jackson</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>date-format</span>: <span style=color:#ae81ff>yyyy-MM-dd HH:mm:ss</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>time-zone</span>: <span style=color:#ae81ff>GMT+8</span>
</span></span></code></pre></div><p>如图 6 所示，除了 <code>hospitla-manage</code>，其余所有 9 个 Spring-Boot 子项目均需要按照上述规则编写对应的配置文件。 <code>hospitla-manage</code> 的启动不依赖 Nacos，因此不需要。</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/4cc0f08f-0374-44b6-82c2-250eba012f2d.png alt></p><h3 id=创建微服务部署流水线>创建微服务部署流水线</h3><p>流水线表示应用从代码编译、测试、打包和部署的过程，KubeSphere 的流水线管理使用了业界常用的 Jenkinsfile 来表述一组 CI/CD 流程。 Jenkinsfile 是一个文本文件，使用了 Jenkins 提供的 DSL（Domain-Specific Language）语法。 KubeSphere 提供了可视化编辑器，用户只需在页面上输入少量配置信息，接口自动组装完成 Jenkinsfile。 当然，也可直接编辑 Jenkinsfile。</p><p>流水线涉及如下几个概念：</p><ul><li>Stage：阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作。Stage 是一个逻辑分组的概念，可以跨多个 Node。</li><li>Node：节点，一个 Node 就是一个 Jenkins 节点，或者是 Master，或者是 Agent，是执行 Step 的具体运行时环境。</li><li>Step：步骤，Step 是最基本的操作单元，小到创建一个目录，大到构建一个 Docker 镜像，由各类 Jenkins Plugin 提供。</li></ul><p>KubeSphere 默认提供的 Agent 有 base、go、maven 和 nodejs。它们分别适用于不同编程语言开发的项目的打包构建。 因为我们即将部署的 10 个子项目均是 Spring-Boot 应用，因此我们选择 maven 作为启动流水线的 agent。</p><p>我们可以直接编写流水线的 Jenkinsfile，也可以通过 KubeSphere 提供的可视化页面编辑流水线。 通常，流水线的第一步是<strong>下载项目源代码</strong> <a href=https://hliangzhao.cn/articles/000001637123225376d9e01cc3841cb9c4fa467de7aaf83000#fn:4 title=4 target=_blank rel="noopener noreferrer">4</a>，我们在 UI 上直接添加相关命令：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/6d7add0f-de92-4ea6-8ffa-b173398d6052.png alt></p><p>KubeSphere 会自动生成这次编辑的 Jenkinsfile 代码片段：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;clone code&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent none
</span></span><span style=display:flex><span>  steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 拉取代码并展示代码文件布局
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      git<span style=color:#f92672>(</span>url: <span style=color:#e6db74>&#39;https://gitee.com/leifengyang/yygh-parent&#39;</span><span style=color:#f92672>,</span> branch: <span style=color:#e6db74>&#39;master&#39;</span><span style=color:#f92672>,</span> changelog: <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> poll: <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      sh <span style=color:#e6db74>&#39;ls -al&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>流水线的第二个阶段通常是<strong>项目的打包与编译</strong>。 默认情况下，Maven 从官方仓库下载项目依赖，如果想要修改默认镜像仓库，需要修改集群中名为 <code>ks-devops-agent</code> 的 ConfigMap，它拥有一个叫做 <code>MavenSetting</code> 的键：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k8s@ubuntu:~$ k get cm -A | grep devops
</span></span><span style=display:flex><span>his-devopsqxxv7                   istio-ca-root-cert                                           <span style=color:#ae81ff>1</span>      24h
</span></span><span style=display:flex><span>his-devopsqxxv7                   kube-root-ca.crt                                             <span style=color:#ae81ff>1</span>      24h
</span></span><span style=display:flex><span>kubesphere-devops-system          devops-config                                                <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-system          devops-jenkins                                               <span style=color:#ae81ff>9</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-system          istio-ca-root-cert                                           <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-system          jenkins-agent-config                                         <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-system          jenkins-casc-config                                          <span style=color:#ae81ff>2</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-system          kube-root-ca.crt                                             <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-worker          istio-ca-root-cert                                           <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-worker          ks-devops-agent                                              <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>kubesphere-devops-worker          kube-root-ca.crt                                             <span style=color:#ae81ff>1</span>      5d7h
</span></span><span style=display:flex><span>k8s@ubuntu:~$ k describe cm ks-devops-agent -n kubesphere-devops-worker
</span></span><span style=display:flex><span>Name:         ks-devops-agent
</span></span><span style=display:flex><span>Namespace:    kubesphere-devops-worker
</span></span><span style=display:flex><span>Labels:       app.kubernetes.io/managed-by<span style=color:#f92672>=</span>Helm
</span></span><span style=display:flex><span>Annotations:  meta.helm.sh/release-name: devops
</span></span><span style=display:flex><span>              meta.helm.sh/release-namespace: kubesphere-devops-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Data
</span></span><span style=display:flex><span><span style=color:#f92672>====</span>
</span></span><span style=display:flex><span>MavenSetting:
</span></span><span style=display:flex><span>----
</span></span><span style=display:flex><span>&lt;?xml version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span> encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>?&gt;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;!--
</span></span><span style=display:flex><span> | This is the configuration file <span style=color:#66d9ef>for</span> Maven. It can be specified at two levels:
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;settings xmlns<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://maven.apache.org/SETTINGS/1.0.0&#34;</span>
</span></span><span style=display:flex><span>          xmlns:xsi<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style=display:flex><span>          xsi:schemaLocation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&#34;</span>&gt;
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>我们需要修改 <code>MavenSetting</code> 文件，在其中添加国内镜像仓库地址：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/8231db2a-b71b-4ed6-a4c4-5f274d2a96e7.png alt></p><p>我们通过命令 <code>mvn clean package -Dmaven.test.skip=true</code> 进行项目打包编译。由此，流水线的第二阶段需要执行的命令如下：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/b78aead1-e8a0-417e-8082-8f040ecc1e70.png alt></p><p>相应地，在 Jenkinsfile 中也会自动生成第二步的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;project compilation&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent none
</span></span><span style=display:flex><span>  steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      sh <span style=color:#e6db74>&#39;mvn clean package -Dmaven.test.skip=true&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>流水线的第三个阶段是<strong>制作镜像</strong>。我们在章节 2.1 说过，每个子项目的根目录有一个 Dockerfile，并且在章节 2.4 展示过 Dockerfile 的内容。 因此，对于单体应用 <code>hospitla-manage</code>，它的镜像构建命令为 <code>docker build -t hospital-manage -f hospital-manage/Dockerfile hospital-manage/</code>；对于网关子项目 <code>server-gateway</code>，它的镜像构建命令为 <code>docker build -t server-gateway/Dockerfile server-gateway/</code>；其余 8 个微服务的构建命令则是 <code>docker build -t service/service-xxx service/service-xxx/</code>。这里的 <code>xxx</code> 被替换为具体的微服务名称。 在上述构建命令中，尤其需要注意的是 Dockerfile 相对于项目根目录 <code>yygh-parent</code> 所在的位置以及镜像构建上下文的相对位置。</p><p>因为上述 10 个镜像的构建相互之间独立，因此可以<strong>并行化执行</strong>。我们可以很轻易地在 KubeSphere 中做到这一点：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/532f6d99-5d4e-4ccf-8ca9-5d04ef301686.png alt></p><p>相应地，Jenkinsfile 中增加了如下内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;default-2&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  parallel <span style=color:#f92672>{</span>    <span style=color:#75715e>// 并行构建 10 个镜像
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;build hospital-manage&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      agent none
</span></span><span style=display:flex><span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          sh <span style=color:#e6db74>&#39;docker build -t hospital-manage -f hospital-manage/Dockerfile hospital-manage/&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;build server-gateway&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;build service-cmn&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>流水线的第四个阶段是<strong>镜像推送</strong>。在企业内部，构建好的镜像通常会被推送到企业的私有仓库中。 笔者采用阿里云给个人开发者免费提供的镜像仓库作为推送目标。因为目标仓库是一个私有仓库，因此需要提供账户和密码作为凭证（credential）。 如何在 KubeSphere 中为镜像推送命令提供凭证呢？ 我们可以在 DevOps 的项目设置中创建：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/eb3c1913-ae02-4393-9b2e-0f30b96c6356.png alt></p><p>上图中，笔者创建一个名为 <code>aliyun-docker-hub</code> 的凭证，用户名是我的阿里云账户名，密码则是申请容器镜像服务所创建的密码。 读者需要替换成自己的账户密码：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/28781e75-908e-47b1-a59e-f58e9206ac8d.png alt></p><p>基于该凭证，我们在 Jenkinsfile 中编写镜像推送的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用&#39;aliyun-docker-registry&#39;这个凭证登录私有仓库并将镜像推送至其中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    withCredentials<span style=color:#f92672>([</span>usernamePassword<span style=color:#f92672>(</span>credentialsId: <span style=color:#e6db74>&#39;aliyun-docker-registry&#39;</span><span style=color:#f92672>,</span> passwordVariable: <span style=color:#e6db74>&#39;ALIYUN_REG_PWD&#39;</span><span style=color:#f92672>,</span> usernameVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ALIYUN_REG_USER&#39;</span> <span style=color:#f92672>,)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      sh <span style=color:#e6db74>&#39;echo&#34;$ALIYUN_REG_PWD&#34;| docker login $REGISTRY -u&#34;$ALIYUN_REG_USER&#34;--password-stdin&#39;</span>
</span></span><span style=display:flex><span>      sh <span style=color:#e6db74>&#39;docker tag hospital-manage:latest $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>      sh <span style=color:#e6db74>&#39;docker push $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>environment <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  REGISTRY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;registry.cn-hangzhou.aliyuncs.com&#39;</span>
</span></span><span style=display:flex><span>  DOCKERHUB_NAMESPACE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;hliangzhao-private&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>同样地，上述过程也以并行的方式执行。最终，Jenkinsfile 中被添加了如下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;default-3&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  parallel <span style=color:#f92672>{</span>   <span style=color:#75715e>// 并行推送 10 个镜像
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;push hospital-manage&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      agent none
</span></span><span style=display:flex><span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          withCredentials<span style=color:#f92672>([</span>usernamePassword<span style=color:#f92672>(</span>credentialsId <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;aliyun-docker-registry&#39;</span> <span style=color:#f92672>,</span>passwordVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ALIYUN_REG_PWD&#39;</span> <span style=color:#f92672>,</span>usernameVariable <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ALIYUN_REG_USER&#39;</span> <span style=color:#f92672>,)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            sh <span style=color:#e6db74>&#39;echo&#34;$ALIYUN_REG_PWD&#34;| docker login $REGISTRY -u&#34;$ALIYUN_REG_USER&#34;--password-stdin&#39;</span>
</span></span><span style=display:flex><span>            sh <span style=color:#e6db74>&#39;docker tag hospital-manage:latest $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>            sh <span style=color:#e6db74>&#39;docker push $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;push server-gateway&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;push service-cmn&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>测试一下到目前为止的流水线，一切运行顺利：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/202210271659626.jpg alt></p><p>流水线的最后阶段是<strong>部署到开发环境和生产环境</strong>。因为这一阶段需要和 Kubernetes API Server 打交道，所以需要指定 Kubernetes 上下文 <a href=https://hliangzhao.cn/articles/000001637123225376d9e01cc3841cb9c4fa467de7aaf83000#fn:5 title=5 target=_blank rel="noopener noreferrer">5</a>。 KubeSphere 自动为我们创建了名为 <code>demo-kubeconfig</code> 的凭证，该凭证提供了形如 <code>.kube/config</code> 的文件，使得我们可以根据凭证发起 <code>kubectl apply</code> 命令。 与此同时，我们还需要指定待部署的资源清单文件的位置。 以子项目 <code>hospital-manage</code> 为例，它的资源清单文件在 <code>yygh-parent/hospital-manage/deploy/</code> 目录下。 观察该目录下的 <code>deploy.yaml</code> 文件，可以发现它要求集群从阿里云私有镜像仓库拉取镜像，需要我们提供 <code>imagePullSecrets</code> 字段：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/f5dd3704-7a33-4e68-88ba-c3889e70cb92.png alt></p><p>这意味着我们需要在 his 项目中创建名为 aliyun-docker-hub 的 Secret。 注意，这里是在为 his 项目创建 Secret，而先前是在 DevOps 的项目设置中创建 Credential。二者的服务对象是不同的。 对于部署这个操作，我们可以直接在 UI 上选择 “添加 kubernetesDeploy”：</p><p><img src=https://pek3b.qingstor.com/kubesphere-community/images/766d0837-047b-4e30-99f2-de23de55bc80.png alt></p><p>由此生成的 Jenkinsfile 代码为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;deploy hospital-manage to dev&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent none
</span></span><span style=display:flex><span>  steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      kubernetesDeploy<span style=color:#f92672>(</span>enableConfigSubstitution: <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        deleteResource: <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        kubeconfigId: <span style=color:#e6db74>&#39;demo-kubeconfig&#39;</span><span style=color:#f92672>,</span>          <span style=color:#75715e>// 存储了 kubeconfig 上下文信息的文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        configs: <span style=color:#e6db74>&#39;hospital-manage/deploy/**&#39;</span>      <span style=color:#75715e>// 资源清单文件所在位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>我们尝试运行一下现在的流水线，诡异的事情却发生了。在项目部署阶段产生了如下错误：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Starting Kubernetes deployment
</span></span><span style=display:flex><span>Loading configuration: /home/jenkins/agent/workspace/his-devopsqxxv7/yygh-parent-devops/hospital-manage/deploy/deploy.yml
</span></span><span style=display:flex><span>ERROR: ERROR: java.lang.RuntimeException: io.kubernetes.client.openapi.ApiException: Bad Request
</span></span><span style=display:flex><span>hudson.remoting.ProxyException: java.lang.RuntimeException: io.kubernetes.client.openapi.ApiException: Bad Request
</span></span><span style=display:flex><span>  at com.microsoft.jenkins.kubernetes.wrapper.ResourceManager.handleApiExceptionExceptNotFound<span style=color:#f92672>(</span>ResourceManager.java:180<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>Api call failed with code 400, detailed message: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;kind&#34;</span>: <span style=color:#e6db74>&#34;Status&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;v1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;metadata&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;Failure&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;the export parameter, deprecated since v1.14, is no longer supported&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;reason&#34;</span>: <span style=color:#e6db74>&#34;BadRequest&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;code&#34;</span>: <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>Kubernetes deployment ended with HasError
</span></span></code></pre></div><p>观察报错内容，似乎是负责执行流水线的 Jenkins Agent 版本太老所导致的。 经过查阅，笔者发现 KubeSphere 的官方维护人员已经提交了相关 issue（https://github.com/kubesphere/website/issues/2096）来说明此事。根据说明，报错的根源在于 Jenkins 的官方插件 <a href=https://github.com/jenkinsci/kubernetes-cd-plugin title=kubernetes-cd-plugin target=_blank rel="noopener noreferrer">kubernetes-cd-plugin</a> “年久失修”，我所安装的 Kubernetes 的 API 版本是 v1.22，而 Jenkins 的 kubernetes-cd-plugin 却已经停摆两年。 对于这个问题，KubeSphere 官方提供的解决方案是以 shell 命令 <code>kubectl apply -f your-crd-file.yaml</code> 的方式进行部署，而非在 UI 上添加 <code>kubernetesDeploy</code>。</p><p>幸运的是，在笔者撰写此文的 40 分钟前，KubeSphere 官方发起了一个针对此问题的临时解决方案：https://github.com/kubesphere/website/pull/2098。 在该 Pull request 中，贡献者提供了一种提供 kubeconfig 验证的写法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;deploy hospital-manage to dev&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent none
</span></span><span style=display:flex><span>  steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;maven&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 如果不提供 kubeconfigFile，则 kubectl 上下文找不到
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      withCredentials<span style=color:#f92672>([</span>kubeconfigFile<span style=color:#f92672>(</span>credentialsId: env<span style=color:#f92672>.</span><span style=color:#a6e22e>KUBECONFIG_CREDENTIAL_ID</span><span style=color:#f92672>,</span> variable: <span style=color:#e6db74>&#39;KUBECONFIG&#39;</span><span style=color:#f92672>)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sh <span style=color:#e6db74>&#39;kubectl apply -f hospital-manage/deploy/**&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>实验证明，该方法有效。同样地，10 个子项目可以并行化部署到 dev 环境。相应的 Jenkins 代码就不再展示了。 部署到 prod 环境的操作类似。此外，还可以添加部署条件，例如，只有获得相关管理员授权之后部署操作才会启动。</p><h3 id=创建前端项目部署流水线>创建前端项目部署流水线</h3><p>接下来，还剩两个前端项目 <code>yygh-site</code> 和 <code>yygh-admin</code> 需要部署。 前端项目的部署服从相似的步骤：首先下载源码，然后需要通过 Node.js 之类的工具为项目安装依赖并构建（产生 <code>dist</code> 目录），最后是镜像构建、推送和部署。 以 <code>yygh-site</code> 为例，它最终的 Jenkinsfile 如下所示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    agent <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        node <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            label <span style=color:#e6db74>&#39;nodejs&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;拉取代码&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                  git<span style=color:#f92672>(</span>url: <span style=color:#e6db74>&#39;https://gitee.com/leifengyang/yygh-site&#39;</span><span style=color:#f92672>,</span> branch: <span style=color:#e6db74>&#39;master&#39;</span><span style=color:#f92672>,</span> changelog: <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> poll: <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                  sh <span style=color:#e6db74>&#39;ls -al&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;项目编译&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;ls&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;npm install --registry=https://registry.npm.taobao.org&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;npm run build&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;构建镜像&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;ls&#39;</span>
</span></span><span style=display:flex><span>                    sh <span style=color:#e6db74>&#39;docker build -t yygh-site:latest -f Dockerfile  .&#39;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;推送镜像&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                container<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;nodejs&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    withCredentials<span style=color:#f92672>([</span>usernamePassword<span style=color:#f92672>(</span>credentialsId: <span style=color:#e6db74>&#39;aliyun-docker-registry&#39;</span><span style=color:#f92672>,</span> usernameVariable: <span style=color:#e6db74>&#39;DOCKER_USER_VAR&#39;</span><span style=color:#f92672>,</span> passwordVariable: <span style=color:#e6db74>&#39;DOCKER_PWD_VAR&#39;</span><span style=color:#f92672>,)])</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#39;echo&#34;$DOCKER_PWD_VAR&#34;| docker login $REGISTRY -u&#34;$DOCKER_USER_VAR&#34;--password-stdin&#39;</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#39;docker tag yygh-site:latest $REGISTRY/$DOCKERHUB_NAMESPACE/yygh-site:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>                        sh <span style=color:#e6db74>&#39;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/yygh-site:SNAPSHOT-$BUILD_NUMBER&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;部署到 dev 环境&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                kubernetesDeploy<span style=color:#f92672>(</span>configs: <span style=color:#e6db74>&#39;deploy/**&#39;</span><span style=color:#f92672>,</span> enableConfigSubstitution: <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> kubeconfigId: <span style=color:#e6db74>&#34;$KUBECONFIG_CREDENTIAL_ID&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1、配置全系统的邮件：                   全系统的监控
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 2、修改 ks-jenkins 的配置，里面的邮件；   流水线发邮件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;发送确认邮件&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            agent none
</span></span><span style=display:flex><span>            steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mail<span style=color:#f92672>(</span>to: <span style=color:#e6db74>&#39;someone@test.com&#39;</span><span style=color:#f92672>,</span> subject: <span style=color:#e6db74>&#39;yygh-site 构建结果&#39;</span><span style=color:#f92672>,</span> body: <span style=color:#e6db74>&#34;成功构建 $BUILD_NUMBER&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    environment <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>此处不再展示更多细节。</p><h2 id=总结>总结</h2><p>KubeSphere 为我们提供了 Jenkins 流水线的编辑页面，在一定程度上可以简化操作。</p><h2 id=参考>参考</h2><p>本文参考了雷丰阳的视频课程 <a href=https://www.bilibili.com/video/BV13Q4y1C7hS title="云原生 Java 架构师的第一课 K8s+Docker+KubeSphere+DevOps" target=_blank rel="noopener noreferrer">云原生 Java 架构师的第一课 K8s+Docker+KubeSphere+DevOps</a>。 如果想全面而深入地自主实践，推荐观看原视频。</p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&text=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&title=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fkubesphere-devops-pipeline-guide%2f&t=KubeSphere%20DevOps%20%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%85%a5%e9%97%a8%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#什么是-devops>什么是 DevOps</a></li><li><a href=#基于-devops-的项目部署>基于 DevOps 的项目部署</a><ul><li><a href=#项目介绍>项目介绍</a></li><li><a href=#部署中间件>部署中间件</a></li><li><a href=#导入初始数据>导入初始数据</a></li><li><a href=#在-nacos-中创建微服务的启动配置>在 Nacos 中创建微服务的启动配置</a></li><li><a href=#创建微服务部署流水线>创建微服务部署流水线</a></li><li><a href=#创建前端项目部署流水线>创建前端项目部署流水线</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>