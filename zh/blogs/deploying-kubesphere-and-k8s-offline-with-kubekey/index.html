<!doctype html><html lang=en-US><head><meta charset=utf-8><title>KubeKey 离线部署 KubeSphere v3.4.1 和 K8s v1.26 实战指南</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="详细介绍了如何使用 KubeKey **v3.0.13** 离线部署 KubeSphere 和 K8s 集群。"><meta name=keywords content="Kubernetes,KubeSphere,KubeKey"><meta property="og:type" content="article"><meta property="og:title" content="KubeKey 离线部署 KubeSphere v3.4.1 和 K8s v1.26 实战指南"><meta property="og:description" content="详细介绍了如何使用 KubeKey **v3.0.13** 离线部署 KubeSphere 和 K8s 集群。"><meta property="og:image" content="https://pek3b.qingstor.com/kubesphere-community/images/deploying-kubesphere-and-k8s-offline-with-kubekey-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/deploying-kubesphere-and-k8s-offline-with-kubekey/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://pek3b.qingstor.com/kubesphere-community/images/deploying-kubesphere-and-k8s-offline-with-kubekey-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/deploying-kubesphere-and-k8s-offline-with-kubekey/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/deploying-kubesphere-and-k8s-offline-with-kubekey/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>KubeKey 离线部署 KubeSphere v3.4.1 和 K8s v1.26 实战指南</span></div><div class='main-div middle-div'><div class=author>运维有术</div><span class=date>发布于：2023-12-13</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>KubeKey 离线部署 KubeSphere v3.4.1 和 K8s v1.26 实战指南</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&text=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&title=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&t=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><h2 id=前言>前言</h2><h3 id=知识点>知识点</h3><ul><li>定级：<strong>入门级</strong></li><li>了解清单 (manifest) 和制品 (artifact) 的概念</li><li>掌握 manifest 清单的编写方法</li><li>根据 manifest 清单制作 artifact</li><li>KubeKey 离线集群配置文件编写</li><li>KubeKey 离线部署 Harbor</li><li>KubeKey 离线部署 KubeSphere 和 K8s</li><li>KubeKey 离线部署常见问题排查处理</li></ul><h3 id=实战服务器配置>实战服务器配置</h3><table><thead><tr><th style=text-align:center>主机名</th><th style=text-align:center>IP</th><th style=text-align:center>CPU</th><th style=text-align:center>内存</th><th style=text-align:center>系统盘</th><th style=text-align:center>数据盘</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center>ksp-master-1</td><td style=text-align:center>192.168.9.91</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>离线环境 KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ksp-master-2</td><td style=text-align:center>192.168.9.92</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>离线环境 KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ksp-master-3</td><td style=text-align:center>192.168.9.93</td><td style=text-align:center>8</td><td style=text-align:center>16</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>离线环境 KubeSphere/k8s-master</td></tr><tr><td style=text-align:center>ksp-registry</td><td style=text-align:center>192.168.9.90</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>离线环境镜像仓库节点（Harbor）</td></tr><tr><td style=text-align:center>ksp-deploy</td><td style=text-align:center>192.168.9.89</td><td style=text-align:center>4</td><td style=text-align:center>8</td><td style=text-align:center>40</td><td style=text-align:center>100</td><td style=text-align:center>联网主机用于制作离线包</td></tr><tr><td style=text-align:center>合计</td><td style=text-align:center>4</td><td style=text-align:center>32</td><td style=text-align:center>64</td><td style=text-align:center>200</td><td style=text-align:center>500</td><td style=text-align:center></td></tr></tbody></table><h3 id=实战环境涉及软件版本信息>实战环境涉及软件版本信息</h3><ul><li>操作系统：<strong>CentOS 7.9 x86_64</strong></li><li>KubeSphere：<strong>v3.4.1</strong></li><li>K8s：<strong>v1.26.5</strong></li><li>Containerd：<strong>1.6.4</strong></li><li>KubeKey: <strong>v3.0.13</strong></li><li>Harbor：<strong>2.5.3</strong></li></ul><h2 id=1-简介>1. 简介</h2><p>KubeKey 从 v2.1.0 版开始新增了清单 (manifest) 和制品 (artifact) 的概念，为用户离线部署 KubeSphere 和 K8s 集群提供了一种简单便捷的解决方案。</p><p>manifest 是一个描述当前 Kubernetes 集群信息和定义 artifact 制品中需要包含哪些内容的文本文件。</p><p>使用 KubeKey，用户只需使用清单 manifest 文件来定义将要离线部署的集群环境需要的内容，再通过该 manifest 来导出制品 artifact 文件即可完成准备工作。离线部署时只需要 KubeKey 和 artifact 就可快速、简单的在环境中部署镜像仓库 Harbor 和 KubeSphere 以及 K8s 集群。</p><p>KubeKey 生成 manifest 文件有两种方式：</p><ul><li>利用现有运行中的集群作为源生成 manifest 文件，也是官方推荐的一种方式，具体参考 KubeSphere <a href=https://www.kubesphere.io/zh/docs/v3.4/installing-on-linux/introduction/air-gapped-installation/ target=_blank rel="noopener noreferrer">官网的离线部署文档</a>。</li><li>根据 <a href=https://github.com/kubesphere/kubekey/blob/master/docs/manifest-example.md target=_blank rel="noopener noreferrer">manifest 模板文件</a> 手动编写 manifest 文件。</li></ul><p>第一种方式的好处是可以根据 1:1 的运行集群构建离线集群，依赖于已有集群，灵活度不够，并不是所有人都具备这种条件。</p><p>因此，本文参考官方的离线文档，采用<strong>手写 manifest</strong> 清单文件的方式，实现离线环境的安装部署。</p><h2 id=2-离线部署资源制作>2. 离线部署资源制作</h2><p>制作离线部署资源需要找一台能联通互联网的节点，本文为了资源的制作和离线部署验证，单独增加了一个能联网的 <strong>ksp-deploy</strong> 节点。</p><p>在该节点下载 KubeKey （下文简称 KK）最新版（<strong>v3.0.13</strong>）。具体 KK 版本号可以在 <a href=https://github.com/kubesphere/kubekey/releases target=_blank rel="noopener noreferrer">KubeKey 发行页面</a> 查看。</p><h3 id=21-下载-kubekey>2.1. 下载 KubeKey</h3><ul><li>下载最新版的 KubeKey</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd ~
</span></span><span style=display:flex><span>mkdir kubekey
</span></span><span style=display:flex><span>cd kubekey/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 选择中文区下载(访问 GitHub 受限时使用)</span>
</span></span><span style=display:flex><span>export KKZONE<span style=color:#f92672>=</span>cn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行下载命令，获取最新版的 kk（受限于网络，有时需要执行多次）</span>
</span></span><span style=display:flex><span>curl -sfL https://get-kk.kubesphere.io | sh -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 也可以使用下面的命令指定具体版本</span>
</span></span><span style=display:flex><span>curl -sfL https://get-kk.kubesphere.io | VERSION<span style=color:#f92672>=</span>v3.0.13 sh -
</span></span></code></pre></div><h3 id=22-获取-manifest-模板>2.2. 获取 manifest 模板</h3><p>manifest 文件的编写可以参考 <a href=https://github.com/kubesphere/kubekey/blob/master/docs/manifest-example.md target=_blank rel="noopener noreferrer">官方示例文档</a>。有两个可用参考用例，一个简单版，一个完整版。参考简单版即可。</p><p>受限于篇幅，本文不展示原始的示例文件，建议读者仔细阅读官方示例，理解每一项配置的含义后根据需求改写（<strong>暂时无法理解的，可以直接使用下文提供的成品配置文件</strong>）。</p><h3 id=23-获取-images-list-及可裁剪性分析>2.3. 获取 images-list 及可裁剪性分析</h3><p>执行下面的命令获取官方 releases v3.4.1 对应的 images-list（最终实验结果，一些镜像需要自行整理，完整的镜像列表可参考下文中的 manifest 文件）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://github.com/kubesphere/ks-installer/releases/download/v3.4.1/images-list.txt
</span></span></code></pre></div><p>完整的 Image（<strong>136 个</strong>） 分类及可裁剪性（<strong>必须留的有标粗，个人判断，未必精准</strong>）：</p><ul><li>kubesphere-images（<strong>18 个，不可裁剪</strong>）</li><li>kubeedge-images（3 个，可裁剪，取决于是否启用 kubeedge）</li><li>gatekeeper-images（1 个，可裁剪，取决于是否启用 gatekeeper，建议保留）</li><li>openpitrix-images（<strong>1 个，可裁剪但是基本都会用到，建议保留</strong>）</li><li>kubesphere-devops-images（45 个，构建用的开发环境镜像可裁剪，前缀带 builder-、tomcat85-、java-、nodejs-、python- 这一类的都可以酌情处理）</li><li>kubesphere-monitoring-images（<strong>14 个，不可裁剪</strong>）</li><li>kubesphere-logging-images（15 个，能裁剪的也就是 elasticsearch- 和 opensearch 开头的，KubeSphere v3.4.1 默认选择 opensearch，建议都保留）</li><li>istio-images（9 个，可裁剪，取决于是否启用 istio，建议保留）</li><li>example-images（13 个，可裁剪）</li><li>weave-scope-images（1 个，可裁剪，取决于是否启用 weave）</li><li><strong>官方列表中未列出的核心 images</strong>（12 个，必须，否则部署时报错）</li><li><strong>官方列表中未列出的必要 images</strong>（4 个，必须，否则部署时报错）</li></ul><p>为了保持完整性，本文使用了所有 Image，只是修改了镜像前缀为 <strong>registry.cn-beijing.aliyuncs.com/kubesphereio</strong>，修改后的完整的镜像列表在下面的 manifest 文件中展示，读者可根据需求裁剪。</p><h3 id=24-获取操作系统依赖包>2.4. 获取操作系统依赖包</h3><p>本实验环境使用的操作系统是 x64 的 CentOS 7.9，所以只下载 centos7 的操作系统依赖包，其他操作系统请读者在 <a href=https://github.com/kubesphere/kubekey/releases target=_blank rel="noopener noreferrer">KubeKey releases 页面</a>下载。</p><p>执行下面的命令，在能联网的部署服务器上执行下载。网络访问受限时，也可以通过其他方式，将该 ISO 下载后放到制作离线镜像的服务器的 /root/kubekey 目录下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://github.com/kubesphere/kubekey/releases/download/v3.0.12/centos7-rpms-amd64.iso
</span></span></code></pre></div><blockquote><p>说明：KubeKey v3.0.13 的 release 中没包，只能在 v3.0.12 的 releases 中下载。</p></blockquote><p>最终的 ISO（<strong>centos7-rpms-amd64.iso，314 MB</strong>）实际信息如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看文件大小</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># ll -h centos7-rpms-amd64.iso</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root 315M Oct <span style=color:#ae81ff>23</span> 18:21 centos7-rpms-amd64.iso
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证 sha256sum，确保 ISO 在下载过程中没出问题（官方提供的 sha256sum 信息在 https://github.com/kubesphere/kubekey/releases/download/v3.0.12/centos7-rpms.iso.sha256sum.txt）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># sha256sum centos7-rpms-amd64.iso</span>
</span></span><span style=display:flex><span>2588fbc12acc9f3b95766a0c20382988f2a21da2a36e444b7e1a0f523e75f858  centos7-rpms-amd64.iso
</span></span></code></pre></div><h3 id=25-生成-manifest-文件>2.5. 生成 manifest 文件</h3><p>根据上面的文件及相关信息，生成最终 <strong>manifest.yaml</strong>。</p><p>命名为 <strong>ksp-v3.4.1-manifest.yaml</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kubekey.kubesphere.io/v1alpha2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Manifest</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>arches</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>operatingSystems</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>arch</span>: <span style=color:#ae81ff>amd64</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>linux</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>id</span>: <span style=color:#ae81ff>centos</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;7&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>osImage</span>: <span style=color:#ae81ff>CentOS Linux 7 (Core)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>repository</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>iso</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>localPath</span>: <span style=color:#e6db74>&#34;/root/kubekey/centos7-rpms-amd64.iso&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>url</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubernetesDistributions</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>kubernetes</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.26.5</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>helm</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v3.9.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cni</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.2.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>etcd</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v3.4.13</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>calicoctl</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v3.26.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerRuntimes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>docker</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>20.10.23</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>containerd</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>1.6.4</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>crictl</span>: 
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.24.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>docker-registry</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>harbor</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v2.5.3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>docker-compose</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v2.2.2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>images</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-installer:v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-apiserver:v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-console:v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-controller-manager:v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kubectl:v1.20.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kubefed:v0.8.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/tower:v0.2.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/minio:RELEASE.2019-08-07T01-59-21Z</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/mc:RELEASE.2019-08-07T23-14-43Z</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/snapshot-controller:v4.0.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/nginx-ingress-controller:v1.3.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/defaultbackend-amd64:1.4</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/metrics-server:v0.4.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/redis:5.0.14-alpine</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/haproxy:2.0.25-alpine</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/alpine:3.14</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/openldap:1.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/netshoot:v1.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/cloudcore:v1.13.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/iptables-manager:v1.13.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/edgeservice:v0.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/gatekeeper:v3.5.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/openpitrix-jobs:v3.3.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/devops-apiserver:ks-v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/devops-controller:ks-v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/devops-tools:ks-v3.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/ks-jenkins:v3.4.0-2.319.3-1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/inbound-agent:4.10-2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-base:v3.2.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-nodejs:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.1-jdk11</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-python:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.16</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.17</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.18</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-base:v3.2.2-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-nodejs:v3.2.0-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.0-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-maven:v3.2.1-jdk11-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-python:v3.2.0-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.0-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.16-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.17-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/builder-go:v3.2.2-1.18-podman</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/s2ioperator:v3.2.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/s2irun:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/s2i-binary:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java11-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java11-runtime:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java8-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/tomcat85-java8-runtime:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/java-11-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/java-8-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/java-8-runtime:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/java-11-runtime:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-8-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-6-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/nodejs-4-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/python-36-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/python-35-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/python-34-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/python-27-centos7:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/argocd:v2.3.3</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/argocd-applicationset:v0.4.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/dex:v2.30.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/redis:6.2.6-alpine</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/configmap-reload:v0.7.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus:v2.39.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus-config-reloader:v0.55.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/prometheus-operator:v0.55.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-rbac-proxy:v0.11.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-state-metrics:v2.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/node-exporter:v1.3.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/alertmanager:v0.23.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/thanos:v0.31.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/grafana:8.3.3</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-rbac-proxy:v0.11.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/notification-manager-operator:v2.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/notification-manager:v2.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/notification-tenant-sidecar:v3.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/elasticsearch-curator:v5.7.6</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch-curator:v0.0.5</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/elasticsearch-oss:6.8.22</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch:2.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/opensearch-dashboards:2.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/fluentbit-operator:v0.14.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/docker:19.03</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/fluent-bit:v1.9.4</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/log-sidecar-injector:v1.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/filebeat:6.7.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-operator:v0.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-exporter:v0.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-events-ruler:v0.6.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-auditing-operator:v0.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-auditing-webhook:v0.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/pilot:1.14.6</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/proxyv2:1.14.6</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-operator:1.29</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-agent:1.29</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-collector:1.29</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-query:1.29</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/jaeger-es-index-cleaner:1.29</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kiali-operator:v1.50.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kiali:v1.50</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/busybox:1.31.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/nginx:1.14-alpine</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/wget:1.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/hello:plain-text</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/wordpress:4.8-apache</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/hpa-example:latest</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/fluentd:v1.4.2-2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/perl:latest</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-productpage-v1:1.16.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-reviews-v1:1.16.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-reviews-v2:1.16.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-details-v1:1.16.2</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/examples-bookinfo-ratings-v1:1.16.3</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/scope:1.13.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.8</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.9</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.26.5</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.26.5</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.26.5</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.26.5</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.15.12</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.9.3</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.26.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.26.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.26.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.26.1</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/haproxy:2.3</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/provisioner-localpv:3.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/linux-utils:3.3.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>registry.cn-beijing.aliyuncs.com/kubesphereio/kubectl:v1.22.0</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>kubectl:v1.22.0</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>auths</span>: {}
</span></span></code></pre></div><blockquote><p><strong>manifest 修改说明</strong></p><ul><li><p><strong>最后的 16 个镜像就是官方 images-list 文件缺失的镜像，一定要手工补充在 list 中</strong></p></li><li><p>kubernetes 版本：v1.26.5</p></li><li><p>其他组件版本的选择：个人是根据 kubekey 在线安装过程的日志，查找相关组件的对应版本，以及参考官方的文档 <a href=https://github.com/kubesphere/kubekey/blob/v3.0.13/docs/components-versions.md target=_blank rel="noopener noreferrer">组件默认版本说明</a>、<a href=https://github.com/kubesphere/kubekey/blob/v3.0.13/cmd/kk/apis/kubekey/v1alpha2/default.go target=_blank rel="noopener noreferrer">组件默认版本源码</a> 、<a href=https://github.com/kubesphere/kubekey/blob/v3.0.13/version/components.json target=_blank rel="noopener noreferrer">支持的组件列表</a> 和 <a href=https://github.com/kubesphere/kubekey/blob/v3.0.13/cmd/kk/pkg/artifact/manifest.go target=_blank rel="noopener noreferrer">制品清单源码</a></p></li><li><p>开启 <strong>harbor</strong> 和 <strong>docker-compose</strong> 配置项，为后面通过 KubeKey 自建 harbor 仓库推送镜像使用。</p></li><li><p>默认创建的 manifest 里面的镜像列表从 <strong>docker.io</strong> 获取，替换前缀为 <strong>registry.cn-beijing.aliyuncs.com/kubesphereio</strong>。</p></li><li><p>若需要导出的 artifact 文件中包含操作系统依赖文件（如：conntarck、chrony 等），可在 <strong>operationSystem</strong> 元素中的 <strong>.repostiory.iso.url</strong> 中配置相应的 ISO 依赖文件下载地址为 <strong>localPath</strong> ，填写提前下载好的 ISO 包在本地的存放路径，并将 <strong>url</strong> 配置项置空。</p></li><li><p>您可以访问 <code>https://github.com/kubesphere/kubekey/releases/tag/v3.0.12</code> 下载 ISO 文件。</p></li></ul></blockquote><h3 id=26-导出制品-artifact>2.6. 导出制品 artifact</h3><p><strong>制品 (artifact) 说明</strong></p><ul><li><p>制品（artifact）是一个根据指定的 manifest 文件内容导出的包含镜像 tar 包和相关二进制文件的 tgz 包。</p></li><li><p>在 KubeKey 初始化镜像仓库、创建集群、添加节点和升级集群的命令中均可指定一个 artifact，KubeKey 将自动解包该 artifact 并在执行命令时直接使用解包出来的文件。</p></li><li><p>导出时请确保网络连接正常。</p></li><li><p>KubeKey 会解析镜像列表中的镜像名，若镜像名中的镜像仓库需要鉴权信息，可在 manifest 文件中的 <strong>.registry.auths</strong> 字段中进行配置（<strong>本文未配置</strong>）。</p></li></ul><p>根据生成的 manifest，执行下面的命令制作制品（artifact）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export KKZONE<span style=color:#f92672>=</span>cn
</span></span><span style=display:flex><span>./kk artifact export -m ksp-v3.4.1-manifest.yaml -o ksp-v3.4.1-artifact.tar.gz
</span></span></code></pre></div><p>制作完成后，我们简单查看一下制作的制品包含哪些内容。</p><ul><li>查看 KubeKey 目录内容</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 制作完成后查看结果</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># ls -lh</span>
</span></span><span style=display:flex><span>total 14G
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root 315M Oct <span style=color:#ae81ff>23</span> 18:21 centos7-rpms-amd64.iso
</span></span><span style=display:flex><span>-rwxr-xr-x. <span style=color:#ae81ff>1</span> root root  76M Nov  <span style=color:#ae81ff>7</span> 16:43 kk
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root  13G Dec <span style=color:#ae81ff>12</span> 13:08 ksp-v3.4.1-artifact.tar.gz
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root  11K Dec <span style=color:#ae81ff>12</span> 11:23 ksp-v3.4.1-manifest.yaml
</span></span><span style=display:flex><span>drwxr-xr-x. <span style=color:#ae81ff>3</span> root root   <span style=color:#ae81ff>18</span> Dec <span style=color:#ae81ff>12</span> 13:08 kubekey
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root  35M Dec  <span style=color:#ae81ff>8</span> 10:33 kubekey-v3.0.13-linux-amd64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 制作过程中捕捉的内容，可能不全（制作完成后 kubekey/artifact 目录会被清理）</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># du -sh kubekey/*</span>
</span></span><span style=display:flex><span>13G     kubekey/artifact
</span></span><span style=display:flex><span>88K     kubekey/logs
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># du -sh kubekey/artifact/*</span>
</span></span><span style=display:flex><span>102M    kubekey/artifact/cni
</span></span><span style=display:flex><span>43M     kubekey/artifact/containerd
</span></span><span style=display:flex><span>14M     kubekey/artifact/crictl
</span></span><span style=display:flex><span>130M    kubekey/artifact/docker
</span></span><span style=display:flex><span>17M     kubekey/artifact/etcd
</span></span><span style=display:flex><span>45M     kubekey/artifact/helm
</span></span><span style=display:flex><span>12G     kubekey/artifact/images
</span></span><span style=display:flex><span>207M    kubekey/artifact/kube
</span></span><span style=display:flex><span>660M    kubekey/artifact/registry
</span></span><span style=display:flex><span>315M    kubekey/artifact/repository
</span></span><span style=display:flex><span>9.0M    kubekey/artifact/runc
</span></span></code></pre></div><ul><li>查看制品大小（全镜像，制品包居然达到了 13G，生产环境还是有选择的裁剪吧）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># ls -lh ksp-v3.4.1-artifact.tar.gz</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root 13G Dec <span style=color:#ae81ff>12</span> 13:08 ksp-v3.4.1-artifact.tar.gz
</span></span></code></pre></div><h3 id=27-导出-kubekey>2.7. 导出 KubeKey</h3><p>把 KubeKey 工具也制作成压缩包，便于拷贝到离线节点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 压缩</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-deploy kubekey<span style=color:#f92672>]</span><span style=color:#75715e># tar zcvf kubekey-v3.0.13.tar.gz kk kubekey-v3.0.13-linux-amd64.tar.gz</span>
</span></span></code></pre></div><h3 id=28-kernel-升级包>2.8. Kernel 升级包</h3><p><strong>CentOS 7.9 的默认内核比较老，建议升级操作系统内核（具体是否升级请根据实际环境自行决定）</strong>。</p><ul><li>下载 Kernel 升级包</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span><span style=display:flex><span>wget https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-tools-libs-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span><span style=display:flex><span>wget https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-tools-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span></code></pre></div><ul><li>打包 Kernel 升级包</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tar zcvf kernel-lt-5.4.263-1-upgrade.tar.gz kernel-lt-*
</span></span></code></pre></div><p>至此，我们已经准备了 3 个离线部署资源包：</p><ul><li>KubeKey：<strong>kubekey-v3.0.13.tar.gz（69M）</strong></li><li>制品（artifact）：<strong>ksp-v3.4.1-artifact.tar.gz（13G）</strong></li><li>内核升级包（<strong>可选</strong>）：<strong>kernel-lt-5.4.263-1-upgrade.tar.gz（50M ）</strong></li></ul><h2 id=3-k8s-离线集群服务器-初始化配置>3. K8s 离线集群服务器-初始化配置</h2><h3 id=31-操作系统基础配置>3.1. 操作系统基础配置</h3><p>本演示环境使用 KubeKey 自动配置，生产环境可以参考我以前发布的部署实战系列文档手工配置。</p><h3 id=32-数据盘配置>3.2. 数据盘配置</h3><p>每台服务器新增一块数据盘 <strong>/dev/sdb</strong>，用于 <strong>Containerd</strong> 和 <strong>Kubernetes Pod</strong> 的持久化存储。</p><p>为了满足部分用户希望在生产上线后，磁盘容量不够时可以实现扩容，本文采用了 LVM 的方式配置磁盘（<strong>实际上，本人维护的生产环境，几乎不用 LVM</strong>）。</p><p><strong>本小节的配置比较简单，因此，下面的内容为无废话实操版。</strong></p><p>请注意，以下操作无特殊说明时需在所有新增节点上执行。本文只选取 Master-1 节点作为演示，并假定其余服务器都已按照相同的方式进行配置和设置。</p><ul><li>创建 PV</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> pvcreate /dev/sdb
</span></span></code></pre></div><ul><li>创建 VG</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vgcreate data /dev/sdb
</span></span></code></pre></div><ul><li>创建 LV</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用所有空间，VG 名字为 data，LV 名字为 lvdata</span>
</span></span><span style=display:flex><span>lvcreate -l 100%VG data -n lvdata
</span></span></code></pre></div><ul><li>格式化磁盘</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkfs.xfs /dev/mapper/data-lvdata
</span></span></code></pre></div><ul><li>手工挂载磁盘</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /data
</span></span><span style=display:flex><span>mount /dev/mapper/data-lvdata /data/
</span></span></code></pre></div><ul><li>配置开机自动挂载</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tail -1 /etc/mtab &gt;&gt; /etc/fstab
</span></span></code></pre></div><ul><li>创建 openebs 本地数据根目录</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /data/openebs/local
</span></span></code></pre></div><ul><li>创建 Containerd 数据目录</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /data/containerd
</span></span></code></pre></div><ul><li>创建 Containerd 数据目录软连接</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ln -s /data/containerd /var/lib/containerd
</span></span></code></pre></div><blockquote><p>说明：KubeKey 不支持在部署的时候更改 Containerd 的数据目录，只能用这种变通的方式（<strong>也可以提前手工安装 Containerd，建议</strong>）。</p></blockquote><h3 id=33-升级系统内核>3.3. 升级系统内核</h3><p><strong>升级 CentOS 7.9 操作系统内核</strong>（<strong>可选项，生产环境建议执行</strong>）。</p><p>请注意，以下操作无特殊说明时需在集群所有节点上执行。本文只选取 <strong>Master-1</strong> 节点作为演示，并假定其余服务器都已按照相同的方式进行配置和设置。</p><ul><li>上传内核升级包</li></ul><p>将内核升级包 <code>kernel-lt-5.4.263-1-upgrade.tar.gz</code> 上传到集群中的每个节点的 /root 目录。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /root
</span></span><span style=display:flex><span>tar xvf kernel-lt-5.4.263-1-upgrade.tar.gz
</span></span></code></pre></div><ul><li>安装新版本内核</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install kernel-lt-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span></code></pre></div><blockquote><p><strong>注意：</strong> 这里我们只安装内核，同时安装其他包，会有<strong>包 conflicts</strong> 的报错。</p></blockquote><ul><li>修改系统默认内核为新内核</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>grubby --set-default <span style=color:#e6db74>&#34;/boot/vmlinuz-5.4.263-1.el7.elrepo.x86_64&#34;</span>
</span></span></code></pre></div><ul><li>重启系统，使用新内核引导系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>reboot
</span></span></code></pre></div><ul><li>验证内核版本</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-master-1 ~<span style=color:#f92672>]</span><span style=color:#75715e># uname -r</span>
</span></span><span style=display:flex><span>5.4.263-1.el7.elrepo.x86_64
</span></span></code></pre></div><ul><li>更新其他 Kernel 相关软件包（<strong>可选</strong>，用不到则不用更新）</li></ul><p>在使用新内核引导系统后，安装其他 Kernel 相关软件包，解决之前出现的依赖冲突问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 卸载旧版本的 kernel-tools 相关软件包，保留 kernel-3.10.0-1160.71.1，避免新内核异常无法进入系统（具体版本号以实际为准）</span>
</span></span><span style=display:flex><span>yum remove kernel-tools-3.10.0-1160.71.1.el7.x86_64 kernel-tools-libs-3.10.0-1160.71.1.el7.x86_64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装新版本的 kernel-tools 相关软件包</span>
</span></span><span style=display:flex><span>yum install kernel-lt-tools-5.4.263-1.el7.elrepo.x86_64.rpm kernel-lt-tools-libs-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span></code></pre></div><ul><li>清理临时安装包（<strong>建议，养成良好的运维习惯</strong>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf kernel-lt-5.4.263-1.el7.elrepo.x86_64.rpm kernel-lt-tools-5.4.263-1.el7.elrepo.x86_64.rpm kernel-lt-tools-libs-5.4.263-1.el7.elrepo.x86_64.rpm
</span></span></code></pre></div><h2 id=4-离线部署-kubesphere-和-k8s-的前提准备>4. 离线部署 KubeSphere 和 K8s 的前提准备</h2><h3 id=41-上传离线部署资源包到部署节点>4.1. 上传离线部署资源包到部署节点</h3><p>将以下离线部署资源包（KubeKey 和制品 artifact ），上传至离线环境部署节点 (通常是 <strong>Master-1</strong> 节点) 的 /data/ 目录（<strong>可根据实际情况修改</strong>）。</p><ul><li>Kubekey：<strong>kubekey-v3.0.13.tar.gz</strong></li><li>制品 artifact：<strong>ksp-v3.4.1-artifact.tar.gz</strong></li></ul><p>执行以下命令，解压 KubeKey：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创离线资源存放的数据目录</span>
</span></span><span style=display:flex><span>mkdir /data/kubekey
</span></span><span style=display:flex><span>mv /data/ksp-v3.4.1-artifact.tar.gz /data/kubekey/
</span></span><span style=display:flex><span>tar xvf /data/kubekey-v3.0.13.tar.gz -C /data/kubekey
</span></span><span style=display:flex><span>cd /data/kubekey
</span></span></code></pre></div><h3 id=42-创建离线集群配置文件>4.2. 创建离线集群配置文件</h3><ul><li>执行以下命令创建离线集群配置文件</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./kk create config --with-kubesphere v3.4.1 --with-kubernetes v1.26.5 -f ksp-v341-v1265-offline.yaml
</span></span></code></pre></div><p>命令执行成功后，在当前目录会生成文件名为 <strong>ksp-v341-v1265-offline.yaml</strong> 的配置文件。</p><blockquote><p>注意：生成的默认配置文件内容较多，这里就不做过多展示了，更多详细的配置参数请参考 <a href=https://github.com/kubesphere/kubekey/blob/master/docs/config-example.md target=_blank rel="noopener noreferrer">官方配置示例</a>。</p></blockquote><h3 id=43-修改-cluster-配置>4.3. 修改 Cluster 配置</h3><p>在离线集群配置文件文件中 <strong>kind: Cluster</strong> 小节的作用是部署 Kubernetes 集群。本文示例采用 3 个节点同时作为 control-plane、etcd 节点和 worker 节点。</p><p>执行以下命令修改离线集群配置文件 <code>ksp-v341-v1265-offline.yaml</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ksp-v341-v1265-offline.yaml
</span></span></code></pre></div><p>修改 <strong>kind: Cluster</strong> 小节中 hosts 和 roleGroups 等信息，修改说明如下。</p><ul><li>hosts：指定节点的 IP、ssh 用户、ssh 密码、ssh 端口。示例演示了 ssh 端口号的配置方法。同时，新增一个 Registry 节点的配置</li><li>roleGroups：指定 3 个 etcd、control-plane 节点，复用相同的机器作为 3 个 worker 节点</li><li>必须指定主机组 <code>registry</code> 作为仓库部署节点（本文为了满足读者的需求使用了 KubeKey 自动部署 Harbor 镜像仓库。当然，也可以使用已有的 Harbor，使用已有 Harbor 时此配置可以不加）</li><li>internalLoadbalancer： 启用内置的 HAProxy 负载均衡器</li><li>domain：自定义了一个 <strong>opsman.top</strong>，没特殊需求的场景保留默认值即可</li><li>containerManager：使用了 containerd</li><li>storage.openebs.basePath：<strong>新增配置</strong>，指定 openebs 默认存储路径为 <strong>/data/openebs/local</strong></li><li>registry：必须指定 <code>type</code> 类型为 <code>harbor</code>，否则默认安装 docker registry</li></ul><p>修改后的完整示例如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kubekey.kubesphere.io/v1alpha2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sample</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: ksp-master-1, address: 192.168.9.91, internalAddress: 192.168.9.91, port:22, user: root, password</span>: <span style=color:#e6db74>&#34;P@88w0rd&#34;</span>}
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: ksp-master-2, address: 192.168.9.92, internalAddress: 192.168.9.92, user: root, password</span>: <span style=color:#e6db74>&#34;P@88w0rd&#34;</span>}
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: ksp-master-3, address: 192.168.9.93, internalAddress: 192.168.9.93, user: root, password</span>: <span style=color:#e6db74>&#34;P@88w0rd&#34;</span>}
</span></span><span style=display:flex><span>  - {<span style=color:#f92672>name: ksp-registry, address: 192.168.9.90, internalAddress: 192.168.9.90, user: root, password</span>: <span style=color:#e6db74>&#34;P@88w0rd&#34;</span>}
</span></span><span style=display:flex><span>  <span style=color:#f92672>roleGroups</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>etcd</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>control-plane</span>: 
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-1</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-2</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-master-3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ksp-registry</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>controlPlaneEndpoint</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>## Internal loadbalancer for apiservers </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>internalLoadbalancer</span>: <span style=color:#ae81ff>haproxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>lb.opsman.top</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>6443</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kubernetes</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v1.26.5</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clusterName</span>: <span style=color:#ae81ff>opsman.top</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>autoRenewCerts</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>containerManager</span>: <span style=color:#ae81ff>containerd</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>etcd</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>kubekey</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>plugin</span>: <span style=color:#ae81ff>calico</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubePodsCIDR</span>: <span style=color:#ae81ff>10.233.64.0</span><span style=color:#ae81ff>/18</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kubeServiceCIDR</span>: <span style=color:#ae81ff>10.233.0.0</span><span style=color:#ae81ff>/18</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>multusCNI</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>openebs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>basePath</span>: <span style=color:#ae81ff>/data/openebs/local</span> <span style=color:#75715e># 默认没有的新增配置，base path of the local PV provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># 如需使用 kk 部署 harbor, 可将该参数设置为 harbor，不设置该参数且需使用 kk 创建容器镜像仓库，将默认使用 docker registry。</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>harbor</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 注意：</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1、如需使用 kk 部署的 harbor 或其他自定义仓库，可设置对应仓库的 auths，如使用 kk 创建 docker registry 仓库，则无需配置该参数。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2、kk 部署的 harbor，默认地址为 dockerhub.kubekey.local，如要修改确保与 privateRegistry 字段的值保持一致。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3、如需使用 kk 部署 harbor，请先注释该参数，待部署完 Harbor 后再来修改启用。</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>auths</span>:
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;registry.opsman.top&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>username</span>: <span style=color:#ae81ff>admin</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>password</span>: <span style=color:#ae81ff>Harbor12345</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>certsPath</span>: <span style=color:#e6db74>&#34;/etc/docker/certs.d/registry.opsman.top&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 设置集群部署时使用的私有仓库</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>privateRegistry</span>: <span style=color:#e6db74>&#34;registry.opsman.top&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespaceOverride</span>: <span style=color:#e6db74>&#34;kubesphereio&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>registryMirrors</span>: []
</span></span><span style=display:flex><span>    <span style=color:#f92672>insecureRegistries</span>: []
</span></span><span style=display:flex><span>  <span style=color:#f92672>addons</span>: []
</span></span></code></pre></div><blockquote><p>注意：离线 Harbor 部署，我们使用了私有自定义域名和自签名证书，实际生产中建议各位使用真正的互联网域名和正规机构签发的免费或收费证书。</p></blockquote><h3 id=44-修改-clusterconfiguration-配置>4.4. 修改 ClusterConfiguration 配置</h3><p>在离线集群配置文件中 <strong>kind: ClusterConfiguration</strong> 小节的作用是部署 KubeSphere 及相关组件。</p><p>本文为了验证离线部署的完整性，启用了除 Kubeedge 、gatekeeper 以外的所有插件。</p><p>继续编辑离线集群配置文件 <code>ksp-v341-v1265-offline.yaml</code>，修改 <strong>kind: ClusterConfiguration</strong> 部分来启用可插拔组件，具体的修改说明如下。</p><ul><li>启用 Etcd 监控</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>etcd</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>monitoring</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>endpointIps</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2379</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tlsEnable</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><ul><li>启用应用商店</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>openpitrix</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>store</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere DevOps 系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>devops</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere 日志系统（<strong>v3.4.0 开始默认启用 OpenSearch</strong>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>logging:
</span></span><span style=display:flex><span>  enabled: true <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere 事件系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere 告警系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>alerting</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere 审计日志</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>auditing</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><ul><li>启用 KubeSphere 服务网格（Istio）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>servicemesh</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>istio</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>components</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ingressGateways</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>istio-ingressgateway</span> <span style=color:#75715e># 将服务暴露至服务网格之外。默认不开启。</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cni</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span> <span style=color:#75715e># 启用后，会在 Kubernetes pod 生命周期的网络设置阶段完成 Istio 网格的 pod 流量转发设置工作。</span>
</span></span></code></pre></div><ul><li>启用 Metrics Server</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>metrics_server:
</span></span><span style=display:flex><span>  enabled: true <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span></code></pre></div><blockquote><p>说明：KubeSphere 支持用于 <a href=https://www.kubesphere.io/zh/docs/v3.3/project-user-guide/application-workloads/deployments/ target=_blank rel="noopener noreferrer">部署</a> 的容器组（Pod）弹性伸缩程序 (HPA)。在 KubeSphere 中，Metrics Server 控制着 HPA 是否启用。</p></blockquote><ul><li>启用网络策略、容器组 IP 池，服务拓扑图（名字排序，对应配置参数排序）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>networkpolicy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 将 &#34;false&#34; 更改为 &#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ippool</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>calico</span> <span style=color:#75715e># 将 &#34;none&#34; 更改为 &#34;calico&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>topology</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>weave-scope</span> <span style=color:#75715e># 将 &#34;none&#34; 更改为 &#34;weave-scope&#34;</span>
</span></span></code></pre></div><blockquote><p>说明：</p><ul><li>从 3.0.0 版本开始，用户可以在 KubeSphere 中配置原生 Kubernetes 的网络策略。</li><li>容器组 IP 池用于规划容器组网络地址空间，每个容器组 IP 池之间的地址空间不能重叠。</li><li>启用服务拓扑图以集成 <a href=https://www.weave.works/oss/scope/ target=_blank rel="noopener noreferrer">Weave Scope</a> (Docker 和 Kubernetes 的可视化和监控工具)，服务拓扑图显示在您的项目中，将服务之间的连接关系可视化（实际上没啥用，该项目目前已停止维护了，姑且放着吧）。</li></ul></blockquote><ul><li><strong>修改上面的所有参数后，必须加入一个参数</strong>（以前的 2.x 时代的 kk 没这个问题，不加的话，在部署 KubeSphere 的时候会有命名空间不匹配的问题）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace_override</span>: <span style=color:#ae81ff>kubesphereio</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>......</span>
</span></span></code></pre></div><p>经过上述步骤，我们成功完成了对离线集群配置文件 <code>ksp-v341-v1265-offline.yaml</code> 的修改。由于篇幅限制，无法在此展示完整的文件内容，请各位读者根据上文提供的配置说明仔细核对。</p><h2 id=5-安装配置-harbor>5. 安装配置 Harbor</h2><p>为了验证 KubeKey 部署离线 Harbor 的能力，本实战内容采用 KubeKey 部署 Harbor。<strong>生产环境建议提前自建</strong>。</p><p>请注意，以下操作无特殊说明时需在离线环境部署节点（<strong>默认为 Master-1</strong>）上执行。</p><h3 id=51-安装-harbor>5.1. 安装 Harbor</h3><p>执行以下命令安装镜像仓库 Harbor（<strong>受限于篇幅，输出结果未展示</strong>）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /root/kubekey
</span></span><span style=display:flex><span>./kk init registry -f ksp-v341-v1265-offline.yaml -a ksp-v3.4.1-artifact.tar.gz
</span></span></code></pre></div><blockquote><p><strong>说明：</strong> <code>ksp-v3.4.1-artifact.tar.gz</code> 我们制作的离线部署资源包中的制品包。</p></blockquote><p>部署完成后，我们 <strong>SSH 登陆到 Registry 节点</strong>，执行以下的命令，验证 Harbor 的安装情况：</p><ul><li>查看安装完成后有哪些内容</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry ~<span style=color:#f92672>]</span><span style=color:#75715e># ls -lh /opt/harbor/</span>
</span></span><span style=display:flex><span>total 633M
</span></span><span style=display:flex><span>......（受限于篇幅，输出结果未展示）
</span></span></code></pre></div><ul><li>查看安装版本</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry ~<span style=color:#f92672>]</span><span style=color:#75715e># docker images</span>
</span></span><span style=display:flex><span>REPOSITORY                      TAG       IMAGE ID       CREATED         SIZE
</span></span><span style=display:flex><span>goharbor/harbor-exporter        v2.5.3    d9a8cfa37cf8   <span style=color:#ae81ff>17</span> months ago   87.2MB
</span></span><span style=display:flex><span>goharbor/chartmuseum-photon     v2.5.3    788b207156ad   <span style=color:#ae81ff>17</span> months ago   225MB
</span></span><span style=display:flex><span>goharbor/redis-photon           v2.5.3    5dc5331f3de8   <span style=color:#ae81ff>17</span> months ago   154MB
</span></span><span style=display:flex><span>goharbor/trivy-adapter-photon   v2.5.3    27798821348a   <span style=color:#ae81ff>17</span> months ago   251MB
</span></span><span style=display:flex><span>goharbor/notary-server-photon   v2.5.3    c686413b72ce   <span style=color:#ae81ff>17</span> months ago   112MB
</span></span><span style=display:flex><span>goharbor/notary-signer-photon   v2.5.3    a3bc1def3f94   <span style=color:#ae81ff>17</span> months ago   109MB
</span></span><span style=display:flex><span>goharbor/harbor-registryctl     v2.5.3    942de6829d43   <span style=color:#ae81ff>17</span> months ago   136MB
</span></span><span style=display:flex><span>goharbor/registry-photon        v2.5.3    fb1278854b91   <span style=color:#ae81ff>17</span> months ago   77.9MB
</span></span><span style=display:flex><span>goharbor/nginx-photon           v2.5.3    91877cbc147a   <span style=color:#ae81ff>17</span> months ago   44.3MB
</span></span><span style=display:flex><span>goharbor/harbor-log             v2.5.3    ca36fb3b68a6   <span style=color:#ae81ff>17</span> months ago   161MB
</span></span><span style=display:flex><span>goharbor/harbor-jobservice      v2.5.3    75e6a7496590   <span style=color:#ae81ff>17</span> months ago   227MB
</span></span><span style=display:flex><span>goharbor/harbor-core            v2.5.3    93a775677473   <span style=color:#ae81ff>17</span> months ago   203MB
</span></span><span style=display:flex><span>goharbor/harbor-portal          v2.5.3    d78f9bbad9ee   <span style=color:#ae81ff>17</span> months ago   52.6MB
</span></span><span style=display:flex><span>goharbor/harbor-db              v2.5.3    bd50ae1eccdf   <span style=color:#ae81ff>17</span> months ago   224MB
</span></span><span style=display:flex><span>goharbor/prepare                v2.5.3    15102b9ebde6   <span style=color:#ae81ff>17</span> months ago   166MB
</span></span></code></pre></div><ul><li>查看安装状态</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry ~<span style=color:#f92672>]</span><span style=color:#75715e># cd /opt/harbor/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry harbor<span style=color:#f92672>]</span><span style=color:#75715e># docker-compose ps -a</span>
</span></span></code></pre></div><ul><li>查看 Harbor 配置的域名（<strong>确保使用了自定义域名</strong>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry harbor<span style=color:#f92672>]</span><span style=color:#75715e># cat /opt/harbor/harbor.yml | grep hostname:</span>
</span></span><span style=display:flex><span>hostname: registry.opsman.top
</span></span></code></pre></div><ul><li>查看 Docker 是否配置了私有证书（<strong>确保使用了自定义域名及证书</strong>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-registry harbor<span style=color:#f92672>]</span><span style=color:#75715e># ll /etc/docker/certs.d/registry.opsman.top/</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1103</span> Dec <span style=color:#ae81ff>13</span> 09:47 ca.crt
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1253</span> Dec <span style=color:#ae81ff>13</span> 09:47 registry.opsman.top.cert
</span></span><span style=display:flex><span>-rw-------. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1679</span> Dec <span style=color:#ae81ff>13</span> 09:47 registry.opsman.top.key
</span></span></code></pre></div><blockquote><p>小知识：KubeKey 部署 Harbor 时会自动同步自签名证书到集群所有节点，自己部署的 Harbor <strong>必须手动复制</strong> Registry 节点的<strong>自签名证书</strong>到集群所有节点。</p><p>KubeKey 完成复制的动作在下面两个模块：</p><ul><li><code>[InitRegistryModule] Synchronize certs file</code></li><li><code>[InitRegistryModule] Synchronize certs file to all nodes</code></li></ul></blockquote><h3 id=52-在-harbor-中创建项目>5.2. 在 Harbor 中创建项目</h3><p>由于 Harbor 项目存在访问控制（RBAC）的限制，即只有指定角色的用户才能执行某些操作。如果您未创建项目，则镜像不能被推送到 Harbor。</p><p>Harbor 中有两种类型的项目：</p><ul><li>公共项目（Public）：任何用户都可以从这个项目中拉取镜像。</li><li>私有项目（Private）：只有作为项目成员的用户可以拉取镜像。</li></ul><p>使用 KubeKey 安装的 Harbor 默认信息如下：</p><ul><li>登陆账户信息：管理员账号：<strong>admin</strong>，密码：<strong>Harbor12345</strong>（生产环境必须修改）。</li><li>Harbor 安装文件在 <strong>/opt/harbor</strong> , 如需运维 Harbor，可至该目录下。</li></ul><p>接下来的任务需要我们 <strong>SSH 登陆到 Registry 节点</strong>执行。</p><p>执行以下命令，下载官方提供的自动初始化 Harbor 仓库的脚本（<strong>可不下载直接用本文提供的脚本</strong>）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -O https://raw.githubusercontent.com/kubesphere/ks-installer/master/scripts/create_project_harbor.sh
</span></span></code></pre></div><ul><li>根据实际情况，执行以下命令修改脚本配置 <code>vim create_project_harbor.sh</code>。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># Harbor 仓库地址（写域名，默认配置为 https://dockerhub.kubekey.local）</span>
</span></span><span style=display:flex><span>url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://registry.opsman.top&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 访问 Harbor 仓库的默认用户和密码（生产环境建议修改）</span>
</span></span><span style=display:flex><span>user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin&#34;</span>
</span></span><span style=display:flex><span>passwd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Harbor12345&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 需要创建的项目名列表，按我们制作的离线包的镜像命名规则，实际上只需要创建一个 kubesphereio 即可，这里保留了所有可用值，各位可根据自己的离线仓库镜像名称规则修改。</span>
</span></span><span style=display:flex><span>harbor_projects<span style=color:#f92672>=(</span>library
</span></span><span style=display:flex><span>    kubesphere
</span></span><span style=display:flex><span>    calico
</span></span><span style=display:flex><span>    coredns
</span></span><span style=display:flex><span>    openebs
</span></span><span style=display:flex><span>    csiplugin
</span></span><span style=display:flex><span>    minio
</span></span><span style=display:flex><span>    mirrorgooglecontainers
</span></span><span style=display:flex><span>    osixia
</span></span><span style=display:flex><span>    prom
</span></span><span style=display:flex><span>    thanosio
</span></span><span style=display:flex><span>    jimmidyson
</span></span><span style=display:flex><span>    grafana
</span></span><span style=display:flex><span>    elastic
</span></span><span style=display:flex><span>    istio
</span></span><span style=display:flex><span>    jaegertracing
</span></span><span style=display:flex><span>    jenkins
</span></span><span style=display:flex><span>    weaveworks
</span></span><span style=display:flex><span>    openpitrix
</span></span><span style=display:flex><span>    joosthofman
</span></span><span style=display:flex><span>    nginxdemos
</span></span><span style=display:flex><span>    fluent
</span></span><span style=display:flex><span>    kubeedge
</span></span><span style=display:flex><span>    kubesphereio
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> project in <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>harbor_projects[@]<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;creating </span>$project<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    curl -k -u <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span>passwd<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/v2.0/projects&#34;</span> -d <span style=color:#e6db74>&#34;{ \&#34;project_name\&#34;: \&#34;</span><span style=color:#e6db74>${</span>project<span style=color:#e6db74>}</span><span style=color:#e6db74>\&#34;, \&#34;public\&#34;: true}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><blockquote><p>重点注意：</p><ul><li>harbor_projects 中一定要新增 <code>kubesphereio</code>，默认没有。不加后面报错，详情见 <strong>问题 2</strong>。</li><li>脚本创建的是 public 项目，如需要私有项目请修改脚本。</li></ul></blockquote><ul><li>执行脚本创建项目</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sh create_project_harbor.sh
</span></span></code></pre></div><ul><li>正确的执行结果如下（<strong>library 会有报错，因为默认已经存在，可忽略</strong>）</li></ul><h3 id=53-推送离线镜像到-harbor-仓库>5.3. 推送离线镜像到 Harbor 仓库</h3><p>将提前准备好的离线镜像推送到 Harbor 仓库，这一步为<strong>可选项</strong>，因为创建集群的时候默认会推送镜像（本文使用参数忽略了）。为了部署成功率，建议先推送。</p><ul><li>推送离线镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./kk artifact image push -f ksp-v341-v1265-offline.yaml -a ksp-v3.4.1-artifact.tar.gz
</span></span></code></pre></div><ul><li>Harbor 管理页面查看项目和镜像仓库（<strong>提前在自己电脑上做好域名解析配置</strong>）</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-offline-harbor-v253-projects-118.png alt></p><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-offline-harbor-v253-projects-repositories-kubesphereio.png alt></p><h2 id=6-安装-kubesphere-和-k8s-集群>6. 安装 KubeSphere 和 K8s 集群</h2><h3 id=61-安装-kubesphere-和-k8s-集群>6.1. 安装 KubeSphere 和 K8s 集群</h3><p>执行以下命令，安装 KubeSphere 和 K8s 集群。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./kk create cluster -f ksp-v341-v1265-offline.yaml -a ksp-v3.4.1-artifact.tar.gz --with-packages --skip-push-images
</span></span></code></pre></div><blockquote><p>参数说明</p><ul><li><strong>ksp-v341-v1265-offline.yaml</strong>：离线环境集群的配置文件</li><li><strong>ksp-v3.4.1-artifact.tar.gz</strong>：制品包的 tar 包镜像</li><li><strong>--with-packages</strong>：如需要安装操作系统依赖，需指定该选项</li><li><strong>--skip-push-images：</strong> 忽略推送镜像，因为，前面已经完成了推送镜像到私有仓库的任务</li></ul></blockquote><p>上面的命令执行后，首先 KubeKey 会检查部署 K8s 的依赖及其他详细要求。检查合格后，系统将提示您确认安装。输入 <strong>yes</strong> 并按 ENTER 继续部署。</p><blockquote><p>特殊说明：由于本文在安装的过程中启用了日志插件，因此在安装的过程中必须按照 「<strong>问题 6</strong>」的描述<strong>手工介入处理</strong>，<strong>否则安装会失败</strong>。</p></blockquote><p>安装过程日志输出比较多，受限于篇幅本文只展示最终结果。</p><p>部署完成需要大约 10-30 分钟左右，具体看网速、机器配置、启用多少插件等。</p><p>部署完成后，您应该会在终端上看到类似于下面的输出。提示部署完成的同时，输出中还会显示用户登陆 KubeSphere 的默认管理员用户和密码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###              Welcome to KubeSphere!           ###</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Console: http://192.168.9.91:30880
</span></span><span style=display:flex><span>Account: admin
</span></span><span style=display:flex><span>Password: P@88w0rd
</span></span><span style=display:flex><span>NOTES：
</span></span><span style=display:flex><span>  1. After you log into the console, please check the
</span></span><span style=display:flex><span>     monitoring status of service components in
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#34;Cluster Management&#34;</span>. If any service is not
</span></span><span style=display:flex><span>     ready, please wait patiently <span style=color:#66d9ef>until</span> all components
</span></span><span style=display:flex><span>     are up and running.
</span></span><span style=display:flex><span>  2. Please change the default password after login.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span>https://kubesphere.io             2023-12-13 10:56:38
</span></span><span style=display:flex><span><span style=color:#75715e>#####################################################</span>
</span></span><span style=display:flex><span>10:56:40 CST skipped: <span style=color:#f92672>[</span>ksp-master-3<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>10:56:40 CST skipped: <span style=color:#f92672>[</span>ksp-master-2<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>10:56:40 CST success: <span style=color:#f92672>[</span>ksp-master-1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>10:56:40 CST Pipeline<span style=color:#f92672>[</span>CreateClusterPipeline<span style=color:#f92672>]</span> execute successfully
</span></span><span style=display:flex><span>Installation is complete.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please check the result using the command:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        kubectl logs -n kubesphere-system <span style=color:#66d9ef>$(</span>kubectl get pod -n kubesphere-system -l <span style=color:#e6db74>&#39;app in (ks-install, ks-installer)&#39;</span> -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#66d9ef>)</span> -f
</span></span></code></pre></div><blockquote><p>小技巧：</p></blockquote><ul><li>当出现熟悉的安装滚动条 <strong>>>---></strong> 后，可以另开一个终端 使用命令 <code>kubectl get pod -A </code>或是 <code>kubectl get pod -A | grep -v Running</code> 观察进度，如出现异常可及时介入处理。</li><li>也可以通过下面的命令查看详细的部署过程日志及报错信息。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs -n kubesphere-system <span style=color:#66d9ef>$(</span>kubectl get pod -n kubesphere-system -l <span style=color:#e6db74>&#39;app in (ks-install, ks-installer)&#39;</span> -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#66d9ef>)</span> -f
</span></span></code></pre></div><h3 id=62--部署结果验证>6.2. 部署结果验证</h3><p>登录 Web 控制台通过 <code>http://{IP}:30880</code> 使用默认帐户和密码 <code>admin/P@88w0rd</code> 访问 KubeSphere 的 Web 控制台，简单的验证一下部署结果。</p><ul><li>查看集群节点状态</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-v126-offline-clusters-nodes.png alt></p><ul><li>查看系统组件状态</li></ul><p><img src=https://opsman-1258881081.cos.ap-beijing.myqcloud.com//ksp-v341-v126-offline-clusters-components.png alt></p><h2 id=7-常见问题>7. 常见问题</h2><h3 id=问题-1>问题 1</h3><ul><li>问题现象</li></ul><p>执行脚本 <code>create_project_harbor.sh</code> ，创建 Harbor 项目时，报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl performs SSL certificate verification by default, using a <span style=color:#e6db74>&#34;bundle&#34;</span>
</span></span><span style=display:flex><span> of Certificate Authority <span style=color:#f92672>(</span>CA<span style=color:#f92672>)</span> public keys <span style=color:#f92672>(</span>CA certs<span style=color:#f92672>)</span>. If the default
</span></span><span style=display:flex><span> bundle file isn<span style=color:#e6db74>&#39;t adequate, you can specify an alternate file
</span></span></span><span style=display:flex><span><span style=color:#e6db74> using the --cacert option.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>If this HTTPS server uses a certificate signed by a CA represented in
</span></span></span><span style=display:flex><span><span style=color:#e6db74> the bundle, the certificate verification probably failed due to a
</span></span></span><span style=display:flex><span><span style=color:#e6db74> problem with the certificate (it might be expired, or the name might
</span></span></span><span style=display:flex><span><span style=color:#e6db74> not match the domain name in the URL).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>If you&#39;</span>d like to turn off curl<span style=color:#960050;background-color:#1e0010>&#39;</span>s verification of the certificate, use
</span></span><span style=display:flex><span> the -k <span style=color:#f92672>(</span>or --insecure<span style=color:#f92672>)</span> option.
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>因为我们 Harbor 使用的是 Https 协议，并且使用了私有的域名和私有自定义的证书。需修改脚本，在 curl 命令中加入 <code>-k</code> 参数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 修改后命令</span>
</span></span><span style=display:flex><span>curl -k -u <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>user<span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span>passwd<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>url<span style=color:#e6db74>}</span><span style=color:#e6db74>/api/v2.0/projects&#34;</span> -d <span style=color:#e6db74>&#34;{ \&#34;project_name\&#34;: \&#34;</span><span style=color:#e6db74>${</span>project<span style=color:#e6db74>}</span><span style=color:#e6db74>\&#34;, \&#34;public\&#34;: true}&#34;</span>
</span></span></code></pre></div><h3 id=问题-2>问题 2</h3><ul><li>问题现象</li></ul><p>部署 Kubesphere 和 Kubernetes 集群之前，执行推送离线镜像的命令，报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>15:01:29 CST <span style=color:#f92672>[</span>CopyImagesToRegistryModule<span style=color:#f92672>]</span> Push multi-arch manifest to private registry
</span></span><span style=display:flex><span>15:01:29 CST message: <span style=color:#f92672>[</span>LocalHost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>get manifest list failed by module cache
</span></span><span style=display:flex><span>15:01:29 CST failed: <span style=color:#f92672>[</span>LocalHost<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>error: Pipeline<span style=color:#f92672>[</span>ArtifactImagesPushPipeline<span style=color:#f92672>]</span> execute failed: Module<span style=color:#f92672>[</span>CopyImagesToRegistryModule<span style=color:#f92672>]</span> exec failed:
</span></span><span style=display:flex><span>failed: <span style=color:#f92672>[</span>LocalHost<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>PushManifest<span style=color:#f92672>]</span> exec failed after <span style=color:#ae81ff>1</span> retries: get manifest list failed by module cache
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>参考 <a href=https://github.com/kubesphere/kubekey/issues/2054 target=_blank rel="noopener noreferrer">issues-2054</a>，在 Harbor 中创建项目 <code>kubesphereio</code>。</p><h3 id=问题-3>问题 3</h3><ul><li>问题现象</li></ul><p>部署集群时，报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>17:26:33 CST message: <span style=color:#f92672>[</span>ksp-master-1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>pull image failed: Failed to exec command: sudo -E /bin/bash -c <span style=color:#e6db74>&#34;env PATH=</span>$PATH<span style=color:#e6db74> crictl pull registry.opsman.top/kubesphereio/pause:3.8 --platform amd64&#34;</span>
</span></span><span style=display:flex><span>E1211 17:26:33.225514    <span style=color:#ae81ff>5977</span> remote_image.go:238<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;PullImage from image service failed&#34;</span> err<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpc error: code = Unknown desc = failed to pull and unpack image \&#34;registry.opsman.top/kubesphereio/pause:3.8\&#34;: failed to resolve reference \&#34;registry.opsman.top/kubesphereio/pause:3.8\&#34;: failed to do request: Head \&#34;https://registry.opsman.top/v2/kubesphereio/pause/manifests/3.8\&#34;: x509: certificate signed by unknown authority&#34;</span> image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>
</span></span><span style=display:flex><span>FATA<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> pulling image: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry.opsman.top/v2/kubesphereio/pause/manifests/3.8&#34;</span>: x509: certificate signed by unknown authority: Process exited with status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>17:26:33 CST retry: <span style=color:#f92672>[</span>ksp-master-1<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>参考 <a href=https://github.com/kubesphere/kubekey/issues/1762 target=_blank rel="noopener noreferrer">issues-1762</a>，在集群部署文件 <code>ksp-v341-v1265-offline.yaml</code> 的 registry 部分配置中加入以下内容（一定要确保 <strong>/etc/docker/certs.d/registry.opsman.top</strong> 文件夹存在）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 本文用的 registry.opsman.top 默认为 dockerhub.kubekey.local</span>
</span></span><span style=display:flex><span><span style=color:#f92672>certsPath</span>: <span style=color:#e6db74>&#34;/etc/docker/certs.d/registry.opsman.top&#34;</span>
</span></span></code></pre></div><p>如果在部署过程中报错，可以在 containerd 的配置文件中，加入下面的配置，重启 containerd 服务，再重新执行部署任务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#  vi /etc/containerd/config.toml 找到正确位置加入（一般在文件最后有类似段落，修改替换即可）</span>
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.configs.&#34;registry.opsman.top&#34;.tls]</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>ca_file = &#34;/etc/docker/certs.d/registry.opsman.top/ca.crt&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>cert_file = &#34;/etc/docker/certs.d/registry.opsman.top/registry.opsman.top.cert&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>key_file = &#34;/etc/docker/certs.d/registry.opsman.top/registry.opsman.top.key&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>insecure_skip_verify = false</span>
</span></span><span style=display:flex><span>              
</span></span><span style=display:flex><span><span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>systemctl restart containerd</span>
</span></span></code></pre></div><p>如果报错提示 <code>/etc/docker/certs.d/registry.opsman.top</code> 找不到，可以按下面的操作执行（<strong>没用 KubeKey 部署 Harbor 时会出现</strong>）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. 登陆到 registry 节点</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 复制 /etc/docker/certs.d/registry.opsman.top 文件夹到其他节点</span>
</span></span></code></pre></div><h3 id=问题-4>问题 4</h3><ul><li>问题现象</li></ul><p>部署集群时，报错如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>17:50:16 CST message: <span style=color:#f92672>[</span>ksp-master-3<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>pull image failed: Failed to exec command: sudo -E /bin/bash -c <span style=color:#e6db74>&#34;env PATH=</span>$PATH<span style=color:#e6db74> crictl pull registry.opsman.top/kubesphereio/pause:3.8 --platform amd64&#34;</span>
</span></span><span style=display:flex><span>E1211 17:50:16.841836    <span style=color:#ae81ff>8464</span> remote_image.go:238<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;PullImage from image service failed&#34;</span> err<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpc error: code = Unknown desc = failed to pull and unpack image \&#34;registry.opsman.top/kubesphereio/pause:3.8\&#34;: failed to resolve reference \&#34;registry.opsman.top/kubesphereio/pause:3.8\&#34;: get TLSConfig for registry \&#34;https://registry.opsman.top\&#34;: failed to load cert file: open /etc/docker/certs.d/registry.opsman.top/registry.opsman.top.cert: no such file or directory&#34;</span> image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>
</span></span><span style=display:flex><span>FATA<span style=color:#f92672>[</span>0000<span style=color:#f92672>]</span> pulling image: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.8&#34;</span>: get TLSConfig <span style=color:#66d9ef>for</span> registry <span style=color:#e6db74>&#34;https://registry.opsman.top&#34;</span>: failed to load cert file: open /etc/docker/certs.d/registry.opsman.top/registry.opsman.top.cert: no such file or directory: Process exited with status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>17:50:16 CST retry: <span style=color:#f92672>[</span>ksp-master-3<span style=color:#f92672>]</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>制作离线资源的官方 image-list 中不存在 pause:3.8 这个 image，需要自己预先加上再制作制品。实际上一共需要补充 <strong>16</strong> 个，报错都不一样，可以根据报错信息补充（<strong>本文提供的 images-list 已经是补充完整的</strong>）。</p><h3 id=问题-5>问题 5</h3><ul><li>问题现象</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason     Age                   From               Message
</span></span><span style=display:flex><span>  ----     ------     ----                  ----               -------
</span></span><span style=display:flex><span>  Normal   Scheduled  18m                   default-scheduler  Successfully assigned kube-system/metrics-server-5d65c798b8-m9tbj to ksp-master-3
</span></span><span style=display:flex><span>  Normal   Pulling    16m <span style=color:#f92672>(</span>x4 over 18m<span style=color:#f92672>)</span>     kubelet            Pulling image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphere/metrics-server:v0.4.2&#34;</span>
</span></span><span style=display:flex><span>  Warning  Failed     16m <span style=color:#f92672>(</span>x4 over 18m<span style=color:#f92672>)</span>     kubelet            Failed to pull image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphere/metrics-server:v0.4.2&#34;</span>: rpc error: code <span style=color:#f92672>=</span> NotFound desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphere/metrics-server:v0.4.2&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;registry.opsman.top/kubesphere/metrics-server:v0.4.2&#34;</span>: registry.opsman.top/kubesphere/metrics-server:v0.4.2: not found
</span></span><span style=display:flex><span>  Warning  Failed     16m <span style=color:#f92672>(</span>x4 over 18m<span style=color:#f92672>)</span>     kubelet            Error: ErrImagePull
</span></span><span style=display:flex><span>  Warning  Failed     16m <span style=color:#f92672>(</span>x6 over 17m<span style=color:#f92672>)</span>     kubelet            Error: ImagePullBackOff
</span></span><span style=display:flex><span>  Normal   BackOff    2m57s <span style=color:#f92672>(</span>x64 over 17m<span style=color:#f92672>)</span>  kubelet            Back-off pulling image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphere/metrics-server:v0.4.2&#34;</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>可能是 bug（<strong>已反馈给社区，暂未确认</strong>）。社区给了临时方案在离线集群配置文件中 <strong>kind: ClusterConfiguration</strong> 小节中，加入参数 <code>namespace_override: kubesphereio</code>。</p><h3 id=问题-6>问题 6</h3><ul><li>问题现象</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl describe pod opensearch-cluster-data-0 -n kubesphere-logging-system</span>
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason     Age                  From               Message
</span></span><span style=display:flex><span>  ----     ------     ----                 ----               -------
</span></span><span style=display:flex><span>  Normal   Pulling    56s <span style=color:#f92672>(</span>x3 over 2m57s<span style=color:#f92672>)</span>  kubelet            Pulling image <span style=color:#e6db74>&#34;busybox:latest&#34;</span>
</span></span><span style=display:flex><span>  Warning  Failed     15s <span style=color:#f92672>(</span>x3 over 2m17s<span style=color:#f92672>)</span>  kubelet            Error: ErrImagePull
</span></span><span style=display:flex><span>  Warning  Failed     15s                  kubelet            Failed to pull image <span style=color:#e6db74>&#34;busybox:latest&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;docker.io/library/busybox:latest&#34;</span>: failed to resolve reference <span style=color:#e6db74>&#34;docker.io/library/busybox:latest&#34;</span>: failed to <span style=color:#66d9ef>do</span> request: Head <span style=color:#e6db74>&#34;https://registry-1.docker.io/v2/library/busybox/manifests/latest&#34;</span>: dial tcp: lookup registry-1.docker.io on 114.114.114.114:53: read udp 192.168.9.92:37639-&gt;114.114.114.114:53: i/o timeout
</span></span><span style=display:flex><span>  Normal   BackOff    0s <span style=color:#f92672>(</span>x3 over 2m16s<span style=color:#f92672>)</span>   kubelet            Back-off pulling image <span style=color:#e6db74>&#34;busybox:latest&#34;</span>
</span></span><span style=display:flex><span>  Warning  Failed     0s <span style=color:#f92672>(</span>x3 over 2m16s<span style=color:#f92672>)</span>   kubelet            Error: ImagePullBackOff
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>这个应该也是个 bug，官方配置写死了 busybox 的地址（<strong>已反馈给社区，已确认</strong>），暂时需要手改。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看 sts</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@ksp-master-1 kubekey<span style=color:#f92672>]</span><span style=color:#75715e># kubectl get sts -n kubesphere-logging-system</span>
</span></span><span style=display:flex><span>NAME                        READY   AGE
</span></span><span style=display:flex><span>opensearch-cluster-data     0/2     7m42s
</span></span><span style=display:flex><span>opensearch-cluster-master   0/1     7m40s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改 sts 使用的 busyboy 镜像为本地镜像（细节不展示）</span>
</span></span><span style=display:flex><span>kubectl edit sts opensearch-cluster-data -n kubesphere-logging-system
</span></span><span style=display:flex><span>kubectl edit sts opensearch-cluster-master -n kubesphere-logging-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 本文修改后 image 内容（自己根据实际情况修改域名前缀）</span>
</span></span><span style=display:flex><span>registry.opsman.top/kubesphereio/busybox:1.31.1
</span></span></code></pre></div><h3 id=问题-7>问题 7</h3><ul><li>问题现象</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>preflight<span style=color:#f92672>]</span> You can also perform this action in beforehand using <span style=color:#e6db74>&#39;kubeadm config images pull&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>WARNING ImagePull<span style=color:#f92672>]</span>: failed to pull image registry.opsman.top/kubesphereio/pause:3.9: output: E1213 10:31:38.814017    <span style=color:#ae81ff>8325</span> remote_image.go:238<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;PullImage from image service failed&#34;</span> err<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;rpc error: code = NotFound desc = failed to pull and unpack image \&#34;registry.opsman.top/kubesphereio/pause:3.9\&#34;: failed to resolve reference \&#34;registry.opsman.top/kubesphereio/pause:3.9\&#34;: registry.opsman.top/kubesphereio/pause:3.9: not found&#34;</span> image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/pause:3.9&#34;</span>
</span></span><span style=display:flex><span>time<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2023-12-13T10:31:38+08:00&#34;</span> level<span style=color:#f92672>=</span>fatal msg<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pulling image: rpc error: code = NotFound desc = failed to pull and unpack image \&#34;registry.opsman.top/kubesphereio/pause:3.9\&#34;: failed to resolve reference \&#34;registry.opsman.top/kubesphereio/pause:3.9\&#34;: registry.opsman.top/kubesphereio/pause:3.9: not found&#34;</span>
</span></span><span style=display:flex><span>, error: exit status <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>这个报错是在部署过程中出现的，但是报错并未导致集群部署失败。解决办法跟<code>问题 4</code> 一样，制作离线资源的官方 image-list 中不存在 pause:3.9 这个 image，需要自己预先加上再制作制品。</p><h3 id=问题-8>问题 8</h3><ul><li>问题现象</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason       Age                   From               Message
</span></span><span style=display:flex><span>  ----     ------       ----                  ----               -------
</span></span><span style=display:flex><span>  Normal   Pulling      4m25s                 kubelet            Pulling image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/ks-apiserver:v3.4.1&#34;</span>
</span></span><span style=display:flex><span>  Warning  Failed       4m22s                 kubelet            Failed to pull image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/ks-apiserver:v3.4.1&#34;</span>: rpc error: code <span style=color:#f92672>=</span> Unknown desc <span style=color:#f92672>=</span> failed to pull and unpack image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/ks-apiserver:v3.4.1&#34;</span>: failed to extract layer sha256:9f4598b692bcf57921e45bc384b60591c5f8eac82e32e781e9fe5849ef6eb29e: write /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/291/fs/usr/local/bin/ks-apiserver: no space left on device: unknown
</span></span><span style=display:flex><span>  Warning  Failed       4m22s                 kubelet            Error: ErrImagePull
</span></span><span style=display:flex><span>  Warning  Failed       4m21s                 kubelet            Error: ImagePullBackOff
</span></span><span style=display:flex><span>  Normal   BackOff      39s <span style=color:#f92672>(</span>x15 over 4m21s<span style=color:#f92672>)</span>  kubelet            Back-off pulling image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/ks-apiserver:v3.4.1&#34;</span>
</span></span></code></pre></div><ul><li>解决方案</li></ul><p>人为造成，KubeKey 的离线部署资源包放在了节点 <code>ksp-master-1</code>，同时，该节点也是 K8s 的 Master-1 节点。该节点的系统盘为 40G，演示环境没加额外的数据盘，所以<strong>磁盘空间满了</strong>。实际使用中，建议新加一块数据盘。</p><h3 id=问题-9>问题 9</h3><ul><li>问题现象</li></ul><p>容器 <code>devops-argocd-dex-server</code> 反复重启。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># kubectl describe pod devops-argocd-dex-server-84fff59566-2brcn -n argocd</span>
</span></span><span style=display:flex><span>Events:
</span></span><span style=display:flex><span>  Type     Reason     Age                    From               Message
</span></span><span style=display:flex><span>  ----     ------     ----                   ----               -------
</span></span><span style=display:flex><span>  Normal   Created    35m <span style=color:#f92672>(</span>x2 over 36m<span style=color:#f92672>)</span>      kubelet            Created container dex-server
</span></span><span style=display:flex><span>  Normal   Started    35m <span style=color:#f92672>(</span>x2 over 36m<span style=color:#f92672>)</span>      kubelet            Started container dex-server
</span></span><span style=display:flex><span>  Normal   Killing    35m                    kubelet            Container dex-server failed liveness probe, will be restarted
</span></span><span style=display:flex><span>  Normal   Pulled     35m                    kubelet            Container image <span style=color:#e6db74>&#34;registry.opsman.top/kubesphereio/dex:v2.30.2&#34;</span> already present on machine
</span></span><span style=display:flex><span>  Warning  Unhealthy  35m <span style=color:#f92672>(</span>x6 over 36m<span style=color:#f92672>)</span>      kubelet            Liveness probe failed: Get <span style=color:#e6db74>&#34;http://10.233.89.12:5558/healthz/live&#34;</span>: dial tcp 10.233.89.12:5558: connect: connection refused
</span></span><span style=display:flex><span>  Warning  Unhealthy  22m <span style=color:#f92672>(</span>x38 over 36m<span style=color:#f92672>)</span>     kubelet            Readiness probe failed: Get <span style=color:#e6db74>&#34;http://10.233.89.12:5558/healthz/ready&#34;</span>: dial tcp 10.233.89.12:5558: connect: connection refused
</span></span><span style=display:flex><span>  Warning  BackOff    2m21s <span style=color:#f92672>(</span>x127 over 33m<span style=color:#f92672>)</span>  kubelet            Back-off restarting failed container dex-server in pod devops-argocd-dex-server-84fff59566-2brcn_argocd<span style=color:#f92672>(</span>d83b98dc-cd21-47d9-aa5e-e7a26d458e7f<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>解决方案（<strong>未解决</strong>）</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 细节没深究，删除 pod 自动重建，但是还会自动重启</span>
</span></span><span style=display:flex><span>kubectl delete pod devops-argocd-dex-server-84fff59566-2brcn -n argocd
</span></span></code></pre></div><h2 id=8-总结>8. 总结</h2><p>本次的实战课程，我们详细介绍了如何使用 KubeKey <strong>v3.0.13</strong> 离线部署 KubeSphere 和 K8s 集群。</p><p>概括总结全文主要涉及以下内容：</p><ul><li>了解清单 (manifest) 和制品 (artifact) 的概念</li><li>了解 manifest 和 images-list 资源的获取地址</li><li>了解 images-list 的组成及裁剪方案</li><li>手工编写 manifest 清单</li><li>根据 manifest 清单制作 artifact</li><li>KubeKey 离线部署 Harbor</li><li>Harbor 镜像仓库自动创建项目</li><li>KubeKey 离线部署 KubeSphere 和 K8s</li><li>KubeKey 离线部署常见问题及解决方案</li></ul><p>受限于篇幅限制，本文略有遗憾之处在于很多部署任务的输出结果没有展示，建议读者在实战中仔细分析。</p><blockquote><p><strong>免责声明：</strong></p><ul><li>笔者水平有限，尽管经过多次验证和检查，尽力确保内容的准确性，<strong>但仍可能存在疏漏之处</strong>。敬请业界专家大佬不吝指教。</li><li>本文所述内容仅限于实战环境验证测试通过，读者可学习、借鉴，但<strong>严禁直接用于生产环境</strong>。<strong>由此引发的任何问题，作者概不负责</strong>！</li></ul></blockquote></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&text=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&title=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2fdeploying-kubesphere-and-k8s-offline-with-kubekey%2f&t=KubeKey%20%e7%a6%bb%e7%ba%bf%e9%83%a8%e7%bd%b2%20KubeSphere%20v3.4.1%20%e5%92%8c%20K8s%20v1.26%20%e5%ae%9e%e6%88%98%e6%8c%87%e5%8d%97" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#前言>前言</a><ul><li><a href=#知识点>知识点</a></li><li><a href=#实战服务器配置>实战服务器配置</a></li><li><a href=#实战环境涉及软件版本信息>实战环境涉及软件版本信息</a></li></ul></li><li><a href=#1-简介>1. 简介</a></li><li><a href=#2-离线部署资源制作>2. 离线部署资源制作</a><ul><li><a href=#21-下载-kubekey>2.1. 下载 KubeKey</a></li><li><a href=#22-获取-manifest-模板>2.2. 获取 manifest 模板</a></li><li><a href=#23-获取-images-list-及可裁剪性分析>2.3. 获取 images-list 及可裁剪性分析</a></li><li><a href=#24-获取操作系统依赖包>2.4. 获取操作系统依赖包</a></li><li><a href=#25-生成-manifest-文件>2.5. 生成 manifest 文件</a></li><li><a href=#26-导出制品-artifact>2.6. 导出制品 artifact</a></li><li><a href=#27-导出-kubekey>2.7. 导出 KubeKey</a></li><li><a href=#28-kernel-升级包>2.8. Kernel 升级包</a></li></ul></li><li><a href=#3-k8s-离线集群服务器-初始化配置>3. K8s 离线集群服务器-初始化配置</a><ul><li><a href=#31-操作系统基础配置>3.1. 操作系统基础配置</a></li><li><a href=#32-数据盘配置>3.2. 数据盘配置</a></li><li><a href=#33-升级系统内核>3.3. 升级系统内核</a></li></ul></li><li><a href=#4-离线部署-kubesphere-和-k8s-的前提准备>4. 离线部署 KubeSphere 和 K8s 的前提准备</a><ul><li><a href=#41-上传离线部署资源包到部署节点>4.1. 上传离线部署资源包到部署节点</a></li><li><a href=#42-创建离线集群配置文件>4.2. 创建离线集群配置文件</a></li><li><a href=#43-修改-cluster-配置>4.3. 修改 Cluster 配置</a></li><li><a href=#44-修改-clusterconfiguration-配置>4.4. 修改 ClusterConfiguration 配置</a></li></ul></li><li><a href=#5-安装配置-harbor>5. 安装配置 Harbor</a><ul><li><a href=#51-安装-harbor>5.1. 安装 Harbor</a></li><li><a href=#52-在-harbor-中创建项目>5.2. 在 Harbor 中创建项目</a></li><li><a href=#53-推送离线镜像到-harbor-仓库>5.3. 推送离线镜像到 Harbor 仓库</a></li></ul></li><li><a href=#6-安装-kubesphere-和-k8s-集群>6. 安装 KubeSphere 和 K8s 集群</a><ul><li><a href=#61-安装-kubesphere-和-k8s-集群>6.1. 安装 KubeSphere 和 K8s 集群</a></li><li><a href=#62--部署结果验证>6.2. 部署结果验证</a></li></ul></li><li><a href=#7-常见问题>7. 常见问题</a><ul><li><a href=#问题-1>问题 1</a></li><li><a href=#问题-2>问题 2</a></li><li><a href=#问题-3>问题 3</a></li><li><a href=#问题-4>问题 4</a></li><li><a href=#问题-5>问题 5</a></li><li><a href=#问题-6>问题 6</a></li><li><a href=#问题-7>问题 7</a></li><li><a href=#问题-8>问题 8</a></li><li><a href=#问题-9>问题 9</a></li></ul></li><li><a href=#8-总结>8. 总结</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>