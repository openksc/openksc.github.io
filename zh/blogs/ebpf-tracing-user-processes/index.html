<!doctype html><html lang=en-US><head><meta charset=utf-8><title>eBPF 概述，第 5 部分：跟踪用户进程</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文主要讲解了如何使用 eBPF 程序来跟踪用户空间应用程序。"><meta name=keywords content="eBPF,Linux,Python"><meta property="og:type" content="article"><meta property="og:title" content="eBPF 概述，第 5 部分：跟踪用户进程"><meta property="og:description" content="本文主要讲解了如何使用 eBPF 程序来跟踪用户空间应用程序。"><meta property="og:image" content="https://kubesphere-community.pek3b.qingstor.com/images/ebpf-guide-cover.png"><meta property="og:url" content="https://openksc.github.io/zh/blogs/ebpf-tracing-user-processes/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@KubeSphere"><meta property="twitter:image" content="https://kubesphere-community.pek3b.qingstor.com/images/ebpf-guide-cover.png"><meta name=docsearch:language content="zh-CN"><meta name=docsearch:version content><link rel=canonical href=https://kubesphere.io/zh/blogs/ebpf-tracing-user-processes/><link rel="shortcut icon" href=/images/favicons/favicon.ico><link rel=apple-touch-icon href=/images/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/svg+xml href=/images/favicons/favicon.svg><link rel=icon type=image/png href=/images/favicons/favicon.png><link rel=manifest href=/images/favicons/site.webmanifest><link rel=mask-icon href=/images/favicons/safari-pinned-tab.svg color=#00ad6e><meta name=msapplication-config content='/images/favicons/browserconfig.xml'><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/fonts/Roboto/stylesheet.css><link rel=stylesheet href=/fonts/ProximaNova/stylesheet.css><link rel=stylesheet href=/css/jquery.modal.min.css><link rel=stylesheet href=/css/viewer.min.css><link rel=stylesheet href=/swiper/swiper-bundle.min.css><link rel=stylesheet href=/scss/common.min.0c3fdcc05ec210321169846714f74b11c4a1baf09a1833fa9273b2347c81e636.css><script src=/js/jquery-3.7.1.min.js></script><script src=/js/viewer.min.js></script><script src=/js/jquery.modal.min.js></script><script src=/swiper/swiper-bundle.min.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?0888981f1fa45d241b1fb6962da2963e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-YYCVN36HT5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-YYCVN36HT5")</script><script type=text/javascript>!function(e,t,n,s,o){e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},n=t.createElement("script"),tag=t.getElementsByTagName("script")[0],n.async=1,n.src=("https:"==document.location.protocol?"https://":"http://")+s,tag.parentNode.insertBefore(n,tag)}(window,document,"script","assets.giocdn.com/2.1/gio.js","gio"),gio("init","8a24ae300cbf8b8c",{}),gio("send")</script><link rel=stylesheet href=/scss/content.min.f73b326fbf8c5bd331900b0de21c7dde608a4926f482f6465f9ae1d9049b83ad.css><link rel=stylesheet href=/scss/markdown.min.db47186481122431dffae72d17dbbd51f90b66f022cc163458645709924e4eac.css></head><body><header class=navigation><div class=join-div><div class=content>🚀 KubeSphere v4.1.3 发布，多项优化与改进，欢迎体验！<a href=/zh/docs/v4.1/20-release-notes/release-v413/ target=_blank rel="noopener noreferrer">请查看 Release notes →</a>
<img id=close-join src=/images/header/close.svg alt=close></div></div><div class=common-layout><div class=header-container><a href=/zh/ aria-label=logo><img src=/images/header/logo.svg alt class=logo></a><ul class=nav><li class=menu-li><span class=menu-span>应用场景</span><ul class="dropdown-menu menu-2"><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li class=menu-li><span class=menu-span>资源</span><ul class="dropdown-menu menu-3"><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li class=menu-li><span class=menu-span>文档中心</span><ul class="dropdown-menu menu-4"><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/ target=_blank rel="noopener noreferrer">扩展组件开发</a></li><li><a href=https://kube.design/ target=_blank rel="noopener noreferrer">Kube Design</a></li></ul></li><li class=menu-li><span class=menu-span>开源社区</span><ul class="dropdown-menu menu-5"><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a></li><li><a href=https://www.kubesphere.io/zh/ target=_blank rel="noopener noreferrer">中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025 target=_blank rel="noopener noreferrer">开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/ target=_blank rel="noopener noreferrer">认证</a></li></ul><div class=right-menu><ul><li class=language-menu><div><img src=/images/header/black.svg alt>
<span>简体中文</span></div><ul class=dropdown-menu><li onclick='handleLangClick("zh","/zh/blogs/ebpf-tracing-user-processes/")'>简体中文</li></ul></li><li class=github-li><div class=github-star><a class=star-btn href=https://github.com/kubesphere/kubesphere rel="noopener noreferrer" target=_blank><span class=star-img></span>&nbsp;<span>Star</span>
</a><a class=social-count href=https://github.com/kubesphere/kubesphere/stargazers rel="noopener noreferrer" target=_blank></a></div></li><li class=menu-icon><img src=/images/header/menu.svg alt></li></ul></div></div></div><div id=modal-for-menu class=modal><ul class=nav><li data-check=0 class=menu-li><span class=menu-span>应用场景</span><ul class=dropdown-menu><li><a href=/zh/devops/>拥抱一站式 DevOps 工作流</a></li><li><a href=/zh/service-mesh/>在 Kubernetes 运行微服务</a></li><li><a href=/zh/observability/>构建丰富的云原生可观测性</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>资源</span><ul class=dropdown-menu><li><a href=/zh/projects/>开源项目</a></li><li><a href=/zh/conferences/>开源峰会</a></li><li><a href=/zh/blogs/>技术博客</a></li><li><a href=/zh/videos/>视频资源</a></li><li><a href=/zh/learn/>云原生实战</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>文档中心</span><ul class=dropdown-menu><li><a href=/zh/docs/v4.1>v4.1 <img src=/images/header/star.svg alt=star></a></li><li><a href=/zh/docs/v3.4>v3.4</a></li><li><a href=/zh/docs/v3.3>v3.3</a></li><li><a href=https://dev-guide.kubesphere.io/extension-dev-guide/zh/>扩展组件开发</a></li><li><a href=https://kube.design/>Kube Design</a></li></ul></li><li data-check=0 class=menu-li><span class=menu-span>开源社区</span><ul class=dropdown-menu><li><a href=/zh/contribution/>参与贡献</a></li><li><a href=/zh/live/>社区活动</a></li><li><a href=/zh/case/>案例学习</a></li><li><a href=/zh/partner/>合作伙伴</a></li><li><a href=/zh/user-group/>用户委员会</a></li><li><a href=/zh/news/>动态</a></li><li><a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md>版本计划</a></li><li><a href=https://www.kubesphere.io/zh/>中国站</a></li><li><a href=https://github.com/kubesphere/community/tree/master/sig-advocacy-and-outreach/ospp-2025>开源之夏 2025</a></li></ul></li><li><a data-docs=用户论坛 href=https://ask.kubesphere.io/forum>用户论坛</a></li><li><a data-docs=认证 href=https://kubesphere.cloud/certification/>认证</a></li></ul><div class=link-div><a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank rel="noopener noreferrer" aria-label=slack><img src=/images/header/slack-hover.svg alt>
</a><a href=https://x.com/KubeSphere target=_blank rel="noopener noreferrer" aria-label=twitter><img src=/images/header/twitter-hover.svg alt>
</a><a href=https://github.com/kubesphere/kubesphere target=_blank rel="noopener noreferrer" aria-label=github><img src=/images/header/github-hover.svg alt></a></div></div></header><script>var bindNavMouseEvent,bindScrollChangeHeader,bindClickShowMenu,bindClickModalLi,bindClickClose,language,handleLangClick,githubApiLink="https://api.github.com/repos/kubesphere/kubesphere",getStar=function(){$(".social-count").hide(),$.getJSON(githubApiLink,function(e){$(".social-count").show().html(e.stargazers_count)})};getStar(),bindNavMouseEvent=function(e,t){t||(t=$(e));var n=!1;t.mouseenter(function(){if(n)return!1;n=!0,$(this).find(".dropdown-menu").fadeIn(200,function(){n=!1})}),t.mouseleave(function(){$(this).find(".dropdown-menu").fadeOut(200)})},bindScrollChangeHeader=function(){var t=100,e=$("header");window.addEventListener("scroll",function(){var t=window.scrollY;t>0?e.addClass("navigationScroll"):e.removeClass("navigationScroll")})},bindClickShowMenu=function(){$(".menu-icon").click(function(){$("#modal-for-menu").modal()})},bindClickModalLi=function(){$(".modal .menu-li").click(function(){var e=$(this).data("check");e===0?($(this).data("check",1),$(this).find(".dropdown-menu").slideDown(200)):($(this).data("check",0),$(this).find(".dropdown-menu").slideUp(200)),$(this).find(".menu-span").toggleClass("up")})},bindClickClose=function(){$("#close-join").click(function(){$(".navigation .join-div").hide(),$(".main-section").removeClass("padding")})},language="zh",bindClickClose(),bindScrollChangeHeader(),$(".header-container .menu-li").each(function(){bindNavMouseEvent("",$(this))}),bindNavMouseEvent(".header-container .language-menu"),bindNavMouseEvent(".header-container .btn-li"),bindClickShowMenu(),bindClickModalLi(),handleLangClick=function(e,t){try{localStorage.setItem("lang",e)}catch{}location.href=t}</script><section class=main-section><div class=common-layout><div class=breadcrumb><span><a href=/zh/blogs/>技术博客</a> > </span><span>eBPF 概述，第 5 部分：跟踪用户进程</span></div><div class='main-div middle-div'><div class=author>Adrian Ratiu</div><span class=date>发布于：2021-11-23</span>&nbsp;&nbsp;&nbsp;
<span style=font-size:14px;color:#919aa3 id=busuanzi_container_page_pv>本文总阅读量：<span id=busuanzi_value_page_pv></span></span><h1>eBPF 概述，第 5 部分：跟踪用户进程</h1><div class=share-1><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&text=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&title=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&t=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div><div class=content><div class=md-body><blockquote><p>原文链接： <a href=https://www.collabora.com/news-and-blog/blog/2019/05/14/an-ebpf-overview-part-5-tracing-user-processes/ target=_blank rel="noopener noreferrer">https://www.collabora.com/news-and-blog/blog/2019/05/14/an-ebpf-overview-part-5-tracing-user-processes/</a></p></blockquote><blockquote><p><strong>作者：Adrian Ratiu</strong><br><strong>译者：狄卫华</strong><br><strong>注：本文已取得作者本人的翻译授权</strong></p></blockquote><h2 id=1-前言>1. 前言</h2><p>在之前的部分中，我们专注于 Linux 内核跟踪，在我们看来，基于 eBPF 的项目是最安全、最广泛可用和最有效的方法（eBPF 在 Linux 中完全是上游支持的，保证稳定的 ABI，在几乎所有的发行版中都默认启用，并可与所有其他跟踪机制集成）。 eBPF 成为内核工作的不二之选。 然而，到目前为止，我们故意避免深入讨论用户空间跟踪，因为它值得特别对待，因此我们在第 5 部分中专门讨论。</p><p>首先，我们将讨论为什么使用，然后我们将 eBPF 用户跟踪分为静态和动态两类分别讨论。</p><h2 id=2-为什么要在用户空间使用-ebpf>2. 为什么要在用户空间使用 eBPF？</h2><p>最重要的用户问题是，既然有这么多其他的调试器/性能分析器/跟踪器，这么多针对特定语言或操作系统的工具为同样的任务而开发，为什么还要使用 eBPF 来跟踪用户空间进程？答案并不简单，根据不同的使用情况，eBPF 可能不是最佳解决方案；在庞大的用户空间生态系统中，并没有一个适合所有情况的调试/跟踪的项目。</p><p>eBPF 跟踪具有以下优势：</p><ul><li><p>它为内核和用户空间提供了一个统一的跟踪接口，与其他工具（[k,u]probe, (dtrace)tracepoint 等）使用的机制兼容。2015 年的文章<a href=https://www.brendangregg.com/blog/2015-07-08/choosing-a-linux-tracer.html target=_blank rel="noopener noreferrer">选择 linux 跟踪器</a>虽然有些过时，但其提供了很好的见解，说明使用所有不同的工具有多困难，要花多少精力。有一个统一的、强大的、安全的、可广泛使用的框架来满足大多数跟踪的需要，是非常有价值的。一些更高级别的工具，如 Perf/SystemTap/DTrace，正在 eBPF 的基础上重写（成为 eBPF 的前端），所以了解 eBPF 有助于使用它们。</p></li><li><p>eBPF 是完全可编程的。Perf/ftrace 和其他工具都需要在事后处理数据，而 eBPF 可直接在内核/应用程序中运行自定义的高级本地编译的 C/Python/Go 检测代码。它可以在多个 eBPF 事件运行之间存储数据，例如以基于函数状态/参数计算每个函数调用统计数据。</p></li><li><p>eBPF 可以跟踪系统中的一切，它并不局限于特定的应用程序。例如可以在共享库上设置 uprobes 并跟踪链接和调用它的所有进程。</p></li><li><p>很多调试器需要暂停程序来观察其状态或降低运行时性能，从而难以进行实时分析，尤其是在生产工作负载上。因为 eBPF 附加了 JIT 的本地编译的检测代码，它的性能影响是最小的，不需要长时间暂停执行。</p></li></ul><p>诚然，eBPF 也有一些缺点：</p><ul><li>eBPF 不像其他跟踪器那样可以移植。该虚拟机主要是在 Linux 内核中开发的（有一个正在进行的 BSD 移植），相关的工具是基于 Linux 开发的。</li><li>eBPF 需要一个相当新的内核。例如对于 MIPS 的支持是在 v4.13 中加入的，但绝大多数 MIPS 设备在运行的内核都比 v4.13 老。</li><li>一般来说，eBPF 不容易像语言或特定应用的用户空间调试器那样提供一样多的洞察力。例如，Emacs 的核心是一个用 C 语言编写的 ELISP 解释器：eBPF 可以通过挂载在 Emacs 运行时的 C 函数调用来跟踪/调试 ELISP 程序，但它不了解更高级别的 ELISP 语言实现，因此使用 Emacs 提供的特殊 ELISP 语言特定跟踪器和调试器变得更加有用。另一个例子是调试在 Web 浏览器引擎中运行的 JavaScript 应用程序。</li><li>因为 "普通 eBPF" 在 Linux 内核中运行，所以每次 eBPF 检测用户进程时都会发生内核 - 用户上下文切换。这对于调试性能关键的用户空间代码来说可能很昂贵（也许可以使用<a href=https://github.com/iovisor/ubpf target=_blank rel="noopener noreferrer">用户空间 eBPF 虚拟机</a>项目来避免这种切换成本？）。这对于调试性能关键的用户空间代码来说是很昂贵的（也许<a href=https://github.com/iovisor/ubpf target=_blank rel="noopener noreferrer">用户空间 eBPF VM</a> 项目可以用来避免这种切换成本？）。这种上下文切换比正常的调试器（或像 strace 这样的工具）要便宜得多，所以它通常可以忽略不计，但在这种情况下，像 LTTng 这样能够完全运行在用户空间的跟踪器可能更合适。</li></ul><h2 id=3-静态跟踪点usdt-探针>3. 静态跟踪点（USDT 探针）</h2><p>静态跟踪点（tracepoint），在用户空间也被称为 USDT（用户静态定义的跟踪）探针（应用程序中感兴趣的特定位置），跟踪器可以在此处挂载检查代码执行和数据。它们由开发人员在源代码中明确定义，通常在编译时用 "--enable-trace" 等标志启用。静态跟踪点的优势在于它们不会经常变化：开发人员通常会保持稳定的静态跟踪 ABI，所以跟踪工具在不同的应用程序版本之间工作，这很有用，例如当升级 PostgreSQL 安装并遇到性能降低时。</p><h3 id=31-预定义的跟踪点>3.1 预定义的跟踪点</h3><p><a href=https://github.com/iovisor/bcc/tree/master/tools target=_blank rel="noopener noreferrer">BCC-tools</a> 包含很多有用的且经过测试的工具，可以与特定应用程序或语言运行时定义的跟踪点进行交互。对于我们的示例，我们将跟踪 Python 应用程序。确保你在构建了 python3 时启用了 "--enable-trace" 标识，并在 python 二进制文件或 libpython（取决于你构建方式）上运行 <a href=https://github.com/iovisor/bcc/blob/master/tools/tplist.py target=_blank rel="noopener noreferrer">tplist</a> 以确认跟踪点被启用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ tplist -l /usr/lib/libpython3.7m.so
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;import__find__load__start&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;import__find__load__done&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;gc__start&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;gc__done&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;line&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;function__return&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;function__entry&#39;</span>
</span></span></code></pre></div><p>首先我们使用 BCC 提供的一个很酷的跟踪工具 <a href=https://github.com/iovisor/bcc/blob/master/tools/lib/uflow_example.txt target=_blank rel="noopener noreferrer">uflow</a>，来跟踪 python 的<a href=https://github.com/python/cpython/blob/3.7/Lib/http/server.py target=_blank rel="noopener noreferrer">简单 http 服务器</a>的执行流程。跟踪应该是不言自明的，箭头和缩进表示函数的进入/退出。我们在这个跟踪中看到的是一个工作线程如何在 CPU 3 上退出，而主线程则准备在 CPU 0 上为其他传入的 http 请求提供服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python -m http.server &gt;/dev/null &amp; sudo ./uflow -l python $!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> <span style=color:#ae81ff>11727</span>
</span></span><span style=display:flex><span>Tracing method calls in python process 11727... Ctrl-C to quit.
</span></span><span style=display:flex><span>CPU PID    TID    TIME<span style=color:#f92672>(</span>us<span style=color:#f92672>)</span> METHOD
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11757</span>  7.034           /usr/lib/python3.7/_weakrefset.py._remove
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11757</span>  7.034     /usr/lib/python3.7/threading.py._acquire_restore
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11740</span>  7.034               /usr/lib/python3.7/threading.py.__exit__
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11740</span>  7.034             /usr/lib/python3.7/socketserver.py.service_actions
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11740</span>  7.034     /usr/lib/python3.7/selectors.py.select
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11740</span>  7.532     /usr/lib/python3.7/socketserver.py.service_actions
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>   <span style=color:#ae81ff>11740</span>  <span style=color:#ae81ff>11740</span>  7.532
</span></span></code></pre></div><p>接下来，我们希望在跟踪点被命中时运行我们的自定义代码，因此我们不完全依赖 BCC 提供的任何工具。 以下示例将自身挂钩到 python 的 function__entry 跟踪点（请参阅 <a href=https://docs.python.org/3/howto/instrumentation.html target=_blank rel="noopener noreferrer">python 检测</a>文档）并在有人下载文件时通知我们：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> bcc <span style=color:#f92672>import</span> BPF, USDT
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bpf <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#include &lt;uapi/linux/ptrace.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>static int strncmp(char *s1, char *s2, int size) {for (int i = 0; i &lt; size; ++i)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if (s1[i] != s2[i])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            return 1;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>int trace_file_transfers(struct pt_regs *ctx) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    uint64_t fnameptr;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    char fname[128]=</span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>, searchname[9]=&#34;copyfile&#34;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    bpf_usdt_readarg(2, ctx, &amp;fnameptr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    bpf_probe_read(&amp;fname, sizeof(fname), (void *)fnameptr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if (!strncmp(fname, searchname, sizeof(searchname)))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        bpf_trace_printk(&#34;Someone is transferring a file!</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>n&#34;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>};
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u <span style=color:#f92672>=</span> USDT(pid<span style=color:#f92672>=</span>int(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span>u<span style=color:#f92672>.</span>enable_probe(probe<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;function__entry&#34;</span>, fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;trace_file_transfers&#34;</span>)
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> BPF(text<span style=color:#f92672>=</span>bpf, usdt_contexts<span style=color:#f92672>=</span>[u])
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        (_, _, _, _, ts, msg) <span style=color:#f92672>=</span> b<span style=color:#f92672>.</span>trace_fields()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%-18.9f</span><span style=color:#e6db74> </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (ts, msg))
</span></span></code></pre></div><p>我们通过再次附加到简单的 http-server 进行测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python -m http.server &gt;/dev/null &amp; sudo ./trace_simplehttp.py $!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>14<span style=color:#f92672>]</span> <span style=color:#ae81ff>28682</span>
</span></span><span style=display:flex><span>34677.450520000    b<span style=color:#e6db74>&#39;Someone is transferring a file!&#39;</span>
</span></span></code></pre></div><p>上面的例子告诉我们什么时候有人在下载文件，但它不能比这更详细的信息，比如关于谁在下载、下载什么文件等。这是因为 python 只默认启用了几个非常通用的跟踪点（模块加载、函数进入/退出等）。为了获得更多的信息，我们必须在感兴趣的地方定义我们自己的跟踪点，以便我们能够提取相关的数据。</p><h3 id=32-定义我们自己的跟踪点>3.2 定义我们自己的跟踪点</h3><p>到目前为止，我们只使用别人定义的跟踪点，但是如果我们的应用程序并没有提供任何跟踪点，或者我们需要添加比现有跟踪点更多的信息，那么我们将不得不添加自己的跟踪点。</p><p>添加跟踪点方式有多种，例如 python-core 通过 <a href=https://github.com/python/cpython/blob/v3.7.2/Include/pydtrace.h target=_blank rel="noopener noreferrer">pydtrace.h</a> 和 <a href=https://github.com/python/cpython/blob/v3.7.2/Include/pydtrace.d target=_blank rel="noopener noreferrer">pydtrace.d</a> 使用 systemtap 的开发包 "systemtap-sdt-dev"，但我们将采取另一种方法，使用 <a href=https://github.com/sthima/libstapsdt target=_blank rel="noopener noreferrer">libstapsdt</a>，因为它有一个更简单的 API，更轻巧（只依赖于 libelf），并支持多种语言绑定。为了保持一致性，我们再次把重点放在 python 上，但是跟踪点也可以用其他语言添加，这里有<a href=https://github.com/sthima/libstapsdt/blob/master/example/demo.c target=_blank rel="noopener noreferrer">一个 C 语言示例</a>。</p><p>首先，我们给简单的 http 服务器打上补丁，公开跟踪点。代码应该是不言自明的：注意跟踪点的名字 <strong>file_transfer</strong> 及其参数，足够存储两个字符串指针和一个 32 位无符号整数，代表客户端 IP 地址，文件路径和文件大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>diff <span style=color:#f92672>--</span>git a<span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.7</span><span style=color:#f92672>/</span>http<span style=color:#f92672>/</span>server<span style=color:#f92672>.</span>py b<span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.7</span><span style=color:#f92672>/</span>http<span style=color:#f92672>/</span>server<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span>index ca2dd50<span style=color:#f92672>..</span>af08e10 <span style=color:#ae81ff>100644</span>
</span></span><span style=display:flex><span><span style=color:#f92672>---</span> a<span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.7</span><span style=color:#f92672>/</span>http<span style=color:#f92672>/</span>server<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#f92672>+++</span> b<span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>python3<span style=color:#ae81ff>.7</span><span style=color:#f92672>/</span>http<span style=color:#f92672>/</span>server<span style=color:#f92672>.</span>py
</span></span><span style=display:flex><span><span style=color:#f92672>@@</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>107</span>,<span style=color:#ae81ff>6</span> <span style=color:#f92672>+</span><span style=color:#ae81ff>107</span>,<span style=color:#ae81ff>13</span> <span style=color:#f92672>@@</span> <span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> partial
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#f92672>from</span> http <span style=color:#f92672>import</span> HTTPStatus
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>+</span><span style=color:#f92672>import</span> stapsdt
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>provider <span style=color:#f92672>=</span> stapsdt<span style=color:#f92672>.</span>Provider(<span style=color:#e6db74>&#34;simplehttp&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>probe <span style=color:#f92672>=</span> provider<span style=color:#f92672>.</span>add_probe(<span style=color:#e6db74>&#34;file_transfer&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>                           stapsdt<span style=color:#f92672>.</span>ArgTypes<span style=color:#f92672>.</span>uint64,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>                           stapsdt<span style=color:#f92672>.</span>ArgTypes<span style=color:#f92672>.</span>uint64,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>                           stapsdt<span style=color:#f92672>.</span>ArgTypes<span style=color:#f92672>.</span>uint32)<span style=color:#f92672>+</span>provider<span style=color:#f92672>.</span>load()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e># Default error message template</span>
</span></span><span style=display:flex><span> DEFAULT_ERROR_MESSAGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;</span><span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#e6db74>@@ -650,6 +657,8 @@ class SimpleHTTPRequestHandler(BaseHTTPRequestHandler):
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         f = self.send_head()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         if f:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             try:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+                path = self.translate_path(self.path)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+                probe.fire(self.address_string(), path, os.path.getsize(path))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 self.copyfile(f, self.wfile)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             finally:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 f.close()
</span></span></span></code></pre></div><p>运行打过补丁的服务器，我们可以使用 tplist 验证我们的 <strong>file_transfer</strong> 跟踪点在运行时是否存在：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python -m http.server &gt;/dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> &amp; tplist -p $!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#ae81ff>13297</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/tmp/simplehttp-Q6SJDX.so&#39;</span> b<span style=color:#e6db74>&#39;simplehttp&#39;</span>:b<span style=color:#e6db74>&#39;file_transfer&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so.1.0&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;import__find__load__start&#39;</span>
</span></span><span style=display:flex><span>b<span style=color:#e6db74>&#39;/usr/lib/libpython3.7m.so.1.0&#39;</span> b<span style=color:#e6db74>&#39;python&#39;</span>:b<span style=color:#e6db74>&#39;import__find__load__done&#39;</span>
</span></span></code></pre></div><p>我们将对上述示例中的跟踪器示例代码进行以下最重要的修改：</p><ul><li>它将其逻辑挂接到我们自定义的 <strong>file_transfer</strong> 跟踪点。</li><li>它使用 <a href=https://perf.wiki.kernel.org/index.php/Tutorial target=_blank rel="noopener noreferrer">PERF EVENTS</a> 来存储可以将任意结构传递到用户空间的数据，而不是我们之前使用的 ftrace 环形缓存区只能传输单个字符串。</li><li>它<strong>不</strong>使用 <strong>bpf_usdt_readarg</strong> 来获取 USDT 提供的指针，而是直接在处理程序函数签名中声明它们。 这是一个显着的质量改善，可用于所有处理程序。</li><li>此跟踪器明确使用 <strong><a href=https://perf.wiki.kernel.org/index.php/Tutorial target=_blank rel="noopener noreferrer">python2</a></strong>，即使到目前为止我们所有的示例（包括上面的 python http.server 补丁） 使用 <strong><a href=https://perf.wiki.kernel.org/index.php/Tutorial target=_blank rel="noopener noreferrer">python3</a></strong>。 希望将来所有 BCC API 和文档都能移植到 python 3。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> <span style=color:#75715e>#!/usr/bin/env python2</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>from</span> bcc <span style=color:#f92672>import</span> BPF, USDT
</span></span><span style=display:flex><span> <span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> bpf <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> #include &lt;uapi/linux/ptrace.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74> BPF_PERF_OUTPUT(events);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74> struct file_transf {char client_ip_str[20];
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     char file_path[300];
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     u32 file_size;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     u64 timestamp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> };
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74> int trace_file_transfers(struct pt_regs *ctx, char *ipstrptr, char *pathptr, u32 file_size) {struct file_transf ft = </span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     ft.file_size = file_size;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     ft.timestamp = bpf_ktime_get_ns();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     bpf_probe_read(&amp;ft.client_ip_str, sizeof(ft.client_ip_str), (void *)ipstrptr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     bpf_probe_read(&amp;ft.file_path, sizeof(ft.file_path), (void *)pathptr);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     events.perf_submit(ctx, &amp;ft, sizeof(ft));
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     return 0;
</span></span></span><span style=display:flex><span><span style=color:#e6db74> };
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_event</span>(cpu, data, size):
</span></span><span style=display:flex><span>     event <span style=color:#f92672>=</span> b[<span style=color:#e6db74>&#34;events&#34;</span>]<span style=color:#f92672>.</span>event(data)
</span></span><span style=display:flex><span>     print(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{0}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>{1}</span><span style=color:#e6db74> is downloding file </span><span style=color:#e6db74>{2}</span><span style=color:#e6db74> (</span><span style=color:#e6db74>{3}</span><span style=color:#e6db74> bytes)&#34;</span><span style=color:#f92672>.</span>format(event<span style=color:#f92672>.</span>timestamp, event<span style=color:#f92672>.</span>client_ip_str, event<span style=color:#f92672>.</span>file_path, event<span style=color:#f92672>.</span>file_size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> u <span style=color:#f92672>=</span> USDT(pid<span style=color:#f92672>=</span>int(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span> u<span style=color:#f92672>.</span>enable_probe(probe<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file_transfer&#34;</span>, fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;trace_file_transfers&#34;</span>)
</span></span><span style=display:flex><span> b <span style=color:#f92672>=</span> BPF(text<span style=color:#f92672>=</span>bpf, usdt_contexts<span style=color:#f92672>=</span>[u])
</span></span><span style=display:flex><span> b[<span style=color:#e6db74>&#34;events&#34;</span>]<span style=color:#f92672>.</span>open_perf_buffer(print_event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>while</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>         b<span style=color:#f92672>.</span>perf_buffer_poll()
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>KeyboardInterrupt</span>:
</span></span><span style=display:flex><span>         exit()
</span></span></code></pre></div><p>跟踪已打过补丁的服务器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python -m http.server &gt;/dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> &amp; sudo ./trace_stapsdt.py $!
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#ae81ff>5613</span>
</span></span><span style=display:flex><span>325540469950102: 127.0.0.1 is downloading file /home/adi/ <span style=color:#f92672>(</span><span style=color:#ae81ff>4096</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>325543319100447: 127.0.0.1 is downloading file /home/adi/.bashrc <span style=color:#f92672>(</span><span style=color:#ae81ff>827</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>325552448306918: 127.0.0.1 is downloading file /home/adi/workspace/ <span style=color:#f92672>(</span><span style=color:#ae81ff>4096</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>325563646387008: 127.0.0.1 is downloading file /home/adi/workspace/work.tar <span style=color:#f92672>(</span><span style=color:#ae81ff>112640</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>...<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>上面自定义的 <strong>file_transfer</strong> 跟踪点看起来很简单（直接 python 打印或日志记录调用可能有相同的效果），但它提供的机制非常强大：良好放置的跟踪点保证 ABI 稳定性，提供动态运行的能力安全、本地快速、<strong>可编程</strong>逻辑可以非常有助于快速分析和修复各种问题，而无需重新启动有问题的应用程序（重现问题可能需要很长时间）。</p><h2 id=4-动态探针uprobes>4. 动态探针（uprobes）</h2><p>上面举例说明的静态跟踪点的问题在于，它们需要在源代码中明确定义，并且在修改跟踪点时需要重新构建应用程序。保证现有跟踪点的 ABI 稳定性对维护人员如何重新构建/重写跟踪点数据的代码施加了限制。因此，在某些情况下，完全运行时动态用户空间探测器（uprobes）是首选：它们以特别的方式直接在运行应用程序的内存中进行探测，而无需任何特殊的源代码定义。动态探测器可能会比较容易在应用程序版本之间失效，但即便如此，它们对于实时调试正在运行的实例也很有用。</p><p>虽然静态跟踪点对于跟踪用 Python 或 Java 等高级语言编写的应用程序很有用，但 uprobes 对此不太有用，因为它们工作比较底层，并且不了解语言运行时实现（静态跟踪点之所以可以工作，因为开发人员自行承担公开高级应用程序的相关数据）。然而，动态探测器对于调试语言实现/引擎本身或用没有运行时的语言（如 C）编写的应用程序很有用。</p><p>可以将 uprobe 添加到优化过（stripped）的二进制文件中，但用户必须手动计算进程内内存偏移位置，uprobe 应通过 objdump 和 /proc//maps 等工具附加到该位置（<a href=https://github.com/torvalds/linux/blob/v4.20/Documentation/trace/uprobetracer.rst target=_blank rel="noopener noreferrer">参见示例</a>)，但这种方式比较痛苦且不可移植。 由于大多数发行版都提供调试符号包（或使用调试符号构建的快速方法）并且 BCC 使得使用带有符号名称解析的 uprobes 变得简单，因此绝大多数动态探测使用都是以这种方式进行的。</p><p><a href=https://github.com/iovisor/bcc/blob/master/tools/gethostlatency.py target=_blank rel="noopener noreferrer">gethostlatency</a> BCC 工具通过将 uprobes 附加到 gethostbyname 和 libc 中的相关函数来打印 DNS 请求延迟。 要验证 libc 未优化（stripped）以便可以运行该工具（否则会引发 sybol-not-found 错误）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file /usr/lib/libc-2.28.so
</span></span><span style=display:flex><span>/usr/lib/libc-2.28.so: ELF 64-bit LSB shared object, x86-64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>, dynamically linked, <span style=color:#f92672>(</span>...<span style=color:#f92672>)</span>, not stripped
</span></span><span style=display:flex><span>$ nm -na /usr/lib/libc-2.28.so | grep -i -e getaddrinfo
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000000000000000</span> a getaddrinfo.c
</span></span></code></pre></div><p><a href=https://github.com/iovisor/bcc/blob/master/tools/gethostlatency.py target=_blank rel="noopener noreferrer">gethostlatency</a> 代码与我们上面检查的跟踪点示例非常相似（并且在某些地方相同，它还使用 BPF_PERF_OUTPUT） ，所以我们不会在这里完整地发布它。 最相关的区别是使用 <a href=https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#4-attach_uprobe target=_blank rel="noopener noreferrer">BCC uprobe API</a>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>b<span style=color:#f92672>.</span>attach_uprobe(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c&#34;</span>, sym<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;getaddrinfo&#34;</span>, fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;do_entry&#34;</span>, pid<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>pid)
</span></span><span style=display:flex><span>b<span style=color:#f92672>.</span>attach_uretprobe(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c&#34;</span>, sym<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;getaddrinfo&#34;</span>, fn_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;do_return&#34;</span>, pid<span style=color:#f92672>=</span>args<span style=color:#f92672>.</span>pid)
</span></span></code></pre></div><p>这里需要理解和记住的关键思想是：只要对我们的 BCC eBPF 程序做一些小的改动，我们就可以通过静态和动态探测来跟踪非常不同的应用程序、库甚至是内核。之前我们是静态跟踪 Python 应用程序，现在我们是动态地测量 libc 的主机名解析延时。通过对这些小的（小于 150LOC，很多是模板）例子进行类似的修改，可在运行的系统中跟踪任何内容，这非常安全，没有崩溃的风险或其他工具引起的问题（如调试器应用程序暂停/停顿）。</p><h2 id=5-总结>5. 总结</h2><p>在第 5 部分中，我们研究了如何使用 eBPF 程序来跟踪用户空间应用程序。 使用 eBPF 完成这项任务的最大优势是它提供了一个统一的接口来安全有效地跟踪整个系统：可以在应用程序中重现错误，然后进一步跟踪到库或内核中，通过统一的编程框架/接口提供完整的系统可见性。 然而，eBPF 并不是银弹，尤其是在调试用高级语言编写的应用程序时，特定语言的工具可以更好地提供洞察力，或者对于那些运行旧版本 Linux 内核或需要非 Linux 系统的应用程序。</p></div></div><div class=share-2><div class=share><a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&text=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Twitter.svg alt="twitter icon">
</a><a href="https://reddit.com/submit?url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&title=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/Reddit.svg alt="reddit icon">
</a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Facebook.svg alt="facebook icon">
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f" target=_blank rel="noopener noreferrer"><img src=/images/share/Linkedin.svg alt="linkedin icon">
</a><a href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fopenksc.github.io%2fzh%2fblogs%2febpf-tracing-user-processes%2f&t=eBPF%20%e6%a6%82%e8%bf%b0%ef%bc%8c%e7%ac%ac%205%20%e9%83%a8%e5%88%86%ef%bc%9a%e8%b7%9f%e8%b8%aa%e7%94%a8%e6%88%b7%e8%bf%9b%e7%a8%8b" target=_blank rel="noopener noreferrer"><img src=/images/share/HackerNews.svg alt="hackernews icon"></a></div></div></div><div class=aside><div class=inner-div><div class=title>目录</div><div class=tabs><nav id=TableOfContents><ul><li><a href=#1-前言>1. 前言</a></li><li><a href=#2-为什么要在用户空间使用-ebpf>2. 为什么要在用户空间使用 eBPF？</a></li><li><a href=#3-静态跟踪点usdt-探针>3. 静态跟踪点（USDT 探针）</a><ul><li><a href=#31-预定义的跟踪点>3.1 预定义的跟踪点</a></li><li><a href=#32-定义我们自己的跟踪点>3.2 定义我们自己的跟踪点</a></li></ul></li><li><a href=#4-动态探针uprobes>4. 动态探针（uprobes）</a></li><li><a href=#5-总结>5. 总结</a></li></ul></nav></div></div></div></div></section><div class=SubscribeForm><div class=innerBox><img class=close src=/images/home/close.svg alt=close><p class=description>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=blog_formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input-blog type=text placeholder>
<button id=email-submit-blog>订阅</button>
<span id=message_blog data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在 style=color:red></span><span id=message1_blog style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span></div></div></div><footer><div class=footer><div class="footer-main common-layout"><div class=up-main><div class=left-div><img src=/images/logo.svg alt class=foot-logo><p>通过邮件接收 KubeSphere 最新的技术博客与产品更新的通知</p><div id=formAddress data-actionaddress="https://www.sendcloud.net/v3/api/subInvite/subscription?invitecode=1dc5a4fb-894c-4470-b01d-ca7fa9d47a46" data-usesendcloud=true data-lang=zh><input name=EMAIL id=email-input type=text placeholder=请输入您的邮箱地址>
<button id=email-submit>订阅</button></div><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址! data-message3=邮箱地址已经存在></span><span id=message1 style=color:#00a971 data-success=订阅成功啦，我们保证不会给你发垃圾邮件的啦></span><script>var bindSubmit=function(){var e=$("#email-input");$("#email-submit").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message").data("message1"),a=$("#message").data("message2"),r=$("#message").data("message3"),c=$("#message1").data("success");if(n)if(validateEmail(n)){if(s=$("#formAddress").data("usesendcloud"),!s)return;o=$("#formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:$("#email-input").val().toString()},success:function(){showSuccessMessage(c),setTimeout(function(){$("#email-input").val("")},1e3)},error:function(){showMessage(r)}})}else t.preventDefault(),showMessage(a);else t.preventDefault(),showMessage(i)})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},showMessage=function(e){$("#message").html(e).show()},showSuccessMessage=function(e){$("#message1").html(e).show()},bindHideMessage=function(){$(window).click(function(){$("#message").hide(),$("#message1").hide()})},bindClose=function(){$(".formBox .close").click(function(e){e.stopPropagation(),$(".formBox").fadeOut()})};bindSubmit(),bindClose(),bindHideMessage()</script><span id=message data-message1=请提供您的邮箱 data-message2=请输入有效的邮箱地址!></span></div><div class=right-div><ul class=common-flex-layout><li class=nowrap-li><div class=h3>应用场景</div><a href=/zh/devops/>拥抱一站式 DevOps</a>
<a href=/zh/service-mesh/>在 K8s 运行微服务</a>
<a href=/zh/observability/>构建云原生可观测性</a>
<a href=https://github.com/kubesphere/kubekey target=_blank rel="noopener noreferrer">K8s 一键部署与运维</a>
<a href=https://github.com/OpenFunction/OpenFunction target=_blank rel="noopener noreferrer">构建 FaaS 平台与 Serverless 架构</a>
<a href=https://github.com/openpitrix/openpitrix target=_blank rel="noopener noreferrer">多云应用管理平台</a></li><li class=nowrap-li><div class=h3>资源</div><a href=/zh/projects/>开源项目</a>
<a href=/zh/blogs/>技术博客</a>
<a href=/zh/conferences/>开源峰会</a>
<a href=/zh/videos/>视频资源</a>
<a href=/zh/learn/>云原生实战</a></li><li class=nowrap-li><div class=h3>文档中心</div><a href=/zh/docs/v4.1/01-intro/01-introduction/>产品介绍</a>
<a href=/zh/docs/v4.1/03-installation-and-upgrade/02-install-kubesphere/02-install-kubernetes-and-kubesphere/>如何安装</a>
<a href=/zh/docs/v4.1/02-quickstart/>快速入门</a>
<a href=/zh/docs/v3.4/reference/api-docs/>API 文档</a></li><li class=nowrap-li><div class=h3>开源社区</div><a href=/zh/contribution/>参与贡献</a>
<a href=/zh/live/>社区活动</a>
<a href=/zh/case/>案例学习</a>
<a href=/zh/partner/>合作伙伴</a>
<a href=/zh/user-group/>用户委员会</a>
<a href=https://github.com/kubesphere/kubesphere/blob/master/docs/roadmap.md target=_blank rel="noopener noreferrer">版本计划</a>
<a href=https://kubesphere.com.cn/ target=_blank rel="noopener noreferrer">中国站</a>
<a href=https://ask.kubesphere.io/forum target=_blank rel="noopener noreferrer">中文论坛</a>
<a href=https://kubesphere.io target=_blank rel="noopener noreferrer">全球站</a></li><li class=nowrap-li><div class=h3>产品与服务</div><a href=https://aws.amazon.com/cn/quickstart/architecture/qingcloud-kubesphere/ target=_blank rel="noopener noreferrer">KubeSphere on AWS</a>
<a href=https://market.azure.cn/marketplace/apps/qingcloud.kubesphere target=_blank rel="noopener noreferrer">KubeSphere on Azure</a>
<a href=https://marketplace.digitalocean.com/apps/kubesphere target=_blank rel="noopener noreferrer">KubeSphere on DigitalOcean</a>
<a href=https://www.qingcloud.com/products/kubesphereqke target=_blank rel="noopener noreferrer">KubeSphere on QingCloud(QKE)</a>
<a href=https://kubesphere.com.cn/kse/ target=_blank rel="noopener noreferrer">KubeSphere 企业版</a>
<a href=https://kubesphere.cloud/ksv/ target=_blank rel="noopener noreferrer">KubeSphere 虚拟化平台</a>
<a href=https://kubesphere.com.cn/marketplace/ target=_blank rel="noopener noreferrer">云原生扩展组件市场</a>
<a href=https://kubesphere.cloud target=_blank rel="noopener noreferrer">云原生应用服务平台</a>
<a href=https://m.qingcloud.com/p/aec50 target=_blank rel="noopener noreferrer">了解商业产品与咨询合作</a></li></ul></div></div><div class=down-main><div class=img-div><a class=wechat href=javascript:void(0); aria-label=wechat><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28" height="28" viewBox="0 0 28 28"><defs><path id="a" d="M0 0h15.673v12.156H0z"/></defs><g fill="none" fill-rule="evenodd" transform="translate(1 1)"><circle cx="13" cy="13" r="13" stroke="#B6C2CD"/><g transform="translate(5 7)"><mask id="b" fill="#fff"><use xlink:href="#a"/></mask><path fill="currentColor" d="M15.673 7.898c0-2.061-2.173-3.74-4.619-3.74-2.59.0-4.625 1.679-4.625 3.74.0 2.066 2.035 3.738 4.625 3.738.542.0 1.09-.13 1.632-.256l1.493.776-.408-1.29c1.09-.776 1.902-1.81 1.902-2.968zm-6.119-.645c-.27.0-.541-.257-.541-.514.0-.256.27-.514.541-.514.41.0.681.258.681.514.0.257-.271.514-.681.514zm2.994.0c-.27.0-.541-.257-.541-.514.0-.256.27-.514.54-.514.41.0.681.258.681.514.0.257-.277.514-.68.514z" mask="url(#b)"/><path fill="currentColor" d="M10.602 3.674c.177.0.356.011.533.029C10.657 1.576 8.27.0 5.543.0 2.498.0.0 1.974.0 4.485c0 1.45.829 2.64 2.216 3.564l-.552 1.588 1.94-.929c.693.129 1.251.263 1.94.263.17.0.343-.005.515-.022a3.68 3.68.0 01-.172-1.104c0-2.302 2.081-4.171 4.715-4.171zM7.618 2.243c.417.0.693.263.693.66s-.276.66-.693.66c-.418.0-.835-.263-.835-.66.006-.398.423-.66.835-.66zm-3.88 1.319c-.417.0-.834-.263-.834-.66s.417-.66.834-.66c.418.0.695.263.695.66.0.392-.277.66-.695.66z" mask="url(#b)"/></g></g></svg><div class=hide-div><img src=/images/home/wechat.svg alt></div></a><a class=facebook-a href=https://www.facebook.com/kubesphere target=_blank aria-label=facebook></a><a class=twitter-a href=https://x.com/KubeSphere target=_blank aria-label=twitter rel="noopener noreferrer"></a><a class=linkedin-a href=https://www.linkedin.com/company/kubesphere/ target=_blank aria-label=linkedin rel="noopener noreferrer"></a><a class=bilibili-a href=https://space.bilibili.com/438908638 target=_blank aria-label=bilibili rel="noopener noreferrer"></a><a class=slack-a href=https://join.slack.com/t/kubesphere/shared_invite/zt-2b4t6rdb4-ico_4UJzCln_S2c1pcrIpQ target=_blank aria-label=slack rel="noopener noreferrer"></a><a class=github-a href=https://github.com/kubesphere/kubesphere target=_blank aria-label=github rel="noopener noreferrer"></a><a class=medium-a href=https://itnext.io/@kubesphere target=_blank aria-label=medium rel="noopener noreferrer"></a></div><p class=p1></p><p class=case><a href=http://www.beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><span>京ICP备13019086号</span>
</a><a target=_blank rel="noopener noreferrer" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010502041003"><img src=/images/footer/case-icon.png alt=备案图标>
<span>京公网安备 11010502041003号</span></a></p></div></div></div><div class=cookie><div class=common-layout><p>您的隐私对我们很重要。我们使用Cookie来记住订阅详细信息，优化网站功能并交付根据您的兴趣量身定制的内容。要了解更多信息，请参阅我们的<a href=/zh/privacy>隐私政策</a>.</p><button>
接受并继续</button></div></div></footer><script>var lazyLoad=function(e,t){for(var n,o,i,s=0;s<t;s++){if(n=e.eq(s),o=n.attr("data-loaded"),o)continue;n.offset().top<parseInt($(window).height())+parseInt($(window).scrollTop())&&(i=n.attr("src"),n.attr("src",i),n.attr("data-loaded",!0))}},bindLayLoad=function(){var e=$("img"),t=e.length;lazyLoad(e,t),$(window).scroll(function(){lazyLoad(e,t)})},bindAddPadding=function(){var e=$("#close-join");e.length>0&&$(".main-section").addClass("padding")},docCookies={getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[-.+*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t){return!!e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)&&(document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t),!0)}},bindHideCookie=function(){var t=docCookies.getItem("hasAuth"),e=$(".cookie");t?e.hide():e.show(),e.find("button").on("click",function(){docCookies.setItem("hasAuth","1"),e.hide()})};bindAddPadding(),bindHideCookie()</script><script type=text/javascript src=/js/aside.2d6977c0f16aef4ed3e886dd66675ce74bd0efcd467c2b2bcdb30b92d5e7c7c0e5c6e0c9d8f09a883c22f58df9e6b0b6347fcdd3c9a920b7faba6d7f91a201c3.js integrity="sha512-LWl3wPFq707T6IbdZmdc50vQ781GfCsrzbMLktXnx8DlxuDJ2PCaiDwi9Y355rC2NH/N08mpILf6um1/kaIBww=="></script><script type=text/javascript src=/js/markdown-tab.17f9f46b021adebc7250ce1b07134a577b307e7a436daa4aaf388f218e8463966f53770b26a64817c06c168738a887672d47fb4c29615adfc446e11d09a344cf.js integrity="sha512-F/n0awIa3rxyUM4bBxNKV3swfnpDbapKrziPIY6EY5ZvU3cLJqZIF8BsFoc4qIdnLUf7TClhWt/ERuEdCaNEzw=="></script><script>let forbidForm=!1;var viewer=new Viewer(document.querySelector(".md-body"),{url:"src"}),blogBindSubmit=function(){var e=$("#email-input-blog");$("#email-submit-blog").click(function(t){t.stopPropagation();var s,o,n=e.val(),i=$("#message_blog").data("message1"),a=$("#message_blog").data("message2"),r=$("#message_blog").data("message3"),c=$("#message1_blog").data("success");if(n)if(validateEmail(n)){if(s=$("#blog_formAddress").data("usesendcloud"),!s)return;o=$("#blog_formAddress").data("actionaddress"),$.post({type:"post",url:o,data:{email:n.toString()},success:function(){showSuccessMessage_blog(c),setTimeout(function(){window.onscroll="",$(".SubscribeForm").hide(),$("#email-input-blog").val("")},5e3)},error:function(){showMessage_blog(r)}})}else t.preventDefault(),$("#message_blog").html(a).show();else t.preventDefault(),$("#message_blog").html(i).show()})},validateEmail=function(e){var t=/^[A-Za-z0-9]+([_.][A-Za-z0-9]+)*@([A-Za-z0-9-]+\.)+[A-Za-z]{2,6}$/;return t.test(e)},bindHideMessageBlog=function(){$(window).click(function(){$("#message_blog").hide()})},bindCloseBlog=function(){$(".SubscribeForm .close").click(function(e){e.stopPropagation(),$(".SubscribeForm").fadeOut(),window.onscroll=""})},showMessage_blog=function(e){$("#message_blog").html(e).show()},showSuccessMessage_blog=function(e){$("#message1_blog").html(e).show()};window.onscroll=()=>{var e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.clientHeight||document.body.clientHeight,n=document.documentElement.scrollHeight||document.body.scrollHeight;forbidForm&&(window.onscroll=""),e+t>n-710?$(".SubscribeForm").hide():$(".SubscribeForm").show()},blogBindSubmit(),bindCloseBlog(),bindHideMessageBlog()</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script></body></html>